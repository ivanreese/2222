<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=description content=2222><title>2222</title><link rel=stylesheet href=css/play.css><style>body{background-color:black;font-family:"Courier New",Courier,monospace;touch-action:none}#gameCanvas{position:absolute;top:0;left:0;width:100%;height:100%;bottom:0;right:0;border:0;background-color:black;-webkit-tap-highlight-color:transparent;image-rendering:-moz-crisp-edges;image-rendering:-webkit-crisp-edges;image-rendering:pixelated;image-rendering:crisp-edges}.homepagelink{overflow:hidden;text-overflow:ellipsis;max-width:50%}h1{color:lightblue;font-weight:400;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;height:2em;margin-top:.5em;margin-bottom:.5em}a{color:lightblue}.title{background-color:none;text-align:center;font-size:100%;float:center;color:gray;position:absolute;left:10%;right:10%;top:0;height:3em}.footer{background-color:none;text-align:center;float:center;color:#fff;position:absolute;left:0;right:0;height:3em;bottom:0}.gameContainer{background-color:none;position:absolute;left:0;right:0;top:3.5em;bottom:3em;touch-action:none}.mobile-menu{position:relative;top:5em;margin-left:auto;margin-right:auto;font-weight:700;border-radius:.25em}.mobile-menu.item-count-3{width:30em}.mobile-menu.item-count-3 .button{width:28.3333%;padding:7.5% 0}.mobile-menu.item-count-2{width:20em}.mobile-menu.item-count-2 .button{width:46%;padding:12.1765% 0}.mobile-menu.item-count-1{width:10em}.mobile-menu.item-count-1 .button{width:98%;padding:26.5% 0}.mobile-menu,.mobile-menu .close,.tab-icon{background:rgba(0,0,0,.4);border:2px solid rgba(255,255,255,.4);color:#fff}.mobile-menu .button{margin:2%;border-radius:.25em;text-align:center;float:left}.mobile-menu .clear{clear:both}.close-affordance,.tab-affordance{width:6em;height:6em;position:absolute;z-index:1000}.tab-affordance{left:-2em;top:5em}.close-affordance{left:-4em;top:-1em}.mobile-menu .close,.tab-icon{height:48px;position:absolute;border-radius:6px}.tab-icon{left:-.5em;top:70px;width:18px;border-radius:0 6px 6px 0;border-left:0}.mobile-menu .close{left:-18px;width:18px;top:0;border-radius:6px 0 0 6px;border-right:0}.mobile-menu .close .slice,.tab-icon .slice{margin:4.5px 1px;width:2px;height:80%;background:rgba(255,255,255,.4)}.tab-icon .slice{float:right}.tab-icon .slice:first-child{margin-right:4.5px}.mobile-menu .close .slice{float:left}.mobile-menu .close .slice:first-child{margin-left:4.5px}@media screen and (max-width:32em){.mobile-menu{font-size:.8em;width:90%}}@media screen and (max-width:24em){.mobile-menu{font-size:.65em;width:90%}}.disable-select{-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}a{display:inline-block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:80%}</style><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"></head><body><div class=title><h1 id=gametitle>2222</h1></div><div class=gameContainer><canvas id=gameCanvas></canvas></div><div class=footer><span id=errormessage style=color:red></span> <a id=homepagelink href=https://github.com/ivanreese/2222/puzzlescript-next/by-pestopancake target=_blank>github.com/ivanreese/2222/puzzlescript-next/by-pestopancake</a></div><script>if (window.document.documentMode) {
		document.getElementById('errormessage').innerHTML = "Internet Explorer is not supported.<br>Consider updating to another browser.";
		//We can't really stop execution of the rest of the code here. Should crash soon enough.
	}</script><script>function storage_has(e){const n=null!=localStorage.getItem(e);return debugSwitch.includes("stor")&&console.log(`Storage has key=${e} = ${n}.`),n}function storage_get(e){const n=localStorage.getItem(e);return debugSwitch.includes("stor")&&console.log(`Storage get key=${e} = "${n}".`),n}function storage_set(e,n){return debugSwitch.includes("stor")&&console.log(`Storage set key=${e} = "${n}".`),localStorage.setItem(e,n)}function storage_remove(e){debugSwitch.includes("stor")&&console.log(`Storage remove key=${e}.`),localStorage.removeItem(e)}var unitTesting=!1;let curLevelNo=0;var solvedSections=[],curlevelTarget=null,hasUsedCheckpoint=!1,levelEditorOpened=!1,muted=0,runrulesonlevelstart_phase=!1,ignoreNotJustPressedAction=!0,verbose_logging=!1,throttle_movement=!1,cache_console_messages=!1,quittingTitleScreen=!1,quittingMessageScreen=!1,deltatime=17,timer=0,repeatinterval=150,autotick=0,autotickinterval=0,winning=!1,againing=!1,againinterval=150,norepeat_action=!1,oldflickscreendat=[],keybuffer=[],debugSwitch="",showLayers=!1,showLayerNo=0,defaultDebugMode=!1,defaultVerboseLogging=!1,tweeninterval=0,tweentimer=0,isAnimating=!1,animateinterval=0,restarting=!1,messageselected=!1,textImages={},initLevel={},curLevel=initLevel;solving=!1;var canSetHTMLColors=!0,canDump=!1,canOpenEditor=!1,IDE=!1;const diffToVisualize=null;function stripTags(e){var n=document.createElement("div");return n.innerHTML=e,n.textContent||n.innerText||""}function consolePrint(e,n){}function consolePrintFromRule(e,n,t){}function consoleCacheDump(e){}function consoleError(e,n){var t=document.getElementById("errormessage");t?(e=stripTags(e),t.innerHTML+=e+"<br>"):console.error(e,n)}function logErrorNoLine(e){var n=document.getElementById("errormessage");e=stripTags(e),n.innerHTML+=e+"<br>"}function clearInputHistory(){}function pushInput(e){}function pushSoundToHistory(e){}for(var font={0:"\n00000\n00000\n00000\n01110\n10001\n10011\n10101\n11001\n10001\n01110\n00000\n00000",1:"\n00000\n00000\n00000\n11100\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000",2:"\n00000\n00000\n00000\n11110\n00001\n00001\n01110\n10000\n10000\n11111\n00000\n00000",3:"\n00000\n00000\n00000\n11110\n00001\n00110\n00001\n00001\n00001\n11110\n00000\n00000",4:"\n00000\n00000\n00000\n10000\n10000\n10000\n10010\n11111\n00010\n00010\n00000\n00000",5:"\n00000\n00000\n00000\n11111\n10000\n11110\n00001\n00001\n00001\n11110\n00000\n00000",6:"\n00000\n00000\n00000\n01110\n10000\n11110\n10001\n10001\n10001\n01110\n00000\n00000",7:"\n00000\n00000\n00000\n11111\n00001\n00010\n00100\n00100\n00100\n00100\n00000\n00000",8:"\n00000\n00000\n00000\n01110\n10001\n01110\n10001\n10001\n10001\n01110\n00000\n00000",9:"\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n01111\n00001\n01110\n00000\n00000",a:"\n00000\n00000\n00000\n00000\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000",b:"\n00000\n00000\n00000\n10000\n10000\n11110\n10001\n10001\n10001\n01110\n00000\n00000",c:"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n01111\n00000\n00000",d:"\n00000\n00000\n00000\n00001\n00001\n01111\n10001\n10001\n10001\n01111\n00000\n00000",e:"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000",f:"\n00000\n00000\n00000\n00011\n00100\n11111\n00100\n00100\n00100\n00100\n00000\n00000",g:"\n00000\n00000\n00000\n00000\n00000\n01111\n10001\n10001\n10001\n01111\n00001\n01110",h:"\n00000\n00000\n00000\n10000\n10000\n11110\n10001\n10001\n10001\n10001\n00000\n00000",i:"\n00000\n00000\n00000\n00100\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000",j:"\n00000\n00000\n00000\n00100\n00000\n01100\n00100\n00100\n00100\n00100\n10100\n01000",k:"\n00000\n00000\n00000\n10000\n10000\n10001\n10010\n11100\n10010\n10001\n00000\n00000",l:"\n00000\n00000\n00000\n01100\n00100\n00100\n00100\n00100\n00100\n01110\n00000\n00000",m:"\n00000\n00000\n00000\n00000\n00000\n01010\n10101\n10101\n10101\n10101\n00000\n00000",n:"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n10001\n00000\n00000",o:"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000",p:"\n00000\n00000\n00000\n00000\n00000\n11110\n10001\n10001\n10001\n11110\n10000\n10000",q:"\n00000\n00000\n00000\n00000\n00000\n01111\n10001\n10001\n10001\n01111\n00001\n00001",r:"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10000\n00000\n00000",s:"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n01110\n00001\n11110\n00000\n00000",t:"\n00000\n00000\n00000\n00100\n00100\n11111\n00100\n00100\n00100\n00011\n00000\n00000",u:"\n00000\n00000\n00000\n00000\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000",v:"\n00000\n00000\n00000\n00000\n00000\n10001\n10010\n10100\n11000\n10000\n00000\n00000",w:"\n00000\n00000\n00000\n00000\n00000\n10101\n10101\n10101\n10101\n01010\n00000\n00000",x:"\n00000\n00000\n00000\n00000\n00000\n10001\n01010\n00100\n01010\n10001\n00000\n00000","×":"\n00000\n00000\n00000\n00000\n00000\n10001\n01010\n00100\n01010\n10001\n00000\n00000",y:"\n00000\n00000\n00000\n00000\n00000\n10001\n10001\n10001\n10001\n01111\n00001\n11110",z:"\n00000\n00000\n00000\n00000\n00000\n11111\n00010\n00100\n01000\n11111\n00000\n00000",A:"\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000",B:"\n00000\n00000\n00000\n11110\n10001\n11110\n10001\n10001\n10001\n11110\n00000\n00000",C:"\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10000\n10000\n01111\n00000\n00000",D:"\n00000\n00000\n00000\n11110\n10001\n10001\n10001\n10001\n10001\n11110\n00000\n00000",E:"\n00000\n00000\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000",F:"\n00000\n00000\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n10000\n00000\n00000",G:"\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10011\n10001\n01111\n00000\n00000",H:"\n00000\n00000\n00000\n10001\n10001\n11111\n10001\n10001\n10001\n10001\n00000\n00000",I:"\n00000\n00000\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000",J:"\n00000\n00000\n00000\n01111\n00001\n00001\n00001\n00001\n00001\n01110\n00000\n00000",K:"\n00000\n00000\n00000\n10001\n10010\n10100\n11000\n10100\n10010\n10001\n00000\n00000",L:"\n00000\n00000\n00000\n10000\n10000\n10000\n10000\n10000\n10000\n11111\n00000\n00000",M:"\n00000\n00000\n00000\n11111\n10101\n10101\n10101\n10101\n10101\n10101\n00000\n00000",N:"\n00000\n00000\n00000\n10001\n11001\n10101\n10011\n10001\n10001\n10001\n00000\n00000",O:"\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000",P:"\n00000\n00000\n00000\n11110\n10001\n10001\n10001\n11110\n10000\n10000\n00000\n00000",Q:"\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n10001\n10101\n01110\n00100\n00000",R:"\n00000\n00000\n00000\n11110\n10001\n10001\n11110\n10001\n10001\n10001\n00000\n00000",S:"\n00000\n00000\n00000\n01111\n10000\n01110\n00001\n00001\n00001\n11110\n00000\n00000",T:"\n00000\n00000\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n00100\n00000\n00000",U:"\n00000\n00000\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000",V:"\n00000\n00000\n00000\n10001\n10001\n10001\n10001\n10001\n01010\n00100\n00000\n00000",W:"\n00000\n00000\n00000\n10101\n10101\n10101\n10101\n10101\n10101\n01010\n00000\n00000",X:"\n00000\n00000\n00000\n10001\n10001\n01010\n00100\n01010\n10001\n10001\n00000\n00000",Y:"\n00000\n00000\n00000\n10001\n10001\n01010\n00100\n00100\n00100\n00100\n00000\n00000",Z:"\n00000\n00000\n00000\n11111\n00001\n00010\n00100\n01000\n10000\n11111\n00000\n00000",".":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00100\n00000\n00000","·":"\n00000\n00000\n00000\n00000\n00000\n00000\n00100\n00000\n00000\n00000\n00000\n00000","•":"\n00000\n00000\n00000\n00000\n00000\n01110\n01110\n01110\n00000\n00000\n00000\n00000","…":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n10101\n00000\n00000","†":"\n00000\n00100\n00100\n01110\n00100\n00100\n00100\n00100\n00100\n00100\n00000\n00000","‡":"\n00000\n00100\n00100\n01110\n00100\n00100\n00100\n00100\n01110\n00100\n00000\n00000","ƒ":"\n00000\n00000\n00000\n00011\n00100\n11111\n00100\n00100\n00100\n00100\n01000\n00000","‚":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00100\n01100\n00000\n00000","„":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n01001\n11011\n00000\n00000",",":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00100\n01100\n00000\n00000",";":"\n00000\n00000\n00000\n00000\n00000\n00100\n00000\n00000\n00100\n01100\n00000\n00000",":":"\n00000\n00000\n00000\n00000\n00000\n00100\n00000\n00000\n00000\n00100\n00000\n00000","?":"\n00000\n00000\n00000\n01110\n10001\n00001\n00001\n00110\n00000\n00100\n00000\n00000","¿":"\n00000\n00000\n00000\n00100\n00000\n01100\n10000\n10000\n10001\n01110\n00000\n00000","!":"\n00000\n00000\n00000\n00100\n00100\n00100\n00100\n00100\n00000\n00100\n00000\n00000","¡":"\n00000\n00000\n00000\n00100\n00000\n00100\n00100\n00100\n00100\n00100\n00000\n00000","@":"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n10111\n10000\n01110\n00000\n00000","£":"\n00000\n00000\n00000\n00000\n00000\n01110\n01001\n11100\n01000\n11111\n00000\n00000",$:"\n00000\n00000\n00000\n00000\n00100\n01111\n10100\n01110\n00101\n11110\n00100\n00000","%":"\n00000\n00000\n00000\n00000\n00000\n11001\n11010\n00100\n01011\n10011\n00000\n00000","‰":"\n00000\n00000\n00000\n00000\n11001\n11010\n00100\n01011\n10011\n00000\n00011\n00011","^":"\n00000\n00000\n00000\n00100\n01010\n00000\n00000\n00000\n00000\n00000\n00000\n00000","&":"\n00000\n00000\n00000\n00000\n00000\n01100\n10000\n01011\n10010\n01100\n00000\n00000","*":"\n00000\n00000\n00000\n00000\n00000\n01010\n00100\n01010\n00000\n00000\n00000\n00000","(":"\n00000\n00000\n00000\n00010\n00100\n00100\n00100\n00100\n00100\n00010\n00000\n00000",")":"\n00000\n00000\n00000\n01000\n00100\n00100\n00100\n00100\n00100\n01000\n00000\n00000","+":"\n00000\n00000\n00000\n00000\n00000\n00100\n00100\n11111\n00100\n00100\n00000\n00000","÷":"\n00000\n00000\n00000\n00000\n00000\n00100\n00000\n11111\n00000\n00100\n00000\n00000","±":"\n00000\n00000\n00000\n00000\n00000\n00100\n00100\n11111\n00100\n11111\n00000\n00000","-":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n01110\n00000\n00000\n00000\n00000","–":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n11110\n00000\n00000\n00000\n00000","—":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n11111\n00000\n00000\n00000\n00000",_:"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n11111\n00000\n00000","=":"\n00000\n00000\n00000\n00000\n00000\n00000\n11111\n00000\n11111\n00000\n00000\n00000"," ":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000","{":"\n00000\n00000\n00000\n00110\n00100\n00100\n01100\n00100\n00100\n00110\n00000\n00000","}":"\n00000\n00000\n00000\n01100\n00100\n00100\n00110\n00100\n00100\n01100\n00000\n00000","[":"\n00000\n00000\n00000\n00110\n00100\n00100\n00100\n00100\n00100\n00110\n00000\n00000","]":"\n00000\n00000\n00000\n01100\n00100\n00100\n00100\n00100\n00100\n01100\n00000\n00000","'":"\n00000\n00000\n00000\n00100\n00100\n00100\n00000\n00000\n00000\n00000\n00000\n00000","‘":"\n00000\n00000\n00000\n00110\n00100\n00000\n00000\n00000\n00000\n00000\n00000\n00000","’":"\n00000\n00000\n00000\n00100\n01100\n00000\n00000\n00000\n00000\n00000\n00000\n00000","“":"\n00000\n00000\n00000\n11011\n10010\n00000\n00000\n00000\n00000\n00000\n00000\n00000","”":"\n00000\n00000\n00000\n01001\n11011\n00000\n00000\n00000\n00000\n00000\n00000\n00000",'"':"\n00000\n00000\n00000\n01010\n01010\n01010\n00000\n00000\n00000\n00000\n00000\n00000","/":"\n00000\n00000\n00000\n00000\n00000\n00001\n00010\n00100\n01000\n10000\n00000\n00000","\\":"\n00000\n00000\n00000\n00000\n00000\n10000\n01000\n00100\n00010\n00001\n00000\n00000","|":"\n00000\n00000\n00000\n00000\n00000\n00100\n00100\n00100\n00100\n00100\n00000\n00000","¦":"\n00000\n00000\n00000\n00000\n00100\n00100\n00000\n00100\n00100\n00100\n00000\n00000","<":"\n00000\n00000\n00000\n00000\n00000\n00010\n00100\n01000\n00100\n00010\n00000\n00000","‹":"\n00000\n00000\n00000\n00000\n00000\n00000\n00100\n01000\n00100\n00000\n00000\n00000","«":"\n00000\n00000\n00000\n00000\n00000\n00000\n01001\n10010\n01001\n00000\n00000\n00000",">":"\n00000\n00000\n00000\n00000\n00000\n01000\n00100\n00010\n00100\n01000\n00000\n00000","›":"\n00000\n00000\n00000\n00000\n00000\n00000\n00100\n00010\n00100\n00000\n00000\n00000","»":"\n00000\n00000\n00000\n00000\n00000\n00000\n10010\n01001\n10010\n00000\n00000\n00000","~":"\n00000\n00000\n00000\n00000\n00000\n00000\n01000\n10101\n00010\n00000\n00000\n00000","˜":"\n00000\n00000\n00000\n00000\n00000\n01010\n10100\n00000\n00000\n00000\n00000\n00000","`":"\n00000\n00000\n00000\n00000\n00000\n01000\n00100\n00000\n00000\n00000\n00000\n00000","#":"\n00000\n00000\n00000\n00000\n00000\n01010\n11111\n01010\n11111\n01010\n00000\n00000","À":"\n01000\n00100\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","Á":"\n00010\n00100\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","Â":"\n00100\n01010\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","Ã":"\n01000\n10101\n00010\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","Ä":"\n00000\n01010\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","Å":"\n00100\n01010\n00100\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","Æ":"\n00000\n00000\n00000\n01111\n10100\n10100\n10100\n11111\n10100\n10111\n00000\n00000","Ç":"\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10000\n10000\n01111\n00100\n01000","È":"\n01000\n00100\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","É":"\n00010\n00100\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","Ê":"\n00100\n01010\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","Ë":"\n00000\n01010\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","Ì":"\n01000\n00100\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","Í":"\n00010\n00100\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","Î":"\n00100\n01010\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","Ï":"\n00000\n01010\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","Ð":"\n00000\n00000\n00000\n01110\n01001\n01001\n11101\n01001\n01001\n01110\n00000\n00000","Ñ":"\n01001\n10110\n00000\n10001\n11001\n10101\n10011\n10001\n10001\n10001\n00000\n00000","Ò":"\n01000\n00100\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ó":"\n00010\n00100\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ô":"\n00100\n01010\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Õ":"\n01001\n10110\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ö":"\n00000\n01010\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ø":"\n00000\n00010\n00100\n01110\n10101\n10101\n10101\n10101\n10101\n01110\n00100\n01000","Ù":"\n00000\n01000\n00100\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ú":"\n00000\n00010\n00100\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Û":"\n00100\n01010\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ü":"\n00000\n01010\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","Ý":"\n00000\n00000\n00100\n10001\n10001\n01010\n00100\n00100\n00100\n00100\n00000\n00000","Þ":"\n00000\n00000\n10000\n11110\n10001\n10001\n10001\n10001\n10001\n11110\n10000\n00000","ß":"\n00000\n00000\n00000\n01110\n10001\n10110\n10001\n10001\n10001\n10110\n10000\n00000","ẞ":"\n00000\n00000\n00000\n01110\n10001\n10110\n10001\n10001\n10001\n10110\n00000\n00000","à":"\n00000\n00000\n01000\n00100\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","á":"\n00000\n00000\n00010\n00100\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","â":"\n00000\n00000\n00100\n01010\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","ã":"\n00000\n00000\n01001\n10110\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","ä":"\n00000\n00000\n00000\n01010\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","å":"\n00000\n00100\n01010\n00100\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","æ":"\n00000\n00000\n00000\n00000\n00000\n01110\n10101\n10110\n10100\n01111\n00000\n00000","ç":"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n01111\n00100\n01000","è":"\n00000\n00000\n01000\n00100\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","é":"\n00000\n00000\n00010\n00100\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","ê":"\n00000\n00000\n00100\n01010\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","ë":"\n00000\n00000\n00000\n01010\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","ì":"\n00000\n00000\n01000\n00100\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","í":"\n00000\n00000\n00010\n00100\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","î":"\n00000\n00000\n00100\n01010\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","ï":"\n00000\n00000\n00000\n01010\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","ð":"\n00000\n00000\n00010\n00111\n00010\n01110\n10010\n10010\n10010\n01110\n00000\n00000","ñ":"\n00000\n00000\n01001\n10110\n00000\n01110\n10001\n10001\n10001\n10001\n00000\n00000","ò":"\n00000\n00000\n01000\n00100\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","ó":"\n00000\n00000\n00010\n00100\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","ô":"\n00000\n00000\n00100\n01010\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","õ":"\n00000\n00000\n01001\n10110\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","ö":"\n00000\n00000\n00000\n01010\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","ø":"\n00000\n00000\n00000\n00010\n00100\n01110\n10101\n10101\n10101\n01110\n00100\n01000","ù":"\n00000\n00000\n00000\n01000\n00100\n10001\n10001\n10001\n10001\n01111\n00000\n00000","ú":"\n00000\n00000\n00000\n00010\n00100\n10001\n10001\n10001\n10001\n01111\n00000\n00000","û":"\n00000\n00000\n00100\n01010\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000","ü":"\n00000\n00000\n00000\n01010\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000","ý":"\n00000\n00000\n00000\n00010\n00100\n10001\n10001\n10001\n10001\n01111\n00001\n11110","þ":"\n00000\n00000\n00000\n10000\n10000\n11110\n10001\n10001\n10001\n11110\n10000\n10000","ÿ":"\n00000\n00000\n00000\n01010\n00000\n10001\n10001\n10001\n10001\n01111\n00001\n11110","Ā":"\n00000\n01110\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","ā":"\n00000\n00000\n00000\n01110\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","Ă":"\n01010\n00100\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00000\n00000","ă":"\n00000\n00000\n01010\n00100\n00000\n01111\n10001\n10001\n10001\n01111\n00000\n00000","Ą":"\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n11111\n10001\n10001\n00010\n00001","ą":"\n00000\n00000\n00000\n00000\n00000\n01111\n10001\n10001\n10001\n01111\n00010\n00001","Ć":"\n00010\n00100\n00000\n01111\n10000\n10000\n10000\n10000\n10000\n01111\n00000\n00000","ć":"\n00000\n00000\n00010\n00100\n00000\n01111\n10000\n10000\n10000\n01111\n00000\n00000","Ĉ":"\n00100\n01010\n00000\n01111\n10000\n10000\n10000\n10000\n10000\n01111\n00000\n00000","ĉ":"\n00000\n00000\n00100\n01010\n00000\n01111\n10000\n10000\n10000\n01111\n00000\n00000","Ċ":"\n00000\n00100\n00000\n01111\n10000\n10000\n10000\n10000\n10000\n01111\n00000\n00000","ċ":"\n00000\n00000\n00000\n00100\n00000\n01111\n10000\n10000\n10000\n01111\n00000\n00000","Č":"\n01010\n00100\n00000\n01111\n10000\n10000\n10000\n10000\n10000\n01111\n00000\n00000","č":"\n00000\n00000\n01010\n00100\n00000\n01111\n10000\n10000\n10000\n01111\n00000\n00000","Ď":"\n01010\n00100\n00000\n11110\n10001\n10001\n10001\n10001\n10001\n11110\n00000\n00000","ď":"\n00000\n00000\n00000\n00101\n00101\n01100\n10100\n10100\n10100\n01100\n00000\n00000","Đ":"\n00000\n00000\n00000\n01110\n01001\n01001\n11101\n01001\n01001\n01110\n00000\n00000","đ":"\n00000\n00000\n00010\n00111\n00010\n01110\n10010\n10010\n10010\n01110\n00000\n00000","Ē":"\n00000\n01110\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","ē":"\n00000\n00000\n00000\n01110\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","Ĕ":"\n01010\n00100\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","ĕ":"\n00000\n00000\n01010\n00100\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","Ė":"\n00000\n00100\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00000\n00000","ė":"\n00000\n00000\n00000\n00100\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","Ę":"\n00000\n00000\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11111\n00010\n00001","ę":"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n11111\n10000\n01110\n00010\n00001","Ě":"\n01010\n00100\n00000\n11111\n10000\n11111\n10000\n10000\n10000\n11110\n00000\n00000","ě":"\n00000\n00000\n01010\n00100\n00000\n01110\n10001\n11111\n10000\n01110\n00000\n00000","Ĝ":"\n00100\n01010\n00000\n01111\n10000\n10000\n10000\n10011\n10001\n01111\n00000\n00000","ĝ":"\n00000\n00000\n00100\n01010\n00000\n01111\n10001\n10001\n10001\n01111\n00001\n01110","Ğ":"\n01010\n00100\n00000\n01111\n10000\n10000\n10000\n10011\n10001\n01111\n00000\n00000","ğ":"\n00000\n00000\n01010\n00100\n00000\n01111\n10001\n10001\n10001\n01111\n00001\n01110","Ġ":"\n00000\n00100\n00000\n01111\n10000\n10000\n10000\n10011\n10001\n01111\n00000\n00000","ġ":"\n00000\n00000\n00000\n00100\n00000\n01111\n10001\n10001\n10001\n01111\n00001\n01110","Ģ":"\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10011\n10001\n01111\n00000\n01100","ģ":"\n00010\n00100\n00000\n01111\n10000\n10000\n10000\n10011\n10001\n01111\n00000\n00000","Ĥ":"\n00100\n01010\n00000\n10001\n10001\n11111\n10001\n10001\n10001\n10001\n00000\n00000","ĥ":"\n00100\n01010\n00000\n10000\n10000\n11110\n10001\n10001\n10001\n10001\n00000\n00000","Ħ":"\n00000\n00000\n01010\n11111\n01010\n01110\n01010\n01010\n01010\n01010\n00000\n00000","ħ":"\n00000\n00000\n01000\n11100\n01000\n01110\n01001\n01001\n01001\n01001\n00000\n00000","Ĩ":"\n01001\n10110\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","ĩ":"\n01010\n10100\n00000\n00100\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","Ī":"\n00000\n01110\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","ī":"\n00000\n00000\n00000\n01110\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","Ĭ":"\n01010\n00100\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","ĭ":"\n00000\n00000\n01010\n00100\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","Į":"\n00000\n00000\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00010\n00001","į":"\n00000\n00000\n00000\n00100\n00000\n01100\n00100\n00100\n00100\n01110\n00010\n00001","İ":"\n00000\n00100\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n11111\n00000\n00000","ı":"\n00000\n00000\n00000\n00000\n00000\n01100\n00100\n00100\n00100\n01110\n00000\n00000","Ĳ":"\n00000\n00000\n00000\n10010\n10010\n10010\n10010\n10010\n10010\n10110\n00000\n00000","ĳ":"\n00000\n00000\n00000\n01001\n00000\n11001\n01001\n01001\n01001\n11101\n00001\n00010","Ĵ":"\n00010\n00101\n00000\n01111\n00001\n00001\n00001\n00001\n00001\n01110\n00000\n00000","ĵ":"\n00000\n00000\n00100\n01010\n00000\n01100\n00100\n00100\n00100\n00100\n10100\n01000","Ķ":"\n00000\n00000\n00000\n10001\n10010\n10100\n11000\n10100\n10010\n10001\n00100\n01000","ķ":"\n00000\n00000\n00000\n10000\n10000\n10001\n10010\n11100\n10010\n10001\n00100\n01000","ĸ":"\n00000\n00000\n00000\n00000\n00000\n10001\n10010\n11100\n10010\n10001\n00000\n00000","Ĺ":"\n00000\n00010\n00100\n10000\n10000\n10000\n10000\n10000\n10000\n11111\n00000\n00000","ĺ":"\n00010\n00100\n00000\n01100\n00100\n00100\n00100\n00100\n00100\n01110\n00000\n00000","Ļ":"\n00000\n00000\n00000\n10000\n10000\n10000\n10000\n10000\n10000\n11111\n00000\n00100","ļ":"\n00000\n00000\n00000\n01100\n00100\n00100\n00100\n00100\n00100\n01110\n00000\n00100","Ľ":"\n00000\n00000\n00000\n10010\n10010\n10000\n10000\n10000\n10000\n11111\n00000\n00000","ľ":"\n00000\n00000\n00000\n01101\n00101\n00100\n00100\n00100\n00100\n01110\n00000\n00000","Ŀ":"\n00000\n00000\n00000\n10000\n10000\n10100\n10000\n10000\n10000\n11111\n00000\n00000","ŀ":"\n00000\n00000\n00000\n01100\n00100\n00100\n00101\n00100\n00100\n01110\n00000\n00000","Ł":"\n00000\n00000\n00000\n01000\n01010\n01100\n11000\n01000\n01000\n01111\n00000\n00000","ł":"\n00000\n00000\n00000\n01100\n00100\n00100\n00110\n01100\n00100\n01110\n00000\n00000","Ń":"\n00000\n00010\n00100\n10001\n11001\n10101\n10011\n10001\n10001\n10001\n00000\n00000","ń":"\n00000\n00000\n00010\n00100\n00000\n01110\n10001\n10001\n10001\n10001\n00000\n00000","Ņ":"\n00000\n00000\n00000\n10001\n11001\n10101\n10011\n10001\n10001\n10001\n00100\n01000","ņ":"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n10001\n00100\n01000","Ň":"\n00000\n01010\n00100\n10001\n11001\n10101\n10011\n10001\n10001\n10001\n00000\n00000","ň":"\n00000\n00000\n01010\n00100\n00000\n01110\n10001\n10001\n10001\n10001\n00000\n00000","ŉ":"\n00000\n00000\n00000\n10000\n10000\n00110\n01001\n01001\n01001\n01001\n00000\n00000","Ŋ":"\n00000\n00000\n00000\n10001\n11001\n10101\n10011\n10001\n10001\n10001\n00001\n00010","ŋ":"\n00000\n00000\n00000\n00000\n00000\n01110\n10001\n10001\n10001\n10001\n00001\n00010","Ō":"\n00000\n01110\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ō":"\n00000\n00000\n00000\n01110\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","Ŏ":"\n01010\n00100\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ŏ":"\n00000\n00000\n01010\n00100\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","Ő":"\n01001\n10010\n00000\n01110\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ő":"\n00000\n00000\n01001\n10010\n00000\n01110\n10001\n10001\n10001\n01110\n00000\n00000","Œ":"\n00000\n00000\n00000\n01111\n10100\n10100\n10111\n10100\n10100\n01111\n00000\n00000","œ":"\n00000\n00000\n00000\n00000\n00000\n01110\n10101\n10110\n10100\n01111\n00000\n00000","Ŕ":"\n00010\n00100\n00000\n11110\n10001\n10001\n11110\n10001\n10001\n10001\n00000\n00000","ŕ":"\n00000\n00000\n00010\n00100\n00000\n01111\n10000\n10000\n10000\n10000\n00000\n00000","Ŗ":"\n00000\n00000\n00000\n11110\n10001\n10001\n11110\n10001\n10001\n10001\n00100\n01000","ŗ":"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n10000\n10000\n10000\n00100\n01000","Ř":"\n01010\n00100\n00000\n11110\n10001\n10001\n11110\n10001\n10001\n10001\n00000\n00000","ř":"\n00000\n00000\n01010\n00100\n00000\n01111\n10000\n10000\n10000\n10000\n00000\n00000","Ś":"\n00010\n00100\n00000\n01111\n10000\n01110\n00001\n00001\n00001\n11110\n00000\n00000","ś":"\n00000\n00000\n00010\n00100\n00000\n01111\n10000\n01110\n00001\n11110\n00000\n00000","Ŝ":"\n00100\n01010\n00000\n01111\n10000\n01110\n00001\n00001\n00001\n11110\n00000\n00000","ŝ":"\n00000\n00000\n00100\n01010\n00000\n01111\n10000\n01110\n00001\n11110\n00000\n00000","Ş":"\n00000\n00000\n00000\n01111\n10000\n01110\n00001\n00001\n00001\n11110\n00100\n00000","ş":"\n00000\n00000\n00000\n00000\n00000\n01111\n10000\n01110\n00001\n11110\n00100\n01000","Š":"\n01010\n00100\n00000\n01111\n10000\n01110\n00001\n00001\n00001\n11110\n00000\n00000","š":"\n00000\n00000\n01010\n00100\n00000\n01111\n10000\n01110\n00001\n11110\n00000\n00000","Ţ":"\n00000\n00000\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n00100\n00010\n00100","ţ":"\n00000\n00000\n00000\n00100\n00100\n11111\n00100\n00100\n00100\n00011\n00000\n01100","Ť":"\n01010\n00100\n00000\n11111\n00100\n00100\n00100\n00100\n00100\n00100\n00000\n00000","ť":"\n00000\n00000\n00001\n00101\n00100\n11111\n00100\n00100\n00100\n00011\n00000\n00000","Ŧ":"\n00000\n00000\n00000\n11111\n00100\n00100\n01110\n00100\n00100\n00100\n00000\n00000","ŧ":"\n00000\n00000\n00000\n00100\n00100\n11111\n00100\n01110\n00100\n00011\n00000\n00000","Ũ":"\n01001\n10110\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ũ":"\n00000\n00000\n01001\n10110\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000","Ū":"\n00000\n01110\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ū":"\n00000\n00000\n00000\n01110\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000","Ŭ":"\n01010\n00100\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ŭ":"\n00000\n00000\n01010\n00100\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000","Ů":"\n00100\n01010\n00100\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ů":"\n00000\n00000\n00100\n01010\n00100\n10001\n10001\n10001\n10001\n01111\n00000\n00000","Ű":"\n01001\n10010\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00000\n00000","ű":"\n00000\n00000\n01001\n10010\n00000\n10001\n10001\n10001\n10001\n01111\n00000\n00000","Ų":"\n00000\n00000\n00000\n10001\n10001\n10001\n10001\n10001\n10001\n01110\n00100\n00010","ų":"\n00000\n00000\n00000\n00000\n00000\n10001\n10001\n10001\n10001\n01111\n00010\n00001","Ŵ":"\n00100\n01010\n00000\n10101\n10101\n10101\n10101\n10101\n10101\n01010\n00000\n00000","ŵ":"\n00000\n00000\n00100\n01010\n00000\n10101\n10101\n10101\n10101\n01010\n00000\n00000","Ŷ":"\n00100\n01010\n00000\n10001\n10001\n01010\n00100\n00100\n00100\n00100\n00000\n00000","ŷ":"\n00000\n00000\n00100\n01010\n00000\n10001\n10001\n10001\n10001\n01111\n00001\n11110","Ÿ":"\n00000\n01010\n00000\n10001\n10001\n01010\n00100\n00100\n00100\n00100\n00000\n00000","Ź":"\n00010\n00100\n00000\n11111\n00001\n00010\n00100\n01000\n10000\n11111\n00000\n00000","ź":"\n00000\n00000\n00010\n00100\n00000\n11111\n00010\n00100\n01000\n11111\n00000\n00000","Ż":"\n00000\n00100\n00000\n11111\n00001\n00010\n00100\n01000\n10000\n11111\n00000\n00000","ż":"\n00000\n00000\n00000\n00100\n00000\n11111\n00010\n00100\n01000\n11111\n00000\n00000","Ž":"\n01010\n00100\n00000\n11111\n00001\n00010\n00100\n01000\n10000\n11111\n00000\n00000","ž":"\n00000\n00000\n01010\n00100\n00000\n11111\n00010\n00100\n01000\n11111\n00000\n00000","€":"\n00000\n00000\n00000\n00111\n01000\n11110\n01000\n11110\n01000\n00111\n00000\n00000","™":"\n00000\n11111\n00100\n00100\n00100\n00000\n01010\n10101\n10101\n10101\n00000\n00000","¢":"\n00000\n00000\n00000\n00010\n00100\n01111\n10100\n10100\n10100\n01111\n00100\n01000","¤":"\n00000\n00000\n00000\n00000\n10001\n01110\n10001\n10001\n01110\n10001\n00000\n00000","¥":"\n00000\n00000\n10001\n01010\n00100\n01110\n00100\n01110\n00100\n00000\n00000","§":"\n00000\n00000\n00000\n01110\n10000\n01110\n10001\n01110\n00001\n01110\n00000\n00000","¨":"\n00000\n00000\n00000\n01010\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000","©":"\n00000\n00000\n00000\n01110\n10001\n10111\n10101\n10111\n10001\n01110\n00000\n00000","®":"\n00000\n00000\n00000\n01110\n10001\n10111\n10101\n10101\n10001\n01110\n00000\n00000","ª":"\n00000\n01110\n00010\n01110\n01010\n01110\n00000\n00000\n00000\n00000\n00000\n00000","º":"\n00000\n00100\n01010\n01010\n01010\n00100\n00000\n00000\n00000\n00000\n00000\n00000","¬":"\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n01110\n00010\n00000\n00000\n00000","¯":"\n00000\n00000\n00000\n01110\n00000\n00000\n00000\n00000\n00000\n00000\n00000\n00000","°":"\n00000\n00000\n00100\n01010\n00100\n00000\n00000\n00000\n00000\n00000\n00000\n00000","✓":"\n00000\n00000\n00000\n00000\n00000\n00001\n00010\n10100\n01000\n00000\n00000\n00000"},fontKeys=Object.keys(font),fontIndex={},i=0;i<fontKeys.length;i++)fontIndex[fontKeys[i]]=i;function RC4(e){this.s=new Array(256),this.i=0,this.j=0;for(var n=0;n<256;n++)this.s[n]=n;e&&this.mix(e)}function print_call_stack(){var e=(new Error).stack;console.log(e)}function RNG(e){this.seed=e,null==e?e=(Math.random()+Date.now()).toString():"function"==typeof e?(this.uniform=e,this.nextByte=function(){return~~(256*this.uniform())},e=null):"[object String]"!==Object.prototype.toString.call(e)&&(e=JSON.stringify(e)),this._normal=null,this._state=e?new RC4(e):null}
/**
 * Seedable random number generator functions.
 * @version 1.0.0
 * @license Public Domain
 *
 * @example
 * var rng = new RNG('Example');
 * rng.random(40, 50);  // =>  42
 * rng.uniform();       // =>  0.7972798995050903
 * rng.normal();        // => -0.6698504543216376
 * rng.exponential();   // =>  1.0547367609131555
 * rng.poisson(4);      // =>  2
 * rng.gamma(4);        // =>  2.781724687386858
 */
String.prototype.getBytes=function(){for(var e=[],n=0;n<this.length;n++){var t=this.charCodeAt(n),r=[];do{r.push(255&t),t>>=8}while(t>0);e=e.concat(r.reverse())}return e},RC4.prototype._swap=function(e,n){var t=this.s[e];this.s[e]=this.s[n],this.s[n]=t},RC4.prototype.mix=function(e){for(var n=e.getBytes(),t=0,r=0;r<this.s.length;r++)t+=this.s[r]+n[r%n.length],t%=256,this._swap(r,t)},RC4.prototype.next=function(){return this.i=(this.i+1)%256,this.j=(this.j+this.s[this.i])%256,this._swap(this.i,this.j),this.s[(this.s[this.i]+this.s[this.j])%256]},RNG.prototype.nextByte=function(){return this._state.next()},RNG.prototype.uniform=function(){for(var e=0,n=0;n<7;n++)e*=256,e+=this.nextByte();return e/(Math.pow(2,56)-1)},RNG.prototype.random=function(e,n){return null==e?this.uniform():(null==n&&(n=e,e=0),e+Math.floor(this.uniform()*(n-e)))},RNG.prototype.normal=function(){if(null!==this._normal){var e=this._normal;return this._normal=null,e}var n=this.uniform()||Math.pow(2,-53),t=this.uniform();return this._normal=Math.sqrt(-2*Math.log(n))*Math.sin(2*Math.PI*t),Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*t)},RNG.prototype.exponential=function(){return-Math.log(this.uniform()||Math.pow(2,-53))},RNG.prototype.poisson=function(e){var n=Math.exp(-(e||1)),t=0,r=1;do{t++,r*=this.uniform()}while(r>n);return t-1},RNG.prototype.gamma=function(e){var n=(e<1?1+e:e)-1/3,t=1/Math.sqrt(9*n);do{do{var r=this.normal(),o=Math.pow(t*r+1,3)}while(o<=0);var a=this.uniform(),i=Math.pow(r,2)}while(a>=1-.0331*i*i&&Math.log(a)>=.5*i+n*(1-o+Math.log(o)));return e<1?n*o*Math.exp(this.exponential()/-e):n*o},RNG.roller=function(e,n){var t=e.split(/(\d+)?d(\d+)([+-]\d+)?/).slice(1),r=parseFloat(t[0])||1,o=parseFloat(t[1]),a=parseFloat(t[2])||0;return n=n||new RNG,function(){for(var e=r+a,t=0;t<r;t++)e+=n.random(o);return e}};var FastBase64_chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",FastBase64_encLookup=[];function FastBase64_Init(){for(var e=0;e<4096;e++)FastBase64_encLookup[e]=FastBase64_chars[e>>6]+FastBase64_chars[63&e]}function FastBase64_Encode(e){for(var t=e.length,r="",o=0;t>2;)n=e[o]<<16|e[o+1]<<8|e[o+2],r+=FastBase64_encLookup[n>>12]+FastBase64_encLookup[4095&n],t-=3,o+=3;if(t>0){var a=(252&e[o])>>2,i=(3&e[o])<<4;if(t>1&&(i|=(240&e[++o])>>4),r+=FastBase64_chars[a],r+=FastBase64_chars[i],2==t){var s=(15&e[o++])<<2;s|=(192&e[o])>>6,r+=FastBase64_chars[s]}1==t&&(r+="="),r+="="}return r}function u32ToArray(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]}function u16ToArray(e){return[255&e,e>>8&255]}function MakeRiff(e,n,t){var r,o={chunkId:[82,73,70,70],chunkSize:0,format:[87,65,86,69],subChunk1Id:[102,109,116,32],subChunk1Size:16,audioFormat:1,numChannels:1,sampleRate:e,byteRate:0,blockAlign:0,bitsPerSample:n,subChunk2Id:[100,97,116,97],subChunk2Size:0};return o.byteRate=o.sampleRate*o.numChannels*o.bitsPerSample>>3,o.blockAlign=o.numChannels*o.bitsPerSample>>3,o.subChunk2Size=t.length,o.chunkSize=36+o.subChunk2Size,{dat:[],wav:r=o.chunkId.concat(u32ToArray(o.chunkSize),o.format,o.subChunk1Id,u32ToArray(o.subChunk1Size),u16ToArray(o.audioFormat),u16ToArray(o.numChannels),u32ToArray(o.sampleRate),u32ToArray(o.byteRate),u16ToArray(o.blockAlign),u16ToArray(o.bitsPerSample),o.subChunk2Id,u32ToArray(o.subChunk2Size),t),header:o,dataURI:"data:audio/wav;base64,"+FastBase64_Encode(r)}}FastBase64_Init(),"undefined"!=typeof exports&&(exports.RIFFWAVE=RIFFWAVE);var AUDIO_CONTEXT,SOUND_VOL=.25,SAMPLE_RATE=5512,BIT_DEPTH=8,SQUARE=0,SAWTOOTH=1,SINE=2,NOISE=3,TRIANGLE=4,BREAKER=5,SHAPES=["square","sawtooth","sine","noise","triangle","breaker"];function checkAudioContextExists(){try{null==AUDIO_CONTEXT&&("undefined"!=typeof AudioContext?AUDIO_CONTEXT=new AudioContext:"undefined"!=typeof webkitAudioContext&&(AUDIO_CONTEXT=new webkitAudioContext))}catch(e){window.console.log(e)}}checkAudioContextExists();var rng,masterVolume=1;function Params(){var e={};return e.wave_type=SQUARE,e.p_env_attack=0,e.p_env_sustain=.3,e.p_env_punch=0,e.p_env_decay=.4,e.p_base_freq=.3,e.p_freq_limit=0,e.p_freq_ramp=0,e.p_freq_dramp=0,e.p_vib_strength=0,e.p_vib_speed=0,e.p_arp_mod=0,e.p_arp_speed=0,e.p_duty=0,e.p_duty_ramp=0,e.p_repeat_speed=0,e.p_pha_offset=0,e.p_pha_ramp=0,e.p_lpf_freq=1,e.p_lpf_ramp=0,e.p_lpf_resonance=0,e.p_hpf_freq=0,e.p_hpf_ramp=0,e.sound_vol=.5,e.sample_rate=44100,e.bit_depth=8,e}var seeded=!1;function frnd(e){return seeded?rng.uniform()*e:Math.random()*e}function rnd(e){return seeded?Math.floor(rng.uniform()*(e+1)):Math.floor(Math.random()*(e+1))}pickupCoin=function(){var e=Params();if(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=0),e.p_base_freq=.4+frnd(.5),e.p_env_attack=0,e.p_env_sustain=frnd(.1),e.p_env_decay=.1+frnd(.4),e.p_env_punch=.3+frnd(.3),rnd(1)){e.p_arp_speed=.5+frnd(.2);var n=1+(1|frnd(7)),t=n+(1|frnd(7))+2;e.p_arp_mod=+n/+t}return e},laserShoot=function(){var e=Params();return e.wave_type=rnd(2),e.wave_type===SINE&&rnd(1)&&(e.wave_type=rnd(1)),e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),e.p_base_freq=.5+frnd(.5),e.p_freq_limit=e.p_base_freq-.2-frnd(.6),e.p_freq_limit<.2&&(e.p_freq_limit=.2),e.p_freq_ramp=-.15-frnd(.2),0===rnd(2)&&(e.p_base_freq=.3+frnd(.6),e.p_freq_limit=frnd(.1),e.p_freq_ramp=-.35-frnd(.3)),rnd(1)?(e.p_duty=frnd(.5),e.p_duty_ramp=frnd(.2)):(e.p_duty=.4+frnd(.5),e.p_duty_ramp=-frnd(.7)),e.p_env_attack=0,e.p_env_sustain=.1+frnd(.2),e.p_env_decay=frnd(.4),rnd(1)&&(e.p_env_punch=frnd(.3)),0===rnd(2)&&(e.p_pha_offset=frnd(.2),e.p_pha_ramp=-frnd(.2)),rnd(1)&&(e.p_hpf_freq=frnd(.3)),e},explosion=function(){var e=Params();return rnd(1)?(e.p_base_freq=.1+frnd(.4),e.p_freq_ramp=-.1+frnd(.4)):(e.p_base_freq=.2+frnd(.7),e.p_freq_ramp=-.2-frnd(.2)),e.p_base_freq*=e.p_base_freq,0===rnd(4)&&(e.p_freq_ramp=0),0===rnd(2)&&(e.p_repeat_speed=.3+frnd(.5)),e.p_env_attack=0,e.p_env_sustain=.1+frnd(.3),e.p_env_decay=frnd(.5),0===rnd(1)&&(e.p_pha_offset=-.3+frnd(.9),e.p_pha_ramp=-frnd(.3)),e.p_env_punch=.2+frnd(.6),rnd(1)&&(e.p_vib_strength=frnd(.7),e.p_vib_speed=frnd(.6)),0===rnd(2)&&(e.p_arp_speed=.6+frnd(.3),e.p_arp_mod=.8-frnd(1.6)),e},birdSound=function(){var e=Params();return frnd(10)<1?(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),e.p_env_attack=.4304400932967592+frnd(.2)-.1,e.p_env_sustain=.15739346034252394+frnd(.2)-.1,e.p_env_punch=.004488201744871758+frnd(.2)-.1,e.p_env_decay=.07478075528212291+frnd(.2)-.1,e.p_base_freq=.9865265720147687+frnd(.2)-.1,e.p_freq_limit=0+frnd(.2)-.1,e.p_freq_ramp=-.2995018224359539+frnd(.2)-.1,frnd(1)<.5&&(e.p_freq_ramp=.1+frnd(.15)),e.p_freq_dramp=.004598608156964473+frnd(.1)-.05,e.p_vib_strength=-.2202799497929496+frnd(.2)-.1,e.p_vib_speed=.8084998703158364+frnd(.2)-.1,e.p_arp_mod=0,e.p_arp_speed=0,e.p_duty=-.9031808754347107+frnd(.2)-.1,e.p_duty_ramp=-.8128699999808343+frnd(.2)-.1,e.p_repeat_speed=.601486018931999+frnd(.2)-.1,e.p_pha_offset=-.9424902314367765+frnd(.2)-.1,e.p_pha_ramp=-.1055482222272056+frnd(.2)-.1,e.p_lpf_freq=.9989765717851521+frnd(.2)-.1,e.p_lpf_ramp=-.25051720626043017+frnd(.2)-.1,e.p_lpf_resonance=.32777871505494693+frnd(.2)-.1,e.p_hpf_freq=.0023548750981756753+frnd(.2)-.1,e.p_hpf_ramp=-.002375673204842568+frnd(.2)-.1,e):frnd(10)<1?(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),e.p_env_attack=.5277795946672003+frnd(.2)-.1,e.p_env_sustain=.18243733568468432+frnd(.2)-.1,e.p_env_punch=-.020159754546840117+frnd(.2)-.1,e.p_env_decay=.1561353422051903+frnd(.2)-.1,e.p_base_freq=.9028855606533718+frnd(.2)-.1,e.p_freq_limit=-.008842787837148716,e.p_freq_ramp=-.1,e.p_freq_dramp=-.012891241489551925,e.p_vib_strength=-.17923136138403065+frnd(.2)-.1,e.p_vib_speed=.908263385610142+frnd(.2)-.1,e.p_arp_mod=.41690153355414894+frnd(.2)-.1,e.p_arp_speed=.0010766233195860704+frnd(.2)-.1,e.p_duty=-.8735363011184684+frnd(.2)-.1,e.p_duty_ramp=-.7397985366747507+frnd(.2)-.1,e.p_repeat_speed=.0591789344172107+frnd(.2)-.1,e.p_pha_offset=-.9961184222777699+frnd(.2)-.1,e.p_pha_ramp=-.08234769395850523+frnd(.2)-.1,e.p_lpf_freq=.9412475115697335+frnd(.2)-.1,e.p_lpf_ramp=-.18261358925834958+frnd(.2)-.1,e.p_lpf_resonance=.24541438107389477+frnd(.2)-.1,e.p_hpf_freq=-.01831940280978611+frnd(.2)-.1,e.p_hpf_ramp=-.03857383633171346+frnd(.2)-.1,e):frnd(10)<1?(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),e.p_env_attack=.4304400932967592+frnd(.2)-.1,e.p_env_sustain=.15739346034252394+frnd(.2)-.1,e.p_env_punch=.004488201744871758+frnd(.2)-.1,e.p_env_decay=.07478075528212291+frnd(.2)-.1,e.p_base_freq=.9865265720147687+frnd(.2)-.1,e.p_freq_limit=0+frnd(.2)-.1,e.p_freq_ramp=-.2995018224359539+frnd(.2)-.1,e.p_freq_dramp=.004598608156964473+frnd(.2)-.1,e.p_vib_strength=-.2202799497929496+frnd(.2)-.1,e.p_vib_speed=.8084998703158364+frnd(.2)-.1,e.p_arp_mod=-.46410459213693644+frnd(.2)-.1,e.p_arp_speed=-.10955361249587248+frnd(.2)-.1,e.p_duty=-.9031808754347107+frnd(.2)-.1,e.p_duty_ramp=-.8128699999808343+frnd(.2)-.1,e.p_repeat_speed=.7014860189319991+frnd(.2)-.1,e.p_pha_offset=-.9424902314367765+frnd(.2)-.1,e.p_pha_ramp=-.1055482222272056+frnd(.2)-.1,e.p_lpf_freq=.9989765717851521+frnd(.2)-.1,e.p_lpf_ramp=-.25051720626043017+frnd(.2)-.1,e.p_lpf_resonance=.32777871505494693+frnd(.2)-.1,e.p_hpf_freq=.0023548750981756753+frnd(.2)-.1,e.p_hpf_ramp=-.002375673204842568+frnd(.2)-.1,e):frnd(5)>1?(e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),rnd(1)?(e.p_arp_mod=.2697849293151393+frnd(.2)-.1,e.p_arp_speed=-.3131172257760948+frnd(.2)-.1,e.p_base_freq=.8090588299313949+frnd(.2)-.1,e.p_duty=-.6210022920964955+frnd(.2)-.1,e.p_duty_ramp=-.00043441813553182567+frnd(.2)-.1,e.p_env_attack=.004321877246874195+frnd(.2)-.1,e.p_env_decay=.1+frnd(.2)-.1,e.p_env_punch=.061737781504416146+frnd(.2)-.1,e.p_env_sustain=.4987252564798832+frnd(.2)-.1,e.p_freq_dramp=.31700340314222614+frnd(.2)-.1,e.p_freq_limit=0+frnd(.2)-.1,e.p_freq_ramp=-.163380391341416+frnd(.2)-.1,e.p_hpf_freq=.4709005021145149+frnd(.2)-.1,e.p_hpf_ramp=.6924667290539194+frnd(.2)-.1,e.p_lpf_freq=.8351398631384511+frnd(.2)-.1,e.p_lpf_ramp=.36616557192873134+frnd(.2)-.1,e.p_lpf_resonance=-.08685777111664439+frnd(.2)-.1,e.p_pha_offset=-.036084571580025544+frnd(.2)-.1,e.p_pha_ramp=-.014806445085568108+frnd(.2)-.1,e.p_repeat_speed=-.8094368475518489+frnd(.2)-.1,e.p_vib_speed=.4496665457171294+frnd(.2)-.1,e.p_vib_strength=.23413762515532424+frnd(.2)-.1):(e.p_arp_mod=-.35697118026766184+frnd(.2)-.1,e.p_arp_speed=.3581140690559588+frnd(.2)-.1,e.p_base_freq=1.3260897696157528+frnd(.2)-.1,e.p_duty=-.30984900436710694+frnd(.2)-.1,e.p_duty_ramp=-.0014374759133411626+frnd(.2)-.1,e.p_env_attack=.3160357835682254+frnd(.2)-.1,e.p_env_decay=.1+frnd(.2)-.1,e.p_env_punch=.24323114016870148+frnd(.2)-.1,e.p_env_sustain=.4+frnd(.2)-.1,e.p_freq_dramp=.2866475886237244+frnd(.2)-.1,e.p_freq_limit=0+frnd(.2)-.1,e.p_freq_ramp=-.10956352368742976+frnd(.2)-.1,e.p_hpf_freq=.20772718017889846+frnd(.2)-.1,e.p_hpf_ramp=.1564090637378835+frnd(.2)-.1,e.p_lpf_freq=.6021372770637031+frnd(.2)-.1,e.p_lpf_ramp=.24016227139979027+frnd(.2)-.1,e.p_lpf_resonance=-.08787383821160144+frnd(.2)-.1,e.p_pha_offset=-.381597686151701+frnd(.2)-.1,e.p_pha_ramp=-.0002481687661373495+frnd(.2)-.1,e.p_repeat_speed=.07812112809425686+frnd(.2)-.1,e.p_vib_speed=-.13648848579133943+frnd(.2)-.1,e.p_vib_strength=.0018874158972302657+frnd(.2)-.1),e):(e.wave_type=Math.floor(frnd(SHAPES.length)),1!==e.wave_type&&3!==e.wave_type||(e.wave_type=2),e.p_base_freq=.85+frnd(.15),e.p_freq_ramp=.3+frnd(.15),e.p_env_attack=0+frnd(.09),e.p_env_sustain=.2+frnd(.3),e.p_env_decay=0+frnd(.1),e.p_duty=frnd(2)-1,e.p_duty_ramp=Math.pow(frnd(2)-1,3),e.p_repeat_speed=.5+frnd(.1),e.p_pha_offset=-.3+frnd(.9),e.p_pha_ramp=-frnd(.3),e.p_arp_speed=.4+frnd(.6),e.p_arp_mod=.8+frnd(.1),e.p_lpf_resonance=frnd(2)-1,e.p_lpf_freq=1-Math.pow(frnd(1),3),e.p_lpf_ramp=Math.pow(frnd(2)-1,3),e.p_lpf_freq<.1&&e.p_lpf_ramp<-.05&&(e.p_lpf_ramp=-e.p_lpf_ramp),e.p_hpf_freq=Math.pow(frnd(1),5),e.p_hpf_ramp=Math.pow(frnd(2)-1,5),e)},pushSound=function(){var e=Params();return e.wave_type=Math.floor(frnd(SHAPES.length)),2===e.wave_type&&e.wave_type++,0===e.wave_type&&(e.wave_type=NOISE),e.p_base_freq=.1+frnd(.4),e.p_freq_ramp=.05+frnd(.2),e.p_env_attack=.01+frnd(.09),e.p_env_sustain=.01+frnd(.09),e.p_env_decay=.01+frnd(.09),e.p_repeat_speed=.3+frnd(.5),e.p_pha_offset=-.3+frnd(.9),e.p_pha_ramp=-frnd(.3),e.p_arp_speed=.6+frnd(.3),e.p_arp_mod=.8-frnd(1.6),e},powerUp=function(){var e=Params();return rnd(1)?e.wave_type=SAWTOOTH:e.p_duty=frnd(.6),e.wave_type=Math.floor(frnd(SHAPES.length)),3===e.wave_type&&(e.wave_type=SQUARE),rnd(1)?(e.p_base_freq=.2+frnd(.3),e.p_freq_ramp=.1+frnd(.4),e.p_repeat_speed=.4+frnd(.4)):(e.p_base_freq=.2+frnd(.3),e.p_freq_ramp=.05+frnd(.2),rnd(1)&&(e.p_vib_strength=frnd(.7),e.p_vib_speed=frnd(.6))),e.p_env_attack=0,e.p_env_sustain=frnd(.4),e.p_env_decay=.1+frnd(.4),e},hitHurt=function(){return result=Params(),result.wave_type=rnd(2),result.wave_type===SINE&&(result.wave_type=NOISE),result.wave_type===SQUARE&&(result.p_duty=frnd(.6)),result.wave_type=Math.floor(frnd(SHAPES.length)),result.p_base_freq=.2+frnd(.6),result.p_freq_ramp=-.3-frnd(.4),result.p_env_attack=0,result.p_env_sustain=frnd(.1),result.p_env_decay=.1+frnd(.2),rnd(1)&&(result.p_hpf_freq=frnd(.3)),result},jump=function(){return result=Params(),result.wave_type=SQUARE,result.wave_type=Math.floor(frnd(SHAPES.length)),3===result.wave_type&&(result.wave_type=SQUARE),result.p_duty=frnd(.6),result.p_base_freq=.3+frnd(.3),result.p_freq_ramp=.1+frnd(.2),result.p_env_attack=0,result.p_env_sustain=.1+frnd(.3),result.p_env_decay=.1+frnd(.2),rnd(1)&&(result.p_hpf_freq=frnd(.3)),rnd(1)&&(result.p_lpf_freq=1-frnd(.6)),result},blipSelect=function(){return result=Params(),result.wave_type=rnd(1),result.wave_type=Math.floor(frnd(SHAPES.length)),3===result.wave_type&&(result.wave_type=rnd(1)),result.wave_type===SQUARE&&(result.p_duty=frnd(.6)),result.p_base_freq=.2+frnd(.4),result.p_env_attack=0,result.p_env_sustain=.1+frnd(.1),result.p_env_decay=frnd(.2),result.p_hpf_freq=.1,result},random=function(){return result=Params(),result.wave_type=Math.floor(frnd(SHAPES.length)),result.p_base_freq=Math.pow(frnd(2)-1,2),rnd(1)&&(result.p_base_freq=Math.pow(frnd(2)-1,3)+.5),result.p_freq_limit=0,result.p_freq_ramp=Math.pow(frnd(2)-1,5),result.p_base_freq>.7&&result.p_freq_ramp>.2&&(result.p_freq_ramp=-result.p_freq_ramp),result.p_base_freq<.2&&result.p_freq_ramp<-.05&&(result.p_freq_ramp=-result.p_freq_ramp),result.p_freq_dramp=Math.pow(frnd(2)-1,3),result.p_duty=frnd(2)-1,result.p_duty_ramp=Math.pow(frnd(2)-1,3),result.p_vib_strength=Math.pow(frnd(2)-1,3),result.p_vib_speed=frnd(2)-1,result.p_env_attack=Math.pow(frnd(2)-1,3),result.p_env_sustain=Math.pow(frnd(2)-1,2),result.p_env_decay=frnd(2)-1,result.p_env_punch=Math.pow(frnd(.8),2),result.p_env_attack+result.p_env_sustain+result.p_env_decay<.2&&(result.p_env_sustain+=.2+frnd(.3),result.p_env_decay+=.2+frnd(.3)),result.p_lpf_resonance=frnd(2)-1,result.p_lpf_freq=1-Math.pow(frnd(1),3),result.p_lpf_ramp=Math.pow(frnd(2)-1,3),result.p_lpf_freq<.1&&result.p_lpf_ramp<-.05&&(result.p_lpf_ramp=-result.p_lpf_ramp),result.p_hpf_freq=Math.pow(frnd(1),5),result.p_hpf_ramp=Math.pow(frnd(2)-1,5),result.p_pha_offset=Math.pow(frnd(2)-1,3),result.p_pha_ramp=Math.pow(frnd(2)-1,3),result.p_repeat_speed=frnd(2)-1,result.p_arp_speed=frnd(2)-1,result.p_arp_mod=frnd(2)-1,result};var generators=[pickupCoin,laserShoot,explosion,powerUp,hitHurt,jump,blipSelect,pushSound,random,birdSound],generatorNames=["pickupCoin","laserShoot","explosion","powerUp","hitHurt","jump","blipSelect","pushSound","random","birdSound"];function SoundEffect(e,n){this._buffer=AUDIO_CONTEXT.createBuffer(1,e,n)}function ULBS(){if("suspended"===AUDIO_CONTEXT.state){var e=function(){AUDIO_CONTEXT.resume().then((function(){document.body.removeEventListener("touchstart",e),document.body.removeEventListener("touchend",e),document.body.removeEventListener("mousedown",e),document.body.removeEventListener("mouseup",e),document.body.removeEventListener("keydown",e),document.body.removeEventListener("keyup",e)}))};document.body.addEventListener("touchstart",e,!1),document.body.addEventListener("touchend",e,!1),document.body.addEventListener("mousedown",e,!1),document.body.addEventListener("mouseup",e,!1),document.body.addEventListener("keydown",e,!1),document.body.addEventListener("keyup",e,!1)}}if(generateFromSeed=function(e){const n=e.toString().split(":");rng=new RNG(n[0]/100|0);var t=n[0]%100,r=generators[t%generators.length];seeded=!0;var o=r();return o.seed=n[0],o.sound_vol=SOUND_VOL*(parseFloat(n[1])||10)/10,seeded=!1,o},SoundEffect.prototype.getBuffer=function(){return this._buffer.getChannelData(0)},SoundEffect.prototype.play=function(){ULBS();var e=AUDIO_CONTEXT.createBufferSource(),n=AUDIO_CONTEXT.createBiquadFilter(),t=AUDIO_CONTEXT.createBiquadFilter(),r=AUDIO_CONTEXT.createBiquadFilter();e.buffer=this._buffer,e.connect(n),n.frequency.value=1600,t.frequency.value=1600,r.frequency.value=1600,n.connect(t),t.connect(r),r.connect(AUDIO_CONTEXT.destination);var o=AUDIO_CONTEXT.currentTime;void 0!==e.start?e.start(o):e.noteOn(o),e.onended=function(){r.disconnect()}},SoundEffect.MIN_SAMPLE_RATE=22050,void 0===AUDIO_CONTEXT&&((SoundEffect=function(e,n){this._sample_rate=n,this._buffer=new Array(e),this._audioElement=null}).prototype.getBuffer=function(){return this._audioElement=null,this._buffer},SoundEffect.prototype.play=function(){if(this._audioElement)this._audioElement.cloneNode(!1).play();else{for(var e=0;e<this._buffer.length;e++)this._buffer[e]=255&Math.floor(128*Math.max(0,Math.min(this._buffer[e]+1,2)));var n=MakeRiff(this._sample_rate,BIT_DEPTH,this._buffer);this._audioElement=new Audio,this._audioElement.src=n.dataURI,this._audioElement.play()}},SoundEffect.MIN_SAMPLE_RATE=1),SoundEffect.generate=function(e){function n(){t=0,r=100/(e.p_base_freq*e.p_base_freq+.001),o=Math.floor(r),a=100/(e.p_freq_limit*e.p_freq_limit+.001),i=1-.01*Math.pow(e.p_freq_ramp,3),s=1e-6*-Math.pow(e.p_freq_dramp,3),l=.5-.5*e.p_duty,c=5e-5*-e.p_duty_ramp,u=e.p_arp_mod>=0?1-.9*Math.pow(e.p_arp_mod,2):1+10*Math.pow(e.p_arp_mod,2),0,d=Math.floor(2e4*Math.pow(1-e.p_arp_speed,2)+32),1==e.p_arp_speed&&(d=0)}var t,r,o,a,i,s,l,c,u,d;n();var h=0,g=0,m=.1*Math.pow(e.p_lpf_freq,3),f=1+1e-4*e.p_lpf_ramp,p=5/(1+20*Math.pow(e.p_lpf_resonance,2))*(.01+m);p>.8&&(p=.8);var v=0,_=.1*Math.pow(e.p_hpf_freq,2),b=1+3e-4*e.p_hpf_ramp,y=0,w=.01*Math.pow(e.p_vib_speed,2),S=.5*e.p_vib_strength,k=0,E=0,T=0,M=[Math.floor(e.p_env_attack*e.p_env_attack*1e5),Math.floor(e.p_env_sustain*e.p_env_sustain*1e5),Math.floor(e.p_env_decay*e.p_env_decay*1e5)],C=M[0]+M[1]+M[2],R=0,x=1020*Math.pow(e.p_pha_offset,2);e.p_pha_offset<0&&(x=-x);var L=1*Math.pow(e.p_pha_ramp,2);e.p_pha_ramp<0&&(L=-L);for(var I=Math.abs(Math.floor(x)),O=0,A=[],N=0;N<1024;++N)A[N]=0;var D=[];for(N=0;N<32;++N)D[N]=2*Math.random()-1;var P=Math.floor(2e4*Math.pow(1-e.p_repeat_speed,2)+32);0==e.p_repeat_speed&&(P=0);for(var j,B=Math.exp(e.sound_vol)-1,F=0,$=0,V=Math.floor(44100/e.sample_rate),z=0,q=Math.ceil(C/V),W=(j=e.sample_rate<SoundEffect.MIN_SAMPLE_RATE?new SoundEffect(4*q,SoundEffect.MIN_SAMPLE_RATE):new SoundEffect(q,e.sample_rate)).getBuffer(),G=0;;++G){0!=P&&++t>=P&&n(),0!=d&&G>=d&&(d=0,r*=u),(r*=i+=s)>a&&(r=a,e.p_freq_limit>0&&!0);var U=r;if(S>0&&(y+=w,U=r*(1+Math.sin(y)*S)),(o=Math.floor(U))<8&&(o=8),(l+=c)<0&&(l=0),l>.5&&(l=.5),++T>M[E]){for(T=1,E++;E<3&&0===M[E];)E++;if(3===E)break}k=0===E?T/M[0]:1===E?1+2*Math.pow(1-T/M[1],1)*e.p_env_punch:1-T/M[2],x+=L,(I=Math.abs(Math.floor(x)))>1023&&(I=1023),0!=b&&((_*=b)<1e-5&&(_=1e-5),_>.1&&(_=.1));for(var H=0,Y=0;Y<8;++Y){var J=0;if(++R>=o&&(R%=o,e.wave_type===NOISE))for(N=0;N<32;++N)D[N]=2*Math.random()-1;var X=R/o;if(e.wave_type===SQUARE)J=X<l?.5:-.5;else if(e.wave_type===SAWTOOTH)J=1-2*X;else if(e.wave_type===SINE)J=Math.sin(2*X*Math.PI);else if(e.wave_type===NOISE)J=D[Math.floor(32*R/o)];else if(e.wave_type===TRIANGLE)J=Math.abs(1-2*X)-1;else{if(e.wave_type!==BREAKER)throw new Exception("bad wave type! "+e.wave_type);J=Math.abs(1-X*X*2)-1}var K=h;(m*=f)<0&&(m=0),m>.1&&(m=.1),1!=e.p_lpf_freq?(g+=(J-h)*m,g-=g*p):(h=J,g=0),v+=(h+=g)-K,J=v-=v*_,A[1023&O]=J,J+=A[O-I+1024&1023],O=O+1&1023,H+=J*k}F+=H,++$>=V&&($=0,H=F/V,F=0,H=H/8*masterVolume,H*=B,W[z++]=H,e.sample_rate<SoundEffect.MIN_SAMPLE_RATE&&(W[z++]=H,W[z++]=H,W[z++]=H))}return V>0&&(H=(H=F/V)/8*masterVolume,H*=B,W[z++]=H,e.sample_rate<SoundEffect.MIN_SAMPLE_RATE&&(W[z++]=H,W[z++]=H,W[z++]=H)),j},"undefined"!=typeof exports){var RIFFWAVE=require("./riffwave").RIFFWAVE;exports.Params=Params,exports.generate=generate}var sfxCache={},cachedSeeds=[],CACHE_MAX=50;function cacheSeed(e){if(e in sfxCache)return sfxCache[e];var n=generateFromSeed(e);n.sample_rate=SAMPLE_RATE,n.bit_depth=BIT_DEPTH;var t=SoundEffect.generate(n);for(sfxCache[e]=t,cachedSeeds.push(e);cachedSeeds.length>CACHE_MAX;){var r=cachedSeeds[0];cachedSeeds=cachedSeeds.slice(1),delete sfxCache[r]}return t}function playSound(e,n){(!0!==n&&pushSoundToHistory(e),muted)||(checkAudioContextExists(),unitTesting||cacheSeed(e).play())}function killAudioButton(){var e=document.getElementById("muteButton"),n=document.getElementById("unMuteButton");e&&(e.remove(),n.remove())}function showAudioButton(){var e=document.getElementById("muteButton"),n=document.getElementById("unMuteButton");e&&(e.style.display="block",n.style.display="none")}function toggleMute(){0===muted?muteAudio():unMuteAudio()}function muteAudio(){muted=1;var e=document.getElementById("muteButton"),n=document.getElementById("unMuteButton");e&&(e.style.display="none",n.style.display="block")}function unMuteAudio(){muted=0;var e=document.getElementById("muteButton"),n=document.getElementById("unMuteButton");e&&(e.style.display="block",n.style.display="none")}function CodeMirror(e,n){}CodeMirror.defineMode=function(e,n){};var StringStream=CodeMirror.StringStream=function(e,n){this.pos=this.start=0,this.string=e,this.tabSize=n||8,this.lastColumnPos=this.lastColumnValue=0,this.lineStart=0};function createSprite(e,n,t,r){t||=[state.bgcolor,state.fgcolor];var o=makeSpriteCanvas(e),a=o.getContext("2d");return o.width=n.reduce(((e,n)=>Math.max(e,n.length)),0)*pixelSize,o.height=n.length*pixelSize,renderSprite(a,n,t,0,0,0,r),o}function createTextSprite(e,n,t,r){t||=[state.bgcolor,state.fgcolor];var o=makeSpriteCanvas(e);return drawTextWithFont(o.getContext("2d"),n,t,.5*cellwidth,.5*cellheight,r?r*cellheight:cellheight/n.length),o}function createCanvasSprite(e,n){const t=makeSpriteCanvas(e),r=t.getContext("2d");return n.w&&(t.width*=n.w),n.h&&(t.height*=n.h),r.scale(cellwidth,cellheight),function e(n){for(const t of n)try{for(const[n,o]of Object.entries(t))if("!include"===n){const n=state.objects[o.toLowerCase()];n?e(n.vector.data):logWarningNoLine("include object '"+o+"' not found")}else r[n]instanceof Function?r[n].apply(r,o):r[n]=o}catch(e){console.log(e),logErrorNoLine(`Oops! Looks like there's something wrong with this bit of JSON: "${JSON.stringify(t)}"`,!0),logErrorNoLine(`The system returned this error message: ${e}`,!0)}}(n.data),t}function createSvgSprite(e,n){const t=makeSpriteCanvas(e);n.w&&(t.width*=n.w),n.h&&(t.height*=n.h);const r=t.getContext("2d"),o=n.data.join("\n"),a=new Blob([o],{type:"image/svg+xml"}),i=URL.createObjectURL(a),s=document.createElement("img");return s.src=i,s.addEventListener("load",(function(){r.drawImage(s,0,0),URL.revokeObjectURL(i),redraw()}),!1),t}function renderSprite(e,n,t,r,o,a,i){t||=["#00000000",state.fgcolor];const s={x:o*cellwidth,y:a*cellheight,w:i||n[0].length,h:i||n.length};e.clearRect(s.x,s.y,s.w,s.h);const l="scanline"in state.metadata?pixelSize/2:pixelSize;e.fillStyle=state.fgcolor,n.forEach(((n,r)=>{n.forEach(((n,o)=>{n>=0&&(e.fillStyle=t[n],e.fillRect(s.x+o*pixelSize,s.y+r*pixelSize,pixelSize,l))}))}))}function drawTextWithFont(e,n,t,r,o,a){const i=a*(state.metadata.font_size?Math.max(0,parseFloat(state.metadata.font_size)):1),s=state.metadata.custom_font&&loadedCustomFont?"PuzzleCustomFont":"Monospace";e.font=`${i}px ${s}`,e.fillStyle=t,e.textBaseline="middle",e.textAlign="center",e.fillText(n,r,o)}StringStream.prototype={eol:function(){return this.pos>=this.string.length},sol:function(){return this.pos==this.lineStart},peek:function(){return this.string.charAt(this.pos)||void 0},next:function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},eat:function(e){var n=this.string.charAt(this.pos);if("string"==typeof e)var t=n==e;else t=n&&(e.test?e.test(n):e(n));if(t)return++this.pos,n},eatWhile:function(e){for(var n=this.pos;this.eat(e););return this.pos>n},eatSpace:function(){for(var e=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>e},skipToEnd:function(){this.pos=this.string.length},skipTo:function(e){var n=this.string.indexOf(e,this.pos);if(n>-1)return this.pos=n,!0},backUp:function(e){this.pos-=e},column:function(){return this.lastColumnPos<this.start&&(this.lastColumnValue=countColumn(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start),this.lastColumnValue-(this.lineStart?countColumn(this.string,this.lineStart,this.tabSize):0)},indentation:function(){return countColumn(this.string,null,this.tabSize)-(this.lineStart?countColumn(this.string,this.lineStart,this.tabSize):0)},match:function(e,n,t){if("string"!=typeof e){var r=this.string.slice(this.pos).match(e);return r&&r.index>0?null:(r&&!1!==n&&(this.pos+=r[0].length),r)}var o=function(e){return t?e.toLowerCase():e};if(o(this.string.substr(this.pos,e.length))==o(e))return!1!==n&&(this.pos+=e.length),!0},current:function(){return this.string.slice(this.start,this.pos)},hideFirstChars:function(e,n){this.lineStart+=e;try{return n()}finally{this.lineStart-=e}}},colorPalettesAliases={1:"mastersystem",2:"gameboycolour",3:"amiga",4:"arnecolors",5:"famicom",6:"atari",7:"pastel",8:"ega",9:"amstrad",10:"proteus_mellow",11:"proteus_rich",12:"proteus_night",13:"c64",14:"whitingjp"},colorPalettes={mastersystem:{black:"#000000",white:"#FFFFFF",grey:"#555555",darkgrey:"#555500",lightgrey:"#AAAAAA",gray:"#555555",darkgray:"#555500",lightgray:"#AAAAAA",red:"#FF0000",darkred:"#AA0000",lightred:"#FF5555",brown:"#AA5500",darkbrown:"#550000",lightbrown:"#FFAA00",orange:"#FF5500",yellow:"#FFFF55",green:"#55AA00",darkgreen:"#005500",lightgreen:"#AAFF00",blue:"#5555AA",lightblue:"#AAFFFF",darkblue:"#000055",purple:"#550055",pink:"#FFAAFF"},gameboycolour:{black:"#000000",white:"#FFFFFF",grey:"#7F7F7C",darkgrey:"#3E3E44",lightgrey:"#BAA7A7",gray:"#7F7F7C",darkgray:"#3E3E44",lightgray:"#BAA7A7",red:"#A7120C",darkred:"#880606",lightred:"#BA381F",brown:"#57381F",darkbrown:"#3E2519",lightbrown:"#8E634B",orange:"#BA4B32",yellow:"#C0BA6F",green:"#517525",darkgreen:"#385D12",lightgreen:"#6F8E44",blue:"#5D6FA7",lightblue:"#8EA7A7",darkblue:"#4B575D",purple:"#3E3E44",pink:"#BA381F"},amiga:{black:"#000000",white:"#FFFFFF",grey:"#BBBBBB",darkgrey:"#333333",lightgrey:"#FFEEDD",gray:"#BBBBBB",darkgray:"#333333",lightgray:"#FFEEDD",red:"#DD1111",darkred:"#990000",lightred:"#FF4422",brown:"#663311",darkbrown:"#331100",lightbrown:"#AA6644",orange:"#FF6644",yellow:"#FFDD66",green:"#448811",darkgreen:"#335500",lightgreen:"#88BB77",blue:"#8899DD",lightblue:"#BBDDEE",darkblue:"#666688",purple:"#665555",pink:"#997788"},arnecolors:{black:"#000000",white:"#FFFFFF",grey:"#9d9d9d",darkgrey:"#697175",lightgrey:"#cccccc",gray:"#9d9d9d",darkgray:"#697175",lightgray:"#cccccc",red:"#be2633",darkred:"#732930",lightred:"#e06f8b",brown:"#a46422",darkbrown:"#493c2b",lightbrown:"#eeb62f",orange:"#eb8931",yellow:"#f7e26b",green:"#44891a",darkgreen:"#2f484e",lightgreen:"#a3ce27",blue:"#1d57f7",lightblue:"#B2DCEF",darkblue:"#1B2632",purple:"#342a97",pink:"#de65e2"},famicom:{black:"#000000",white:"#ffffff",grey:"#7c7c7c",darkgrey:"#080808",lightgrey:"#bcbcbc",gray:"#7c7c7c",darkgray:"#080808",lightgray:"#bcbcbc",red:"#f83800",darkred:"#881400",lightred:"#f87858",brown:"#AC7C00",darkbrown:"#503000",lightbrown:"#FCE0A8",orange:"#FCA044",yellow:"#F8B800",green:"#00B800",darkgreen:"#005800",lightgreen:"#B8F8B8",blue:"#0058F8",lightblue:"#3CBCFC",darkblue:"#0000BC",purple:"#6644FC",pink:"#F878F8"},atari:{black:"#000000",white:"#FFFFFF",grey:"#909090",darkgrey:"#404040",lightgrey:"#b0b0b0",gray:"#909090",darkgray:"#404040",lightgray:"#b0b0b0",red:"#A03C50",darkred:"#700014",lightred:"#DC849C",brown:"#805020",darkbrown:"#703400",lightbrown:"#CB9870",orange:"#CCAC70",yellow:"#ECD09C",green:"#58B06C",darkgreen:"#006414",lightgreen:"#70C484",blue:"#1C3C88",lightblue:"#6888C8",darkblue:"#000088",purple:"#3C0080",pink:"#B484DC"},pastel:{black:"#000000",white:"#FFFFFF",grey:"#3e3e3e",darkgrey:"#313131",lightgrey:"#9cbcbc",gray:"#3e3e3e",darkgray:"#313131",lightgray:"#9cbcbc",red:"#f56ca2",darkred:"#a63577",lightred:"#ffa9cf",brown:"#b58c53",darkbrown:"#787562",lightbrown:"#B58C53",orange:"#EB792D",yellow:"#FFe15F",green:"#00FF4F",darkgreen:"#2b732c",lightgreen:"#97c04f",blue:"#0f88d3",lightblue:"#00fffe",darkblue:"#293a7b",purple:"#ff6554",pink:"#eb792d"},ega:{black:"#000000",white:"#ffffff",grey:"#555555",darkgrey:"#555555",lightgrey:"#aaaaaa",gray:"#555555",darkgray:"#555555",lightgray:"#aaaaaa",red:"#ff5555",darkred:"#aa0000",lightred:"#ff55ff",brown:"#aa5500",darkbrown:"#aa5500",lightbrown:"#ffff55",orange:"#ff5555",yellow:"#ffff55",green:"#00aa00",darkgreen:"#00aaaa",lightgreen:"#55ff55",blue:"#5555ff",lightblue:"#55ffff",darkblue:"#0000aa",purple:"#aa00aa",pink:"#ff55ff"},proteus_mellow:{black:"#3d2d2e",white:"#ddf1fc",grey:"#9fb2d4",darkgrey:"#7b8272",lightgrey:"#a4bfda",gray:"#9fb2d4",darkgray:"#7b8272",lightgray:"#a4bfda",red:"#9d5443",darkred:"#8c5b4a",lightred:"#94614c",brown:"#89a78d",darkbrown:"#829e88",lightbrown:"#aaae97",orange:"#d1ba86",yellow:"#d6cda2",green:"#75ac8d",darkgreen:"#8fa67f",lightgreen:"#8eb682",blue:"#88a3ce",lightblue:"#a5adb0",darkblue:"#5c6b8c",purple:"#d39fac",pink:"#c8ac9e"},proteus_night:{black:"#010912",white:"#fdeeec",grey:"#051d40",darkgrey:"#091842",lightgrey:"#062151",gray:"#051d40",darkgray:"#091842",lightgray:"#062151",red:"#ad4576",darkred:"#934765",lightred:"#ab6290",brown:"#61646b",darkbrown:"#3d2d2d",lightbrown:"#8393a0",orange:"#0a2227",yellow:"#0a2541",green:"#75ac8d",darkgreen:"#0a2434",lightgreen:"#061f2e",blue:"#0b2c79",lightblue:"#809ccb",darkblue:"#08153b",purple:"#666a87",pink:"#754b4d"},proteus_rich:{black:"#6f686f",white:"#d1b1e2",grey:"#b9aac1",darkgrey:"#8e8b84",lightgrey:"#c7b5cd",gray:"#b9aac1",darkgray:"#8e8b84",lightgray:"#c7b5cd",red:"#a11f4f",darkred:"#934765",lightred:"#c998ad",brown:"#89867d",darkbrown:"#797f75",lightbrown:"#ab9997",orange:"#ce8c5c",yellow:"#f0d959",green:"#75bc54",darkgreen:"#599d79",lightgreen:"#90cf5c",blue:"#8fd0ec",lightblue:"#bcdce7",darkblue:"#0b2c70",purple:"#9b377f",pink:"#cd88e5"},amstrad:{black:"#000000",white:"#ffffff",grey:"#7f7f7f",darkgrey:"#636363",lightgrey:"#afafaf",gray:"#7f7f7f",darkgray:"#636363",lightgray:"#afafaf",red:"#ff0000",darkred:"#7f0000",lightred:"#ff7f7f",brown:"#ff7f00",darkbrown:"#7f7f00",lightbrown:"#ffff00",orange:"#ff007f",yellow:"#ffff7f",green:"#01ff00",darkgreen:"#007f00",lightgreen:"#7fff7f",blue:"#0000ff",lightblue:"#7f7fff",darkblue:"#00007f",purple:"#7f007f",pink:"#ff7fff"},c64:{black:"#000000",white:"#ffffff",grey:"#6C6C6C",darkgrey:"#444444",lightgrey:"#959595",gray:"#6C6C6C",darkgray:"#444444",lightgray:"#959595",red:"#68372B",darkred:"#3f1e17",lightred:"#9A6759",brown:"#433900",darkbrown:"#221c02",lightbrown:"#6d5c0d",orange:"#6F4F25",yellow:"#B8C76F",green:"#588D43",darkgreen:"#345129",lightgreen:"#9AD284",blue:"#6C5EB5",lightblue:"#70A4B2",darkblue:"#352879",purple:"#6F3D86",pink:"#b044ac"},whitingjp:{black:"#202527",white:"#eff8fd",grey:"#7b7680",darkgrey:"#3c3b44",lightgrey:"#bed0d7",gray:"#7b7680",darkgray:"#3c3b44",lightgray:"#bed0d7",red:"#bd194b",darkred:"#6b1334",lightred:"#ef2358",brown:"#b52e1c",darkbrown:"#681c12",lightbrown:"#e87b45",orange:"#ff8c10",yellow:"#fbd524",green:"#36bc3c",darkgreen:"#317610",lightgreen:"#8ce062",blue:"#3f62c6",lightblue:"#57bbe0",darkblue:"#2c2fa0",purple:"#7037d9",pink:"#ec2b8f"}};var textsheetCanvas=null;function regenText(){textsheetCanvas||=document.createElement("canvas");var e=Math.ceil(Math.sqrt(fontKeys.length));textsheetCanvas.width=e*cellwidth,textsheetCanvas.height=e*cellheight*2;for(var n=textsheetCanvas.getContext("2d"),t=0;t<fontKeys.length;t++){var r=fontKeys[t];if(font.hasOwnProperty(r)){fontstr=font[r].split("\n").map((e=>e.trim().split("").map((e=>parseInt(e))))),fontstr.shift();var o=t%e|0,a=t/e|0;renderSprite(n,fontstr,void 0,1,o,a),renderSprite(n,fontstr,["#00000000","#000000"],1,o,a+e)}}}var spriteImages,glyphImagesCorrespondance,glyphImages,glyphHighlight,glyphHighlightDiff,glyphHighlightResize,glyphPrintButton,glyphMouseOver,editor_s_grille=[[0,1,1,1,0],[1,0,0,0,0],[0,1,1,1,0],[0,0,0,0,1],[0,1,1,1,0]];function createVectorSprite(e,n){return"canvas"===n.type?createCanvasSprite(e,n):"svg"===n.type?createSvgSprite(e,n):null}function regenSpriteImages(){if(textMode)return spriteImages=[],void regenText();!0===IDE&&(textImages.editor_s=createSprite("chars",editor_s_grille,void 0,5)),0!==state.levels.length&&(spriteImages=[],objectSprites.forEach(((e,n)=>{e&&(spriteImages[n]=e.text?createTextSprite("t"+n.toString(),e.text,e.colors,e.scale):e.vector?createVectorSprite("v"+n.toString(),e.vector):createSprite(n.toString(),e.dat,e.colors,state.sprite_size))})),canOpenEditor&&generateGlyphImages())}var canvas,ctx,x,y,cellwidth,cellheight,xoffset,yoffset,glyphSelectedIndex=0,editorRowCount=1,editorGlyphMovements=[],canvasdict={};function makeSpriteCanvas(e){var n;return e in canvasdict?n=canvasdict[e]:(n=document.createElement("canvas"),canvasdict[e]=n),n.width=cellwidth,n.height=cellheight,n}function generateGlyphImages(){if(0!==cellwidth&&0!==cellheight){for(var e of(glyphImagesCorrespondance=[],glyphImages=[],seenobjects={},state.glyphOrder))if(1==e.length&&state.glyphDict.hasOwnProperty(e)){var n=state.glyphDict[e],t=n.join(",");if(seenobjects.hasOwnProperty(t))continue;var r=makeSpriteCanvas("C"+e),o=r.getContext("2d");glyphImagesCorrespondance.push(e),seenobjects[t]=!0;for(var a=0;a<n.length;a++){var i=n[a];-1!==i&&o.drawImage(spriteImages[i],0,0)}glyphImages.push(r)}if(IDE){(o=(glyphHighlight=makeSpriteCanvas("highlight")).getContext("2d")).fillStyle="#FFFFFF";const e=3;o.fillRect(0,0,cellwidth,e),o.fillRect(0,0,e,cellheight),o.fillRect(0,cellheight-e,cellwidth,e),o.fillRect(cellwidth-e,0,e,cellheight),glyphPrintButton=textImages.editor_s,(o=(glyphHighlightDiff=makeSpriteCanvas("glyphHighlightDiff")).getContext("2d")).fillStyle=state.bgcolor,o.fillRect(0,0,cellwidth,2),o.fillRect(0,0,2,cellheight),o.fillRect(0,cellheight-2,cellwidth,2),o.fillRect(cellwidth-2,0,2,cellheight),o.fillStyle=state.fgcolor,o.fillRect(0,0,cellwidth,1),o.fillRect(0,0,1,cellheight),o.fillRect(0,cellheight-1,cellwidth,1),o.fillRect(cellwidth-1,0,1,cellheight),glyphPrintButton=textImages.editor_s,(o=(glyphHighlightResize=makeSpriteCanvas("highlightresize")).getContext("2d")).fillStyle="#FFFFFF";const n=3,t=~~(cellwidth/2-1),r=~~(cellheight/2-1);o.fillRect(t,0,n,cellheight),o.fillRect(0,r,cellwidth,n),(o=(glyphMouseOver=makeSpriteCanvas("glyphMouseOver")).getContext("2d")).fillStyle="yellow";const i=3;o.fillRect(0,0,cellwidth,i),o.fillRect(0,0,i,cellheight),o.fillRect(0,cellheight-i,cellwidth,i),o.fillRect(cellwidth-i,0,i,cellheight);const c=[[[3,2],[5,0],[7,2]],[[3,8],[5,10],[7,8]],[[2,3],[0,5],[2,7]],[[7,3],[10,5],[7,7]],[[3,5],[5,7],[7,5],[5,3]],[[3,3],[5,3],[5,4],[4,4],[4,5],[3,5]],[[4,4],[1,4],[1,7]],[[6,4],[9,4],[9,7]]];for(a=0;a<c.length;a++){editorGlyphMovements[a]=makeSpriteCanvas("editorGlyphMovements"+a);var s=c[a];(o=editorGlyphMovements[a].getContext("2d")).lineWidth=1,o.fillStyle=state.bgcolor,o.strokeStyle=state.fgcolor,o.beginPath(),o.moveTo(s[0][0]*cellwidth/10,s[0][1]*cellheight/10);for(var l=1;l<s.length;l++)o.lineTo(s[l][0]*cellwidth/10,s[l][1]*cellheight/10);o.closePath(),o.fill(),o.stroke()}}}}let pixelSize;function glyphCount(){return state.glyphOrder.filter((e=>1==e.length)).length}function redraw(){0!==cellwidth&&0!==cellheight&&(debugSwitch.includes("perf")&&console.log(`Redraw: ${JSON.stringify(perfCounters)}`),textMode?redrawTextMode():redrawCellGrid(curLevel))}window.addEventListener("resize",(e=>canvasResize()),!1),canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d"),x=0,y=0;const textModeLine=!0;function redrawTextMode(){const e=e=>lineColorOverride[e]||state.fgcolor;if(ctx.fillStyle=state.bgcolor,ctx.fillRect(0,0,canvas.width,canvas.height),void 0!==state.metadata.custom_font&&loadedCustomFont)if(textModeLine)for(let n=0;n<TITLE_HEIGHT;n++)drawTextWithFont(ctx,titleImage[n],e(n),xoffset+(TITLE_WIDTH/2+.5)*cellwidth,yoffset+(n+.5)*cellheight,cellheight);else for(n=0;n<TITLE_WIDTH;n++)for(let t=0;t<TITLE_HEIGHT;t++)drawTextWithFont(ctx,titleImage[t].slice(n,n+1),e(t),xoffset+(n+.5)*cellwidth,yoffset+(t+.5)*cellheight,cellheight);else{const s=Math.ceil(Math.sqrt(fontKeys.length));for(var n=0;n<TITLE_WIDTH;n++)for(var t=0;t<TITLE_HEIGHT;t++){ctx.fillStyle=e(t);var r=titleImage[t].charAt(n);if(r in font){var o=fontIndex[r],a=o%s|0,i=o/s|0;ctx.imageSmoothingEnabled=!1,ctx.drawImage(textsheetCanvas,a*textcellwidth,i*textcellheight,textcellwidth,textcellheight,xoffset+n*cellwidth,yoffset+t*cellheight,cellwidth,cellheight),ctx.imageSmoothingEnabled=!0}}}}function redrawCellGrid(e){null!==diffToVisualize&&((e=new Level(-1,diffToVisualize.width,diffToVisualize.height,diffToVisualize.layerCount,diffToVisualize.objects)).movements=diffToVisualize.movements,e.rigidMovementAppliedMask=diffToVisualize.rigidMovementAppliedMask),ctx.fillStyle=state.bgcolor,ctx.fillRect(0,0,canvas.width,canvas.height);let n=[0,0,screenwidth,screenheight];var r={x:0,y:0};if(levelEditorOpened){const e=glyphCount();editorRowCount=Math.ceil(e/(screenwidth-1)),n[2]-=2,n[3]-=2+editorRowCount}else if(flickscreen){if((o=getPlayerPositions()).length>0){const t=o[0],r=t/e.height|0,a=t%e.height|0,i=(r/screenwidth|0)*screenwidth,s=(a/screenheight|0)*screenheight;n=[i,s,Math.min(i+screenwidth,e.width),Math.min(s+screenheight,e.height)],oldflickscreendat=n}else oldflickscreendat.length>0&&(n=oldflickscreendat)}else if(zoomscreen){var o;if((o=getPlayerPositions()).length>0){const t=o[0],r=t/e.height|0,a=t%e.height|0,i=Math.max(Math.min(r-(screenwidth/2|0),e.width-screenwidth),0),s=Math.max(Math.min(a-(screenheight/2|0),e.height-screenheight),0);n=[i,s,Math.min(i+screenwidth,e.width),Math.min(s+screenheight,e.height)],oldflickscreendat=n}else oldflickscreendat.length>0&&(n=oldflickscreendat)}else if(smoothscreen)if(null!==cameraPositionTarget){["x","y"].forEach((function(e){var n=cameraPositionTarget[e]-cameraPosition[e];0!==n&&(Math.abs(n)<.5/cellwidth?cameraPosition[e]=cameraPositionTarget[e]:(cameraPosition[e]+=n*state.metadata.smoothscreen.cameraSpeed,r[e]=cameraPosition[e]%1))}));const t=Math.max(Math.min(Math.floor(cameraPosition.x)-Math.floor(screenwidth/2),e.width-screenwidth),0),o=Math.max(Math.min(Math.floor(cameraPosition.y)-Math.floor(screenheight/2),e.height-screenheight),0);n=[t,o,Math.min(t+screenwidth,e.width),Math.min(o+screenheight,e.height)],oldflickscreendat=n}else oldflickscreendat.length>0&&(n=oldflickscreendat);debugSwitch.includes("redraw")&&console.log(`redrawCell canvas=${canvas.width},${canvas.height} screen=${screenwidth},${screenheight}`,n),screenOffsetX=n[0],screenOffsetY=n[1];var a=smoothscreen?1:0;var i=state.metadata.tween_length&&currentMovedEntities;isAnimating=state.metadata.smoothscreen||i||Object.keys(seedsToAnimate).length>0;const s=new class{constructor(n){this.minMax=n,this.iter=[Math.max(this.minMax[0]-a,0),Math.max(this.minMax[1]-a,0),Math.min(this.minMax[2]+a,e.width),Math.min(this.minMax[3]+a,e.height)]}getIter(){return this.iter}getPosIndexes(n){const t=e.height,r={downright:e=>[e[0],e[2],1,t,e[1],e[3],1,1],downleft:e=>[e[2]-1,e[0]-1,-1,t,e[1],e[3],1,1],upright:e=>[e[0],e[2],1,t,e[3]-1,e[1]-1,-1,1],upleft:e=>[e[2]-1,e[0]-1,-1,t,e[3]-1,e[1]-1,-1,1],rightdown:e=>[e[1],e[3],1,1,e[0],e[2],1,t],leftdown:e=>[e[3]-1,e[1]-1,-1,1,e[0],e[2],1,t],rightup:e=>[e[1],e[3],1,1,e[2]-1,e[0]-1,-1,t],leftup:e=>[e[3]-1,e[1]-1,-1,1,e[2]-1,e[0]-1,-1,t]};return function(e,n,t,r,o,a,i,s){const l=[];for(let c=e;c!=n;c+=t)for(let e=o;e!=a;e+=i)l.push(c*r+e*s);return l}(...r[n.dirFirst+n.dirSecond](this.iter))}getDrawPos(n,t){const o=~~(n/e.height),a=n%e.height,i=t.spriteoffset.x,s=t.spriteoffset.y+(t.vector?state.sprite_size*(1-t.vector.h):state.sprite_size-t.spritematrix.length);return{x:xoffset+(o-this.minMax[0]-r.x)*cellwidth+i*~~(cellwidth/state.sprite_size),y:yoffset+(a-this.minMax[1]-r.y)*cellheight+s*~~(cellheight/state.sprite_size)}}}(n);function l(e,n,r,o,a){const i={move:{slide:[-1,0],zoom:[0,1],turn:[0,.25],fade:[0,1]},cant:{slide:[0,.2,0],zoom:[1,1.2,1],turn:[0,.1,0],fade:[1,.5,1]},hit:{slide:[0,.2,0],zoom:[1,1.2,1],turn:[0,-.1,.1,0],fade:[1,.5,1]},create:{slide:[1,0],zoom:[0,1],turn:[-.125,0],fade:[0,1]},destroy:{slide:[0,1],zoom:[1,0],turn:[0,.125],fade:[1,0]}},s={slide:(e,n)=>{const t=[1,2,4,8].includes(r)?dirMasksDelta[r]:[0,-1];e.x=n*t[0],e.y=n*t[1]},zoom:(e,n)=>{e.scalex=e.scaley=n,e.x=e.y=.5-e.scalex/2},fade:(e,n)=>{e.alpha=n},turn:(e,n)=>{e.angle=360*n}},l={ease:(e,n,t)=>{a=easingFunction(n)(a)},tween:(e,n,t)=>{a=n}};for(x of e){const e=x.split("=");if(s[e[0]]){"move"!=n||[1,2,4,8].includes(r)||(n="hit");const t=e[1]?e[1].split(",").map((e=>parseFloat(e)||0)):i[n][e[0]],l=(1-a)*(t.length-1),c=~~l,u=l-c,d=t[c]+(t[c+1]-t[c])*u;s[e[0]](o,d)}else l[e[0]]&&l[e[0]](o,e[1],t)}return o}levelEditorOpened||showLayers||setClip(s),i?function(t){const o=state.metadata.tween_easing||"linear",a=state.metadata.tween_snap||state.sprite_size;let i=EasingFunctions[o](1-clamp(tweentimer/tweeninterval,0,1));i=Math.floor(i*a)/a;for(var s=0;s<state.idDict.length;s++)for(var l=state.objects[state.idDict[s]].layer,c=t[0];c<t[2];c++)for(var u=t[1];u<t[3];u++){var d=u+c*e.height;if(0!=e.getCellInto(d,_o12).get(s)){var h=xoffset+(c-n[0]-r.x)*cellwidth,g=yoffset+(u-n[1]-r.y)*cellheight;if(currentMovedEntities&&currentMovedEntities["p"+d+"-l"+l]){var m=currentMovedEntities["p"+d+"-l"+l];if(16!=m){var f=dirMasksDelta[m];h-=cellwidth*f[0]*i,g-=cellheight*f[1]*i}else 16==m&&(ctx.globalAlpha=1-i)}ctx.drawImage(spriteImages[s],0,0,cellwidth,cellheight,Math.floor(h),Math.floor(g),cellwidth,cellheight),ctx.globalAlpha=1}}}(s.getIter()):function(n){showLayerNo=Math.max(0,Math.min(e.layerCount-1,showLayerNo));const t=1-clamp(tweentimer/animateinterval,0,1);0==t&&(seedsToAnimate={});state.metadata.sprite_size&&state.sprite_size;for(const r of state.collisionLayerGroups)for(const o of n.getPosIndexes(r)){const a=e.getCellInto(o,_o12);for(let e=r.firstObjectNo;e<r.firstObjectNo+r.numObjects;++e){const r=isAnimating?seedsToAnimate[o+","+e]:null;if(a.get(e)||r){const a=state.objects[state.idDict[e]];if(showLayers&&a.layer!=showLayerNo)continue;let i=1;const s=n.getDrawPos(o,a),c=a.vector;let u={x:0,y:0,scalex:1,scaley:1,alpha:1,angle:c?c.angle:0};r&&(u=l(r.seed.split(":").slice(1),r.kind,r.dir,u,t));const d=c?{w:(c.w||1)*cellwidth,h:(c.h||1)*cellheight}:{w:a.spritematrix.reduce(((e,n)=>Math.max(e,n.length)),0)*pixelSize,h:a.spritematrix.length*pixelSize},h={x:Math.floor(s.x+u.x*cellwidth),y:Math.floor(s.y+u.y*cellheight),w:u.scalex*d.w*i,h:u.scaley*d.h*i};if(ctx.globalAlpha=u.alpha,c){const n=c&&c.flipx?-h.w:h.w,t=c&&c.flipy?-h.h:h.h;ctx.translate(h.x+h.w/2,h.y+h.h/2),ctx.rotate(u.angle*Math.PI/180),ctx.scale(c.flipx?-1:1,c.flipy?-1:1),ctx.drawImage(spriteImages[e],0,0,d.w,d.h,-n/2,-t/2,n,t)}else 0!=u.angle?(ctx.translate(h.x+h.w/2,h.y+h.h/2),ctx.rotate(u.angle*Math.PI/180),ctx.drawImage(spriteImages[e],0,0,d.w,d.h,-h.w/2,-h.h/2,h.w,h.h)):ctx.drawImage(spriteImages[e],0,0,d.w,d.h,h.x,h.y,h.w,h.h);ctx.globalAlpha=1,ctx.setTransform(1,0,0,1,0,0)}}}}(s),showLayers&&(ctx.fillStyle=state.fgcolor,ctx.font='24px "Source Sans Pro", Helvetica, Arial, sans-serif',ctx.fillText(`Layer ${showLayerNo}`,0,2*yoffset)),state.metadata.status_line&&drawTextWithFont(ctx,statusText,state.fgcolor,xoffset+screenwidth*cellwidth/2,yoffset+screenheight*cellheight+.6*textcellheight,.6*textcellheight),diffToVisualize&&function(){for(var t=diffToVisualize.lineNumber-1;t>=-1&&!debug_visualisation_array[diffToVisualize.turnIndex].hasOwnProperty(t);t--);var r=debug_visualisation_array[diffToVisualize.turnIndex][t],o=new Level(-1,r.width,r.height,r.layerCount,r.objects);o.movements=r.movements,o.rigidMovementAppliedMask=r.rigidMovementAppliedMask;for(var a=n[0];a<n[2];a++)for(var i=n[1];i<n[3];i++){var s=i+a*e.height,l=o.getMovements(s),c=e.getMovements(s),u=o.getCellInto(s,_o11),d=e.getCellInto(s,_o12);c.equals(l)&&d.equals(u)||ctx.drawImage(glyphHighlightDiff,xoffset+(a-n[0])*cellwidth,yoffset+(i-n[1])*cellheight)}for(a=n[0];a<n[2];a++)for(i=n[1];i<n[3];i++){s=i+a*e.height,c=e.getMovements(s);for(var h=0;h<e.layerCount;h++){var g=c.getshiftor(MOV_MASK,MOV_BITS*h);const e=[1,2,4,8,16,-1,19,20].indexOf(g);e>=0&&ctx.drawImage(editorGlyphMovements[e],xoffset+(a-n[0])*cellwidth,yoffset+(i-n[1])*cellheight)}}for(a=n[0];a<n[2];a++)for(i=n[1];i<n[3];i++){s=i+a*e.height;var m=e.getRigids(s);for(h=0;h<e.layerCount;h++){0!==m.getshiftor(MOV_MASK,MOV_BITS*h)&&ctx.drawImage(editorGlyphMovements[5],xoffset+(a-n[0])*cellwidth,yoffset+(i-n[1])*cellheight)}}}(),smoothscreen&&(state.metadata.smoothscreen.debug&&drawSmoothScreenDebug(ctx),ctx.restore()),levelEditorOpened&&drawEditorIcons(n[0],n[1])}function drawSmoothScreenDebug(e){e.save();var n=state.metadata.smoothscreen.boundarySize,t=getPlayerPositions();if(t.length>0){var r={x:t[0]/curLevel.height|0,y:t[0]%curLevel.height|0},o=r.x-cameraPosition.x,a=r.y-cameraPosition.y;e.fillStyle="#00ff00",e.beginPath(),e.arc(xoffset+(Math.floor(screenwidth/2)+o+.5)*cellwidth,yoffset+(Math.floor(screenheight/2)+a+.5)*cellheight,cellwidth/4,0,2*Math.PI),e.fill()}var i=cameraPositionTarget.x-cameraPosition.x,s=cameraPositionTarget.y-cameraPosition.y;e.fillStyle="#0000ff",e.beginPath(),e.arc(xoffset+(Math.floor(screenwidth/2)+i)*cellwidth,yoffset+(Math.floor(screenheight/2)+s)*cellheight,cellwidth/8,0,2*Math.PI),e.fill(),e.strokeStyle="#0000ff",e.lineWidth=cellwidth/16,e.strokeRect(xoffset+(Math.floor(screenwidth/2)+i-Math.floor(n.width/2))*cellwidth,yoffset+(Math.floor(screenheight/2)+s-Math.floor(n.height/2))*cellheight,n.width*cellwidth,n.height*cellheight),e.fillStyle="#ff0000",e.beginPath(),e.arc(xoffset+Math.floor(screenwidth/2)*cellwidth,yoffset+Math.floor(screenheight/2)*cellheight,cellwidth/4,0,2*Math.PI),e.fill(),e.strokeStyle="#ff0000",e.lineWidth=cellwidth/8,e.strokeRect(xoffset+(Math.floor(screenwidth/2)-Math.floor(n.width/2))*cellwidth,yoffset+(Math.floor(screenheight/2)-Math.floor(n.height/2))*cellheight,n.width*cellwidth,n.height*cellheight),e.restore()}function setClip(e){const n={x:xoffset,y:yoffset,w:(e.iter[2]-e.iter[0])*cellwidth,h:(e.iter[3]-e.iter[1])*cellheight+statusLineHeight};ctx.save(),ctx.beginPath(),ctx.moveTo(n.x,n.y),ctx.lineTo(n.x+n.w,n.y),ctx.lineTo(n.x+n.w,n.y+n.h),ctx.lineTo(n.x,n.y+n.h),ctx.clip()}function drawEditorIcons(e,n){glyphImages.length;var t=glyphImages.length-0;ctx.drawImage(glyphPrintButton,xoffset-cellwidth,yoffset-cellheight*(1+editorRowCount)),mouseCoordY===-1-editorRowCount&&-1===mouseCoordX&&ctx.drawImage(glyphMouseOver,xoffset-cellwidth,yoffset-cellheight*(1+editorRowCount));for(var r=mouseCoordX+(screenwidth-1)*(s=editorRowCount-(-mouseCoordY-2)-1),o=0;o<t;o++){var a=glyphImages[0+o],i=o%(screenwidth-1),s=o/(screenwidth-1)|0;ctx.drawImage(a,xoffset+i*cellwidth,yoffset+s*cellheight-cellheight*(1+editorRowCount)),mouseCoordX>=0&&mouseCoordX<screenwidth-1&&r===o&&ctx.drawImage(glyphMouseOver,xoffset+i*cellwidth,yoffset+s*cellheight-cellheight*(1+editorRowCount)),o===glyphSelectedIndex&&ctx.drawImage(glyphHighlight,xoffset+i*cellwidth,yoffset+s*cellheight-cellheight*(1+editorRowCount))}var l="",c=null;if(mouseCoordX>=0&&mouseCoordX<screenwidth&&r>=0&&r<t){const e=glyphImagesCorrespondance[0+r];l=e,e in state.synonymsDict?l+=" = "+state.synonymsDict[e]:e in state.aggregatesDict&&(l+=" = "+state.aggregatesDict[e].join(" and "))}else if(mouseCoordX>=0&&mouseCoordY>=0&&mouseCoordX<screenwidth&&mouseCoordY<screenheight-editorRowCount-2){const t=curLevel.getCellInto(mouseCoordY+n+(mouseCoordX+e)*curLevel.height,_o12);null!==(c=state.idDict.filter(((e,n)=>0!=t.get(n))))&&(l=c.join(", "))}l.length>0&&(ctx.fillStyle=state.fgcolor,ctx.font='16px "Source Sans Pro", Helvetica, Arial, sans-serif',ctx.fillText(l,xoffset,yoffset-.4*cellheight)),mouseCoordX>=-1&&mouseCoordY>=-1&&mouseCoordX<screenwidth-1&&mouseCoordY<screenheight-1-editorRowCount&&(-1==mouseCoordX||-1==mouseCoordY||mouseCoordX==screenwidth-2||mouseCoordY===screenheight-2-editorRowCount?ctx.drawImage(glyphHighlightResize,xoffset+mouseCoordX*cellwidth,yoffset+mouseCoordY*cellheight):ctx.drawImage(glyphHighlight,xoffset+mouseCoordX*cellwidth,yoffset+mouseCoordY*cellheight))}var lastDownTarget,oldcellwidth=0,oldcellheight=0,oldtextmode=-1,oldfgcolor=-1,forceRegenImages=!1,textcellwidth=0,textcellheight=0;let statusLineHeight=0;function canvasResize(e){if(e||=curLevel,canvas.width=canvas.parentNode.clientWidth,canvas.height=canvas.parentNode.clientHeight,screenwidth=e.width,screenheight=e.height,!state)throw"oops!";if(flickscreen=void 0!==state.metadata.flickscreen,zoomscreen=void 0!==state.metadata.zoomscreen,smoothscreen=void 0!==state.metadata.smoothscreen,textMode)screenwidth=TITLE_WIDTH,screenheight=TITLE_HEIGHT;else if(levelEditorOpened){screenwidth+=2;const e=glyphCount();editorRowCount=Math.ceil(e/(screenwidth-1)),screenheight+=2+editorRowCount}else flickscreen?(screenwidth=state.metadata.flickscreen[0],screenheight=state.metadata.flickscreen[1]):zoomscreen?(screenwidth=state.metadata.zoomscreen[0],screenheight=state.metadata.zoomscreen[1]):smoothscreen&&(screenwidth=state.metadata.smoothscreen.screenSize.width,screenheight=state.metadata.smoothscreen.screenSize.height);cellwidth=canvas.width/screenwidth,cellheight=(canvas.height-statusLineHeight)/screenheight,statusLineHeight=state.metadata.status_line?canvas.height/TITLE_HEIGHT:0;let n=h=state.sprite_size||5;if(textMode){n=6;const e=font.X.split("\n").map((e=>e.trim()));h=e.length}if(cellwidth=n*Math.max(~~(cellwidth/n),1),cellheight=h*Math.max(~~(cellheight/h),1),cellwidth/n>cellheight/h||textMode&&void 0!==state.metadata.custom_font&&loadedCustomFont?cellwidth=cellheight*n/h:cellheight=cellwidth*h/n,pixelSize=cellheight/h,xoffset=(canvas.width-cellwidth*screenwidth)/2,yoffset=(canvas.height-statusLineHeight-cellheight*screenheight)/2,levelEditorOpened&&!textMode&&(xoffset+=cellwidth,yoffset+=cellheight*(1+editorRowCount)),cellwidth|=0,cellheight|=0,xoffset|=0,yoffset|=0,textMode&&(textcellwidth=cellwidth,textcellheight=cellheight),debugSwitch.includes("cell")){document.getElementById("debug").innerHTML=`canvas=${canvas.width},${canvas.height} cell=${cellwidth},${cellheight} text=${textcellwidth},${textcellheight} offset=${xoffset},${yoffset} pixel=${pixelSize}`}(oldcellwidth!=cellwidth||oldcellheight!=cellheight||oldtextmode!=textMode||textMode||oldfgcolor!=state.fgcolor||forceRegenImages)&&(forceRegenImages=!1,regenSpriteImages()),oldcellheight=cellheight,oldcellwidth=cellwidth,oldtextmode=textMode,oldfgcolor=state.fgcolor,redraw()}function easingFunction(e){const n=e in EasingFunctions?e:e in easingAliases?easingAliases[e].toLowerCase():"linear";return EasingFunctions[n]}EasingFunctions={linear:e=>e,easeinquad:e=>e*e,easeoutquad:e=>e*(2-e),easeinoutquad:e=>e<.5?2*e*e:(4-2*e)*e-1,easeincubic:e=>e*e*e,easeoutcubic:e=>--e*e*e+1,easeinoutcubic:e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,easeinquart:e=>e*e*e*e,easeoutquart:e=>1- --e*e*e*e,easeinoutquart:e=>e<.5?8*e*e*e*e:1-8*--e*e*e*e,easeinquint:e=>e*e*e*e*e,easeoutquint:e=>1+--e*e*e*e*e,easeinoutquint:e=>e<.5?16*e*e*e*e*e:1+16*--e*e*e*e*e},easingAliases={1:"linear",2:"easeInQuad",3:"easeOutQuad",4:"easeInOutQuad",5:"easeInCubic",6:"easeOutCubic",7:"easeInOutCubic",8:"easeInQuart",9:"easeOutQuart",10:"easeInOutQuart",11:"easeInQuint",12:"easeOutQuint",13:"easeInOutQuint"};var onLevelRestarted=new Event("levelRestarted"),RandomGen=new RNG;function getIntroScreen(e){return{lines:["","==================","","Puzzle Script Next","Version 3.0b","","==================","",e],options:[]}}function getMessageScreen(e){return{lines:["","","","","","","","","","",e],options:[10]}}function getStartScreen(e){const n=["","","","","","",...e];return{lines:n,options:fillRange(6,n.length)}}function getPauseScreen(e){const n=["","-< GAME PAUSED >-",e.levels[curLevelNo].title||"","","resume game",e.metadata.norestart?null:"replay level from the start",e.metadata.level_select?"go to level select screen":null,"exit to title screen"].filter((e=>null!=e));return{lines:n,options:fillRange(4,n.length)}}function getLevelSelectScreen(e){const n=["[ ESC: Back ]                ","Level Select",""],t=[];return e.forEach((e=>{t.push(n.length),n.push(e)})),{lines:n,options:t}}const MENUITEM_CONTINUE="Continue",MENUITEM_LEVELSELECT="Level Select",MENUITEM_NEWGAME="New Game",MENUITEM_STARTGAME="Start Game",TITLE_WIDTH=34,TITLE_HEIGHT=13;var titleImage=[],textMode=!0,titleScreen=!0,titleMode=0,titleSelection=0,titleSelected=!1,hoverSelection=-1;let lineColorOverride=[],linkStack=[];function doSetupTitleScreenLevelContinue(){try{if(storage_has(document.URL)){if(storage_has(document.URL+"_checkpoint")){var e=storage_get(document.URL+"_checkpoint");curlevelTarget=JSON.parse(e);var n=[];for(var t in Object.keys(curlevelTarget.dat))n[t]=curlevelTarget.dat[t];curlevelTarget.dat=new Int32Array(n)}curLevelNo=storage_get(document.URL),storage_has(document.URL+"_sections")&&(solvedSections=JSON.parse(storage_get(document.URL+"_sections")))}}catch(e){}}function showContinueOptionOnTitleScreen(){return hasStartedTheGame()&&!hasFinishedTheGame()}function hasStartedTheGame(){return(curLevelNo>0||null!==curlevelTarget||storage_has(document.URL+"_checkpoint"))&&curLevelNo in state.levels}function hasFinishedTheGame(){return state.metadata.level_select&&solvedSections.length==state.sections.length||curLevelNo>=state.levels.length-1}function hasSolvedAtLeastOneSection(){return state.metadata.level_select&&solvedSections.length>0}function unloadGame(){state=introState,(curLevel=new Level(0,5,5,2,null,null)).objects=new Int32Array(0),levelEditorOpened=!1,generateTitleScreen(),canvasResize(),titleMode=0,titleSelected=!0}function isContinueOptionSelected(){return state.metadata.skip_title_screen||!state.metadata.continue_is_level_select&&titleSelection==MENUITEM_CONTINUE}function isNewGameOptionSelected(){return titleSelection==MENUITEM_NEWGAME||titleSelection==MENUITEM_STARTGAME}function isLevelSelectOptionSelected(){return state.metadata.continue_is_level_select&&titleSelection==MENUITEM_CONTINUE||titleSelection==MENUITEM_LEVELSELECT}function generateTitleScreen(e,n,t){if(debugSwitch.includes("menu")&&console.log("generateTitleScreen()",e,n,t),lineColorOverride=[],tryLoadCustomFont(),titleMode=showContinueOptionOnTitleScreen()?1:0,0===state.levels.length)return void(titleImage=fillAndHighlight(getIntroScreen("Please select a game")));if(isSitelocked())return void(titleImage=fillAndHighlight(getIntroScreen("This game is sitelocked!")));if(0===titleMode){const e=getStartScreen([MENUITEM_STARTGAME]);titleImage=t?fillAndHighlight(e,-1,-1,e.options[0]):fillAndHighlight(e,e.options[0]),titleSelection=t?MENUITEM_STARTGAME:null}else{const r=hasStartedTheGame()||hasSolvedAtLeastOneSection(),o=[];o.push(r&&!hasFinishedTheGame()?MENUITEM_CONTINUE:MENUITEM_NEWGAME),!state.metadata.level_select||state.metadata.continue_is_level_select&&r||o.push(MENUITEM_LEVELSELECT),r&&!hasFinishedTheGame()&&o.push(MENUITEM_NEWGAME);const a=getStartScreen(o);0==levelSelectScrollPos?levelSelectScrollPos=a.options[0]:n&&a.options.includes(levelSelectScrollPos+n)&&(levelSelectScrollPos+=n),titleImage=fillAndHighlight(a,levelSelectScrollPos,e,t);const i=t||e;titleSelection=!!a.options.includes(i)&&o[a.options.indexOf(i)]}const r=(e,n)=>{if(!n)throw"image";titleImage[e]=n.padEnd(TITLE_WIDTH),state.metadata.keyhint_color&&(lineColorOverride[e]=state.metadata.keyhint_color)};if(state.metadata.text_controls){wordwrap(state.metadata.text_controls,TITLE_WIDTH,!0).slice(0,3).forEach(((e,n)=>{r(10+n,e)}))}else{const e=state.metadata.mouse_drag||state.metadata.mouse_rdrag?" Click, Tap, or Drag to interact":" Click or Tap to interact";r(10,IsMouseGameInputEnabled()?e:" Arrow keys or WASD to move"),r(11,(state.metadata.noaction?" X to select":" X to action")+(state.metadata.norestart?"":", R to restart"));const n=IsMouseGameInputEnabled()?" Z or Middle Mouse Button to undo":" Z to undo";r(12,state.metadata.noundo?" ":n)}const o=wordwrap(state.metadata.title||"PuzzleScript Next Game",TITLE_WIDTH),a=state.metadata.author?2:4;if(o.length>a&&(o.splice(a),e||logWarning(`Game title is too long to fit on screen, truncating to ${a} lines.`,state.metadata_lines.title,!0)),o.forEach(((e,n)=>{titleImage[1+n]=centerText(e.trim(),TITLE_WIDTH),state.metadata.title_color&&(lineColorOverride[1+n]=state.metadata.title_color)})),state.metadata.author){const n=wordwrap("by "+state.metadata.author,TITLE_WIDTH);n.length>2&&(n.splice(2),e||logWarning("Author list too long to fit on screen, truncating to 2 lines.",state.metadata_lines.author,!0)),n.forEach(((e,n)=>{titleImage[3+n]=e.trim().padStart(TITLE_WIDTH),state.metadata.author_color&&(lineColorOverride[3+n]=state.metadata.author_color)}))}redraw()}function goToPauseScreen(){levelSelectScrollPos=0,titleSelected=!1,timer=0,quittingTitleScreen=!1,quittingMessageScreen=!1,titleMode=3,titleScreen=!0,textMode=!0,againing=!1,messagetext="",statusText="",generatePauseScreen()}function generatePauseScreen(e,n,t){debugSwitch.includes("menu")&&console.log("generatePauseScreen()",e,n,t);const r=getPauseScreen(state);0==levelSelectScrollPos?levelSelectScrollPos=r.options[0]:n&&r.options.includes(levelSelectScrollPos+n)&&(levelSelectScrollPos+=n),titleImage=fillAndHighlight(r,levelSelectScrollPos,e,t),pauseSelection=(e>=0?e:t>=0?t:0)-r.options[0],redraw()}function selectPauseScreen(e){const n=[()=>{titleScreen=!1,state.levels[curLevelNo].message?drawMessageScreen(state.levels[curLevelNo].message):(textMode=!1,canvasResize())},state.metadata.norestart?null:()=>{DoRestart(!0),textMode=!1,titleScreen=!1,canvasResize()},state.metadata.level_select?()=>{titleSelection=null,gotoLevelSelectScreen()}:null,()=>{goToTitleScreen()}].filter((e=>null!=e));pauseSelection>=0&&pauseSelection<n.length&&n[pauseSelection]()}function centerText(e,n,t=" "){return e?e.length>=n?e.slice(0,n):(t.repeat(~~((n-e.length)/2))+e).padEnd(n,t):t.repeat(n)}function padToSize(e,n,t){const r=e.map((e=>e.padEnd(n)));for(;r.length<t;)r.push("");return r}function fillRange(e,n){return Array(n-e).fill().map(((n,t)=>e+t))}function fillAndHighlight(e,n,t,r){const o=e.lines.map(((o,a)=>a==r&&e.options.includes(a)?centerText(`# ${o} #`,TITLE_WIDTH,"#"):a==t&&e.options.includes(a)?centerText(`> ${o} <`,TITLE_WIDTH):a==n&&e.options.includes(a)?centerText(`# ${o} #`,TITLE_WIDTH):centerText(o,TITLE_WIDTH)));return padToSize(o,TITLE_WIDTH,TITLE_HEIGHT)}doSetupTitleScreenLevelContinue();let levelSelectScrollPos=0,levelHighlightLine=0;function gotoLevelSelectScreen(){if(state.metadata.level_select){if(levelSelectScrollPos=0,levelHighlightLine=0,titleSelected=!1,timer=0,quittingTitleScreen=!1,quittingMessageScreen=!1,titleMode=2,titleScreen=!0,textMode=!0,againing=!1,messagetext="",statusText="",null==titleSelection)for(var e=0;e<state.sections.length;e++)if(state.sections[e].firstLevel>curLevelNo){titleSelection=Math.max(0,e-1),debugSwitch.includes("menu")&&console.log(`gotoLevelSelect curLevelNo=${curLevelNo} titleSelection=${titleSelection}`);break}state.metadata=deepClone(state.default_metadata),twiddleMetadataExtras(),generateLevelSelectScreen()}else goToTitleScreen()}function generateLevelSelectScreen(e,n,t){debugSwitch.includes("menu")&&console.log("generateLevelSelectScreen()",e,n,t),lineColorOverride=[],amountOfLevelsOnScreen=Math.min(9,state.sections.length),titleSelection<levelSelectScrollPos?levelSelectScrollPos=titleSelection:titleSelection>=levelSelectScrollPos+amountOfLevelsOnScreen&&(levelSelectScrollPos=titleSelection-amountOfLevelsOnScreen+1);var r=-1;if(state.metadata.level_select_lock){let e=0;for(var o=0;o<state.sections.length;o++)solvedSections.indexOf(state.sections[o].name)>=0?r=o:e++;void 0!==state.metadata.level_select_unlocked_ahead?r+=Number(state.metadata.level_select_unlocked_ahead):void 0!==state.metadata.level_select_unlocked_rollover?r=solvedSections.length+Number(state.metadata.level_select_unlocked_rollover)-1:r+=1}0==levelHighlightLine?levelHighlightLine=3+titleSelection-levelSelectScrollPos:levelHighlightLine>3&&n<0?levelHighlightLine--:levelHighlightLine<3+amountOfLevelsOnScreen-1&&n>0?levelHighlightLine++:levelSelectScrollPos>0&&(3==levelHighlightLine||n<0)?levelSelectScrollPos--:levelSelectScrollPos+amountOfLevelsOnScreen<state.sections.length&&(11==levelHighlightLine||n>0)&&levelSelectScrollPos++,titleSelection=levelHighlightLine-3+levelSelectScrollPos;const a=state.metadata.level_select_solve_symbol||"X",i=state.sections.map(((e,n)=>{const o=solvedSections.indexOf(e.name)>=0,i=r>=0&&n>r;let s=i?"*".repeat(e.name.length):e.name.substring(0,24);return n!=t+levelSelectScrollPos-3||i?(o?a:" ")+" "+s.padEnd(24):(n>=levelSelectScrollPos&&n<levelSelectScrollPos+amountOfLevelsOnScreen&&(titleSelection=n),(o?a:" ")+"#"+s.padEnd(24))})),s=getLevelSelectScreen(i.slice(levelSelectScrollPos,levelSelectScrollPos+amountOfLevelsOnScreen));debugSwitch.includes("menu")&&console.log(`generateLevelSelectScreen2 titleSelection=${titleSelection}`,`levelSelectScrollPos=${levelSelectScrollPos}`,s),(titleImage=fillAndHighlight(s,levelHighlightLine,e,t))[0]=(0==e?"[  ESC:Back  ]":" [ ESC:Back ] ").padEnd(TITLE_WIDTH),levelSelectScrollPos>0&&(titleImage[2]=(2==e?"[  PREV  ]":"[ PREV ] ").padStart(TITLE_WIDTH)),levelSelectScrollPos+amountOfLevelsOnScreen<i.length&&(titleImage[12]=(12==e?"[  NEXT  ]":"[ NEXT ] ").padStart(TITLE_WIDTH)),redraw()}function gotoLevel(e){debugSwitch.includes("load")&&console.log(`gotoLevel(${e})`),solving||-9999!=e&&(againing=!1,messagetext="",statusText="",curLevelNo=e>=0?state.sections[e].firstLevel:-1-e,loadLevelFromStateOrTarget(),updateLocalStorage(),resetFlickDat(),canvasResize(),clearInputHistory())}function gotoLink(){if(debugSwitch.includes("load")&&console.log("gotoLink()","stack:",linkStack),!solving)for(const e of playerPositions){const n=state.levels[curLevelNo],t=n.getObjects(e);for(const e of state.links.slice(0,n.linksTop).reverse())if(t.includes(e.object)){const n={backup:backupLevel(),backupTop:backups.length};return linkStack.push(n),void gotoLevel(e.targetNo)}}}function returnLink(){debugSwitch.includes("load")&&console.log("returnLink()","stack:",linkStack);const e=linkStack.pop(),n=state.levels[e.backup.levelNo];backups=backups.slice(0,e.backupTop),verbose_logging&&consolePrint(`Returning to level ${e.backup.levelNo} (${htmlJump(n.lineNumber)}).`,!0,n.lineNumber),restoreLevel(e.backup),updateLocalStorage(),resetFlickDat(),canvasResize(),clearInputHistory()}let introState={title:"Empty Game",attribution:"polyomino",objectCount:2,metadata:[],levels:[],collisionLayerGroups:[],bgcolor:"#000000",fgcolor:"#FFFFFF"};var state=introState;function deepClone(e){if(!e)return e;if([Number,String,Boolean].forEach((function(t){e instanceof t&&(n=t(e))})),void 0===n)if("[object Array]"===Object.prototype.toString.call(e))n=[],e.forEach((function(e,t,r){n[t]=deepClone(e)}));else if("object"==typeof e)if(e.nodeType&&"function"==typeof e.cloneNode)var n=e.cloneNode(!0);else if(e.prototype)n=e;else if(e instanceof Date)n=new Date(e);else for(var t in n={},e)n[t]=deepClone(e[t]);else n=e;return n}function wordwrap(e,n,t=!1){if(!e)return[];var r=".{1,"+(n=n||75)+"}(\\s|$)|.{"+n+"}|.+$";if(t){splitNewlines=e.split("\\n");var o=[];return splitNewlines.forEach((e=>{o=o.concat(e.match(RegExp(r,"g")))})),o}return e.match(RegExp(r,"g"))}var splitMessage=[];function drawMessageScreen(e){lineColorOverride=[],tryLoadCustomFont(),titleMode=0,textMode=!0;const n=getMessageScreen(quittingMessageScreen?"":state.metadata.text_message_continue?state.metadata.text_message_continue:IsMouseGameInputEnabled()?"Click or X to continue":"X to continue");titleImage=fillAndHighlight(n),state.metadata.keyhint_color&&(lineColorOverride[n.options[0]]=state.metadata.keyhint_color);const t=wordwrap(e,TITLE_WIDTH,!0).map((e=>"left"==state.metadata.message_text_align?e.padEnd(TITLE_WIDTH):"right"==state.metadata.message_text_align?e.padStart(TITLE_WIDTH):centerText(e,TITLE_WIDTH)));t.length=Math.min(t.length,12);const r=5-~~(t.length/2);t.forEach(((e,n)=>{titleImage[n+r]=e})),canvasResize()}var loadedLevelSeed=0;function loadLevelFromLevelDat(e,n,t,r){if(debugSwitch.includes("load")&&console.log("loadLevelFromLevelDat()",n),null==t&&(t=(Math.random()+Date.now()).toString()),RandomGen=new RNG(loadedLevelSeed=t),forceRegenImages=!0,ignoreNotJustPressedAction=!0,titleScreen=!1,titleMode=showContinueOptionOnTitleScreen()?1:0,titleSelection=0,titleSelected=!1,dragging=!1,rightdragging=!1,e.metadata=deepClone(e.default_metadata),againing=!1,void 0===n)return consolePrint("Trying to access a level that doesn't exist.",!0),void goToTitleScreen();n.message?(verbose_logging&&consolePrint(`Showing message (${htmlJump(n.lineNumber)})`,!0,n.lineNumber),ignoreNotJustPressedAction=!0,tryPlayShowMessageSound(),twiddleMetadataExtras(),drawMessageScreen(n.message),messageselected=!1,canvasResize(),clearInputHistory()):null!=n.target?(verbose_logging&&consolePrint(`GOTO (${htmlJump(n.lineNumber)})`,!0,n.lineNumber),setSectionSolved(e.levels[Number(curLevelNo)].section),gotoLevel(n.target)):(titleMode=0,textMode=!1,curLevel=n.clone(),verbose_logging&&consolePrint(`Loading level ${n.section||""} (${htmlJump(n.lineNumber)}).`,!0,n.lineNumber),RebuildLevelArrays(),void 0!==e&&(void 0!==e.metadata.flickscreen?oldflickscreendat=[0,0,Math.min(e.metadata.flickscreen[0],curLevel.width),Math.min(e.metadata.flickscreen[1],curLevel.height)]:void 0!==e.metadata.zoomscreen?oldflickscreendat=[0,0,Math.min(e.metadata.zoomscreen[0],curLevel.width),Math.min(e.metadata.zoomscreen[1],curLevel.height)]:void 0!==e.metadata.smoothscreen&&(oldflickscreendat=[0,0,Math.min(e.metadata.smoothscreen.screenSize.width,curLevel.width),Math.min(e.metadata.smoothscreen.screenSize.height,curLevel.height)])),initSmoothCamera(),twiddleMetadataExtras(),e.metadata.allow_undo_level||(backups=[]),restartTarget=backupLevel(),keybuffer=[],"run_rules_on_level_start"in e.metadata&&(runrulesonlevelstart_phase=!0,processInput(-1,!0),runrulesonlevelstart_phase=!1)),!0===r&&clearInputHistory()}function loadLevelFromStateTarget(e,n,t,r){debugSwitch.includes("load")&&console.log(`loadLevelFromStateTarget(${n},${t})`),curLevelNo=n,curlevelTarget=t,void 0===t.message&&(0===n?tryPlayStartGameSound():tryPlayStartLevelSound()),loadLevelFromLevelDat(e,e.levels[n],r),restoreLevel(t,!0),restartTarget=t}function loadLevelFromState(e,n,t){debugSwitch.includes("load")&&console.log(`loadLevelFromState(${n})`);var r=e.levels[n];curLevelNo=n,curlevelTarget=null,void 0!==r&&void 0===r.message&&(document.dispatchEvent(new CustomEvent("psplusLevelLoaded",{detail:n})),tryPlayStartLevelSound()),loadLevelFromLevelDat(e,r,t)}var objectSprites=[{color:"#423563",dat:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]]},{color:"#252342",dat:[[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,1,1,1,0],[0,1,0,1,0]]}];function tryLoadCustomFont(){null==state||null==state.metadata||null==state.metadata.custom_font||loadedCustomFont||new FontFace("PuzzleCustomFont","url("+state.metadata.custom_font+")").load().then((function(e){document.fonts.add(e),loadedCustomFont=!0,canvasResize()})).catch((function(e){alert("Unable to load font!")}))}function tryPlaySimpleSound(e){void 0!==state.sfx_Events[e]&&playSeed(state.sfx_Events[e],!0)}function tryPlayTitleSound(){tryPlaySimpleSound("titlescreen")}function tryPlayStartGameSound(){tryPlaySimpleSound("startgame")}function tryPlayEndGameSound(){tryPlaySimpleSound("endgame")}function tryPlayCancelSound(){tryPlaySimpleSound("cancel")}function tryPlayStartLevelSound(){tryPlaySimpleSound("startlevel")}function tryPlayEndLevelSound(){tryPlaySimpleSound("endlevel")}function tryPlayUndoSound(){tryPlaySimpleSound("undo")}function tryPlayRestartSound(){tryPlaySimpleSound("restart")}function tryPlayShowMessageSound(){tryPlaySimpleSound("showmessage")}function tryPlayCloseMessageSound(){tryPlaySimpleSound("closemessage")}loadedCustomFont=!1,tryLoadCustomFont(),generateTitleScreen(),titleMode>0&&(titleSelection=0),canvasResize();var restartTarget,backups=[];function backupLevel(){const e=level4Serialization();if(void 0!==state.metadata.runtime_metadata_twiddling){var n=deepClone(state.metadata);delete n.custom_font,e.metadata=n}return e}function level4Serialization(){return{dat:Array.from(curLevel.objects),width:curLevel.width,height:curLevel.height,oldflickscreendat:oldflickscreendat.concat([]),cameraPositionTarget:Object.assign({},cameraPositionTarget),levelNo:curLevelNo}}function setGameState(e,n,t){debugSwitch.includes("load")&&console.log(`setGameState(${n})`),oldflickscreendat=[],linkStack=[],timer=0,autotick=0,winning=!1,againing=!1,messageselected=!1,STRIDE_MOV=e.STRIDE_MOV,STRIDE_OBJ=e.STRIDE_OBJ,sfxCreateMask=new BitVec(STRIDE_OBJ),sfxDestroyMask=new BitVec(STRIDE_OBJ),void 0===n&&(n=["restart"]),(0===state.levels.length||0===e.levels.length)&&n.length>0&&"rebuild"===n[0]&&(n=["restart"]),void 0===t&&(t=null),RandomGen=new RNG(t),state=e,"rebuild"!==n[0]&&(backups=[]),objectSprites=[];for(const e in state.objects)if(state.objects.hasOwnProperty(e)){const n=state.objects[e];objectSprites[n.id]={dat:n.spritematrix,colors:n.colors,text:n.spritetext,vector:n.vector,scale:n.scale}}switch(void 0!==state.metadata.realtime_interval?(autotick=0,autotickinterval=1e3*state.metadata.realtime_interval):(autotick=0,autotickinterval=0),twiddleMetadataExtras(),throttle_movement&&0===autotickinterval&&logWarning("throttle_movement is designed for use in conjunction with realtime_interval. Using it in other situations makes games gross and unresponsive, broadly speaking.  Please don't."),norepeat_action=void 0!==state.metadata.norepeat_action,n[0]){case"restart":winning=!1,timer=0,titleScreen=!0,tryPlayTitleSound(),textMode=!0,titleSelection=0,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,titleMode=showContinueOptionOnTitleScreen()?1:0,void 0!==state.metadata.skip_title_screen?(consolePrint("skip_title_screen enabled, proceeding to do exactly as it says on the tin."),void 0!==state.metadata.continue_is_level_select?gotoLevelSelectScreen():titleMode<=1?nextLevel():2==titleMode&&gotoLevel(titleSelection)):generateTitleScreen();break;case"rebuild":break;case"loadFirstNonMessageLevel":for(var r=0;r<state.levels.length;r++)if(!state.levels[r].message){curLevelNo=o=r,curlevelTarget=null,winning=!1,timer=0,titleScreen=!1,textMode=!1,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,titleMode=0,showLayers=!1,loadLevelFromState(state,o,t);break}break;case"loadLevel":var o=n[1];curLevelNo=o,curlevelTarget=null,winning=!1,timer=0,titleScreen=!1,textMode=!1,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,titleMode=0,showLayers=!1,loadLevelFromState(state,o,t);break;case"levelline":var a=n[1];for(r=state.levels.length-1;r>=0;r--){if(state.levels[r].lineNumber<=a+1){curLevelNo=r,curlevelTarget=null,winning=!1,timer=0,titleScreen=!1,textMode=!1,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,titleMode=0,showLayers=!1,loadLevelFromState(state,r);break}}}"rebuild"!==n[0]&&clearInputHistory(),canvasResize(),0==state.sounds.length?killAudioButton():showAudioButton()}function RebuildLevelArrays(){curLevel.movements=new Int32Array(curLevel.n_tiles*STRIDE_MOV),curLevel.rigidMovementAppliedMask=[],curLevel.rigidGroupIndexMask=[],curLevel.rowCellContents=[],curLevel.rowCellContents_Movements=[],curLevel.colCellContents=[],curLevel.colCellContents_Movements=[],curLevel.mapCellContents=new BitVec(STRIDE_OBJ),curLevel.mapCellContents_Movements=new BitVec(STRIDE_MOV),_movementVecs=[new BitVec(STRIDE_MOV),new BitVec(STRIDE_MOV),new BitVec(STRIDE_MOV)],_rigidVecs=[new BitVec(STRIDE_MOV),new BitVec(STRIDE_MOV),new BitVec(STRIDE_MOV)],_o1=new BitVec(STRIDE_OBJ),_o2=new BitVec(STRIDE_OBJ),_o2_5=new BitVec(STRIDE_OBJ),_o3=new BitVec(STRIDE_OBJ),_o4=new BitVec(STRIDE_OBJ),_o5=new BitVec(STRIDE_OBJ),_o6=new BitVec(STRIDE_OBJ),_o7=new BitVec(STRIDE_OBJ),_o8=new BitVec(STRIDE_OBJ),_o9=new BitVec(STRIDE_OBJ),_o10=new BitVec(STRIDE_OBJ),_o11=new BitVec(STRIDE_OBJ),_o12=new BitVec(STRIDE_OBJ),_m1=new BitVec(STRIDE_MOV),_m2=new BitVec(STRIDE_MOV),_m3=new BitVec(STRIDE_MOV);for(var e=0;e<curLevel.height;e++)curLevel.rowCellContents[e]=new BitVec(STRIDE_OBJ);for(e=0;e<curLevel.width;e++)curLevel.colCellContents[e]=new BitVec(STRIDE_OBJ);for(e=0;e<curLevel.height;e++)curLevel.rowCellContents_Movements[e]=new BitVec(STRIDE_MOV);for(e=0;e<curLevel.width;e++)curLevel.colCellContents_Movements[e]=new BitVec(STRIDE_MOV);for(e=0;e<curLevel.n_tiles;e++)curLevel.rigidMovementAppliedMask[e]=new BitVec(STRIDE_MOV),curLevel.rigidGroupIndexMask[e]=new BitVec(STRIDE_MOV)}let messagetext="",statusText="",gosubTarget=-1;var currentMovedEntities={},newMovedEntities={};function applyDiff(e,n){for(var t=0;t<e.dat.length;){var r=e.dat[t],o=e.dat[t+1];if(0===o)break;for(var a=0;a<o;a++)n[r+a]=e.dat[t+2+a];t+=2+o}}function unconsolidateDiff(e,n){if(!e.hasOwnProperty("diff"))return e;var t=new Int32Array(n.dat);return applyDiff(e,t),{dat:t,width:e.width,height:e.height,oldflickscreendat:e.oldflickscreendat}}function restoreLevel(e,n,t=!0,r=!0){debugSwitch.includes("load")&&console.log("restoreLevel()",e);var o=e.hasOwnProperty("diff");oldflickscreendat=e.oldflickscreendat.concat([]),t&&(currentMovedEntities={});const a=e.levelNo>=0&&e.levelNo!=curLevelNo;if(a&&(curLevelNo=e.levelNo,curLevel=state.levels[curLevelNo].clone()),o?applyDiff(e,curLevel.objects):curLevel.objects=new Int32Array(e.dat),a||curLevel.width!==e.width||curLevel.height!==e.height)debugSwitch.includes("load")&&console.log(`Restore level: from ${curLevel.width}x${curLevel.height} to ${e.width}x${e.height}`),curLevel.width=e.width,curLevel.height=e.height,curLevel.n_tiles=e.width*e.height,RebuildLevelArrays();else{for(var i=0;i<curLevel.n_tiles;i++)curLevel.movements[i]=0,curLevel.rigidMovementAppliedMask[i].setZero(),curLevel.rigidGroupIndexMask[i].setZero();for(i=0;i<curLevel.height;i++){curLevel.rowCellContents[i].setZero()}for(i=0;i<curLevel.width;i++){curLevel.colCellContents[i].setZero()}}e.cameraPositionTarget&&(cameraPositionTarget=Object.assign({},e.cameraPositionTarget),n&&(cameraPosition=Object.assign({},cameraPositionTarget))),void 0!==state.metadata.runtime_metadata_twiddling&&(void 0===e.metadata&&(e.metadata=deepClone(state.default_metadata),consolePrint("RUNTIME METADATA TWIDDLING: Reloaded level state that did not have saved metadata. Likely this state was recovered from a CHECKPOINT. Using the default metadata instead.",!0)),state.metadata=deepClone(e.metadata),twiddleMetadataExtras(r)),againing=!1,messagetext="",curLevel.commandQueue=[],curLevel.commandQueueSourceRules=[]}var zoomscreen=!1,flickscreen=!1,smoothscreen=!1,screenwidth=0,screenheight=0;function consolidateDiff(e,n){if(e.width!==n.width||e.height!==n.height||e.dat.length!==n.dat.length)return e;if(e.hasOwnProperty("diff")||n.hasOwnProperty("diff"))return e;if(e.dat.length<1024)return e;for(var t=new Int32Array(128),r=0,o=!1,a=-1,i=e.dat,s=n.dat,l=0;l<i.length;l++)if(!1===o){if(i[l]!==s[l]){if(o=!0,a=r,t.length<r+4)(c=new Int32Array(2*t.length)).set(t),t=c;t[r+0]=l,t[r+1]=1,t[r+2]=i[l],r+=3}}else if(i[l]!==s[l]){var c;if(r+1>=t.length)if(t.length<r+4)(c=new Int32Array(2*t.length)).set(t),t=c;t[a+1]++,t[r]=i[l],r++}else o=!1;return{diff:!0,dat:t,width:e.width,height:e.height,oldflickscreendat:e.oldflickscreendat,metadata:e.metadata}}function addUndoState(e){debugSwitch.includes("undo")&&console.log(`addUndoState length=${backups.length} bak=`,e),backups.push(e),backups.length>2&&!backups[backups.length-1].hasOwnProperty("diff")&&(backups[backups.length-3]=consolidateDiff(backups[backups.length-3],backups[backups.length-2]))}function DoRestart(e){!0!==restarting&&(!0!==e&&"norestart"in state.metadata||(restarting=!0,!0!==e&&addUndoState(backupLevel()),verbose_logging&&consolePrint("--- restarting ---",!0),restoreLevel(restartTarget,!0),tryPlayRestartSound(),document.dispatchEvent(new CustomEvent("psplusLevelRestarted",{detail:curLevelNo})),"run_rules_on_level_start"in state.metadata&&processInput(-1,!0),twiddleMetadataExtras(),curLevel.commandQueue=[],curLevel.commandQueueSourceRules=[],restarting=!1))}function backupDiffers(){if(0==backups.length)return!0;var e=backups[backups.length-1];if(e.hasOwnProperty("diff"))return 0!==e.dat.length&&0!==e.dat[1];for(var n=0;n<curLevel.objects.length;n++)if(curLevel.objects[n]!==e.dat[n])return!0;return!1}function DoUndo(e,n,t=!0,r=!0,o=!1){if(levelEditorOpened||!("noundo"in state.metadata)||!0===e){if(n)for(;0==backupDiffers();)backups.pop();if(verbose_logging&&consolePrint(backups.length>0?"--- undoing ---":"Nothing to undo.",!0),backups.length>0){var a=backups[backups.length-1];debugSwitch.includes("undo")&&console.log(`DoUndo length=${backups.length} torestore=`,a),restoreLevel(a,null,t,r),backups=backups.splice(0,backups.length-1),linkStack.length>0&&linkStack.at(-1).backupTop==backups.length&&linkStack.pop(),e&&!o||tryPlayUndoSound()}}}var dirMaskName={1:"up",2:"down",3:"no",4:"left",8:"right",15:"?",16:"action",18:"random",32:"lclick",64:"rclick"},dirMasks={up:1,down:2,no:3,left:4,randomdir:5,right:8,moving:15,action:16,random:18,lclick:32,rclick:64,"":0},dirMasksDelta={1:[0,-1],2:[0,1],3:[0,0],4:[-1,0],8:[1,0],15:[0,0],16:[0,0],18:[0,0],32:[0,0],64:[0,0]};function getObject(e){return state.objects[state.idDict[e]]}function getLayerMovement(e,n){return e.getshiftor(MOV_MASK,MOV_BITS*n)}function deltaPositionIndex(e,n,t,r){return n+r+t*e.height}function getPlayerPositions(){for(var e=[],n=state.playerMask,t=0;t<curLevel.n_tiles;t++)curLevel.getCellInto(t,_o11),n.anyBitsInCommon(_o11)&&e.push(t);return e}function getLayersOfMask(e){for(var n=[],t=0;t<state.objectCount;t++)if(e.get(t)){var r=state.idDict[t],o=state.objects[r];n.push(o.layer)}return n}function moveEntitiesAtIndex(e,n,t){var r=curLevel.getCell(e);r.iand(n);for(var o=getLayersOfMask(r),a=curLevel.getMovements(e),i=0;i<o.length;i++)a.ishiftor(t,MOV_BITS*o[i]);curLevel.setMovements(e,a);var s=e/curLevel.height|0,l=e%curLevel.height;curLevel.colCellContents_Movements[s].ior(a),curLevel.rowCellContents_Movements[l].ior(a),curLevel.mapCellContents_Movements.ior(a)}function startMovement(e){for(var n=getPlayerPositions(),t=0;t<n.length;t++){moveEntitiesAtIndex(n[t],state.playerMask,e)}return n}var _movementVecs,seedsToPlay_CanMove=[],seedsToPlay_CantMove=[],seedsToAnimate={};function repositionEntitiesOnLayer(e,n,t){var r=dirMasksDelta[t],o=r[0],a=r[1],i=e/curLevel.height|0,s=e%curLevel.height,l=curLevel.width-1,c=curLevel.height-1;if(0===i&&o<0||i===l&&o>0||0===s&&a<0||s===c&&a>0)return!1;var u=e+r[1]+r[0]*curLevel.height,d=state.layerMasks[n],h=curLevel.getCellInto(u,_o7),g=curLevel.getCellInto(e,_o8);if(d.anyBitsInCommon(h)&&t<16)return!1;for(let t=0;t<state.sfx_MovementMasks[n].length;t++){const r=state.sfx_MovementMasks[n][t];if(g.get(r.objId)){var m=curLevel.getMovements(e),f=r.directionMask;if(m.anyBitsInCommon(f))if(verbose_logging&&consolePrint(`Object "${state.idDict[r.objId]}" has moved, playing seed "${r.seed}".`),r.seed.startsWith("afx")){const n=getLayerMovement(m,getObject(r.objId).layer),t=deltaPositionIndex(curLevel,e,dirMasksDelta[n][0],dirMasksDelta[n][1]);seedsToAnimate[t+","+r.objId]={kind:"move",seed:r.seed,dir:n}}else-1===seedsToPlay_CanMove.indexOf(r.seed)&&seedsToPlay_CanMove.push(r.seed)}}var p=g.clone();g.iclear(d),p.iand(d),h.ior(p),curLevel.setCell(e,g),curLevel.setCell(u,h);var v=u/curLevel.height|0,_=u%curLevel.height;return curLevel.colCellContents[v].ior(p),curLevel.rowCellContents[_].ior(p),!0}function repositionEntitiesAtCell(e){var n=curLevel.getMovements(e);if(n.iszero())return!1;for(var t=!1,r=0;r<curLevel.layerCount;r++){var o=n.getshiftor(MOV_MASK,MOV_BITS*r);if(0!==o)if(repositionEntitiesOnLayer(e,r,o)){if(state.metadata.tween_length){var a=dirMasksDelta[o],i=e+a[1]+a[0]*curLevel.height;newMovedEntities["p"+i+"-l"+r]=o}n.ishiftclear(o,MOV_BITS*r),t=!0}}return curLevel.setMovements(e,n),t}function Level(e,n,t,r,o,a){this.lineNumber=e,this.width=n,this.height=t,this.n_tiles=n*t,this.objects=o,this.section=a,this.layerCount=r,this.commandQueue=[],this.commandQueueSourceRules=[]}Level.prototype.delta_index=function(e){const[n,t]=dirMasksDelta[e];return n*this.height+t},Level.prototype.clone=function(){var e=new Level(this.lineNumber,this.width,this.height,this.layerCount,null,this.section);return e.objects=new Int32Array(this.objects),e},Level.prototype.getCell=function(e){return new BitVec(this.objects.subarray(e*STRIDE_OBJ,e*STRIDE_OBJ+STRIDE_OBJ))},Level.prototype.getCellInto=function(e,n){for(var t=0;t<STRIDE_OBJ;t++)n.data[t]=this.objects[e*STRIDE_OBJ+t];return n},Level.prototype.setCell=function(e,n){for(var t=0;t<n.data.length;++t)this.objects[e*STRIDE_OBJ+t]=n.data[t]};var _movementVecIndex=0;Level.prototype.getMovements=function(e){var n=_movementVecs[_movementVecIndex];_movementVecIndex=(_movementVecIndex+1)%_movementVecs.length;for(var t=0;t<STRIDE_MOV;t++)n.data[t]=this.movements[e*STRIDE_MOV+t];return n},Level.prototype.getRigids=function(e){return this.rigidMovementAppliedMask[e].clone()},Level.prototype.getMovementsInto=function(e,n){for(var t=n,r=0;r<STRIDE_MOV;r++)t.data[r]=this.movements[e*STRIDE_MOV+r];return t},Level.prototype.setMovements=function(e,n){for(var t=0;t<n.data.length;++t)this.movements[e*STRIDE_MOV+t]=n.data[t];var r=e/this.height|0,o=e%this.height;curLevel.colCellContents_Movements[r].ior(n),curLevel.rowCellContents_Movements[o].ior(n),curLevel.mapCellContents_Movements.ior(n)},Level.prototype.getObjects=function(e){const n=this.getCell(e),t=[];for(let e=0;e<32*STRIDE_OBJ;++e)n.get(e)&&t.push(state.idDict[e]);return t};var ellipsisPattern=["ellipsis"];function BitVec(e){return this.data=new Int32Array(e),this}function Rule(e){this.direction=e[0],this.patterns=e[1],this.hasReplacements=e[2],this.lineNumber=e[3],this.ellipsisCount=e[4],this.groupNumber=e[5],this.isRigid=e[6],this.commands=e[7],this.isRandom=e[8],this.cellRowMasks=e[9],this.cellRowMasks_Movements=e[10],this.isGlobal=e[11],this.isOnce=e[12],this.ruleMask=this.cellRowMasks.reduce(((e,n)=>(e.ior(n),e)),new BitVec(STRIDE_OBJ)),this.cellRowMatches=[];for(var n=0;n<this.patterns.length;n++)this.cellRowMatches.push(this.generateCellRowMatchesFunction(this.patterns[n],this.ellipsisCount[n]))}BitVec.prototype.format=function(){return"["+[...this.data].map((e=>`${e.toString(16)}h`)).join(",")+"]"},BitVec.prototype.cloneInto=function(e){for(var n=0;n<this.data.length;++n)e.data[n]=this.data[n];return e},BitVec.prototype.clone=function(){return new BitVec(this.data)},BitVec.prototype.iand=function(e){for(var n=0;n<this.data.length;++n)this.data[n]&=e.data[n]},BitVec.prototype.inot=function(){for(var e=0;e<this.data.length;++e)this.data[e]=~this.data[e]},BitVec.prototype.ior=function(e){for(var n=0;n<this.data.length;++n)this.data[n]|=e.data[n]},BitVec.prototype.iclear=function(e){for(var n=0;n<this.data.length;++n)this.data[n]&=~e.data[n]},BitVec.prototype.ibitset=function(e){this.data[e>>5]|=1<<(31&e)},BitVec.prototype.ibitclear=function(e){this.data[e>>5]&=~(1<<(31&e))},BitVec.prototype.get=function(e){return 0!=(this.data[e>>5]&1<<(31&e))},BitVec.prototype.getshiftor=function(e,n){var t=31&n,r=this.data[n>>5]>>>t;return t&&(r|=this.data[1+(n>>5)]<<32-t),r&e},BitVec.prototype.ishiftor=function(e,n){var t=31&n,r=e<<t;if(this.data[n>>5]|=r,t){var o=e>>32-t;this.data[1+(n>>5)]|=o}},BitVec.prototype.ishiftclear=function(e,n){var t=31&n,r=e<<t;if(this.data[n>>5]&=~r,t){var o=e>>32-(31&n);this.data[1+(n>>5)]&=~o}},BitVec.prototype.equals=function(e){if(this.data.length!==e.data.length)return!1;for(var n=0;n<this.data.length;++n)if(this.data[n]!==e.data[n])return!1;return!0},BitVec.prototype.setZero=function(){for(var e=0;e<this.data.length;++e)this.data[e]=0},BitVec.prototype.iszero=function(){for(var e=0;e<this.data.length;++e)if(this.data[e])return!1;return!0},BitVec.prototype.bitsSetInArray=function(e){for(var n=0;n<this.data.length;++n)if((this.data[n]&e[n])!==this.data[n])return!1;return!0},BitVec.prototype.bitsClearInArray=function(e){for(var n=0;n<this.data.length;++n)if(this.data[n]&e[n])return!1;return!0},BitVec.prototype.anyBitsInCommon=function(e){return!this.bitsClearInArray(e.data)},Rule.prototype.generateCellRowMatchesFunction=function(e,n){if(0===n){for(var t=e.length,r="",o=1===STRIDE_OBJ?"":"*"+STRIDE_OBJ,a=0;a<STRIDE_OBJ;++a)r+="var cellObjects"+a+" = objects[i"+o+(a?"+"+a:"")+"];\n";o=1===STRIDE_MOV?"":"*"+STRIDE_MOV;for(a=0;a<STRIDE_MOV;++a)r+="var cellMovements"+a+" = movements[i"+o+(a?"+"+a:"")+"];\n";r+="return "+e[0].generateMatchString("0_");for(var i=1;i<t;i++)r+="&&cellRow["+i+"].matches(i+"+i+"*d, objects, movements)";return(r+=";")in matchCache?matchCache[r]:matchCache[r]=new Function("cellRow","i","d","objects","movements",r)}if(1===n){t=e.length,r="var result = [];\n";r+="if(cellRow[0].matches(i, objects, movements)";for(i=1;e[i]!==ellipsisPattern&&i<t;i++)r+="&&cellRow["+i+"].matches(i+"+i+"*d, objects, movements)";for(r+=") {\n",r+="\tfor (var k=kmin;k<kmax;k++) {\n",r+="\t\tif(cellRow["+ ++i+"].matches((i+d*(k+"+(i-1)+")), objects, movements)",i++;i<t;i++)r+="&&cellRow["+i+"].matches((i+d*(k+"+(i-1)+")), objects, movements)";return r+="){\n",r+="\t\t\tresult.push([i,k]);\n",r+="\t\t}\n",r+="\t}\n",r+="}\n",(r+="return result;")in matchCache?matchCache[r]:matchCache[r]=new Function("cellRow","i","kmax","kmin","d","objects","movements",r)}t=e.length;var s=-1,l=-1;for(i=0;i<t;i++)if(e[i]===ellipsisPattern){if(-1!==s){l=i;break}s=i}r="var result = [];\n";r+="if(cellRow[0].matches(i, objects, movements)";for(var c=1;c<s;c++)r+="&&cellRow["+c+"].matches(i+"+c+"*d, objects, movements)";r+=") {\n",r+="\tfor (var k1=k1min;k1<k1max;k1++) {\n",r+="\t\tif(cellRow["+(s+1)+"].matches((i+d*(k1+"+(s+1-1)+")), objects, movements)";for(c=s+2;c<l;c++)r+="&&cellRow["+c+"].matches((i+d*(k1+"+(c-1)+")), objects, movements)";r+="\t\t){\n",r+="\t\t\tfor (var k2=k2min;k1+k2<kmax && k2<k2max;k2++) {\n",r+="\t\t\t\tif(cellRow["+(l+1)+"].matches((i+d*(k1+k2+"+(l+1-2)+")), objects, movements)";for(c=l+2;c<t;c++)r+="&&cellRow["+c+"].matches((i+d*(k1+k2+"+(c-2)+")), objects, movements)";return r+="\t\t\t\t){\n",r+="\t\t\t\t\tresult.push([i,k1,k2]);\n",r+="\t\t\t\t}\n",r+="\t\t\t}\n",r+="\t\t}\n",r+="\t}\n",r+="}\n",(r+="return result;")in matchCache?matchCache[r]:matchCache[r]=new Function("cellRow","i","kmax","kmin","k1max","k1min","k2max","k2min","d","objects","movements",r)};let MOV_BITS=5,MOV_MASK=31;var STRIDE_OBJ=1,STRIDE_MOV=1;function CellPattern(e){this.objectsPresent=e[0],this.objectsMissing=e[1],this.anyObjectsPresent=e[2],this.movementsPresent=e[3],this.movementsMissing=e[4],this.matches=this.generateMatchFunction(),this.replacement=e[5]}function CellReplacement(e){this.objectsClear=e[0],this.objectsSet=e[1],this.movementsClear=e[2],this.movementsSet=e[3],this.movementsLayerMask=e[4],this.randomEntityMask=e[5],this.randomDirMask=e[6]}var _o1,_o2,_o2_5,_o3,_o4,_o5,_o6,_o7,_o8,_o9,_o10,_o11,_o12,_m1,_m2,_m3,matchCache={};function matchCellRow(e,n,t,r,o,a,i){var s=[];if(!r.bitsSetInArray(curLevel.mapCellContents.data)||!o.bitsSetInArray(curLevel.mapCellContents_Movements.data))return s;if(i||void 0===state.metadata.local_radius)xmin=0,xmax=curLevel.width,ymin=0,ymax=curLevel.height;else{var l=parseInt(state.metadata.local_radius);xmin=Math.max(0,(playerPositions[0]/curLevel.height|0)-l),xmax=Math.min(curLevel.width,(playerPositions[0]/curLevel.height|0)+l+1),ymin=Math.max(0,playerPositions[0]%curLevel.height-l),ymax=Math.min(curLevel.height,playerPositions[0]%curLevel.height+l+1)}var c=t.length;switch(e){case 1:ymin+=c-1;break;case 2:ymax-=c-1;break;case 4:xmin+=c-1;break;case 8:xmax-=c-1;break;default:window.console.log("EEEP "+e)}if(e>2){for(var u=ymin;u<ymax;u++)if(r.bitsSetInArray(curLevel.rowCellContents[u].data)&&o.bitsSetInArray(curLevel.rowCellContents_Movements[u].data))for(var d=xmin;d<xmax;d++){n(t,h=d*curLevel.height+u,a,curLevel.objects,curLevel.movements)&&s.push(h)}}else for(d=xmin;d<xmax;d++)if(r.bitsSetInArray(curLevel.colCellContents[d].data)&&o.bitsSetInArray(curLevel.colCellContents_Movements[d].data))for(u=ymin;u<ymax;u++){var h;n(t,h=d*curLevel.height+u,a,curLevel.objects,curLevel.movements)&&s.push(h)}return s}function matchCellRowWildCard(e,n,t,r,o,a,i){var s=[];if(!r.bitsSetInArray(curLevel.mapCellContents.data)||!o.bitsSetInArray(curLevel.mapCellContents_Movements.data))return s;var l=0,c=curLevel.width,u=0,d=curLevel.height,h=t.length-i;switch(e){case 1:u+=h-1;break;case 2:d-=h-1;break;case 4:l+=h-1;break;case 8:c-=h-1;break;default:window.console.log("EEEP2 "+e)}if(e>2){for(var g=u;g<d;g++)if(r.bitsSetInArray(curLevel.rowCellContents[g].data)&&o.bitsSetInArray(curLevel.rowCellContents_Movements[g].data))for(var m=l;m<c;m++){var f=m*curLevel.height+g;4===e?p=m-h+2:8===e?p=curLevel.width-(m+h)+1:window.console.log("EEEP2 "+e),1===i?s.push.apply(s,n(t,f,p,0,a,curLevel.objects,curLevel.movements)):s.push.apply(s,n(t,f,p,0,p,0,p,0,a,curLevel.objects,curLevel.movements))}}else for(m=l;m<c;m++)if(r.bitsSetInArray(curLevel.colCellContents[m].data)&&o.bitsSetInArray(curLevel.colCellContents_Movements[m].data))for(g=u;g<d;g++){var p;f=m*curLevel.height+g;2===e?p=curLevel.height-(g+h)+1:1===e?p=g-h+2:window.console.log("EEEP2 "+e),1===i?s.push.apply(s,n(t,f,p,0,a,curLevel.objects,curLevel.movements)):s.push.apply(s,n(t,f,p,0,p,0,p,0,a,curLevel.objects,curLevel.movements))}return s}function generateTuples(e){for(var n=[[]],t=0;t<e.length;t++){for(var r=e[t],o=[],a=0;a<r.length;a++)for(var i=r[a],s=0;s<n.length;s++){var l=n[s].concat([i]);o.push(l)}n=o}return n}function twiddleMetadataExtras(e=!0){autotickinterval=state.metadata.realtime_interval?1e3*state.metadata.realtime_interval:0,!e&&state.metadata.realtime_interval||(autotick=0),againinterval=state.metadata.again_interval?1e3*state.metadata.again_interval:150,tweeninterval=state.metadata.tween_length?Math.max(1e3*state.metadata.tween_length,0):0,repeatinterval=state.metadata.key_repeat_interval?1e3*state.metadata.key_repeat_interval:200,animateinterval=state.metadata.animate_interval?1e3*state.metadata.animate_interval:250,state.bgcolor=state.metadata.background_color?colorToHex(colorPalette,state.metadata.background_color):"#000000",state.fgcolor=state.metadata.text_color?colorToHex(colorPalette,state.metadata.text_color):"#FFFFFF"}function showTempMessage(e){solving||(keybuffer=[],textMode=!0,titleScreen=!1,quittingMessageScreen=!1,messageselected=!1,ignoreNotJustPressedAction=!0,tryPlayShowMessageSound(),drawMessageScreen(e),canvasResize())}function processOutputCommands(e){for(var n=0;n<e.length;n++){var t=e[n];"f"===t.charAt(1)&&tryPlaySimpleSound(t),!1===unitTesting&&"message"==t&&showTempMessage(messagetext)}}function applyRandomRuleGroup(e,n){perfCounters.randoms++;for(var t=[],r=0;r<n.length;r++){var o=(c=n[r]).findMatches();if(o.length>0)for(var a=generateTuples(o),i=0;i<a.length;i++){var s=a[i];t.push([r,s])}}if(0===t.length)return!1;var l=t[Math.floor(RandomGen.uniform()*t.length)],c=n[r=l[0]];s=l[1];const u=e.delta_index(c.direction);var d=c.applyAt(e,s,!1,u);return c.queueCommands(),d}function applyRuleGroup(e){if(perfCounters.groups++,e[0].isRandom)return applyRandomRuleGroup(curLevel,e);for(var n=!1,t=!0,r=0,o=-1;t;){if(++r>200){logErrorCacheable("Got caught looping lots in a rule group :O",e[0].lineNumber,!0);break}t=!1;for(var a=0;a<e.length;a++){var i=e[a];if(i.tryApply(curLevel)?(i.isOnce||(t=!0),o=0):o++,o===e.length)break}t&&(n=!0,verbose_logging&&(debugger_turnIndex++,addToDebugTimeline(curLevel,-2)))}return n}function applyRules(e,n,t,r,o){perfCounters.tries++,playerPositions=getPlayerPositions();const a=[];let i=r>0,s=0;for(let c=r;c<e.length;){if(o&&o[c]);else{const u=e[c];i=applyRuleGroup(u)||i}if(i&&n[c]>=0){if(l())break}else if(gosubTarget>=0)a.push(c+1),c=gosubTarget,gosubTarget=-1,verbose_logging&&consolePrint(`Gosub to line ${e[c][0].lineNumber}`);else{if(c++,c==e.length&&i&&n[c]>=0&&l())break;for(;c==e.length||t.find((e=>e.groupNumber==c));){if(!(a.length>0)){c=e.length;break}c=a.pop(),verbose_logging&&consolePrint(`Gosub return to line ${e[c][0].lineNumber}`)}}function l(){if(c=n[c],i=!1,s++,s>200)return logErrorCacheable("got caught in an endless startloop...endloop vortex, escaping!",e[c][0].lineNumber,!0),!0}verbose_logging&&(debugger_turnIndex++,addToDebugTimeline(curLevel,-2))}}function resolveMovements(e,n){for(var t=!0;t;){t=!1;for(var r=0;r<e.n_tiles;r++)t=repositionEntitiesAtCell(r)||t}var o=!1;for(r=0;r<e.n_tiles;r++){var a=e.getCellInto(r,_o6),i=e.getMovements(r);if(!i.iszero()){var s=e.rigidMovementAppliedMask[r];if(!s.iszero()&&(i.iand(s),!i.iszero()))for(var l=0;l<e.layerCount;l++){if(0!==i.getshiftor(MOV_MASK,MOV_BITS*l)){var c=e.rigidGroupIndexMask[r].getshiftor(MOV_MASK,MOV_BITS*l);c--;var u=state.rigidGroupIndex_to_GroupIndex[c];!0!==n[u]&&(n[u]=!0,o=!0);break}}for(const e of state.sfx_MovementFailureMasks)if(a.get(e.objId)&&i.anyBitsInCommon(e.directionMask)){const n=getObject(e.objId);if(verbose_logging&&consolePrint(`Object "${state.idDict[n]}" can't move, playing seed "${seedsToPlay_CantMove[r]}"`),e.seed.startsWith("afx")){const t=getLayerMovement(i,n.layer);seedsToAnimate[r+","+e.objId]={kind:"cant",seed:e.seed,dir:t}}else-1===seedsToPlay_CantMove.indexOf(e.seed)&&seedsToPlay_CantMove.push(e.seed)}}for(l=0;l<STRIDE_MOV;l++)e.movements[l+r*STRIDE_MOV]=0;e.rigidGroupIndexMask[r].setZero(),e.rigidMovementAppliedMask[r].setZero()}return o}CellPattern.prototype.generateMatchString=function(){for(var e="(true",n=0;n<Math.max(STRIDE_OBJ,STRIDE_MOV);++n){var t="cellObjects"+n,r="cellMovements"+n,o=this.objectsPresent.data[n],a=this.objectsMissing.data[n],i=this.movementsPresent.data[n],s=this.movementsMissing.data[n];o&&(e+=o&o-1?"\t\t&& (("+t+"&"+o+")==="+o+")\n":"\t\t&& ("+t+"&"+o+")\n"),a&&(e+="\t\t&& !("+t+"&"+a+")\n"),i&&(e+=i&i-1?"\t\t&& (("+r+"&"+i+")==="+i+")\n":"\t\t&& ("+r+"&"+i+")\n"),s&&(e+="\t\t&& !("+r+"&"+s+")\n")}for(var l=0;l<this.anyObjectsPresent.length;l++){e+="\t\t&& (0";for(n=0;n<STRIDE_OBJ;++n){var c=this.anyObjectsPresent[l].data[n];c&&(e+="|(cellObjects"+n+"&"+c+")")}e+=")"}return e+="\t)"},CellPattern.prototype.generateMatchFunction=function(){for(var e="",n=1===STRIDE_OBJ?"":"*"+STRIDE_OBJ,t=0;t<STRIDE_OBJ;++t)e+="\tvar cellObjects"+t+" = objects[i"+n+(t?"+"+t:"")+"];\n";n=1===STRIDE_MOV?"":"*"+STRIDE_MOV;for(t=0;t<STRIDE_MOV;++t)e+="\tvar cellMovements"+t+" = movements[i"+n+(t?"+"+t:"")+"];\n";return(e+="return "+this.generateMatchString()+";")in matchCache?matchCache[e]:matchCache[e]=new Function("i","objects","movements",e)},CellPattern.prototype.replace=function(e,n){var t=this.replacement;if(null===t)return!1;var r=t.randomEntityMask,o=t.randomDirMask,a=t.objectsSet.cloneInto(_o1),i=t.objectsClear.cloneInto(_o2),s=t.movementsSet.cloneInto(_m1),l=t.movementsClear.cloneInto(_m2);if(l.ior(t.movementsLayerMask),!r.iszero()){for(var c=[],u=0;u<32*STRIDE_OBJ;u++)r.get(u)&&c.push(u);var d=c[Math.floor(RandomGen.uniform()*c.length)],h=state.idDict[d],g=state.objects[h];a.ibitset(d),i.ior(state.layerMasks[g.layer]),l.ishiftor(MOV_MASK,MOV_BITS*g.layer)}if(!o.iszero())for(var m=0;m<curLevel.layerCount;m++)if(o.get(MOV_BITS*m)){var f=Math.floor(4*RandomGen.uniform());s.ibitset(f+MOV_BITS*m)}var p=curLevel.getCellInto(n,_o2_5),v=curLevel.getMovements(n),_=p.cloneInto(_o3),b=v.cloneInto(_m3);p.iclear(i),p.ior(a),v.iclear(l),v.ior(s);var y=!1,w=0,S=0;if(e.isRigid){var k=state.groupNumber_to_RigidGroupIndex[e.groupNumber];k++;for(var E=new BitVec(STRIDE_MOV),T=0;T<curLevel.layerCount;T++)E.ishiftor(k,MOV_BITS*T);E.iand(t.movementsLayerMask),w=curLevel.rigidGroupIndexMask[n]||new BitVec(STRIDE_MOV),S=curLevel.rigidMovementAppliedMask[n]||new BitVec(STRIDE_MOV),E.bitsSetInArray(w.data)||t.movementsLayerMask.bitsSetInArray(S.data)||(w.ior(E),S.ior(t.movementsLayerMask),y=!0)}var M=!1;if(!_.equals(p)||!b.equals(v)||y){M=!0,y&&(curLevel.rigidGroupIndexMask[n]=w,curLevel.rigidMovementAppliedMask[n]=S);var C=p.cloneInto(_o4);C.iclear(_),sfxCreateMask.ior(C);for(let e=0;e<state.objectCount;++e)C.get(e)&&sfxCreateList.push({posIndex:n,objId:e});var R=_.cloneInto(_o5);R.iclear(p),sfxDestroyMask.ior(R);for(let e=0;e<state.objectCount;++e)R.get(e)&&sfxDestroyList.push({posIndex:n,objId:e});curLevel.setCell(n,p),curLevel.setMovements(n,v);var x=n/curLevel.height|0,L=n%curLevel.height;curLevel.colCellContents[x].ior(p),curLevel.rowCellContents[L].ior(p),curLevel.mapCellContents.ior(p)}return M},Rule.prototype.findMatches=function(){if(!this.ruleMask.bitsSetInArray(curLevel.mapCellContents.data))return[];const e=curLevel.delta_index(this.direction);debugSwitch.includes("masks")&&console.log(`Findmatches d=${e} dir=${this.direction} levobj=${curLevel.objects} levmov=${curLevel.movements}`);for(var n=[],t=this.cellRowMasks,r=this.cellRowMasks_Movements,o=0;o<this.patterns.length;o++){var a=this.patterns[o],i=this.cellRowMatches[o];if(1===this.ellipsisCount[o])var s=matchCellRowWildCard(this.direction,i,a,t[o],r[o],e,this.ellipsisCount[o]);else if(0===this.ellipsisCount[o])s=matchCellRow(this.direction,i,a,t[o],r[o],e,this.isGlobal);else s=matchCellRowWildCard(this.direction,i,a,t[o],r[o],e,this.ellipsisCount[o]);if(debugSwitch.includes("masks")){const e=t[o].format(),n=r[o].format(),a=curLevel.mapCellContents.format(),i=curLevel.mapCellContents_Movements.format();console.log(`cro=${e} crm=${n} lvo=${a} lvm=${i} => ${s}`)}if(0===s.length)return[];n.push(s)}return n},Rule.prototype.directional=function(){for(var e=0;e<state.rules.length;e++)for(var n=state.rules[e],t=0,r=0;r<n.length;r++)if(this.lineNumber===n[r].lineNumber&&t++,t>1)return!0;return!1},Rule.prototype.applyAt=function(e,n,t,r){var o=this;if(t)for(var a=0;a<this.patterns.length;a++)if(1===this.ellipsisCount[a]){if(0==this.cellRowMatches[a](this.patterns[a],n[a][0],n[a][1]+1,n[a][1],r,e.objects,e.movements).length)return!1}else if(2===this.ellipsisCount[a]){if(0==this.cellRowMatches[a](this.patterns[a],n[a][0],n[a][1]+n[a][2]+1,n[a][1]+n[a][2],n[a][1]+1,n[a][1],n[a][2]+1,n[a][2],r,e.objects,e.movements).length)return!1}else if(!this.cellRowMatches[a](this.patterns[a],n[a],r,e.objects,e.movements))return!1;var i=!1;const s=[];for(a=0;a<o.patterns.length;a++)for(var l=o.patterns[a],c=0,u=o.ellipsisCount[a]>0?n[a][0]:n[a],d=0;d<l.length;d++){var h=l[d];if(h!==ellipsisPattern)i=h.replace(o,u)||i,s.push(u),u+=r;else{var g=n[a][1+c];c++,!0,u+=r*g}}if(verbose_logging&&i){var m=dirMaskName[o.direction];o.directional()||(m="");var f=addToDebugTimeline(e,o.lineNumber);const n=s.map((n=>`(${1+n%e.width};${1+~~(n/e.width)})`)).join(", ");var p=debugSwitch.includes("gaploc")?` at ${n}`:"";consolePrint(`<font color="green">Rule <a onclick="jumpToLine(${o.lineNumber});"  href="javascript:void(0);">${o.lineNumber}</a> ${m} applied${p}.</font>`,!1,o.lineNumber,f)}return i},Rule.prototype.tryApply=function(e){perfCounters.rules++;const n=e.delta_index(this.direction);var t=this.findMatches();if(perfCounters.matches+=t.length,0===t.length)return!1;perfCounters.matched++;var r=!1;if(this.hasReplacements){perfCounters.replaces++;for(var o=generateTuples(t),a=0;a<o.length;a++){var i=o[a],s=a>0,l=this.applyAt(e,i,s,n);l&&perfCounters.replaced++,r=l||r}}return t.length>0&&this.queueCommands(),r},Rule.prototype.queueCommands=function(){var e=this.commands;if(perfCounters.commands+=e.length,0!=e.length){for(var n=curLevel.commandQueue.indexOf("cancel")>=0,t=curLevel.commandQueue.indexOf("restart")>=0,r=!1,o=!1,a=0;a<e.length;a++){var i=e[a][0];"cancel"===i?r=!0:"restart"===i&&(o=!0)}if(!n&&(!t||r)){(r||o)&&(curLevel.commandQueue=[],curLevel.commandQueueSourceRules=[],messagetext="",statusText="");for(a=0;a<e.length;a++){var s=e[a];if("log"!=s[0]){if(!(curLevel.commandQueue.indexOf(s[0])>=0))if("gosub"!=s[0]){if(curLevel.commandQueue.push(s[0]),curLevel.commandQueueSourceRules.push(this),verbose_logging){consolePrint(htmlColor("green",`Rule ${htmlJump(this.lineNumber)} triggers command ${s[0]}.`),!1,this.lineNumber,null)}if("message"==s[0]?messagetext=s[1]:"goto"==s[0]?gotoLevel(s[1]):"status"==s[0]?statusText=s[1]:"link"==s[0]&&gotoLink(),state.metadata.runtime_metadata_twiddling&&twiddleable_params.includes(s[0])&&(value=s[1],"wipe"==value?(delete state.metadata[s[0]],value=null):"default"==value&&(value=deepClone(state.default_metadata[s[0]])),null!=value&&(state.metadata[s[0]]=value),"zoomscreen"!==s[0]&&"flickscreen"!==s[0]||(twiddleMetaData(state,!0),canvasResize()),"smoothscreen"===s[0]&&(void 0!==value?(twiddleMetaData(state,!0),initSmoothCamera()):smoothscreen=!1,canvasResize()),twiddleMetadataExtras(),state.metadata.runtime_metadata_twiddling_debug)){var l="Metadata twiddled: Flag "+s[0]+" set to "+value;value!=s[1]&&(l+=" ("+s[1]+")"),consolePrintFromRule(l,this,!0)}}else gosubTarget=s[1]}else consolePrintFromRule(`${s[1]}`,this,!0)}}}};var playerPositions,playerPositionsAtTurnStart,sfxCreateMask=null,sfxDestroyMask=null,sfxCreateList=[],sfxDestroyList=[];function calculateRowColMasks(){for(var e=0;e<curLevel.mapCellContents.length;e++)curLevel.mapCellContents[e]=0,curLevel.mapCellContents_Movements[e]=0;for(e=0;e<curLevel.width;e++){curLevel.colCellContents[e].setZero(),curLevel.colCellContents_Movements[e].setZero()}for(e=0;e<curLevel.height;e++){curLevel.rowCellContents[e].setZero(),curLevel.rowCellContents_Movements[e].setZero()}for(e=0;e<curLevel.width;e++)for(var n=0;n<curLevel.height;n++){var t=n+e*curLevel.height,r=curLevel.getCellInto(t,_o9);curLevel.mapCellContents.ior(r),curLevel.rowCellContents[n].ior(r),curLevel.colCellContents[e].ior(r);var o=curLevel.getMovementsInto(t,_m1);curLevel.mapCellContents_Movements.ior(o),curLevel.rowCellContents_Movements[n].ior(o),curLevel.colCellContents_Movements[e].ior(o)}}var dirNames=["up","left","down","right","action","mouse","lclick","rclick"],perfCounters={};function processInput(e,n,t,r,o){perfCounters={start:Date.now(),rules:0,matched:0,matches:0,replaces:0,replaced:0,commands:0,randoms:0,groups:0,tries:0};const a=procInp(e,n,t,r,o);return perfCounters.elapsed=Date.now()-perfCounters.start,a}function procInp(e,n,t,r,o){t||(newMovedEntities={});if(againing=!1,null==r&&(r=backupLevel()),playerPositions=[],playerPositionsAtTurnStart=getPlayerPositions(),e<dirNames.length){verbose_logging&&(debugger_turnIndex++,addToDebugTimeline(curLevel,-2));const T=dirNames[e];if([0,1,2,3,4].includes(e))playerPositions=startMovement(dirMasks[T]);else if([6,7].includes(e)){moveEntitiesAtIndex(o,curLevel.getCell(o),dirMasks[T])}if(verbose_logging){const n=addToDebugTimeline(curLevel,-1);consolePrint(-1===e?"Turn starts with no input.":`Turn starts with input of ${T}.`,!1,null,n),consolePrint("Applying rules.")}var a=[];curLevel.commandQueue=[],curLevel.commandQueueSourceRules=[];var i=0,s=!1;const M={objects:new Int32Array(curLevel.objects),movements:new Int32Array(curLevel.movements),rigidGroupIndexMask:curLevel.rigidGroupIndexMask.concat([]),rigidMovementAppliedMask:curLevel.rigidMovementAppliedMask.concat([]),commandQueue:[],commandQueueSourceRules:[]};sfxCreateMask.setZero(),sfxDestroyMask.setZero(),sfxCreateList=[],sfxDestroyList=[],seedsToPlay_CanMove=[],seedsToPlay_CantMove=[],seedsToAnimate={},calculateRowColMasks();var l=[];statusText="";var c=0;do{if(s=!1,c++,applyRules(state.rules,state.loopPoint,state.subroutines,i,a),resolveMovements(curLevel,a)){if(s=!0,IDE){var u=[];for(var d in a)l.includes(d)||(u.push(d),l.push(d));var h=u.map((e=>state.rules[e][0].lineNumber)),g=h.length>1?"lines ":"line ";consolePrint(`Rigid movement application failed in rule-Group starting from ${g+=h.map((e=>`<a onclick="jumpToLine(${e});" href="javascript:void(0);">${e}</a>`)).join(", ")}, and will be disabled in resimulation. Rolling back...`)}curLevel.objects=new Int32Array(M.objects),curLevel.movements=new Int32Array(M.movements),curLevel.rigidGroupIndexMask=M.rigidGroupIndexMask.concat([]),curLevel.rigidMovementAppliedMask=M.rigidMovementAppliedMask.concat([]),curLevel.commandQueue=M.commandQueue.concat([]),curLevel.commandQueueSourceRules=M.commandQueueSourceRules.concat([]),sfxCreateMask.setZero(),sfxDestroyMask.setZero(),sfxCreateList=[],sfxDestroyList=[],verbose_logging&&s&&c>0&&(consolePrint("Relooping through rules because of rigid."),debugger_turnIndex++,addToDebugTimeline(curLevel,-2)),i=0}else{if(verbose_logging){var m=debug_visualisation_array[debugger_turnIndex].length+1;consolePrint("Processed movements.",!1,null,addToDebugTimeline(curLevel,m)),state.lateRules.length>0&&(debugger_turnIndex++,addToDebugTimeline(curLevel,-2),consolePrint("Applying late rules."))}applyRules(state.lateRules,state.lateLoopPoint,state.subroutines,0),i=0}}while(c<250&&s);if(c>=250)return consolePrint("looped through 250 times, gave up. Too many loops!"),applyRules(state.lateRules,state.lateLoopPoint,state.subroutines,0),i=0,backups.push(r),DoUndo(!0,!1),!1;if(curLevel.commandQueue.indexOf("undo")>=0)return verbose_logging&&(consoleCacheDump(),consolePrint("UNDO command executed, undoing turn.",!0)),messagetext="",statusText="",DoUndo(!0,!1,!0,!0,!0),!0;if(playerPositionsAtTurnStart.length>0&&void 0!==state.metadata.require_player_movement&&e>=0){var f=!1;for(c=0;c<playerPositionsAtTurnStart.length;c++){var p=playerPositionsAtTurnStart[c],v=curLevel.getCell(p);if(state.playerMask.bitsClearInArray(v.data)){f=!0;break}}if(!1===f)return verbose_logging&&(consolePrint("require_player_movement set, but no player movement detected, so cancelling turn."),consoleCacheDump()),addUndoState(r),DoUndo(!0,!1,!1),!1}if(curLevel.commandQueue.indexOf("cancel")>=0){if(verbose_logging)consoleCacheDump(),consolePrintFromRule("CANCEL command executed, cancelling turn.",S=curLevel.commandQueueSourceRules[curLevel.commandQueue.indexOf("cancel")],!0);t||processOutputCommands(curLevel.commandQueue);var _=curLevel.commandQueue.length>1;return addUndoState(r),DoUndo(!0,!1,!1,!1),tryPlayCancelSound(),_}if(curLevel.commandQueue.indexOf("restart")>=0){if(verbose_logging&&runrulesonlevelstart_phase)logWarning('A "restart" command is being triggered in the "run_rules_on_level_start" section of level creation, which would cause an infinite loop if it was actually triggered, but it\'s being ignored, so it\'s not.',(S=curLevel.commandQueueSourceRules[curLevel.commandQueue.indexOf("restart")]).lineNumber,!0);if(verbose_logging)consolePrintFromRule("RESTART command executed, reverting to restart state.",(S=curLevel.commandQueueSourceRules[curLevel.commandQueue.indexOf("restart")]).lineNumber),consoleCacheDump();return t||processOutputCommands(curLevel.commandQueue),addUndoState(r),t||DoRestart(!0),!0}if(curLevel.commandQueue.indexOf("quit")>=0&&!solving){if(verbose_logging)consolePrintFromRule("QUIT command executed, exiting level.",S=curLevel.commandQueueSourceRules[curLevel.commandQueue.indexOf("quit")]),consoleCacheDump();return void 0!==state.metadata.level_select?gotoLevelSelectScreen():goToTitleScreen(),messagetext="",statusText="",canvasResize(),!0}var b=!0;if(!winning&&curLevel.commandQueue.indexOf("nosave")>=0){if(verbose_logging)consolePrintFromRule("NOSAVE command executed, not storing current state to undo queue.",S=curLevel.commandQueueSourceRules[curLevel.commandQueue.indexOf("nosave")]);b=!1}var y=!1;for(c=0;c<curLevel.objects.length;c++)if(curLevel.objects[c]!==r.dat[c]){if(t)return verbose_logging&&consoleCacheDump(),addUndoState(r),DoUndo(!0,!1,!1),!0;-1!==e&&b?addUndoState(r):backups.length>0&&(backups[backups.length-1]=unconsolidateDiff(backups[backups.length-1],r)),y=!0,updateCameraPositionTarget();break}if(t&&curLevel.commandQueue.indexOf("win")>=0)return!0;if(t)return verbose_logging&&consoleCacheDump(),!1;for(c=0;c<seedsToPlay_CantMove.length;c++)playSeed(seedsToPlay_CantMove[c]);for(c=0;c<seedsToPlay_CanMove.length;c++)playSeed(seedsToPlay_CanMove[c]);for(const e of state.sfx_CreationMasks)if(sfxCreateMask.get(e.objId))if(e.seed.startsWith("afx"))for(const n of sfxCreateList)n.objId==e.objId&&(verbose_logging&&consolePrint(`Created object "${state.idDict[e.objId]}", playing seed "${e.seed}"`),seedsToAnimate[n.posIndex+","+n.objId]={kind:"create",seed:e.seed});else verbose_logging&&consolePrint(`Created object "${state.idDict[e.objId]}", playing seed "${e.seed}"`),playSeed(e.seed);for(const e of state.sfx_DestructionMasks)if(sfxDestroyMask.get(e.objId))if(e.seed.startsWith("afx"))for(const n of sfxDestroyList)n.objId==e.objId&&(verbose_logging&&consolePrint(`Destroyed object "${state.idDict[e.objId]}", playing seed "${e.seed}"`),seedsToAnimate[n.posIndex+","+n.objId]={kind:"destroy",seed:e.seed});else verbose_logging&&consolePrint(`Destroyed object "${state.idDict[e.objId]}", playing seed "${e.seed}"`),playSeed(e.seed);if(t||processOutputCommands(curLevel.commandQueue),!1===textMode&&(verbose_logging&&consolePrint("Checking win conditions."),void 0===n&&(n=!1),checkWin(n)),!winning){if(curLevel.commandQueue.indexOf("checkpoint")>=0){if(verbose_logging)consolePrintFromRule("CHECKPOINT command executed, saving current state to the restart state.",S=curLevel.commandQueueSourceRules[curLevel.commandQueue.indexOf("checkpoint")]);restartTarget=level4Serialization(),hasUsedCheckpoint=!0;var w=JSON.stringify(restartTarget);storage_set(document.URL+"_checkpoint",w),storage_set(document.URL,curLevelNo)}if(curLevel.commandQueue.indexOf("again")>=0&&y){var S=curLevel.commandQueueSourceRules[curLevel.commandQueue.indexOf("again")],k=verbose_logging,E=messagetext;verbose_logging=!1,processInput(-1,!0,!0)?((verbose_logging=k)&&consolePrintFromRule("AGAIN command executed, with changes detected - will execute another turn.",S),againing=!0,timer=0):(verbose_logging=k)&&consolePrintFromRule("AGAIN command not executed, it wouldn't make any changes.",S),verbose_logging=k,messagetext=E}}verbose_logging&&consolePrint("Turn complete."),currentMovedEntities=newMovedEntities,tweentimer=0,curLevel.commandQueue=[],curLevel.commandQueueSourceRules=[],debugSwitch.includes("anim")&&console.log(`Animate: ${JSON.stringify(seedsToAnimate)}`)}return verbose_logging&&consoleCacheDump(),winning&&(againing=!1),!0}function playSeed(e,n){e&&playSound(e,n)}function checkWin(e){if(levelEditorOpened&&(e=!0),curLevel.commandQueue.indexOf("win")>=0)return runrulesonlevelstart_phase?consolePrint("Win Condition Satisfied (However this is in the run_rules_on_level_start rule pass, so I'm going to ignore it for you.  Why would you want to complete a level before it's already started?!)"):verbose_logging&&!solving&&consolePrint("Win Condition Satisfied."),void(e||DoWin());var n=!1;if(state.winconditions.length>0){for(var t=!0,r=0;r<state.winconditions.length;r++){var o=state.winconditions[r],a=o[1],i=o[2],s=!0;const e=o[4]?e=>a.bitsSetInArray(e):e=>!a.bitsClearInArray(e),n=o[5]?e=>i.bitsSetInArray(e):e=>!i.bitsClearInArray(e);switch(o[0]){case-1:for(var l=0;l<curLevel.n_tiles;l++){if(e((u=curLevel.getCellInto(l,_o10)).data)&&n(u.data)){s=!1;break}}break;case 0:var c=!1;for(l=0;l<curLevel.n_tiles;l++){if(e((u=curLevel.getCellInto(l,_o10)).data)&&n(u.data)){c=!0;break}}!1===c&&(s=!1);break;case 1:for(l=0;l<curLevel.n_tiles;l++){var u;if(e((u=curLevel.getCellInto(l,_o10)).data)&&!n(u.data)){s=!1;break}}}!1===s&&(t=!1)}n=t}n&&(runrulesonlevelstart_phase?consolePrint("Win Condition Satisfied (However this is in the run_rules_on_level_start rule pass, so I'm going to ignore it for you.  Why would you want to complete a level before it's already started?!)"):verbose_logging&&!solving&&consolePrint("Win Condition Satisfied."),e||DoWin())}function DoWin(){if(!winning){if(againing=!1,tryPlayEndLevelSound(),linkStack.length>0)return returnLink(),void processInput(-1,!0);unitTesting?nextLevel():(winning=!0,timer=0)}}function nextLevel(){if(debugSwitch.includes("load")&&console.log("nextLevel()",`curLevelNo=${curLevelNo}`),againing=!1,messagetext="",statusText="",state&&state.levels&&curLevelNo>state.levels.length&&(curLevelNo=state.levels.length-1),ignoreNotJustPressedAction=!0,titleScreen&&titleMode<=1)if(linkStack=[],backups=[],isContinueOptionSelected())loadLevelFromStateOrTarget();else if(isNewGameOptionSelected())curLevelNo=0,curlevelTarget=null,void 0===state.metadata.level_select&&clearLocalStorage(),loadLevelFromStateOrTarget();else{if(!isLevelSelectOptionSelected())throw"next level";titleSelection=null,gotoLevelSelectScreen()}else if(hasUsedCheckpoint&&(curlevelTarget=null,hasUsedCheckpoint=!1),curLevelNo<state.levels.length-1){var e=!1,n=state.levels[Number(curLevelNo)].section,t=state.levels[Number(curLevelNo)+1].section;t!=n&&(setSectionSolved(state.levels[Number(curLevelNo)].section),solvedSections.length==state.sections.length&&null!=state.winSection?curLevelNo=state.winSection.firstLevel-1:"__WIN__"==t&&(gotoLevelSelectScreen(),e=!0)),e||(curLevelNo++,curlevelTarget=null,textMode=!1,titleScreen=!1,quittingMessageScreen=!1,loadLevelFromStateOrTarget())}else if(solvedSections.length==state.sections.length){if(void 0===state.metadata.level_select){try{storage_remove(document.URL),storage_remove(document.URL+"_checkpoint")}catch(e){}curLevelNo=0,curlevelTarget=null,goToTitleScreen()}else goToTitleScreen();tryPlayEndGameSound()}else null!=state.levels[Number(curLevelNo)].section&&setSectionSolved(state.levels[Number(curLevelNo)].section),gotoLevelSelectScreen();updateLocalStorage(),resetFlickDat(),canvasResize()}function loadLevelFromStateOrTarget(){null!==curlevelTarget?loadLevelFromStateTarget(state,curLevelNo,curlevelTarget):loadLevelFromState(state,curLevelNo)}function goToTitleScreen(){debugSwitch.includes("load")&&console.log("gotoTitleScreen()"),againing=!1,messagetext="",statusText="",titleScreen=!0,textMode=!0,hoverSelection=-1,doSetupTitleScreenLevelContinue(),state.metadata=deepClone(state.default_metadata),twiddleMetadataExtras(),null!==canvas&&regenSpriteImages(),levelSelectScrollPos=0,generateTitleScreen()}function resetFlickDat(){void 0!==state&&void 0!==state.metadata.flickscreen&&(oldflickscreendat=[0,0,Math.min(state.metadata.flickscreen[0],curLevel.width),Math.min(state.metadata.flickscreen[1],curLevel.height)])}function updateLocalStorage(){if(!(linkStack.length>0)){debugSwitch.includes("menu")&&console.log("updateLocalStorage",curlevelTarget);try{if(storage_set(document.URL,curLevelNo),null!==curlevelTarget){restartTarget=level4Serialization();var e=JSON.stringify(restartTarget);storage_set(document.URL+"_checkpoint",e)}else storage_remove(document.URL+"_checkpoint")}catch(e){}}}function setSectionSolved(e){if(null!=e&&null!=e&&"__WIN__"!=e.name&&!(solvedSections.indexOf(e)>=0))try{window.localStorage&&(solvedSections.push(e),storage_set(document.URL+"_sections",JSON.stringify(solvedSections)))}catch(e){}}function clearLocalStorage(){debugSwitch.includes("menu")&&console.log("clearLocalStorage"),curLevelNo=0,curlevelTarget=null,solvedSections=[];try{window.localStorage&&(storage_remove(document.URL),storage_remove(document.URL+"_checkpoint"),storage_remove(document.URL+"_sections"))}catch(e){}}var cameraPositionTarget=null,cameraPosition={x:0,y:0};function initSmoothCamera(){if(void 0!==state&&void 0!==state.metadata.smoothscreen){screenwidth=state.metadata.smoothscreen.screenSize.width,screenheight=state.metadata.smoothscreen.screenSize.height;var e=state.metadata.smoothscreen.boundarySize,n=state.metadata.smoothscreen.flick,t=getPlayerPositions();if(t.length>0){var r={x:t[0]/curLevel.height|0,y:t[0]%curLevel.height|0};cameraPositionTarget={x:n?getFlickCameraPosition(r.x,curLevel.width,screenwidth,e.width):getCameraPosition(r.x,curLevel.width,screenwidth),y:n?getFlickCameraPosition(r.y,curLevel.height,screenheight,e.height):getCameraPosition(r.y,curLevel.height,screenheight)},cameraPosition.x=cameraPositionTarget.x,cameraPosition.y=cameraPositionTarget.y}}}function getCameraPosition(e,n,t){return Math.min(Math.max(e,Math.floor(t/2)),n-Math.ceil(t/2))}function getFlickCameraPosition(e,n,t,r){var o=Math.floor(t/2)-Math.floor(r/2),a=e-o,i=Math.floor(a/r),s=Math.floor((n-Math.ceil(t/2)-Math.floor(r/2)-o)/r);return Math.min(Math.max(i,0),s)*r+Math.floor(t/2)}function updateCameraPositionTarget(){var e=state.metadata.smoothscreen,n=getPlayerPositions();if(e&&0!==n.length){var t={x:n[0]/curLevel.height|0,y:n[0]%curLevel.height|0};["x","y"].forEach((function(n){var r="x"===n?screenwidth:screenheight,o="x"===n?"width":"height",a=curLevel[o],i=e.boundarySize[o],s=t[n]-cameraPositionTarget[n],l=Math.sign(s),c=l>0?Math.ceil(i/2):-(Math.floor(i/2)+1);Math.abs(s)-Math.abs(c)>=0&&(cameraPositionTarget[n]=e.flick?getFlickCameraPosition(t[n],a,r,i):getCameraPosition(t[n]-c+l,a,r))}))}}function IsMouseGameInputEnabled(){return state.metadata.mouse_left||state.metadata.mouse_up||state.metadata.mouse_drag||state.metadata.mouse_clicks}const MAX_ERRORS_FOR_REAL=100;let compiling=!1,errorStrings=[],errorCount=0,caseSensitive=!1;const reg_commandwords=/^(afx[\w:=+-.]+|sfx\d+|cancel|checkpoint|restart|win|message|again|undo|nosave|quit|zoomscreen|flickscreen|smoothscreen|again_interval|realtime_interval|key_repeat_interval|noundo|norestart|background_color|text_color|goto|message_text_align|status|gosub|link|log)$/i,reg_name=/^[\p{L}\p{N}_$]+/u,reg_objectname=/^[\p{L}\p{N}_$]+(:[\p{L}\p{N}_$]+)*/u,reg_objectnamerel=/^[\p{L}\p{N}_$]+(:[<>v^]|:[\p{L}\p{N}_$]+)*$/u,reg_objmodi=/^(canvas|copy|flip|rot|scale|shift|text|translate):/i,commandwords_table=["cancel","checkpoint","restart","win","message","again","undo","nosave","quit","zoomscreen","flickscreen","smoothscreen","again_interval","realtime_interval","key_repeat_interval","noundo","norestart","background_color","text_color","goto","message_text_align","status","gosub"],commandargs_table=["message","goto","status","gosub","log"],twiddleable_params=["background_color","text_color","key_repeat_interval","realtime_interval","again_interval","flickscreen","zoomscreen","smoothscreen","noundo","norestart","message_text_align"],soundverbs_directional=["move","cantmove"],soundverbs_other=["create","destroy"];let soundverbs_movement=["action"],directions_table=["action","up","down","left","right","^","v","<",">","moving","stationary","parallel","perpendicular","horizontal","orthogonal","vertical","no","randomdir","random"],directions_only=[">","<","^","v","up","down","left","right","action","moving","stationary","no","randomdir","random","horizontal","vertical","orthogonal","perpendicular","parallel"];const mouse_clicks_table=["lclick","rclick"],clockwiseDirections=["up","right","down","left",">","v","<","^"],cwdIndexOf=e=>clockwiseDirections.indexOf(e)%4;function TooManyErrors(){throw consolePrint("Too many errors/warnings; aborting compilation.",!0),new Error("Too many errors/warnings; aborting compilation.")}function htmlJump(e,n){return n?htmlClass(n,htmlJump(e)):`<a onclick="jumpToLine(${e});"  href="javascript:void(0);">${e}</a>`}function htmlColor(e,n){return`<font color="${e}">${n}</font>`}function htmlClass(e,n){return`<span class="${e}">${n}</span>`}function errorCase(e){return caseSensitive?e:e?e.toUpperCase():"<null>"}function logErrorCacheable(e,n,t){if(compiling||t){if(void 0===n)return logErrorNoLine(e,t);var r='<a onclick="jumpToLine('+n.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+n.toString()+'</span></a> : <span class="errorText">'+e+"</span>";errorStrings.indexOf(r)>=0&&!t||(consolePrint(r),errorStrings.push(r),errorCount++,errorStrings.length>MAX_ERRORS_FOR_REAL&&TooManyErrors())}}function logError(e,n,t){if(compiling||t){if(void 0===n)return logErrorNoLine(e,t);var r='<a onclick="jumpToLine('+n.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+n.toString()+'</span></a> : <span class="errorText">'+e+"</span>";errorStrings.indexOf(r)>=0&&!t||(consolePrint(r,!0),errorStrings.push(r),errorCount++,errorStrings.length>MAX_ERRORS_FOR_REAL&&TooManyErrors())}}function logWarning(e,n,t){if(compiling||t){if(void 0===n)return logWarningNoLine(e,t);var r='<a onclick="jumpToLine('+n.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+n.toString()+'</span></a> : <span class="warningText">'+e+"</span>";errorStrings.indexOf(r)>=0&&!t||(consolePrint(r,!0),errorStrings.push(r),errorStrings.length>MAX_ERRORS_FOR_REAL&&TooManyErrors())}}function logWarningNoLine(e,n,t=!1){if(compiling||n){var r='<span class="warningText">'+e+"</span>";errorStrings.indexOf(r)>=0&&!n||(consolePrint(r,!0),errorStrings.push(r),errorStrings.length>MAX_ERRORS_FOR_REAL&&TooManyErrors()),t&&errorCount++}}function logErrorNoLine(e,n){if(compiling||n){var t='<span class="errorText">'+e+"</span>";errorStrings.indexOf(t)>=0&&!n||(consolePrint(t,!0),errorStrings.push(t),errorCount++,errorStrings.length>MAX_ERRORS_FOR_REAL&&TooManyErrors())}}"function"!=typeof Object.assign&&(Object.assign=function(e){"use strict";if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),t=1;t<arguments.length;t++){var r=arguments[t];if(null!=r)for(var o in r)r.hasOwnProperty(o)&&(n[o]=r[o])}return n});var codeMirrorFn=function(){"use strict";const e=["objects","legend","sounds","collisionlayers","rules","winconditions","tags","mappings","levels"],n=/[\=]+/,t=/^(sfx\d+|undo|restart|titlescreen|startgame|cancel|endgame|startlevel|endlevel|showmessage|closemessage|pausescreen)\b/i,r=/^(startloop|endloop)$/,o=/^(up|down|left|right|horizontal|vertical|orthogonal|late|rigid)$/,a=/^(up|down|left|right|horizontal|vertical|orthogonal)\b/i,i=["checkpoint","objects","collisionlayers","legend","sounds","rules","winconditions","levels","|","[","]","up","down","left","right","late","rigid","^","v",">","<","no","randomdir","random","horizontal","vertical","any","all","no","some","moving","stationary","parallel","perpendicular","action","message","move","create","destroy","cantmove","sfx0","sfx1","sfx2","sfx3","Sfx4","sfx5","sfx6","sfx7","sfx8","sfx9","sfx10","cancel","checkpoint","restart","win","message","again","undo","restart","titlescreen","startgame","cancel","endgame","startlevel","endlevel","showmessage","closemessage"],s=["allow_undo_level","auto_level_titles","case_sensitive","continue_is_level_select","debug","level_select","level_select_lock","mouse_clicks","noaction","nokeyboard","norepeat_action","norestart","noundo","require_player_movement","run_rules_on_level_start","runtime_metadata_twiddling","runtime_metadata_twiddling_debug","scanline","skip_title_screen","smoothscreen_debug","status_line","throttle_movement","verbose_logging"],l=["title","author","homepage","custom_font","text_controls","text_message_continue","debug_switch"],c=["again_interval","animate_interval","font_size","key_repeat_interval","level_select_unlocked_ahead","level_select_unlocked_rollover","local_radius","realtime_interval","tween_length","tween_snap"],u=["background_color","color_palette","flickscreen","level_select_solve_symbol","keyhint_color","message_text_align","mouse_drag","mouse_left","mouse_rdrag","mouse_right","mouse_rup","mouse_up","sitelock_hostname_whitelist","sitelock_origin_whitelist","sprite_size","text_color","tween_easing","zoomscreen","author_color","title_color"],d=["game_uri","level_title_style","show_level_title_in_menu"],h=["smoothscreen","puzzlescript","youtube"],g=[s,l,c,u,h],m=["black","white","darkgray","lightgray","gray","grey","darkgrey","lightgrey","red","darkred","lightred","brown","darkbrown","lightbrown","orange","yellow","green","darkgreen","lightgreen","blue","lightblue","darkblue","purple","pink","transparent"];let f=/[^\(]+/;function p(e,n,t,r){if(n in e.objects)return[n];for(const r of e.legend_synonyms)if(r[0]==n)return p(e,r[1],t);for(const o of e.legend_aggregates)if(o[0]==n)return t||r(n),o.slice(1).flatMap((n=>p(e,n,!1)));for(const o of e.legend_properties)if(o[0]==n)return t&&r(n),o.slice(1).flatMap((n=>p(e,n,!0)));return logError(`Cannot expand symbol "${errorCase(n)}"`,e.lineNumber),[n]}function v(e,n,t){function r(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}const o=e.case_sensitive?new RegExp("\\b"+r(n)+"\\b"):new RegExp("\\b"+r(n)+"\\b","i");var a=e.mixedCase.match(o);null!=a&&(e.original_case_names[n]=a[0],e.original_line_numbers[n]=t)}function _(e,n,t,r){debugSwitch.includes("alias")&&console.log(`Create '${n}' as alias for '${t}'`);const o=[n,t];o.lineNumber=r,e.legend_synonyms.push(o)}class b{tokens=[];constructor(e,n){this.stream=e,this.state=n}pushToken(e,n){this.tokens.push({text:e,kind:n,pos:this.stream.pos}),this.matchPos=this.stream.pos}pushTokens(e){this.tokens.push(e)}get tokens(){return this.tokens}pushBack(){this.stream.pos=this.matchPos}check(e){const n=this.stream.match(e,!1);return n?n[0]:null}matchComment(){for(;;){const e=w(this.stream,this.state);if(!e)break;this.pushToken(e,"comment")}}matchEol(){return this.matchComment(),this.stream.eol()}matchEolSemi(){return this.matchComment(),"//"==this.state.commentStyle&&this.match(/^;/)?(this.pushToken(";","SEMICOLON"),!0):this.stream.eol()}next(){return this.stream.next()}peek(){return this.stream.peek()}match(e,n=!1){this.matchPos=this.stream.pos;const t=this.stream.match(e);return t&&this.stream.eatSpace(),t?n?t[0].toLowerCase():t[0]:null}matchAll(){return(this.match(/.*/)||"").trim()}matchNotComment(){return(this.match(f)||"").trim()}matchToken(e){return this.match(/^\S+/,e)}matchObjectGlyph(e){return this.match(/^\S/,e)}}let y=0;function w(e,n){if(e.match(/\s*/),e.eol())return n.commentLevel>0?"":null;if(!n.commentStyle&&e.match(/^(\/\/)|\(/,!1)&&(e.match(/^\//,!1)?(n.commentStyle="//",f=/(.(?!\/\/))+|[^\(]+/):n.commentStyle="()"),"//"==n.commentStyle&&e.match("//",!1))return e.match(/.*/)[0];if(0==n.commentLevel&&"("!=e.peek())return null;const t=e.pos;do{if(e.match(/[^\(\)]*/),e.eol())break;e.match("(")?n.commentLevel++:e.match(")")&&n.commentLevel--}while(n.commentLevel>0);return e.eatSpace(),e.string.slice(t,e.pos)}function S(e){if("levels"==e.section){const n=e.levels.at(-1);n&&n.length>0&&e.levels.push([])}else"objects"==e.section&&(R(e),e.objects_section=0)}function k(n,t){const r=function(e,n,t){y=e.pos;const r=e.match(n);return r&&e.eatSpace(),r?t?r[0].toLowerCase():r[0]:null}(n,/^\w+/,!0);return r&&e.includes(r)&&function(e,n){const t=e.pos;w(e,n);const r=e.eol();return e.pos=t,r}(n,t)?(w(n,t),""===t.section?t.commentStyle||="()":"objects"===t.section?R(t):"legend"===t.section?(t.names=[],t.names.push(...Object.keys(t.objects)),t.names.push(...t.legend_synonyms.map((e=>e[0]))),t.names.push(...t.legend_aggregates.map((e=>e[0]))),t.names.push(...t.legend_properties.map((e=>e[0])))):"levels"===r&&(t.abbrevNames=[],t.abbrevNames.push(...Object.keys(t.objects)),t.abbrevNames.push(...t.legend_synonyms.map((e=>e[0]))),t.abbrevNames.push(...t.legend_aggregates.map((e=>e[0])))),t.section=r,t.line_should_end=!0,t.line_should_end_because=`a section name ("${t.section.toUpperCase()}")`,t.visitedSections.push(t.section),!0):(function(e){e.pos=y}(n),!1)}function E(e,n){const t=new b(e,n);let r=null;return(r=function(){let e,r,o="ERROR";const a=[];if(e=t.match(/^[a-z_]+/i,!0)){if(n.metadata_lines[r]){var i=n.metadata_lines[e];return logWarning(`You've already defined a "${errorCase(e)}" in the prelude on line ${htmlJump(i)}.`,n.lineNumber),void t.pushToken(e,"ERROR")}if(d.includes(e))return logWarning(`Option ${errorCase(e)} is not implemented, but may be in the future. Let me know if you really need it.`,n.lineNumber),void t.pushToken(e,"ERROR");if(l.includes(e))r=e,t.pushToken(e,"METADATA"),e=t.matchAll(),t.pushToken(e,"METADATATEXT"),a.push(e);else if(g.some((n=>n.includes(e))))for(r=e,t.pushToken(e,"METADATA");!t.matchEol()&&(e=t.match(/^\S+/,!0));)o=e in colorPalettes.arnecolors?"COLOR COLOR-"+errorCase(e):"transparent"===e?"COLOR FADECOLOR":e.match(/^#[0-9a-fA-F]+$/)?"MULTICOLOR"+e:"METADATATEXT",t.pushToken(e,o),a.push(e);else logWarning(`Prelude option "${errorCase(e)}" is not one I know, so I'm going to ignore it. Hope that works for you.`,n.lineNumber),t.pushToken(e,"ERROR")}if(e=t.matchToken())logError(`Unrecognised stuff in the prelude: "${errorCase(e)}".`,n.lineNumber),t.pushToken(e,"ERROR");else if(r)return function(e,t){let r;if(n.metadata_lines[e]=n.lineNumber,s.includes(e))t.length>1?logError(`Prelude option "${errorCase(e)}" doesn't take any parameters, but you went and gave it "${t.join()}".`,n.lineNumber):r=[e,!0];else if(c.includes(e))1!=t.length||NaN==parseFloat(t[0])?logError(`Prelude option "${errorCase(e)}" requires one numeric argument.`,n.lineNumber):r=[e,parseFloat(t[0])];else if(u.includes(e)||l.includes(e))1==t.length||e.startsWith("mouse")?e.includes("_color")&&!isColor(t[0])?logError(`Prelude option "${errorCase(e)}" in incorrect format - found ${t[0]}, but I expect a color name (like 'pink') or hex-formatted color (like '#1412FA'). A default will be used.`,n.lineNumber):r=[e,t[0]]:logError(`Prelude option "${errorCase(e)}" requires exactly one argument, but you gave it ${t.length}.`,n.lineNumber);else{if(!h.includes(e))throw"args";t.length<1?logError(`Prelude option "${errorCase(e)}" has no arguments, but it needs at least one.`,n.lineNumber):r=[e,t.join(" ")]}return r}(r,a)}())&&function(e,n){const t=n[0];if("case_sensitive"==t)e.case_sensitive=!0,caseSensitive=!0,Object.keys(e.metadata).some((e=>l.includes(e)))&&logWarningNoLine("Please make sure that CASE_SENSITIVE comes before any case sensitive prelude setting.",!1,!1);else if("debug_switch"==t)debugSwitch=n[1];else if("mouse_clicks"!=t||directions_table.includes(mouse_clicks_table[0]))if("sprite_size"==t){const r=n[1].split("x").map((e=>parseInt(e)));1!=r.length&&2!=r.length?logError(`MetaData "${errorCase(t)}" requires an argument of numbers like 8x8 or 10, not ${n[1]}.`,e.lineNumber):e.sprite_size=r[0]}else{if("youtube"==t)return void logWarning("Unfortunately, YouTube support hasn't been working properly for a long time - it was always a hack and it hasn't gotten less hacky over time, so I can no longer pretend to support it.",e.lineNumber);if("game_uri"==t)return void logWarning(`Setting "${errorCase(t)}" is an experimental Pattern:Script feature. Do not use.`,e.lineNumber)}else directions_table.push(...mouse_clicks_table),directions_only.push(...mouse_clicks_table),soundverbs_movement.push(...mouse_clicks_table);e.metadata.push(...n)}(n,r),t.matchEol()||t.pushToken(t.matchAll(),"ERROR"),t.tokens}function T(e,n){const t=new b(e,n),r={};return function(){let e;if(!(e=t.match(reg_name,!n.case_sensitive)))return e=t.matchToken(),logError(`Expected a name for a new tag, but found "${errorCase(e)}".`,n.lineNumber),void t.pushToken(e,"ERROR");r.id=e,isAlreadyDeclared(n,e)||e.match(/^(player|background)$/i)?(logError(`You cannot define a tag called "${errorCase(e)}" because the name is already in use.`,n.lineNumber),t.pushToken(e,"ERROR")):t.pushToken(e,"NAME");if(t.matchComment(),!(e=t.match(/^=/,!0)))return e=t.matchToken(),logError(`Expected an equals sign "=" after the tag name but got "${errorCase(e)}".`,n.lineNumber),void t.pushToken(e,"ERROR");t.pushToken(e,"ASSIGNMENT");t.matchComment(),r.members=[];for(;;){if(!(e=t.match(reg_name,!n.case_sensitive)))return e=t.matchToken(),logError(`Expected a name for a new tag member, but found "${errorCase(e)}".`,n.lineNumber),void t.pushToken(e,"ERROR");if(r.members.push(e),t.pushToken(e,"NAME"),t.matchEol())break}return!t.tokens.some((e=>"ERROR"==e.kind))}()&&(n.tags[r.id]=r.members.map((e=>o(e))).flat()),t.matchEol()||t.pushToken(t.matchAll(),"ERROR"),t.tokens;function o(e){const t=[];return Object.hasOwn(n.tags,e)?t.push(...n.tags[e].map((e=>o(e))).flat()):t.push(e),t}}function M(e,n){const t=new b(e,n),r=[],o=n.objects[n.objects_candname];return function(){let a,i="ERROR";if(a=t.match(/^text:/i,!1)){t.pushToken(a,"LOGICWORD"),a=t.matchAll();const e=1==o.colors.length?`COLOR COLOR-${o.colors[0].toUpperCase()}`:"ERROR";return t.pushToken(a,e),r.text=a,n.objects_section=0,!0}if(a=t.match(/^\{[^}]*\}/,!1))return logError(`This ${a} looks rather like a piece of JSON. Did you maybe leave out "CANVAS:"?`,n.lineNumber),t.pushToken(a,i),t.pushToken(t.matchAll(),i),!1;for(;!e.eol();){let e=t.next(),a="ERROR",i=-1;if(e.match(/\s/))break;"."==e?a="COLOR FADECOLOR":e.match(/[0-9a-zA-Z]/)?(i=e<="9"?+e:10+e.toLowerCase().charCodeAt(0)-97,o.colors[i]?a="COLOR BOLDCOLOR COLOR-"+o.colors[i].toUpperCase():logError(`Trying to access color number ${i+1} from the color palette of sprite ${n.objects_candname}, but there are only ${o.colors.length} defined in it."`,n.lineNumber)):logError(`Invalid character "${errorCase(e)}" in sprite for ${n.objects_candname}`,n.lineNumber),t.pushToken(e,a),r.push(i)}return t.matchEol(),!t.tokens.some((e=>"ERROR"==e.kind))}()&&(r.text?o.spritetext=r.text:o.spritematrix=(o.spritematrix||[]).concat([r])),t.matchEol()||t.pushToken(t.matchAll(),"ERROR"),t.tokens}function C(e,n){const t=n.objects_candname,r=n.objects[t];if(!r)throw"obj";const o=new b(e,n),a={transforms:[]};return function(){const e=/^[\p{L}\p{N}_$:<>^]+/u;for(;!o.matchEolSemi();){let t=null,r="ERROR";if(t=o.match(/^copy:/i))a.cloneSprite?logError(`You already assigned a sprite source for "${errorCase(a.candname)}", you can't have more than one!`,n.lineNumber):r="KEYWORD",o.pushToken(t,r),o.matchComment(),r="ERROR",(t=o.match(reg_objectname,!n.case_sensitive))?t==a.candname?logError(`You attempted to set the sprite "${errorCase(t)}" to copy from itself! Please don't.`,n.lineNumber):isAlreadyDeclared(n,t)||createObjectRef(n,t)?(r="NAME",a.cloneSprite=t):logError(`You're trying to copy from "${errorCase(t)}" but it's not defined anywhere.`,n.lineNumber):logError("Missing sprite to copy from.",n.lineNumber),o.pushToken(t,r);else if(t=o.match(/^scale:/i)){o.pushToken(t,"KEYWORD"),o.matchComment(),t=o.match(/^[0-9.]+/);const e=parseFloat(t);NaN==e?logError("Scale requires a numeric argument.",n.lineNumber):(a.scale=e,r="METADATATEXT"),o.pushToken(t,r)}else if(t=o.match(/^flip:/i)){o.pushToken(t,"KEYWORD"),o.matchComment(),t=o.match(e,!0);const s=i(t);null==s?logError(`Flip requires a direction or tag argument, but you gave it ${errorCase(t)}.`,n.lineNumber):(a.transforms.push(["flip",s]),r="METADATATEXT"),o.pushToken(t,r)}else if(t=o.match(/^[|-]/))o.pushToken(t,"KEYWORD"),o.matchComment(),a.transforms.push(["flip","-"==t?">":"v"]);else if(t=o.match(/^shift:/i)){o.pushToken(t,"KEYWORD"),o.matchComment(),t=o.match(e,!0);const s=t?t.split(":"):[],l=i(s[0]),c=s[1]?+s[1]:1;s.length<=2&&l&&c?(a.transforms.push(["shift",l,c]),r="METADATATEXT"):logError(`Shift requires a direction or tag argument and optionally how many, but you gave it ${errorCase(t)}.`,n.lineNumber),o.pushToken(t,r)}else if(t=o.match(/^translate:/i)){o.pushToken(t,"KEYWORD"),o.matchComment(),t=o.match(e,!0);const s=t?t.split(":"):[],l=i(s[0]),c=s[1]?+s[1]:null;2==s.length&&l&&c?(a.transforms.push(["translate",l,+s[1]]),r="METADATATEXT"):logError(`Translate requires two arguments, a direction or tag and an amount, not ${errorCase(t)}.`,n.lineNumber),o.pushToken(t,r)}else if(t=o.match(/^rot:/i)){o.pushToken(t,"KEYWORD"),o.matchComment(),t=o.match(e,!0);const s=t?t.split(":"):[];1==s.length&&s.unshift("up");const l=i(s[0]),c=i(s[1]);s.length<=2&&l&&c?(a.transforms.push(["rot",l,c]),r="METADATATEXT"):logError(`For rot: you need 1 or 2 direction or tag arguments, but you gave it ${t?errorCase(t):"neither"}.`,n.lineNumber),o.pushToken(t,r)}else if(t=o.match(/^canvas:/i)){if(o.pushToken(t,"KEYWORD"),o.matchComment(),a.vector={type:"canvas",data:[],h:1,w:1},t=o.match(/^[0-9,]+/,!0)){const e=t&&t.split(",");e.length>=1&&e.length<=2?(a.vector.w=~~e[0],a.vector.h=~~(e[1]||e[0]),r="METADATATEXT"):logError(`Canvas size has to be specified as a number or number,number, not ${errorCase(t)}.`,n.lineNumber),o.pushToken(t,r)}}else{if(!(t=o.matchToken()))throw"obj-modi";logError(`Invalid token in OBJECT modifier section: "${errorCase(t)}".`,n.lineNumber),o.pushToken(t,"ERROR")}}return!o.tokens.some((e=>"ERROR"==e.kind))}()&&function(){a.cloneSprite&&(r.cloneSprite=a.cloneSprite);a.scale&&(r.scale=a.scale);a.vector&&(r.vector=a.vector);a.transforms&&r.transforms.push(...a.transforms)}(),o.tokens;function i(e){return Object.hasOwn(n.tags,e)?n.tags[e].every((e=>clockwiseDirections.includes(e)))?e:null:clockwiseDirections.includes(e)?e:null}}function R(e){const n=e.objects_candname;if(!(n&&(t=n,t.split(":").length>1)))return;var t;const r=e.objects[n],o=expandObjectDef(e,n,r);if(o){for(const[n,t]of o)Object.hasOwn(e.objects,n)||(e.objects[n]=t,v(e,n,e.lineNumber));const t=[n,...o.map((e=>e[0]))];t.lineNumber=r.lineNumber,delete e.objects[n],e.objects_candname="",e.legend_properties.push(t)}}return{copyState:function(e){return{original_case_names:Object.assign({},e.original_case_names),original_line_numbers:Object.assign({},e.original_line_numbers),lineNumber:e.lineNumber,objects:deepClone(e.objects),collisionLayers:e.collisionLayers.map((e=>e.slice())),collisionLayerGroups:e.collisionLayerGroups.slice(),commentLevel:e.commentLevel,commentStyle:e.commentStyle,section:e.section,visitedSections:e.visitedSections.slice(),line_should_end:e.line_should_end,line_should_end_because:e.line_should_end_because,sol_after_comment:e.sol_after_comment,objects_candname:e.objects_candname,objects_section:e.objects_section,objects_spritematrix:e.objects_spritematrix.slice(),tokenIndex:e.tokenIndex,current_line_wip_array:e.current_line_wip_array.slice(),mixedCase:e.mixedCase,legend_synonyms:e.legend_synonyms.map((e=>e.slice())),legend_aggregates:e.legend_aggregates.map((e=>e.slice())),legend_properties:e.legend_properties.map((e=>e.slice())),tags:Object.assign({},e.tags),mappings:Object.assign({},e.mappings),sounds:e.sounds.map((e=>e.slice())),rules:e.rules.map((e=>e.slice())),names:e.names.slice(),winconditions:e.winconditions.slice(),original_case_names:Object.assign({},e.original_case_names),original_line_numbers:Object.assign({},e.original_line_numbers),abbrevNames:e.abbrevNames.slice(),metadata:e.metadata.slice(),metadata_lines:Object.assign({},e.metadata_lines),sprite_size:e.sprite_size,case_sensitive:e.case_sensitive,levels:e.levels.map((e=>e.slice())),STRIDE_OBJ:e.STRIDE_OBJ,STRIDE_MOV:e.STRIDE_MOV}},blankLine:function(e){S(e)},token:function(e,s){if(s.current_line_wip_array.length>0&&!["rules"].includes(s.section))return h();var l=e.sol();if(l&&(s.mixedCase=e.string,s.current_line_wip_array=[],s.original_line=e.string,s.case_sensitive||(e.string=e.string.toLowerCase()),s.tokenIndex=0,s.line_should_end=!1),s.sol_after_comment&&(l=!0,s.sol_after_comment=!1),-4!==s.tokenIndex&&null!=w(e,s))return s.sol_after_comment=s.sol_after_comment||l,"comment";if(e.eatWhile(/[ \t]/),l&&e.eol())return S(s);if("()"===s.commentStyle&&e.match(")"))return logWarning("You're trying to close a comment here, but I can't find any opening bracket to match it? [This is highly suspicious; you probably want to fix it.]",s.lineNumber),e.skipToEnd(),"ERROR";if("//"===s.commentStyle&&e.match(/[\(\)]/))return logWarning("You're trying to use the wrong type of comment here.[This is highly suspicious; you probably want to fix it.]",s.lineNumber),e.skipToEnd(),"ERROR";if(s.line_should_end&&!e.eol())return logError("Only comments should go after "+s.line_should_end_because+" on a line.",s.lineNumber),e.skipToEnd(),"ERROR";if(l&&e.match(n,!0))return s.line_should_end=!0,s.line_should_end_because="a bunch of equals signs ('===')","EQUALSBIT";if(l&&k(e,s))return"HEADER";if(e.eol())return null;switch(s.section){case"":return e.string=s.mixedCase,s.current_line_wip_array=E(e,s),h();case"tags":return s.current_line_wip_array=T(e,s),h();case"mappings":return 0==s.objects_section?(s.objects_candname=null,s.current_line_wip_array=function(e,n){const t=new b(e,n),r={};return function(){let e;return t.matchComment(),(e=t.match(reg_name,!n.case_sensitive))?(r.lhs=e,"tag"!=isDeclaredAs(n,e)?(logError(`Expected a TAG name but "${errorCase(e)}" is not one.`,n.lineNumber),t.pushToken(e,"ERROR")):t.pushToken(e,"NAME"),t.matchComment(),(e=t.match(/^=>/))?(t.pushToken(e,"ASSIGNMENT"),t.matchComment(),(e=t.match(reg_name,!n.case_sensitive))?(r.rhs=e,isAlreadyDeclared(n,e)?(logError(`You cannot define a mapping called "${errorCase(e)}" because the name is already in use.`,n.lineNumber),t.pushToken(e,"ERROR")):t.pushToken(e,"NAME"),t.matchComment(),(e=t.matchToken())?(logError(`Unrecognised stuff in a mapping: "${errorCase(e)}".`,n.lineNumber),void t.pushToken(e,"ERROR")):!t.tokens.some((e=>"ERROR"==e.kind))):(e=t.matchToken(),logError(`Expected a name for a mapping, but got "${errorCase(e)}" instead.`,n.lineNumber),void t.pushToken(e,"ERROR"))):(e=t.matchToken(),logError(`Expected an arrow sign "=>" but got "${errorCase(e)}" instead.`,n.lineNumber),void t.pushToken(e,"ERROR"))):(e=t.matchToken(),logError(`Expected a TAG name, but found "${errorCase(e)}" instead.`,n.lineNumber),void t.pushToken(e,"ERROR"))}()&&(n.mappings[r.rhs]={fromKey:r.lhs,lineNumber:n.lineNumber},n.objects_candname=r.rhs),t.matchEolSemi()||t.pushToken(t.matchAll(),"ERROR"),t.tokens}(e,s),s.objects_section=s.objects_candname?1:0):(s.current_line_wip_array=function(e,n){const t=new b(e,n),r=n.mappings[n.objects_candname],o={};return function(){let e;for(t.matchComment(),o.lhs=[];e=t.match(reg_name,!n.case_sensitive);)n.tags[r.fromKey].includes(e)?(t.pushToken(e,"NAME"),o.lhs.push(e)):(logError(`The name "${errorCase(e)}" needs to be defined by "${errorCase(r.fromKey)}".`,n.lineNumber),t.pushToken(e,"ERROR")),t.matchComment();if(!(e=t.match(/^->/)))return e=t.matchToken(),logError(`Expected an arrow sign "->" but got "${errorCase(e)}" instead.`,n.lineNumber),void t.pushToken(e,"ERROR");for(t.pushToken(e,"ASSIGNMENT"),t.matchComment(),o.rhs=[];e=t.match(reg_name,!n.case_sensitive);)e?(t.pushToken(e,"NAME"),o.rhs.push(e)):(logError(`The name "${errorCase(e)}" is a very bad thing.`,n.lineNumber),t.pushToken(e,"ERROR"));return t.matchEol()?!t.tokens.some((e=>"ERROR"==e.kind)):(e=t.matchToken(),logError(`Unrecognised stuff in a mapping: "${errorCase(e)}".`,n.lineNumber),void t.pushToken(e,"ERROR"))}()?o.lhs.length!=o.rhs.length||new Set(o.lhs).size!=o.lhs.length||new Set(o.lhs).size!=o.rhs.length?logError("Oops! You need the same number of symbols on both sides, and no duplicates.",n.lineNumber):(r.fromValues=o.lhs,r.values=o.rhs):delete n.mappings[n.objects_candname],t.matchEol()||t.pushToken(t.matchAll(),"ERROR"),t.tokens}(e,s),s.objects_section=0),h();case"objects":switch(!l||3!=s.objects_section&&4!=s.objects_section||s.objects[s.objects_candname].colors.length<=10&&!s.objects[s.objects_candname].vector&&!e.match(/^[.\d]/,!1)&&!e.match(reg_objmodi,!1)&&(s.objects_section=0),l&&0==s.objects_section&&(R(s),s.objects_candname=null,s.current_line_wip_array=[],s.objects_section=1),s.objects_section){case 1:return s.current_line_wip_array.push(...function(e,n){const t=new b(e,n),r={},o=[];return function(){for(n.case_sensitive&&(e.string=n.mixedCase),t.matchComment();;){let e=null,a="ERROR";if(r.candname&&t.check(reg_objmodi))break;if(!(e=t.match(reg_objectname,!n.case_sensitive)||r.candname&&t.matchObjectGlyph(!n.case_sensitive))){if(e=t.matchToken()){logError(`Invalid object name in OBJECT section: "${errorCase(e)}".`,n.lineNumber),t.pushToken(e,"ERROR"),t.pushToken(t.matchAll(),"ERROR");break}throw"name"}if(n.legend_synonyms.some((n=>n[0]==e))?logError(`Name "${errorCase(e)}" already in use.`,n.lineNumber):n.objects[e]&&!n.objects[e].canRedef?logError(`Object "${errorCase(e)}" defined multiple times.`,n.lineNumber):(i.includes(e)&&logWarning(`You named an object "${errorCase(e)}", but this is a keyword. Don't do that!`,n.lineNumber),a="NAME",r.candname?o.push(e):r.candname=e),t.pushToken(e,a),t.matchEolSemi())break}return!t.tokens.some((e=>"ERROR"==e.kind))}()&&function(){const e=n.objects_candname=r.candname;v(n,e,n.lineNumber);const t=n.objects[e]||{lineNumber:n.lineNumber,colors:[],spritematrix:[]};delete t.canRedef,t.transforms=[],delete n.objects[e],n.objects[e]=t;const a=e.toLowerCase();e!=a&&["background","player"].includes(a)&&_(n,a,e,n.lineNumber);for(const t of o)v(n,t,n.lineNumber),_(n,t,e,n.lineNumber)}(),t.tokens}(e,s)),s.objects_candname&&(e.match(reg_objmodi,!1)&&s.current_line_wip_array.push(...C(e,s)),s.objects_section=2),h();case 2:if(s.objects_section=3,e.match(/^[#\w]+/,!1)&&!e.match(reg_objmodi,!1))return s.current_line_wip_array.push(...function(e,n){const t=new b(e,n),r=[];return function(){for(;!t.matchEolSemi();){let e=null,o="ERROR";if(e=t.match(/^[\w]+/,!0))m.includes(e)?(r.push(e),o=e in colorPalettes.arnecolors?`COLOR COLOR-${e.toUpperCase()}`:"transparent"===e?"COLOR FADECOLOR":`MULTICOLOR${e}`):logWarning(`Invalid color in object section: "${errorCase(e)}".`,n.lineNumber);else if(e=t.match(/^#(([0-9a-f]{2}){3,4}|[0-9a-f]{3,4})/i))r.push(e),o=`MULTICOLOR${e}`;else{if(!(e=t.matchToken()))throw"obj-color";logError(`Was looking for color for object "${errorCase(n.objects_candname)}", got "${errorCase(e)}" instead.`,n.lineNumber)}t.pushToken(e,o)}return!t.tokens.some((e=>"ERROR"==e.kind))}()&&(n.objects[n.objects_candname].colors=r),t.tokens}(e,s)),h();case 3:if(e.match(/^text:/i,!1)){e.string=s.mixedCase;const n=M(e,s);return s.current_line_wip_array.push(...n),s.objects_section=0,h()}case 4:if(!e.match(reg_objmodi,!1)){e.string=s.mixedCase;const n=s.objects[s.objects_candname].vector?function(e,n){const t=new b(e,n),r=[],o=n.objects[n.objects_candname];return function(){let e,a="ERROR";if("canvas"==o.vector.type){for(;!t.matchEol();)if(a="ERROR",e=t.match(/^\{[^}]*\}/,!1))try{const n=JSON.parse(e);n&&(r.push(n),a="SPRITEMATRIX")}catch(e){}else e=t.matchAll();return t.pushToken(e,a),"ERROR"==a&&logError(`I was looking for some valid JSON (in curly braces) but found this instead: "${e}."`,n.lineNumber),"ERROR"!=a}if("svg"==o.vector.type)return logError("SVG is not yet implemented. Sorry.",n.lineNumber),e=t.matchAll(),r.push(e),!0;throw"vector"}()&&(o.vector.data=(o.vector.data||[]).concat(r)),t.matchEol()||t.pushToken(t.matchAll(),"ERROR"),t.tokens}(e,s):M(e,s);return s.current_line_wip_array.push(...n),s.objects_section=4,h()}s.objects_section=5;case 5:return s.current_line_wip_array.push(...C(e,s)),h()}break;case"legend":return s.current_line_wip_array=function(e,n){const t=new b(e,n),r=[],o={};return function(){let e;if(e=t.match(reg_objectname,!n.case_sensitive)||t.matchObjectGlyph(!n.case_sensitive)){o.newname=e;const r=isAlreadyDeclared(n,e);r?logError(`Name "${errorCase(e)}" already in use (on line ${htmlJump(r.lineNumber,"errorTextLineNumber")}`):i.includes(e)&&logWarning(`You named an object "${errorCase(e)}", but this is a keyword. Don't do that!`,n.lineNumber),t.pushToken(e,r?"ERROR":"NAME")}if(t.matchComment(),e=t.match(/^=/)){for(t.pushToken(e,"ASSIGNMENT"),t.matchComment();;){let a="ERROR";if(e=t.match(reg_objectname,!n.case_sensitive)||t.matchObjectGlyph(!n.case_sensitive)){const t=getObjectRefs(n,e);if(t)e==o.newname?logError(`You can't define object "${errorCase(e)}" in terms of itself!`,n.lineNumber):(r.includes(e)&&logWarning(`You're repeating the object "${errorCase(e)}" here multiple times on the RHS.  This makes no sense.  Don't do that.`,n.lineNumber),r.push(...t),t.length>1&&(o.andor||="or"),a="NAME");else{const t=getObjectUndefs(n,e);logError(`You're talking about "${errorCase(e)}" but ${t[0]?errorCase(t[0]):"it"} is not defined anywhere.`,n.lineNumber)}}if(t.pushToken(e,a),"NAME"!=a)return e=t.matchToken(),void logError(`Something bad's happening in the LEGEND around ${e}`,n.lineNumber);if(t.matchEol())break;if(!(e=t.match(/^(and|or)\b/i,!0)))return e=t.match(f),logError(`AND or OR expected, found ${errorCase(e)}`,n.lineNumber),void t.pushToken(e,"ERROR");o.andor&&e!=o.andor?logError("Cannot mix AND and OR",n.lineNumber):(o.andor||=e,a="LOGICWORD"),t.pushToken(e,a)}return!t.tokens.some((e=>"ERROR"==e.kind))}logError('In the legend, define new items using the equals symbol - declarations must look like "A = B", "A = B or C [ or D ...]", "A = B and C [ and D ...]".',n.lineNumber)}()&&function(){if(1==r.length)v(n,o.newname,n.lineNumber),_(n,o.newname,r[0],n.lineNumber);else if("and"==o.andor){const e=[o.newname,...r.flatMap((e=>p(n,e,!0,(()=>logError("Cannot define an aggregate (using 'and') in terms of properties (something that uses 'or').",n.lineNumber)))))];e.lineNumber=n.lineNumber,v(n,o.newname,n.lineNumber),n.legend_aggregates.push(e)}else{const e=[o.newname,...r.flatMap((e=>p(n,e,!1,(()=>logError("Cannot define a property (something defined in terms of 'or') in terms of aggregates (something that uses 'and').",n.lineNumber)))))];e.lineNumber=n.lineNumber,v(n,o.newname,n.lineNumber),n.legend_properties.push(e)}}(),t.matchEol()||t.pushToken(t.matchAll(),"ERROR"),t.tokens}(e,s),h();case"sounds":return e.string=s.mixedCase,s.current_line_wip_array=function(e,n){const r=new b(e,n),o=[];return function(){let e=null;if(e=r.match(t,!0)){r.pushToken(e,"SOUNDEVENT"),r.matchComment();const t=e,a=i();if(a)return o.push(...a.map((e=>["SOUNDEVENT",t,e,n.lineNumber]))),!0;logError("Was expecting a sound seed here (a number like 123123, like you generate by pressing the buttons above the console panel), but found something else.",n.lineNumber)}else if(e=r.match(reg_objectname,!n.case_sensitive)){const t=getObjectRefs(n,e);if(t){r.pushToken(e,"NAME");let s=null;if((e=r.match(/^[a-z]+/i,!0))&&(soundverbs_directional.includes(e)||soundverbs_movement.includes(e)||soundverbs_other.includes(e)?(r.pushToken(e,"SOUNDVERB"),s=e,r.matchComment()):r.pushBack()),s){const l=[];for(;e=r.match(a,!0);)r.pushToken(e,"DIRECTION"),l.push(e),r.matchComment();const c=i();if(c)return t.forEach((e=>o.push(...c.map((t=>["SOUND",e,s,l,t,n.lineNumber]))))),!0;e==r.matchToken()&&logError(`Ah I was expecting a ${soundverbs_directional.includes(s)?"direction or sound seed":"sound seed"} after ${s}, but I don't know what to make of "${errorCase(e)}".`,n.lineNumber)}else logError("Was expecting a soundverb here (MOVE, DESTROY, CANTMOVE, or the like), but found something else.",n.lineNumber)}else{const t=getObjectUndefs(n,e);logError(`Found "${errorCase(e)}", which looks like an object but ${t[0]?errorCase(t[0]):"it"} is not declared anywhere.`,n.lineNumber)}}else logError("Was expecting a sound event (like SFX3, or ENDLEVEL) or an object name, but didn't find either.",n.lineNumber);return!1}()&&n.sounds.push(...o),r.matchEol()||r.pushToken(r.matchAll(),"ERROR"),r.tokens;function i(){const e=[];let t=null;for(;t=r.match(/^(\d+(:[\d.]+)?|afx:[\w:=+-.]+)\b/i,!0);)r.pushToken(t,"SOUND"),e.push(t),r.matchComment();return(t=r.matchToken())?(logError(`I wasn't expecting anything after the sound declaration ${e.at(-1)} on this line, so I don't know what to do with "${errorCase(t)}" here.`,n.lineNumber),r.pushToken(t,"ERROR"),null):e}}(e,s),h();case"collisionlayers":return s.current_line_wip_array=function(e,n){const t=new b(e,n);let r;const o=[];let a=0;return function(){let e=null;for(;;){if(e=t.match(/^--[-^v<>-|]*/)){if(t.pushToken(e,"LOGICWORD"),r=e,t.matchEolSemi())break}else if(e=t.match(/^->/))0==o.length||0!=a?logError("Cannot use arrow syntax here.",n.lineNumber):(a=o.length,t.pushToken(e,"LOGICWORD"));else{if(!(e=t.match(reg_objectname,!n.case_sensitive)||t.matchObjectGlyph(!n.case_sensitive)))return e=t.match(f),logError(`Object name expected, found ${errorCase(e)}`,n.lineNumber),void t.pushToken(e,"ERROR");{let r="ERROR";const a=getObjectRefs(n,e);if("background"==e&&0!=o.length)logError("Background must be in a layer by itself.",n.lineNumber);else if(a)o.includes(e)?logWarning(`Object "${errorCase(e)}" included explicitly multiple times in the same layer. Don't do that innit.`,n.lineNumber):o.push(e),r="NAME";else{const t=getObjectUndefs(n,e);logError(`Cannot add "${errorCase(e)}" to a collision layer, ${t[0]?errorCase(t[0]):"it"} has not been declared.`,n.lineNumber)}t.pushToken(e,r)}}if(t.matchEolSemi())break;for(;e=t.match(/^,/);)t.pushToken(e,"LOGICWORD");if(t.matchEolSemi())break}return!t.tokens.some((e=>"ERROR"==e.kind))}()&&function(){const e=[];function t(t,r){e[t]?e[t].layer.push(...r):e[t]={lineNumber:n.lineNumber,layer:r}}function i(e,n,r){const o=n.split(":"),a=r.filter((e=>o.includes(e)));if(1==o.length||0==r.length)t("+",e);else{const n=a.map((e=>o.indexOf(e)));for(const r of e){const e=n.map((e=>r.split(":")[e])).join("+");t(e,[r])}}}if(r){const e="^>v<|-",t=["up","right","down","left","down","right"],o=["downright","downleft","upright","upleft","leftdown","leftup","rightdown","rightup"],a=t[e.indexOf(r[2]||">")],i=t[e.indexOf(r[3]||"v")];return o.includes(a+i)?void n.collisionLayerGroups.push({lineNumber:n.lineNumber,layer:n.collisionLayers.length,dirFirst:a,dirSecond:i}):void consoleError(`Layer divider ${r} is not valid.`)}0==n.collisionLayerGroups.length&&n.collisionLayerGroups.push({lineNumber:n.lineNumber,layer:0,dirFirst:"right",dirSecond:"down"});const s=o.slice(0,a),l=o.slice(a);for(const e of s)if(!n.tags[e]&&!n.legend_properties.find((n=>n[0]==e)))return void logError(`A layer prefix must be a tag or property but ${e} is not.`,n.lineNumber);for(const e of l){const t=getObjectRefs(n,e).map((e=>p(n,e,!1,(e=>logError(`"${e}" is an aggregate (defined using "and"), and cannot be added to a single layer because its constituent objects must be able to coexist.`,n.lineNumber))))).flat(),r=new Set;if(n.collisionLayers.forEach(((e,n)=>{for(const o of t)e.includes(o)&&r.add(n+1)})),0!=r.size){const t=[...r].map((e=>`#${e}, `))+`#${n.collisionLayers.length+1}`;logWarning(`Object "${errorCase(e)}" included in multiple collision layers ( layers ${t} ). You should fix this!`,n.lineNumber)}i(t,e,s)}Object.values(e).map((e=>e.layer)).forEach((e=>n.collisionLayers.push(e)))}(),t.matchEol()||t.pushToken(t.matchAll(),"ERROR"),t.tokens}(e,s),h();case"rules":if(l){var c=f.exec(e.string)[0];s.rules.push([c,s.lineNumber,s.mixedCase]),s.tokenIndex=0}if(-4===s.tokenIndex)return e.skipToEnd(),"MESSAGE";if(e.match(/[\p{Z}\s]*->[\p{Z}\s]*/u,!0))return"ARROW";var u=e.peek();if("["===u||"|"===u||"]"===u||"+"===u)return"+"!==u&&(s.tokenIndex=1),e.next(),e.match(/[\p{Z}\s]*/u,!0),"BRACKET";var d=e.match(/[^\[\|\]\p{Z}\s]*/u,!0)[0].trim();return 0===s.tokenIndex&&r.exec(d)?"BRACKET":0==s.tokenIndex&&"subroutine"==d.toLowerCase()?(s.tokenIndex=-4,"BRACKET"):0===s.tokenIndex&&o.exec(d)||1===s.tokenIndex&&directions_table.includes(d)||Object.hasOwn(s.tags,d)?(e.match(/[\p{Z}\s]*/u,!0),"DIRECTION"):s.names.indexOf(d)>=0?l?(logError("Objects cannot appear outside of square brackets in rules, only directions can.",s.lineNumber),"ERROR"):(e.match(/[\p{Z}\s]*/u,!0),"NAME"):d.match(reg_objectnamerel)&&(isAlreadyDeclared(s,d)||createObjectRef(s,d))?"NAME":(d=d.toLowerCase(),["...","rigid","random","global","once"].includes(d)?"DIRECTION":d.match(reg_commandwords)?((commandargs_table.includes(d)||twiddleable_params.includes(d))&&(s.tokenIndex=-4),"COMMAND"):(logError('Name "'+d+'", referred to in a rule, does not exist.',s.lineNumber),"ERROR"));case"winconditions":return s.current_line_wip_array=function(e,n){const t=new b(e,n),r=[],o={};return function(){let e;if(!(e=t.match(/^(all|any|no|some)\b/i,!0)))return e=t.match(f),logError(`Expecting the start of a win condition ("ALL","SOME","NO") but got "${errorCase(e)}".`,n.lineNumber),void t.pushToken(e,"ERROR");if(o.start=e,t.pushToken(e,"LOGICWORD"),t.matchComment(),a(),!t.matchEol()){if(!(e=t.match(/^(on)\b/i,!0)))return e=t.matchToken(),logError(`Expecting the word "ON" but got "${errorCase(e)}".`,n.lineNumber),void t.pushToken(e,"ERROR");o.kind=e,t.pushToken(e,"LOGICWORD"),t.matchComment(),a(),t.matchEol()||(e=t.matchToken(),logError(`Error in win condition: I don't know what to do with "${errorCase(e)}".`,n.lineNumber),t.pushToken(e,"ERROR"))}return!t.tokens.some((e=>"ERROR"==e.kind))}()&&n.winconditions.push(1==r.length?[o.start,r[0],n.lineNumber]:[o.start,r[0],"on",r[1],n.lineNumber]),t.matchEol()||t.pushToken(t.matchAll(),"ERROR"),t.tokens;function a(){let e;if(!(e=t.match(reg_objectname,!n.case_sensitive)||t.matchObjectGlyph(!n.case_sensitive)))return e=t.matchToken(),logError(`Object name expected, found ${errorCase(e)}`,n.lineNumber),void t.pushToken(e,"ERROR");{let o="ERROR";isAlreadyDeclared(n,e)||createObjectRef(n,e)?(r.push(e),o="NAME"):logError(`Error in win condition: "${errorCase(e)}" is not a valid object name.`,n.lineNumber),t.pushToken(e,o)}}}(e,s),h();case"levels":return e.string=s.mixedCase,s.current_line_wip_array=function(e,n){const t=new b(e,n),r={};return function(){let e;if(e=t.match(/^(goto|level|link|message|section|title)/i,!0)){if(r.start=e,t.pushToken(e,`${errorCase(e)}_VERB`),"link"==e)if(e=t.match(reg_objectname,!n.case_sensitive))if(isAlreadyDeclared(n,e)){const o=p(n,e,!1,(()=>{}));o&&1==o.length||logError(`LINK object "${errorCase(e)}" only works with a simple object or an alias, not something created with AND or OR.`,n.lineNumber),r.link=o[0],t.pushToken(e,"NAME")}else logError(`LINK object "${errorCase(e)}" not found, it needs to be already defined.`,n.lineNumber);else logError("LINK needs an object to know where to put the link.",n.lineNumber);r.text=t.matchAll(),r.text.length>0&&t.pushToken(r.text,"METADATATEXT")}else for(r.gridline="";("()"!=n.commentStyle||"("!=t.peek())&&(e=t.match(/^\S/,!n.case_sensitive));){r.gridline+=e;const o=n.abbrevNames.includes(e)?"LEVEL":"ERROR";"ERROR"==o&&logError(`Key "${errorCase(e)}" not found. Do you need to add it to the legend, or define a new object?`,n.lineNumber),t.pushToken(e,o)}return t.matchEol(),!0}()&&function(){let e=n.levels.at(-1);e&&0==e.length&&(n.levels.pop(),e=null);const t=["goto","level","link","message","section","title"];t.includes(r.start)?n.levels.push([r.start,r.text,n.lineNumber,r.link]):null==e||t.includes(e[0])?n.levels.push([n.lineNumber,null,r.gridline]):e.push(r.gridline)}(),t.matchEol()||t.pushToken(t.matchAll(),"ERROR"),t.tokens}(e,s),h();default:throw"case!"}if(e.eol())return null;if(!e.eol())return e.next(),null;function h(){if(s.current_line_wip_array.length>0){const n=s.current_line_wip_array.shift();return e.pos=n.pos,n.kind}return null}},startState:function(){return{objects:{},lineNumber:0,commentLevel:0,commentStyle:null,section:"",visitedSections:[],line_should_end:!1,line_should_end_because:"",sol_after_comment:!1,objects_candname:"",objects_section:0,objects_spritematrix:[],collisionLayers:[],collisionLayerGroups:[],tokenIndex:0,current_line_wip_array:[],mixedCase:"",legend_synonyms:[],legend_aggregates:[],legend_properties:[],sounds:[],rules:[],names:[],winconditions:[],metadata:[],metadata_lines:{},sprite_size:5,case_sensitive:!1,original_case_names:{},original_line_numbers:{},abbrevNames:[],levels:[[]],tags:{directions:["up","right","down","left"],horizontal:["right","left"],vertical:["up","down"]},mappings:{},subsection:""}}}};window.CodeMirror.defineMode("puzzle",codeMirrorFn);"use strict";var relativeDirections=["^","v","<",">","perpendicular","parallel"],simpleAbsoluteDirections=["up","down","left","right"],simpleRelativeDirections=["^","v","<",">"],relativeDirs=["^","v","<",">","parallel","perpendicular"],relativeDict={right:["up","down","left","right","horizontal_par","vertical_perp"],up:["left","right","down","up","vertical_par","horizontal_perp"],down:["right","left","up","down","vertical_par","horizontal_perp"],left:["down","up","right","left","horizontal_par","vertical_perp"]};const directionaggregates={horizontal:["left","right"],horizontal_par:["left","right"],horizontal_perp:["left","right"],vertical:["up","down"],vertical_par:["up","down"],vertical_perp:["up","down"],moving:["up","down","left","right","action"],orthogonal:["up","down","left","right"],perpendicular:["^","v"],parallel:["<",">"]};var debugMode,colorPalette,tagDirections=[{keys:["^","v","<",">","perpendicular","parallel","orthgonal"],values:["up","down","left","right"]},{keys:["horizontal"],values:["left","right"]},{keys:["vertical"],values:["up","down"]}];function getTag(e,n){return Object.hasOwn(e.tags,n)&&e.tags[n]}function getMapping(e,n){return Object.hasOwn(e.mappings,n)&&e.mappings[n]}function isMappedTo(e,n,t){return Object.hasOwn(e.mappings,n)&&e.mappings[n].fromKey==t}function canMapValue(e,n,t){const r=e.mappings[n];return r&&r.fromKey==t}function getMappedValue(e,n,t){const r=e.mappings[n],o=r.fromValues.indexOf(t);return r.values[o]}function getMappedValues(e,n){return e.mappings[n].values.map((n=>getTag(e,n)||n)).flat()}function cartesianProduct(...e){return e.reduce(((e,n)=>e.flatMap((e=>n.map((n=>e.concat([n])))))),[[]])}class TagExpander{constructor(e,n,t=!1,r=":"){this.ident=n,this.delim=r,[this.stem,...this.tail]=n.split(r),this.keys=[],this.values=[];this.tail.filter((n=>getTag(e,n))).forEach((n=>{this.keys.push(n),this.values.push(e.tags[n])}));if(this.tail.filter((n=>getMapping(e,n))).forEach((n=>{this.keys.push(n),this.values.push(getMappedValues(e,n))})),t){this.tail.filter((e=>tagDirections.find((n=>n.keys.includes(e))))).forEach((e=>{this.keys.push(e),this.values.push(tagDirections.find((n=>n.keys.includes(e))).values)}))}this.expansion=cartesianProduct(...this.values)}get expKeys(){return this.keys}get expValues(){return this.expansion}getExpandedIdents(){return 0==this.keys.length?[this.ident]:this.expansion.map((e=>[this.stem,...this.tail.map((n=>this.keys.includes(n)?e[this.keys.indexOf(n)]:n))].join(this.delim)))}getExpandedIdent(e){return[this.stem,...this.tail.map((n=>this.keys.includes(n)?e[this.keys.indexOf(n)]:n))].join(this.delim)}getExpandedAlt(e,n){const[t,...r]=n.split(":");return 0==r.length?t:[t,...r.map((n=>this.keys.includes(n)?e[this.keys.indexOf(n)]:n))].join(this.delim)}getSubstitutedIdent(e,n,t){const r=this.keys.includes(n)?e[this.keys.indexOf(n)]:n;return simpleRelativeDirections.includes(n)?clockwiseDirections[(clockwiseDirections.indexOf(n)+t)%4]:r}getExpandedAltIdents(e){const[n,...t]=e.split(":");return this.expansion.map((e=>0==t.length?n:[n,...t.map((n=>this.keys.includes(n)?e[this.keys.indexOf(n)]:n))].join(this.delim)))}}function expandObjectRef(e,n,t=!1){return new TagExpander(e,n,t).getExpandedIdents()}function expandObjectDef(e,n,t){const r=new TagExpander(e,n,!0);if(0==r.keys.length)return;return r.expansion.map(((n,o)=>{const a=r.getExpandedIdent(n),i={...deepClone(t),canRedef:!0};if(t.cloneSprite){const o=r.getExpandedAlt(n,t.cloneSprite);e.objects[o]&&(i.cloneSprite=o)}else i.spritematrix=t.spritematrix.map((e=>[...e]));return t.transforms&&(i.transforms=[],t.transforms.forEach((e=>{const t=e[0];i.transforms.push([t,r.getSubstitutedIdent(n,e[1],o),"rot"==t?r.getSubstitutedIdent(n,e[2],o):e[2]])}))),[a,i]}))}function createObjectTagsAsProps(e,n){const t=n=>getTag(e,n)||getMapping(e,n)&&getMapping(e,n).values,r=n.split(":"),o=r.map(((e,n)=>({part:e,index:n,values:t(e)}))).filter((e=>e.values));o.length<=1||o.forEach((n=>{n.values.forEach((t=>{const o=r.map(((e,r)=>r==n.index?t:e)).join(":"),a=[o,...new TagExpander(e,o,!0).getExpandedIdents()];a.lineNumber=e.lineNumber,e.legend_properties.push(a),createObjectTagsAsProps(e,o)}))}))}function applySpriteTransforms(e){const n={flip:(e,n)=>[e=>e.reverse(),e=>e.map((e=>e.reverse()))][n%2](e.spritematrix),shift:(e,n,t)=>e.spritematrix=[e=>[...e.slice(t),...e.slice(0,t)],e=>e.map((e=>[...e.slice(-t),...e.slice(0,-t)])),e=>[...e.slice(-t),...e.slice(0,-t)],e=>e.map((e=>[...e.slice(t),...e.slice(0,t)]))][n](e.spritematrix),rot:(e,n,t)=>e.spritematrix=[e=>e,e=>Array.from(e[0],((n,t)=>e.map((e=>e[t])).reverse())),e=>Array.from(e,(e=>e.reverse())).reverse(),e=>Array.from(e[0],((n,t)=>e.map((e=>e[t])))).reverse()][(4+cwdIndexOf(t)-n)%4](e.spritematrix),translate:(e,n,t)=>[e=>e.y-=t,e=>e.x+=t,e=>e.y+=t,e=>e.x-=t][n](e.spriteoffset)};for(const t of e.transforms||[])n[t[0]](e,cwdIndexOf(t[1]),t[2])}function applyVectorTransforms(e){const n={flip:(e,n)=>[e=>e.flipy=!e.flipy,e=>e.flipx=!e.flipx][n%2](e.vector),rot:(n,t,r)=>[e=>e,e=>e.angle+=90,e=>e.angle+=180,e=>e.angle+=270][(4+cwdIndexOf(r)-t)%4](e.vector),translate:(e,n,t)=>[e=>e.y-=t,e=>e.x+=t,e=>e.y+=t,e=>e.x-=t][n](e.spriteoffset),shift:e=>e};for(const t of e.transforms||[])n[t[0]](e,cwdIndexOf(t[1]),t[2])}function isAlreadyDeclared(e,n){return Object.hasOwn(e.objects,n)||e.legend_synonyms.find((e=>e[0]==n))||e.legend_aggregates.find((e=>e[0]==n))||e.legend_properties.find((e=>e[0]==n))||Object.hasOwn(e.tags,n)||Object.hasOwn(e.mappings,n)}function isDeclaredAs(e,n){return Object.hasOwn(e.objects,n)?"object":e.legend_synonyms.find((e=>e[0]==n))?"alias":e.legend_aggregates.find((e=>e[0]==n))?"and":e.legend_properties.find((e=>e[0]==n))?"or":Object.hasOwn(e.tags,n)?"tag":Object.hasOwn(e.mappings,n)?"map":null}function getObjectRefs(e,n){if(isAlreadyDeclared(e,n))return[n];const t=expandObjectRef(e,n,!0);return t.every((n=>isAlreadyDeclared(e,n)))?t:null}function getObjectUndefs(e,n){if(isAlreadyDeclared(e,n))return[];return expandObjectRef(e,n,!0).filter((n=>!isAlreadyDeclared(e,n)))}function createObjectRef(e,n){const t=getObjectRefs(e,n);if(t&&t.length>1){if(n.split(":").some((e=>relativeDirections.includes(e)))){debugSwitch.includes("exp")&&console.log(`Create object ref for relative direction: ${n}`);for(const t of simpleAbsoluteDirections){const r=e=>relativeDirs.includes(e)?relativeDict[t][relativeDirs.indexOf(e)]:e;createObjectRef(e,n.split(":").map((e=>r(e))).join(":"))}}const r=[n,...t];return r.lineNumber=e.lineNumber,e.legend_properties.push(r),!0}return!1}function isColor(e){return(e=e.trim())in colorPalettes.arnecolors||(!!/^#([0-9A-F]{2}){3,4}$/i.test(e)||(!!/^#([0-9A-F]{3,4})$/i.test(e)||"transparent"===e))}function colorToHex(e,n){return(n=n.trim())in e?e[n]:n}function generateExtraMembers(e){0===e.collisionLayers.length&&logError("No collision layers defined.  All objects need to be in collision layers."),e.idDict=[];for(var n=0,t=0;t<e.collisionLayers.length;t++)for(var r=0;r<e.collisionLayers[t].length;r++){if((h=e.collisionLayers[t][r])in e.objects)(g=e.objects[h]).layer=t,g.id=n,e.idDict[n]=h,n++}let o=n;for(let n=e.collisionLayerGroups.length-1;n>=0;--n){const t=e.collisionLayerGroups[n];t.firstObjectNo=e.objects[e.collisionLayers[t.layer][0]].id,t.numObjects=o-t.firstObjectNo,o=t.firstObjectNo}e.objectCount=n;for(var a=e.collisionLayers.length,i=[],s=0;s<a;s++)i.push(-1);MOV_BITS=8,MOV_MASK=255,STRIDE_OBJ=0|Math.ceil(e.objectCount/32),STRIDE_MOV=0|Math.ceil(a*MOV_BITS/32),e.STRIDE_OBJ=STRIDE_OBJ,e.STRIDE_MOV=STRIDE_MOV,debugMode=!1,verbose_logging=!1,throttle_movement=!1,colorPalette=colorPalettes.arnecolors;for(s=0;s<e.metadata.length;s+=2){var l=e.metadata[s],c=e.metadata[s+1];"color_palette"===l?(c in colorPalettesAliases&&(c=colorPalettesAliases[c]),void 0===colorPalettes[c]?logError('Palette "'+c+'" not found, defaulting to arnecolors.',0):colorPalette=colorPalettes[c]):"debug"===l||defaultDebugMode?IDE&&!1===unitTesting&&(debugMode=!0,cache_console_messages=!0):"verbose_logging"===l||defaultVerboseLogging?IDE&&!1===unitTesting&&(verbose_logging=!0,cache_console_messages=!0):"throttle_movement"===l&&(throttle_movement=!0)}for(const n of Object.values(e.objects)){n.vector?n.colors.length>0&&logWarning("Please don't define colors for vector sprites. They're just going to get ignored anyway.",n.lineNumber+1):0==n.colors.length?(logWarning("A sprite must have at least one color. However did this happen?",n.lineNumber+1),n.colors.push("#ff00ff")):n.colors.length>36&&logError("A sprite cannot have more than 36 colors.  Why you would want more than 36 is beyond me.",n.lineNumber+1);for(let e=0;e<n.colors.length;e++){let t=n.colors[e];isColor(t)?(t=colorToHex(colorPalette,t),n.colors[e]=t):(logError(`Invalid color specified for object "${h}", namely ${n.colors[e]}".`,n.lineNumber+1),n.colors[e]="#ff00ff")}}for(const[n,t]of Object.entries(e.objects))if(t.spriteoffset={x:0,y:0},t.vector){if(t.vector.angle||=0,t.cloneSprite){const n=e.objects[t.cloneSprite];t.vector={...n.vector},t.spriteoffset={...n.spriteoffset}}applyVectorTransforms(t)}else{if(t.cloneSprite){const n=e.objects[t.cloneSprite];t.spritematrix=n?n.spritematrix.map((e=>[...e])):[],t.spriteoffset=n?{...n.spriteoffset}:t.spriteoffset}0==t.spritematrix.length&&(t.spritematrix=Array.from({length:e.sprite_size},(()=>new Array(e.sprite_size).fill(0)))),applySpriteTransforms(t)}debugSwitch.includes("obj")&&console.log("Objects",e.objects),debugSwitch.includes("obj")&&console.log("Properties",e.legend_properties),debugSwitch.includes("obj")&&console.log("Aggregates",e.legend_aggregates),debugSwitch.includes("obj")&&console.log("Synonyms",e.legend_synonyms);var u=[],d={};for(var h in e.objects)if(e.objects.hasOwnProperty(h)){var g=e.objects[h];(_=i.concat([]))[g.layer]=g.id,d[h]=_,u.push([g.lineNumber,h])}for(var m=!0;m;){m=!1;for(s=0;s<e.legend_synonyms.length;s++){l=(f=e.legend_synonyms[s])[0],c=f[1];l in d&&void 0!==d[l]||void 0===d[c]||(m=!0,d[l]=d[c],u.push([f.lineNumber,l]))}for(s=0;s<e.legend_aggregates.length;s++){l=(f=e.legend_aggregates[s])[0];var f,p=f.slice(1),v=!0;for(r=0;r<p.length;r++){if(void 0===d[p[r]]){v=!1;break}}if((!(l in d)||void 0===d[l])&&v){var _=i.concat([]);for(r=1;r<f.length;r++){h=f[r];if(null==(g=e.objects[h])&&logError("Object not found with name "+h,e.lineNumber),-1==_[g.layer])_[g.layer]=g.id;else if(void 0===g.layer)logError('Object "'+h.toUpperCase()+'" has been defined, but not assigned to a layer.',f.lineNumber),g.layer=0;else logError('Trying to create an aggregate object (something defined in the LEGEND section using AND) with both "'+h.toUpperCase()+'" and "'+e.idDict[_[g.layer]].toUpperCase()+"\", which are on the same layer and therefore can't coexist.",f.lineNumber)}m=!0,d[f[0]]=_,u.push([f.lineNumber,l])}}}u.sort(((e,n)=>e[0]-n[0])),u=u.map((e=>e[1])),e.glyphDict=d,e.glyphOrder=u;var b={};for(s=0;s<e.legend_aggregates.length;s++){b[(S=e.legend_aggregates[s])[0]]=S.slice(1)}e.aggregatesDict=b;var y={};for(s=0;s<e.legend_properties.length;s++){y[(S=e.legend_properties[s])[0]]=S.slice(1)}e.propertiesDict=y;var w={};for(s=0;s<e.legend_synonyms.length;s++){var S;l=(S=e.legend_synonyms[s])[0];(x=S[1])in b?b[l]=b[x]:x in y?y[l]=y[x]:l!==x&&(w[l]=x)}e.synonymsDict=w;for(var k,E,T=!0;T;){for(var h in T=!1,w){if(w.hasOwnProperty(h))(x=w[h])in y?(delete w[h],y[h]=y[x],T=!0):x in b?(delete b[h],b[h]=b[x],T=!0):x in w&&(w[h]=w[x])}for(var h in y)if(y.hasOwnProperty(h)){var M=y[h];for(s=0;s<M.length;s++){if((x=M[s])in w)M[s]=w[x],T=!0;else if(x in y){M.splice(s,1);var C=y[x];for(r=0;r<C.length;r++){var R=C[r];-1===M.indexOf(R)&&M.push(R)}T=!0}x in b&&logError('Trying to define property "'+h.toUpperCase()+'" in terms of aggregate "'+x.toUpperCase()+'".')}}for(var h in b)if(b.hasOwnProperty(h))for(M=b[h],s=0;s<M.length;s++){var x;if((x=M[s])in w)M[s]=w[x],T=!0;else if(x in b){M.splice(s,1);for(C=b[x],r=0;r<C.length;r++){R=C[r];-1===M.indexOf(R)&&M.push(R)}T=!0}x in y&&logError('Trying to define aggregate "'+h.toUpperCase()+'" in terms of property "'+x.toUpperCase()+'".')}}for(var l in e.propertiesSingleLayer={},y)if(y.hasOwnProperty(l)){(M=y[l]).every((n=>e.objects[n]))||(console.log("Properties not in state.objects:",M),TooManyErrors());var L=!0;for(s=1;s<M.length;s++)if(e.objects[M[s-1]].layer!==e.objects[M[s]].layer){L=!1;break}L&&(e.propertiesSingleLayer[l]=e.objects[M[0]].layer)}if(void 0===e.idDict[0]&&e.collisionLayers.length>0&&logError("You need to have some objects defined"),void 0===e.objects.background)if("background"in e.synonymsDict){h=e.synonymsDict.background;k=(g=e.objects[h]).id,E=g.layer}else if("background"in e.propertiesDict){var I=e.propertiesDict.background;h=I[0];k=(g=e.objects[h]).id,E=g.layer;for(s=1;s<I.length;s++){var O=I[s];if(e.objects[O].layer!==E)logError("Background objects must be on the same layer",e.original_line_numbers.background)}}else if("background"in e.aggregatesDict){k=(g=e.objects[e.idDict[0]]).id,E=g.layer,logError("Background cannot be an aggregate (declared with 'and'), it has to be a simple type, or property (declared in terms of others using 'or').",e.original_line_numbers.background)}else{null!=(g=e.objects[e.idDict[0]])&&(k=g.id,E=g.layer),logError("You have to define something to be the background")}else k=e.objects.background.id,E=e.objects.background.layer;e.backgroundid=k,e.backgroundlayer=E}function generateExtraMembersPart2(e){function n(n,t){if(n in e.metadata){var r=e.metadata[n]||t,o=null,a=null;if(e.objects[r])o=e.objects[r].id,a=e.objects[r];else if(r in e.synonymsDict){var i=e.synonymsDict[r];o=(s=e.objects[i]).id,a=s}else{var s;o=(s=e.objects[e.idDict[1]]).id,logError(r+" object/alias has to be defined")}if(null!=a&&void 0!==a.layer){var l=a.layer;1!=e.collisionLayers[l].length&&logWarningNoLine("Mouse object '"+r+"' (for input '"+n+"') could overlap with other objects on the same layer. Consider moving the object to its own layer.",!0,!1)}return o}}if(e.lmbID=n("mouse_left","lmb"),e.rmbID=n("mouse_right","rmb"),e.dragID=n("mouse_drag","drag"),e.rdragID=n("mouse_rdrag","rdrag"),e.lmbupID=n("mouse_up","lmbup"),e.rmbupID=n("mouse_rup","rmbup"),"mouse_obstacle"in e.metadata){var t=e.metadata.mouse_obstacle;t&&(e.obstacleMask=e.objectMasks[t],e.obstacleMask||(logError(t+" object/alias has to be defined."),e.obstacleMask=e.objectMasks.background))}}function levelFromString(e,n){var t=e.backgroundlayer,r=e.layerMasks[t],o=new Level(n[0],n[2].length,n.length-2,e.collisionLayers.length,null,n[1]);o.objects=new Int32Array(o.width*o.height*STRIDE_OBJ);for(var a=0;a<o.width;a++)for(var i=0;i<o.height;i++){var s=n[i+2].charAt(a);0==s.length&&(s=n[i+2].charAt(n[i+2].length-1));var l=e.glyphDict[s];if(null==l)return void 0===e.propertiesDict[s]?logError('Error, symbol "'+s+'", used in map, not found.',n[0]+i):logError('Error, symbol "'+s+'" is defined using OR, and therefore ambiguous - it cannot be used in a map. Did you mean to define it in terms of AND?',n[0]+i),o;var c=new BitVec(STRIDE_OBJ);l=l.concat([]);for(var u=0;u<o.layerCount;u++)l[u]>=0&&c.ibitset(l[u]);for(var d=0;d<STRIDE_OBJ;++d)o.objects[STRIDE_OBJ*(a*o.height+i)+d]=c.data[d]}var h=o.calcBackgroundMask(e);for(a=0;a<o.n_tiles;a++){var g=o.getCell(a);r.anyBitsInCommon(g)||(g.ior(h),o.setCell(a,g))}return o}function levelsToArray(e){const n=[],t=[];let r,o,a,i;0==e.levels.at(-1).length&&e.levels.pop();let s=1;e.levels.forEach((l=>{if(o||=`Level ${s}`,"message"==l[0]){i&&logWarning("Message unreachable due to previous GOTO.",l[2]);wordwrap(l[1],35).length>12&&logWarning("Message too long to fit on screen.",l[2]),n.push({message:l[1],lineNumber:l[2],section:r})}else"goto"==l[0]?(i&&logWarning("GOTO unreachable due to previous GOTO.",l[2]),n.push({target:l[1],lineNumber:l[2],section:r}),i=!0):"section"==l[0]?(r=l[1],i=!1):"level"==l[0]?o=l[1]:"title"==l[0]?(a=l[1],logWarning("Option TITLE is not implemented, but may be in the future. Let me know if you really need it.",e.lineNumber)):"link"==l[0]?t.push({target:l[1],lineNumber:l[2],object:l[3]}):(i&&0==t.length&&logWarning("Level unreachable due to previous GOTO.",l[0]),l[1]=r,n.push(levelFromString(e,l)),n.at(-1).title=o,n.at(-1).linksTop=t.length,++s,o=null)})),t.forEach((e=>{let t=-9999;-1!=(t=n.findIndex((n=>e.target==n.section)))?e.targetNo=t:-1!=(t=n.findIndex((n=>e.target==n.title)))?e.targetNo=-1-t:(logError(`Sorry, link target "${e.target.toUpperCase()}" does not seem to be the name of any level.`,e.lineNumber),e.targetNo=-9999)})),e.levels=n,e.links=t}function extractSections(e){for(var n=[],t=null,r=0;r<e.levels.length;r++){var o=e.levels[r];if(o.section!=t){var a={name:o.section,firstLevel:r};"__WIN__"==a.name?e.winSection=a:n.push(a),t=o.section}}e.sections=n}function convertSectionNamesToIndices(e){for(var n={},t={},r=0;r<e.sections.length;r++){void 0===n[l=e.sections[r].name.toLowerCase()]?n[l]=r:t[l]=!0}for(var o=0;o<e.rules.length;o++)for(var a=e.rules[o],i=0;i<a.commands.length;i++){var s=a.commands[i];if("goto"==s[0]&&"number"!=typeof s[1]){var l,c=n[l=s[1].toLowerCase()];void 0===c?(logError(`Invalid GOTO command - there is no section named "${s[1]}". Either it does not exist, or it has zero levels.`,a.lineNumber),c=-9999):void 0!==t[l]&&(logError(`Invalid GOTO command - there are multiple sections named "${s[1]}". Section names must be unique for GOTO to work.`,a.lineNumber),c=-9999),s[1]=c}}for(var u=0;u<e.levels.length;u++){var d=e.levels[u];if(void 0!==d.target){var h=d.target.toLowerCase(),g=n[h];void 0===g?(logError(`Invalid GOTO command - there is no section named "${s[1]}".`,d.lineNumber),g=0):void 0!==t[h]&&(logError(`Invalid GOTO command - there are multiple sections named "${s[1]}".`,d.lineNumber),g=0),d.target=g}}}function fixUpGosubs(e){const n=e.subroutines,t=e.rules;let r=0;for(const e of n){for(;t[r][0].lineNumber<e.lineNumber;)r++;e.groupNumber=r}for(const n of e.rules)for(const t of n)for(const n of t.commands)if("gosub"==n[0]&&"string"==typeof n[1]){const r=e.subroutines.find((e=>e.label==n[1].toLowerCase()));r?n[1]=r.groupNumber:logError(`Invalid GOSUB command - there is no subroutine named "${n[1]}".`,t.lineNumber)}}function directionalRule(e){for(const t of[...e.lhs,...e.rhs]){if(t.length>1)return!0;for(const e of t)for(var n=0;n<e.length;n+=2){if(relativeDirections.includes(e[n]))return!0;if(e[n+1].split(":").some((e=>relativeDirections.includes(e))))return!0}}return!1}function findIndexAfterToken(e,n,t){e=e.toLowerCase();for(var r=0,o=0;o<=t;o++){var a=n[o];r=e.indexOf(a,r)+a.length}return r}function rightBracketToRightOf(e,n){for(;n<e.length;n++)if("]"===e[n])return!0;return!1}function processRuleString(e,n,t){var r=e[0],o=e[1],a=e[2];"+"===(r=(r=r.replace(/\[/g," [ ").replace(/\]/g," ] ").replace(/\|/g," | ").replace(/\-\>/g," -> ")).trim())[0]&&(r=r.substring(0,1)+" "+r.substring(1,r.length));var i=r.split(/\s/).filter((function(e){return""!==e}));0==i.length&&logError("Spooky error!  Empty line passed to rule function.",o);var s=0,l=[],c=null,u=[],d=!1,h=!1,g=[],m=[],f=!1,p=!1,v=o,_=[],b=!1,y=!1,w=!1;let S=!1;const k=[];if(1===i.length){if("startloop"===i[0])return C={bracket:1};if("endloop"===i[0])return C={bracket:-1}}if("subroutine"==i[0])return{label:i.slice(1).join(" ").toLowerCase(),lineNumber:o};-1==i.indexOf("->")&&logError("A rule has to have an arrow in it. There's no arrow here! Consider reading up about rules - you're clearly doing something weird",o);c=[];for(var E=0,T=0;T<i.length;T++){var M=i[T];switch(s){case 0:"+"===M?(y=!0,v===o?0==t.length?logError('The "+" symbol, for joining a rule with the group of the previous rule, needs a previous rule to be applied to.',o):0!==T?logError('The "+" symbol, for joining a rule with the group of the previous rule, must be the first symbol on the line ',o):v=t[t.length-1].groupNumber:logError('Two "+"s (the "append to previous rule group" symbol) applied to the same rule.',o)):M in directionaggregates?l=l.concat(directionaggregates[M]):"late"===M?f=!0:"rigid"===M?p=!0:"random"===M?(b=!0,y&&logError("A rule-group can only be marked random by the opening rule in the group (aka, a '+' and 'random' can't appear as rule modifiers on the same line).  Why? Well, you see \"random\" isn't a property of individual rules, but of whole rule groups.  It indicates that a single possible application of some rule from the whole group should be applied at random.",o)):"global"==M?w=!0:"once"==M?S=!0:simpleAbsoluteDirections.indexOf(M)>=0?l.push(M):simpleRelativeDirections.indexOf(M)>=0?logError('You cannot use relative directions ("^v<>") to indicate in which direction(s) a rule applies.  Use absolute directions indicators (Up, Down, Left, Right, Horizontal, or Vertical, for instance), or, if you want the rule to apply in all four directions, do not specify directions',o):getTag(n,M)?k.push(M):"["==M?(0==l.length&&(l=l.concat(directionaggregates.orthogonal)),s=1,T--):logError("The start of a rule must consist of some number of directions (possibly 0), before the first bracket, specifying in what directions to look (with no direction specified, it applies in all four directions).  It seems you've just entered \""+M.toUpperCase()+'".',o);break;case 1:if("["==M)++E>1&&logWarning("Multiple opening brackets without closing brackets.  Something fishy here.  Every '[' has to be closed by a ']', and you can't nest them.",o),c.length>0&&logError('Error, malformed cell rule - encountered a "["" before previous bracket was closed',o),d=!0,c=[];else if(directions_only.includes(M))c.length%2==1?logError("Error, an item can only have one direction/action at a time, but you're looking for several at once!",o):d?f&&"no"!==M&&"random"!==M&&"randomdir"!==M?logError("Movements cannot appear in late rules.",o):c.push(M):logWarning("Invalid syntax. Directions should be placed at the start of a rule.",o);else if("|"==M)d?c.length%2==1?logError("In a rule, if you specify a movement, it has to act on an object.",o):(u.push(c),c=[]):logWarning('Janky syntax.  "|" should only be used inside cell rows (the square brackety bits).',o);else if("]"===M)--E<0&&logWarning("Multiple closing brackets without corresponding opening brackets.  Something fishy here.  Every '[' has to be closed by a ']', and you can't nest them.",o),c.length%2==1?"..."===c[0]?logError("Cannot end a rule with ellipses.",o):logError("In a rule, if you specify a movement, it has to act on an object.",o):(u.push(c),c=[]),h?m.push(u):g.push(u),u=[],d=!1;else if("->"===M){if(v!==o)t[t.length-1].late!==f&&logWarning("Oh gosh you can mix late and non-late rules in a rule-group if you really want to, but gosh why would you want to do that?  What do you expect to accomplish?",o);d?logError('Encountered an unexpected "->" inside square brackets.  It\'s used to separate states, it has no place inside them >:| .',o):h?logError('Error, you can only use "->" once in a rule; it\'s used to separate before and after states.',o):h=!0}else if(isAlreadyDeclared(n,M)||createObjectRef(n,M))d?c.length%2==0?(c.push(""),c.push(M)):c.length%2==1&&c.push(M):logWarning("Invalid token "+M.toUpperCase()+". Object names should only be used within cells (square brackets).",o);else if("..."===M)d?(c.push(M),c.push(M)):logWarning("Invalid syntax, ellipses should only be used within cells (square brackets).",o);else if(M.match(reg_commandwords)){!1===h?logError("Commands should only appear at the end of rules, not in or before the pattern-detection/-replacement sections.",o):d&&logWarning("Commands should only appear at the end of rules, not in or before the pattern-detection/-replacement sections.",o);const e=M.toLowerCase(),t=commandargs_table.includes(e),r=twiddleable_params.includes(e);if(t||r){if(r&&!n.metadata.includes("runtime_metadata_twiddling"))logError("You can only change a flag at runtime if you have the 'runtime_metadata_twiddling' prelude flag defined!",o);else{const n=findIndexAfterToken(a,i,T),t=a.substring(n).trim();r&&""==t&&logError('You included a twiddleable option, but did not specify a value. The twiddle may behave strangely. Please use "set", "default", "wipe", or specify the correct value. See the documentation for more info.',o),_.push([e,""==t?" ":t])}T=i.length}else _.push([e])}else logError('Error, malformed cell rule - was looking for cell contents, but found "'+M+'".  What am I supposed to do with this, eh, please tell me that.',o)}}if(f&&p&&logError("Late rules cannot be marked as rigid (rigid rules are all about dealing with the consequences of unresolvable movements, and late rules can't even have movements).",o),g.length!=m.length)_.length>0&&0==m.length||logError("Error, when specifying a rule, the number of matches (square bracketed bits) on the left hand side of the arrow must equal the number on the right",o);else for(T=0;T<g.length;T++)g[T].length!=m[T].length&&(logError("In a rule, each pattern to match on the left must have a corresponding pattern on the right of equal length (number of cells).",o),n.invalid=!0),0==g[T].length&&logError("You have an totally empty pattern on the left-hand side.  This will match *everything*.  You certainly don't want this.");0==g.length&&logError("This rule refers to nothing.  What the heck? :O",o);var C={directions:l,lhs:g,rhs:m,lineNumber:o,late:f,rigid:p,groupNumber:v,commands:_,randomRule:b,globalRule:w,isOnce:S,prefixes:k};return!1===directionalRule(C)&&C.directions.length>1&&C.directions.splice(1),C}function deepCloneHS(e,n){return e.map((e=>e.map((e=>n?n(e):[...e]))))}function deepCloneRule(e,n,t){return{lineNumber:e.lineNumber,direction:e.direction,lhs:deepCloneHS(e.lhs,n),rhs:deepCloneHS(e.rhs,t),late:e.late,rigid:e.rigid,groupNumber:e.groupNumber,commands:e.commands,randomRule:e.randomRule,globalRule:e.globalRule,isOnce:e.isOnce}}function rulesToArray(e){let n=parseRulesToArray(e);n=expandRulesWithPrefixes(e,n),n=expandRulesWithMultipleDirections(e,n);for(const t of n)convertRelativeDirsToAbsolute(e,t);n=expandRulesWithTags(e,n),checkRuleObjects(e,n),n=expandRulesWithMultiDirectionObjects(e,n);for(const t of n){if(debugSwitch.includes("noul")||rewriteUpLeftRules(t),atomizeAggregates(e,t),e.invalid)return;rephraseSynonyms(e,t)}n=convertObjectsAndDirections(e,n),e.rules=n}function parseRulesToArray(e){const n=e.rules;for(var t=[],r=[],o=[],a=0;a<n.length;a++){var i=n[a][1],s=processRuleString(n[a],e,t);if(s.bracket)r.push([i,s.bracket]);else if(s.label){const e=o.find((e=>e.label==s.label));e?logError(`Duplicate subroutine, "${s.label}" already defined at line ${e.lineNumber}`,s.lineNumber):o.push({label:s.label,lineNumber:s.lineNumber})}else t.push(s)}return e.loops=r,e.subroutines=o,debugSwitch.includes("exp")&&console.log(`parseRulesToArray ${t.length}`),t}function expandRulesWithPrefixes(e,n){const t=n.map((n=>expandRuleWithPrefixes(e,n))).flat();return debugSwitch.includes("exp")&&console.log(`expandRulesWithPrefixes ${n.length} -> ${t.length}`),t}function expandRuleWithPrefixes(e,n){if(0==n.prefixes.length)return[n];var t=[];const r=cartesianProduct(...n.prefixes.map((n=>e.tags[n])));for(const o of r){const r=t=>t.map(((t,r)=>r%2==0?t:replaceObjectPrefix(e,t,n.prefixes,o))),a=deepCloneRule(n,r,r);a.directions=n.directions,t.push(a)}return t}function replaceObjectPrefix(e,n,t,r){return n.split(":").map((n=>(e=>t.includes(e)&&r[t.indexOf(e)])(n)||(n=>{const o=t.find((t=>canMapValue(e,n,t)));return o&&getMappedValue(e,n,r[t.indexOf(o)])})(n)||n)).join(":")}function expandRulesWithTags(e,n){const t=n.map((n=>expandRuleWithTags(e,n))).flat();return debugSwitch.includes("exp")&&console.log(`expandRulesWithTags ${n.length} -> ${t.length}`),t}function expandRuleWithTags(e,n){const t=[];if(n.lhs.forEach(((n,r)=>{n.forEach(((n,o)=>{n.forEach(((n,a)=>{a%2!=1||"no"==[a-1]||"..."==n||isAlreadyDeclared(e,n)||t.push({rowx:r,cellx:o,atomx:a,ident:n})}))}))})),0==t.length)return[n];let r=[n];return t.forEach(((t,o)=>{const a=[];r.forEach((r=>{const o=new TagExpander(e,t.ident,!0);for(const e of o.getExpandedIdents()){const o=deepCloneRule(r);o.lhs[t.rowx][t.cellx][t.atomx]=e,n.rhs[t.rowx][t.cellx][t.atomx]==t.ident&&(o.rhs[t.rowx][t.cellx][t.atomx]=e),a.push(o)}})),r=a})),r}function expandRulesWithMultiDirectionObjects(e,n){var t=[];for(const e of n){const n=[...e.lhs,...e.rhs].flat().map((e=>e.filter(((e,n)=>n%2==1)))).flat(),r=n.map((e=>e.split(":"))).flat().filter(((e,n,t)=>e in directionaggregates&&t.indexOf(e)==n));if(0==r.length)t.push(e);else{const n=r[0];for(const r of directionaggregates[n]){const o=e=>e.map(((e,t)=>t%2==0?e:e==n?r:e.includes(`:${n}`)?e.replace(`:${n}`,`:${r}`):e));t.push(deepCloneRule(e,o,o))}}}return debugSwitch.includes("exp")&&console.log(`expandRulesWithMultiDirectionObjects ${n.length} -> ${t.length}`),t}function checkRuleObjects(e,n){for(const t of n){const n=[...t.lhs,...t.rhs].flat().map((e=>e.filter(((e,n)=>n%2==1)))).filter((e=>"..."!=e)).flat();for(const r of n)isAlreadyDeclared(e,r)||console.log("Not declared",t.lineNumber,r)}}function expandRulesWithMultipleDirections(e,n){for(var t=[],r=0;r<n.length;r++)for(var o=n[r],a=o.directions,i=0;i<a.length;i++){var s=a[i];if(s in directionaggregates&&directionalRule(o))for(var l=directionaggregates[s],c=0;c<l.length;c++){var u;(u=deepCloneRule(o)).direction=l[c],t.push(u)}else(u=deepCloneRule(o)).direction=s,t.push(u)}return debugSwitch.includes("exp")&&console.log(`expandRulesWithMultipleDirections ${n.length} -> ${t.length}`),t}function convertObjectsAndDirections(e,n){for(var t=[],r=0;r<n.length;r++){var o=n[r];t=t.concat(concretizeMovingRule(e,o,o.lineNumber))}var a=[];for(r=0;r<t.length;r++){o=t[r];a=a.concat(concretizePropertyRule(e,o,o.lineNumber))}for(r=0;r<a.length;r++)makeSpawnedObjectsStationary(e,a[r],o.lineNumber);return a}function containsEllipsis(e){for(var n=0;n<e.lhs.length;n++)for(var t=0;t<e.lhs[n].length;t++)if("..."===e.lhs[n][t][1])return!0;return!1}function rewriteUpLeftRules(e){if(!(containsEllipsis(e)||e.rhs.length>0&&e.rhs.length!=e.lhs.length)){if("up"==e.direction)e.direction="down";else{if("left"!=e.direction)return;e.direction="right"}for(var n=0;n<e.lhs.length;n++)e.lhs[n].reverse(),e.rhs.length>0&&e.rhs[n].reverse()}}function getPossibleObjectsFromCell(e,n){for(var t=[],r=0;r<n.length;r+=2){n[r];var o=n[r+1];if(o in e.objects)t.push(o);else if(o in e.propertiesDict)for(var a=e.propertiesDict[o],i=0;i<a.length;i++){var s=a[i];t.push(s)}}return t}function getPropertiesFromCell(e,n){for(var t=[],r=0;r<n.length;r+=2){var o=n[r],a=n[r+1];"random"!=o&&(a in e.propertiesDict&&t.push(a))}return t}function getMovings(e,n){for(var t=[],r=0;r<n.length;r+=2){var o=n[r],a=n[r+1];o in directionaggregates&&t.push([a,o])}return t}function concretizePropertyInCell(e,n,t){for(var r=0;r<e.length;r+=2)e[r+1]===n&&"random"!==e[r]&&(e[r+1]=t)}function concretizeMovingInCell(e,n,t,r){for(var o=0;o<e.length;o+=2)e[o]===n&&e[o+1]===t&&(e[o]=r)}function concretizeMovingInCellByAmbiguousMovementName(e,n,t){for(var r=0;r<e.length;r+=2)e[r]===n&&(e[r]=t)}function expandRuleTags(e,n){for(var t=[],r=0;r<n.length;r+=2){var o=n[r],a=n[r+1];if(!a.includes(":")||"no"!=o&&a in e.propertiesDict)t.push(o),t.push(a);else{const n=new TagExpander(e,a,!0);for(const e of n.getExpandedIdents())t.push(o),t.push(e)}}return t}function expandNoPrefixedProperties(e,n){for(var t=[],r=0;r<n.length;r+=2){var o=n[r],a=n[r+1];if("no"===o&&a in e.propertiesDict)for(var i=e.propertiesDict[a],s=0;s<i.length;s++){var l=i[s];t.push(o),t.push(l)}else t.push(o),t.push(a)}return t}function concretizePropertyRule(e,n,t){for(var r=0;r<n.lhs.length;r++)for(var o=n.lhs[r],a=0;a<o.length;a++)o[a]=expandNoPrefixedProperties(e,expandRuleTags(e,o[a])),n.rhs.length>0&&(n.rhs[r][a]=expandNoPrefixedProperties(e,expandRuleTags(e,n.rhs[r][a])));const i={},s=[],l=[];for(let t=0;t<n.rhs.length;t++){const r=n.lhs[t],o=n.rhs[t];for(let n=0;n<o.length;n++){const t=getPropertiesFromCell(e,r[n]),a=getPropertiesFromCell(e,o[n]);for(let e=0;e<a.length;e++){const n=a[e];t.includes(n)||(i[n]=!0)}t.forEach((e=>s.push(e))),a.forEach((e=>l.push(e)))}}let c=[n];if(s.length>0&&l.length>0){const t=n=>e.propertiesDict[n].length,r=t(s[0]);s.some((e=>t(e)!=r))||l.some((e=>t(e)!=r))||s.some((e=>l.includes(e)))||(c=function(n,t){let r=[];for(;t-- >0;)r.push(deepCloneRule(n));r.forEach(((n,t)=>{[n.lhs,n.rhs].forEach((n=>{n.forEach((n=>{n.forEach((n=>{for(let r=0;r<n.length;r+=2)"random"!=n[r]&&n[r+1]in e.propertiesDict&&(n[r+1]=e.propertiesDict[n[r+1]][t])}))}))}))})),debugSwitch.includes("exp")&&console.log(`replaceMappedProperties added ${rules.length} -> ${newrules.length}`);return r}(n,r))}for(var u,d=!0;d;){d=!1;for(r=0;r<c.length;r++){var h=c[r];u=!1;for(a=0;a<h.lhs.length&&!u;a++)for(var g=h.lhs[a],m=0;m<g.length&&!u;m++)for(var f=g[m],p=getPropertiesFromCell(e,f),v=0;v<p.length;++v){var _=p[v];if(!e.propertiesSingleLayer.hasOwnProperty(_)||!0===i[_]){var b=e.propertiesDict[_];u=!0,d=!0;for(var y=0;y<b.length;y++){var w=b[y],S=deepCloneRule(h);for(var k in S.propertyReplacement={},h.propertyReplacement)if(h.propertyReplacement.hasOwnProperty(k)){var E=h.propertyReplacement[k];S.propertyReplacement[k]=[E[0],E[1]]}concretizePropertyInCell(S.lhs[a][m],_,w),S.rhs.length>0&&concretizePropertyInCell(S.rhs[a][m],_,w),void 0===S.propertyReplacement[_]?S.propertyReplacement[_]=[w,1]:S.propertyReplacement[_][1]=S.propertyReplacement[_][1]+1,c.push(S)}break}}u&&(c.splice(r,1),r--)}}for(r=0;r<c.length;r++){if(void 0!==(h=c[r]).propertyReplacement)for(var _ in h.propertyReplacement)if(h.propertyReplacement.hasOwnProperty(_)){var T=h.propertyReplacement[_];w=T[0];if(1===T[1])for(a=0;a<h.rhs.length;a++){var M=h.rhs[a];for(m=0;m<M.length;m++){concretizePropertyInCell(M[m],_,w)}}}}var C="";for(r=0;r<c.length;r++){h=c[r];delete c.propertyReplacement;for(a=0;a<h.rhs.length;a++)for(g=h.rhs[a],m=0;m<g.length;m++)for(f=g[m],p=getPropertiesFromCell(e,f),v=0;v<p.length;v++)i.hasOwnProperty(p[v])&&(C=p[v])}return C.length>0?(logError('This rule has a property on the right-hand side, "'+C.toUpperCase()+"\", that can't be inferred from the left-hand side.  (either for every property on the right there has to be a corresponding one on the left in the same cell, OR, if there's a single occurrence of a particular property name on the left, all properties of the same name on the right are assumed to be the same).",t),[]):c}function makeSpawnedObjectsStationary(e,n,t){if(!n.late)for(var r=0;r<n.rhs.length;r++)for(var o=n.lhs[r],a=n.rhs[r],i=0;i<a.length;i++)for(var s=a[i],l=getPossibleObjectsFromCell(e,o[i]),c=l.map((n=>e.objects[n].layer)),u=0;u<s.length;u+=2){if(""===s[u]){var d=s[u+1];if(!(d in e.propertiesDict||l.indexOf(d)>=0)){var h=e.objects[d].layer;-1===c.indexOf(h)&&(s[u]="stationary")}}}}function concretizeMovingRule(e,n,t){for(var r,o=[n],a=!0;a;){a=!1;for(var i=0;i<o.length;i++){var s=o[i];r=!1;for(var l=0;l<s.lhs.length;l++)for(var c=s.lhs[l],u=0;u<c.length;u++){if((x=getMovings(e,c[u])).length>0){r=!0,a=!0;for(var d=x[0][0],h=x[0][1],g=directionaggregates[h],m=0;m<g.length;m++){var f=g[m],p=deepCloneRule(s);for(var v in p.movingReplacement={},s.movingReplacement)if(s.movingReplacement.hasOwnProperty(v)){var _=s.movingReplacement[v];p.movingReplacement[v]=[_[0],_[1],_[2],_[3],_[4],_[5]]}for(var v in p.aggregateDirReplacement={},s.aggregateDirReplacement)if(s.aggregateDirReplacement.hasOwnProperty(v)){_=s.aggregateDirReplacement[v];p.aggregateDirReplacement[v]=[_[0],_[1],_[2]]}if(concretizeMovingInCell(p.lhs[l][u],h,d,f),p.rhs.length>0&&concretizeMovingInCell(p.rhs[l][u],h,d,f),void 0===p.movingReplacement[d+h])p.movingReplacement[d+h]=[f,1,h,d,l,u];else{var b=p.movingReplacement[d+h];l===b[4]&&u===b[5]||(b[1]=b[1]+1)}void 0===p.aggregateDirReplacement[h]?p.aggregateDirReplacement[h]=[f,1,h]:p.aggregateDirReplacement[h][1]=p.aggregateDirReplacement[h][1]+1,o.push(p)}}}r&&(o.splice(i,1),i--)}}for(i=0;i<o.length;i++){if(void 0!==(s=o[i]).movingReplacement){var y={};for(var d in s.movingReplacement)if(s.movingReplacement.hasOwnProperty(d)){var w=(C=s.movingReplacement[d])[0],S=C[1],k=C[2],E=C[3];if(1===S)for(l=0;l<s.rhs.length;l++){var T=s.rhs[l];for(u=0;u<T.length;u++){concretizeMovingInCell(T[u],k,E,w)}}}var M={};for(var d in s.aggregateDirReplacement)if(s.aggregateDirReplacement.hasOwnProperty(d)){var C;w=(C=s.aggregateDirReplacement[d])[0],S=C[1];M[k=C[2]]=k in M||1!==S?"INVALID":w}for(var k in y)if(y.hasOwnProperty(k)&&"INVALID"!==k){if("INVALID"===(w=y[k]))continue;for(l=0;l<s.rhs.length;l++)for(T=s.rhs[l],u=0;u<T.length;u++){concretizeMovingInCellByAmbiguousMovementName(T[u],k,w)}}for(var k in M)if(M.hasOwnProperty(k)&&"INVALID"!==k){if("INVALID"===(w=M[k]))continue;for(l=0;l<s.rhs.length;l++)for(T=s.rhs[l],u=0;u<T.length;u++){concretizeMovingInCellByAmbiguousMovementName(T[u],k,w)}}}}var R="";for(i=0;i<o.length;i++){s=o[i];delete o.movingReplacement;for(l=0;l<s.rhs.length;l++)for(c=s.rhs[l],u=0;u<c.length;u++){var x;(x=getMovings(e,c[u])).length>0&&(R=x[0][1])}}return R.length>0&&(logError('This rule has an ambiguous movement on the right-hand side, "'+R+"\", that can't be inferred from the left-hand side.  (either for every ambiguous movement associated to an entity on the right there has to be a corresponding one on the left attached to the same entity, OR, if there's a single occurrence of a particular ambiguous movement on the left, all properties of the same movement attached to the same object on the right are assumed to be the same (or something like that)).",t),e.invalid=!0),o}function rephraseSynonyms(e,n){for(var t=0;t<n.lhs.length;t++)for(var r=n.lhs[t],o=n.rhs[t],a=0;a<r.length;a++){for(var i=r[a],s=1;s<i.length;s+=2){i[s]in e.synonymsDict&&(i[s]=e.synonymsDict[i[s]])}if(n.rhs.length>0){var l=o[a];for(s=1;s<l.length;s+=2){l[s]in e.synonymsDict&&(l[s]=e.synonymsDict[l[s]])}}}}function atomizeAggregates(e,n){for(var t=0;t<n.lhs.length;t++)for(var r=n.lhs[t],o=0;o<r.length;o++){atomizeCellAggregates(e,r[o],n.lineNumber)}for(t=0;t<n.rhs.length;t++)for(r=n.rhs[t],o=0;o<r.length;o++){atomizeCellAggregates(e,r[o],n.lineNumber)}}function atomizeCellAggregates(e,n,t){for(var r=0;r<n.length;r+=2){var o=n[r],a=n[r+1];if(a in e.aggregatesDict){"no"===o&&logError("You cannot use 'no' to exclude the aggregate object "+a.toUpperCase()+" (defined using 'AND'), only regular objects, or properties (objects defined using 'OR').  If you want to do this, you'll have to write it out yourself the long way.",t);var i=e.aggregatesDict[a];n[r+1]=i[0];for(var s=1;s<i.length;s++)n.push(n[r]),n.push(i[s])}}}function convertRelativeDirsToAbsolute(e,n){[...n.lhs,...n.rhs].flat().forEach((e=>{absolutifyRuleCell(n.direction,e)}))}function absolutifyRuleCell(e,n){const t=n=>relativeDirs.includes(n)?relativeDict[e][relativeDirs.indexOf(n)]:n;for(var r=0;r<n.length;r+=2)n[r]=t(n[r]),n[r+1]=n[r+1].split(":").map((e=>t(e))).join(":")}function rulesToMask(e){for(var n=e.collisionLayers.length,t=[],r=0;r<n;r++)t.push(null);for(r=0;r<e.rules.length;r++)for(var o=e.rules[r],a=0;a<o.lhs.length;a++)for(var i=o.lhs[a],s=o.rhs[a],l=0;l<i.length;l++){for(var c=i[l],u=t.concat([]),d=new BitVec(STRIDE_OBJ),h=new BitVec(STRIDE_OBJ),g=[],m=new BitVec(STRIDE_MOV),f=new BitVec(STRIDE_MOV),p=new BitVec(STRIDE_MOV),v=0;v<c.length;v+=2){if("..."===(P=c[v])){if(d=ellipsisPattern,2!==c.length)logError("You can't have anything in with an ellipsis. Sorry.",o.lineNumber);else if(0===l||l===i.length-1)logError("There's no point in putting an ellipsis at the very start or the end of a rule",o.lineNumber);else if(o.rhs.length>0){2===(S=s[l]).length&&"..."===S[0]||logError("An ellipsis on the left must be matched by one in the corresponding place on the right.",o.lineNumber)}break}if("random"!==P){var _=c[v+1],b=e.objects[_],y=e.objectMasks[_];if(b)var w=0|b.layer;else w=e.propertiesSingleLayer[_];if(void 0===w&&logError("Oops!  "+_.toUpperCase()+" not assigned to a layer.",o.lineNumber),"no"===P)h.ior(y);else null!==(V=u[w])&&(o.discard=[_.toUpperCase(),V.toUpperCase()]),u[w]=_,b?(d.ior(y),p.ishiftor(MOV_MASK,MOV_BITS*w)):g.push(y),"stationary"===P?f.ishiftor(MOV_MASK,MOV_BITS*w):m.ishiftor(dirMasks[P],MOV_BITS*w)}else logError("RANDOM cannot be matched on the left-hand side, it can only appear on the right",o.lineNumber)}if(o.rhs.length>0){var S=s[l],k=i[l];"..."===S[0]&&"..."!==k[0]&&logError("An ellipsis on the right must be matched by one in the corresponding place on the left.",o.lineNumber);for(v=0;v<S.length;v+=2){"..."===S[v]&&2!==S.length&&logError("You can't have anything in with an ellipsis. Sorry.",o.lineNumber)}}if(d!==ellipsisPattern){if(i[l]=new CellPattern([d,h,g,m,f,null]),d.anyBitsInCommon(h)){var E=o.lineNumber;r>0&&e.rules[r-1].lineNumber===E||r+1<e.rules.length&&e.rules[r+1].lineNumber===E||logWarning('This rule has some content of the form "X no X" (either directly or maybe indirectly - check closely how the terms are defined if nothing stands out) which can never match and so the rule is getting removed during compilation.',o.lineNumber),e.rules.splice(r,1),r--}else if(0!==o.rhs.length){var T=s[l],M=t.concat([]),C=t.concat([]),R=new BitVec(STRIDE_OBJ),x=new BitVec(STRIDE_OBJ),L=new BitVec(STRIDE_MOV),I=new BitVec(STRIDE_MOV),O=new BitVec(STRIDE_MOV),A=new BitVec(STRIDE_OBJ),N=new BitVec(STRIDE_MOV),D=new BitVec(STRIDE_MOV);for(v=0;v<T.length;v+=2){var P=T[v];_=T[v+1];if("..."===P)break;if("random"!==P){b=e.objects[_],y=e.objectMasks[_];if(b)w=0|b.layer;else w=e.propertiesSingleLayer[_];if("no"==P)R.ior(y);else{null===(V=M[w])&&(V=C[w]),null!==V&&(o.hasOwnProperty("discard")||logError("Rule matches object types that can't overlap: \""+_.toUpperCase()+'" and "'+V.toUpperCase()+'".',o.lineNumber)),M[w]=_,P.length>0&&N.ishiftor(MOV_MASK,MOV_BITS*w);var j=e.layerMasks[w];b&&(x.ibitset(b.id),R.ior(j),O.ishiftor(MOV_MASK,MOV_BITS*w)),"stationary"===P&&L.ishiftor(MOV_MASK,MOV_BITS*w),"randomdir"===P?D.ishiftor(dirMasks[P],MOV_BITS*w):I.ishiftor(dirMasks[P],MOV_BITS*w)}}else if(_ in e.objectMasks){var B,F=e.objectMasks[_];A.ior(F),e.propertiesDict.hasOwnProperty(_)?B=e.propertiesDict[_]:(logWarning(`In this rule you're asking me to spawn a random ${_.toUpperCase()} for you, but that's already a concrete single object.  You wanna be using random with properties (things defined in terms of OR in the legend) so there's some things to select between.`,o.lineNumber),B=[_]);for(var $=0;$<B.length;$++){var V,z=B[$];if(null!==(V=M[w=0|e.objects[z].layer])){var q=z.toUpperCase(),W=V.toUpperCase();q!==W&&logWarning("This rule may try to spawn a "+q+" with random, but also requires a "+W+" be here, which is on the same layer - they shouldn't be able to coexist!",o.lineNumber)}C[w]=z}}else logError('You want to spawn a random "'+_.toUpperCase()+"\", but I don't know how to do that",o.lineNumber)}d.bitsSetInArray(x.data)||R.ior(d),m.bitsSetInArray(I.data)||L.ior(m);for(v=0;v<n;v++)null!==u[v]&&null===M[v]&&(R.ior(e.layerMasks[v]),N.ishiftor(MOV_MASK,MOV_BITS*v));p.iclear(O),N.ior(p),R.iszero()&&x.iszero()&&L.iszero()&&I.iszero()&&N.iszero()&&A.iszero()&&D.iszero()||(i[l].replacement=new CellReplacement([R,x,L,I,N,A,D]))}}else i[l]=ellipsisPattern}}function cellRowMasks(e){for(var n=[],t=e[1],r=0;r<t.length;r++){for(var o=t[r],a=new BitVec(STRIDE_OBJ),i=0;i<o.length;i++)o[i]!==ellipsisPattern&&a.ior(o[i].objectsPresent);n.push(a)}return n}function cellRowMasks_Movements(e){for(var n=[],t=e[1],r=0;r<t.length;r++){for(var o=t[r],a=new BitVec(STRIDE_MOV),i=0;i<o.length;i++)o[i]!==ellipsisPattern&&a.ior(o[i].movementsPresent);n.push(a)}return n}function collapseRules(e){for(var n=0;n<e.length;n++)for(var t=e[n],r=0;r<t.length;r++){for(var o=t[r],a=[0,[],o.rhs.length>0,o.lineNumber],i=[],s=0;s<o.lhs.length;s++)i.push(0);a[0]=dirMasks[o.direction];for(s=0;s<o.lhs.length;s++){for(var l=o.lhs[s],c=0;c<l.length;c++)l[c]===ellipsisPattern&&(i[s]++,i[s]>2?logError("You can't use more than two ellipses in a single cell match pattern.",o.lineNumber):c>0&&l[c-1]===ellipsisPattern&&logWarning("Why would you go and have two ellipses in a row like that? It's exactly the same as just having a single ellipsis, right?",o.lineNumber));a[1][s]=l}a.push(i),a.push(o.groupNumber),a.push(o.rigid),a.push(o.commands),a.push(o.randomRule),a.push(cellRowMasks(a)),a.push(cellRowMasks_Movements(a)),a.push(o.globalRule),a.push(o.isOnce),t[r]=new Rule(a)}matchCache={}}function ruleGroupDiscardOverlappingTest(e){if(0!==e.length)for(var n=[],t=0;t<e.length;t++){var r=e[t];if(r.hasOwnProperty("discard")){var o=0!==t&&e[t-1].lineNumber===r.lineNumber,a=t!==e.length-1&&e[t+1].lineNumber===r.lineNumber;e.splice(t,1);for(var i=!1,s=0;s<n.length;s++){var l=n[s];if(l[0]===r.discard[0]&&l[1]===r.discard[1]){i=!0;break}}if(i||n.push(r.discard),!o&&!a||0===e.length){const e=n[0];var c="";if(n.length>1){c=" (ditto for ";for(s=1;s<n.length;s++){s>1&&(c+=", ",s===n.length-1&&(c+="and "));const e=n[s];if(c+=`${e[0]}/${e[1]}`,3===s&&n.length>4){c+=" etc.";break}}c+=")"}logError(`${e[0]} and ${e[1]} can never overlap${c}, but this rule requires that to happen, so it's being culled.`,r.lineNumber)}t--}}}function arrangeRulesByGroupNumber(e){for(var n={},t={},r=0;r<e.rules.length;r++){var o=e.rules[r],a=n;o.late&&(a=t),null==a[o.groupNumber]&&(a[o.groupNumber]=[]),a[o.groupNumber].push(o)}var i=[];for(var s in n){if(n.hasOwnProperty(s))ruleGroupDiscardOverlappingTest(c=n[s]),c.length>0&&i.push(c)}var l=[];for(var s in t){var c;if(t.hasOwnProperty(s))ruleGroupDiscardOverlappingTest(c=t[s]),c.length>0&&l.push(c)}e.rules=i,e.lateRules=l}function generateRigidGroupList(e){for(var n=[],t=[],r=[],o=[],a=[],i=0;i<e.rules.length;i++){for(var s=e.rules[i],l=!1,c=0;c<s.length;c++){s[c].isRigid&&(l=!0)}if(a[i]=l,l){var u=s[0].groupNumber;r[u]=i;var d=n.length;t[i]=d,o[u]=d,n.push(i)}}if(n.length>30){var h=n[30];logError("There can't be more than 30 rigid groups (rule groups containing rigid members).",e.rules[h][0].lineNumber)}e.rigidGroups=a,e.rigidGroupIndex_to_GroupIndex=n,e.groupNumber_to_RigidGroupIndex=o,e.groupIndex_to_RigidGroupIndex=t}function getMaskFromName(e,n){var t=new BitVec(STRIDE_OBJ);if(n in e.objects){var r=e.objects[n];t.ibitset(r.id)}if(n in e.aggregatesDict)for(var o=e.aggregatesDict[n],a=0;a<o.length;a++){var i=o[a];r=e.objects[i];t.ibitset(r.id)}if(n in e.propertiesDict)for(o=e.propertiesDict[n],a=0;a<o.length;a++){i=o[a],r=e.objects[i];t.ibitset(r.id)}if(n in e.synonymsDict){i=e.synonymsDict[n],r=e.objects[i];t.ibitset(r.id)}return!e.metadata.includes("nokeyboard")&&t.iszero()&&logErrorNoLine("error, didn't find any object called player, either in the objects section, or the legends section. there must be a player!"),t}function generateMasks(e){e.playerMask=getMaskFromName(e,"player");for(var n=[],t=e.collisionLayers.length,r=0;r<t;r++){for(var o=new BitVec(STRIDE_OBJ),a=0;a<e.objectCount;a++){var i=e.idDict[a];(l=e.objects[i]).layer==r&&o.ibitset(l.id)}n.push(o)}e.layerMasks=n;var s={};for(var i in e.objects)if(e.objects.hasOwnProperty(i)){var l=e.objects[i];s[i]=new BitVec(STRIDE_OBJ),s[i].ibitset(l.id)}var c=e.legend_synonyms.concat(e.legend_properties);c.sort((function(e,n){return e.lineNumber-n.lineNumber}));for(var u=0;u<c.length;u++){var d=c[u];if(2==d.length)s[d[0]]=s[d[1]];else{var h=new BitVec(STRIDE_OBJ);for(a=1;a<d.length;a++){i=d[a];h.ior(s[i])}s[d[0]]=h}}var g=new BitVec(STRIDE_OBJ);for(var m of(g.inot(),s["\nall\n"]=g,e.objectMasks=s,e.aggregateMasks={},Object.keys(e.aggregatesDict))){var f=e.aggregatesDict[m],p=new BitVec(STRIDE_OBJ);for(u=0;u<f.length;u++){i=f[u],l=e.objects[i];p.ior(s[i])}e.aggregateMasks[m]=p}}function checkObjectsAreLayered(e){for(var n in e.objects)if(e.objects.hasOwnProperty(n)){for(var t=!1,r=0;r<e.collisionLayers.length;r++){for(var o=e.collisionLayers[r],a=0;a<o.length;a++)if(o[a]===n){t=!0;break}if(t)break}if(!1===t){var i=e.objects[n];logError('Object "'+n.toUpperCase()+'" has been defined, but not assigned to a layer.',i.lineNumber)}}}function isInt(e){return!isNaN(e)&&function(e){return(0|e)===e}(parseFloat(e))}function twiddleMetaData(e,n=!1){var t;if(n)t=e.metadata;else{t={};for(var r=0;r<e.metadata.length;r+=2){var o=e.metadata[r],a=e.metadata[r+1];t[o]=a}}const i=function(e,n){if(!isFinite(e)||!isInt(e))return logWarning(`Wasn't able to make sense of "${e}" as a (whole number) dimension.`,n),NaN;var t=parseInt(e);return isNaN(t)&&logWarning(`Wasn't able to make sense of "${e}" as a dimension.`,n),t<=0&&logWarning(`The dimension given to me (you gave "${e}") is baad - it should be greater than 0.`,n),t},s=function(e,n){var t=a.split("x");if(2!==t.length)return logWarning("Dimensions must be of the form AxB.",n),null;var r=[i(t[0],n),i(t[1],n)];return!isFinite(t[0])||!isFinite(t[1])||isNaN(r[0])||isNaN(r[1])?(logWarning(`Couldn't understand the dimensions given to me (you gave "${a}") - should be of the form AxB.`,n),null):((r[0]<=0||r[1]<=0)&&logWarning(`The dimensions given to me (you gave "${a}") are baad - they should be > 0.`,n),r)};if(void 0!==t.flickscreen){a=t.flickscreen;t.flickscreen=s(0,e.metadata_lines.flickscreen),null===t.flickscreen&&delete t.flickscreen}if(void 0!==t.zoomscreen){a=t.zoomscreen;t.zoomscreen=s(0,e.metadata_lines.zoomscreen),null===t.zoomscreen&&delete t.zoomscreen}if(void 0!==t.smoothscreen){var l=(a=t.smoothscreen).split(/\s+/),c=!0;l.length<1?(logErrorNoLine("smoothscreen given no arguments but expects at least 1: smoothscreen [flick] WxH [IxJ] [S]"),c=!1):l.length>4&&(logErrorNoLine("smoothscreen given "+l.length+" arguments but expects at most 4: smoothscreen [flick] WxH [IxJ] [S]"),c=!1);const e={screenSize:{width:0,height:0},boundarySize:{width:1,height:1},cameraSpeed:.125,flick:!1,debug:!!t.smoothscreen_debug};"flick"===l[0]&&(e.flick=!0,l.shift());const n=l[0].match(/^(?<width>\d+)x(?<height>\d+)$/);if(n?(e.screenSize.width=parseInt(n.groups.width),e.screenSize.height=parseInt(n.groups.height),e.flick&&(e.boundarySize.width=e.screenSize.width,e.boundarySize.height=e.screenSize.height)):(logErrorNoLine("smoothscreen given first argument "+l[0]+" but must be formatted WxH where W and H are integers"),c=!1),l.length>1){const n=l[1].match(/^(?<width>\d+)x(?<height>\d+)$/);n?(e.boundarySize.width=parseInt(n.groups.width),e.boundarySize.height=parseInt(n.groups.height)):(logErrorNoLine("smoothscreen given second argument "+l[1]+" but must be formatted IxJ where I and J are integers"),c=!1)}if(l.length>2){const n=l[2].match(/^(?<speed>\d+(\.\d+)?)$/);n?e.cameraSpeed=clamp(parseFloat(n.groups.speed),0,1):(logErrorNoLine("smoothscreen given third argument "+l[2]+" but must be a number"),c=!1)}c?t.smoothscreen=e:delete t.smoothscreen}if(t.tween_easing){let e=t.tween_easing;e&&(e=NaN!=parseInt(e)&&easingAliases[parseInt(e)]?easingAliases[parseInt(e)]:e.toLowerCase(),EasingFunctions[e]?t.tween_easing=e:(logErrorNoLine(`tween easing ${t.tween_easing} is not valid.`),delete t.tween_easing))}if(t.tween_snap){const e=Math.max(parseInt(t.tween_snap),1);e?t.tween_snap=e:(logErrorNoLine(`tween ${t.tween_snap} is not valid.`),delete t.tween_snap)}e.metadata=t,n||(e.default_metadata=deepClone(t))}function processWinConditions(e){for(var n=[],t=0;t<e.winconditions.length;t++){var r=e.winconditions[t];if(0==r.length)return;var o=0;switch(r[0].toLowerCase()){case"no":o=-1;break;case"all":o=1}var a,i=r[r.length-1],s=r[1];a=5==r.length?r[3]:"\nall\n";var l=0,c=0,u=!1,d=!1;s in e.objectMasks?(u=!1,l=e.objectMasks[s]):s in e.aggregateMasks?(u=!0,l=e.aggregateMasks[s]):logError('Unwelcome term "'+s+"\" found in win condition. I don't know what I'm supposed to do with this. ",i),a in e.objectMasks?(d=!1,c=e.objectMasks[a]):a in e.aggregateMasks?(d=!0,c=e.aggregateMasks[a]):logError('Unwelcome term "'+s+"\" found in win condition. I don't know what I'm supposed to do with this. ",i);var h=[o,l,c,i,u,d];n.push(h)}e.winconditions=n}function printCellRow(e){for(var n="[ ",t=0;t<e.length;t++){t>0&&(n+="| ");for(var r=e[t],o=0;o<r.length;o+=2){var a=r[o],i=r[o+1];n+="..."===a?a+" ":a+" "+i+" "}}return n+="] "}function cacheRuleStringRep(e){var n="(<a onclick=\"jumpToLine('"+e.lineNumber.toString()+'\');"  href="javascript:void(0);">'+e.lineNumber+"</a>) "+e.direction.toString().toUpperCase()+" ";e.rigid&&(n="RIGID "+n+" "),e.randomRule&&(n="RANDOM "+n+" "),e.globalRule&&(n="GLOBAL "+n+" "),e.isOnce&&(n="ONCE "+n+" "),e.late&&(n="LATE "+n+" ");for(var t=0;t<e.lhs.length;t++){n+=printCellRow(e.lhs[t])}n+="-> ";for(t=0;t<e.rhs.length;t++){n+=printCellRow(e.rhs[t])}for(t=0;t<e.commands.length;t++){var r=e.commands[t];1===r.length?n+=r[0].toString():n=n+"("+r[0].toString()+", "+r[1].toString()+") "}e.stringRep=n}function cacheAllRuleNames(e){for(var n=0;n<e.rules.length;n++){cacheRuleStringRep(e.rules[n])}}function printRules(e){var n="",t=0,r=-1;let o=0;for(var a=0,i=0;i<e.rules.length;i++){var s=e.rules[i];let l="";for(let n=e.subroutines[o];n&&n.lineNumber<s.lineNumber;n=e.subroutines[++o])l+=`SUBROUTINE ${n.label}<br>`;if(t<e.loops.length&&e.loops[t][0]<s.lineNumber&&(n+=l+"STARTLOOP<br>",l="",++t<e.loops.length&&(r=e.loops[t][0],t++)),-1!==r&&r<s.lineNumber&&(n+="ENDLOOP<br>",r=-1),n+=l,s.hasOwnProperty("discard"))a++;else n+=i>0&&e.rules[i-1].groupNumber===s.groupNumber?"+ ":"&nbsp;&nbsp;",n+=s.stringRep+"<br>"}-1!==r&&(n+="ENDLOOP<br>"),n+="===========<br>",consolePrint(n="<br>Rule Assembly : ("+(e.rules.length-a)+" rules)<br>===========<br>"+n)}function removeDuplicateRules(e){for(var n={},t=-1,r=e.rules.length-1;r>=0;r--){var o=e.rules[r],a=o.groupNumber;a!==t&&(n={});var i=o.stringRep;n.hasOwnProperty(i)?e.rules.splice(r,1):n[i]=!0,t=a}}function generateLoopPoints(e){var n={},t=!0,r=0;if(e.loops.length>0){for(var o=0;o<e.loops.length;o++){var a=e.loops[o];o%2==0?-1===a[1]&&logError("Found an ENDLOOP, but I'm not in a loop?",a[0]):1===a[1]&&logError("Found a STARTLOOP, but I'm already inside a loop? (Puzzlescript can't nest loops, FWIW).",a[0])}var i=e.loops[e.loops.length-1];-1!==i[1]&&logError("Yo I found a STARTLOOP without a corresponding ENDLOOP.",i[0])}for(var s=0;s<e.loops.length;s++)for(a=e.loops[s],o=0;o<e.rules.length;o++){var l=(h=e.rules[o])[0],c=h[h.length-1],u=l.lineNumber,d=c.lineNumber;if(a[0]>=u&&a[0]<=d&&logWarning("Found a loop point in the middle of a rule. You probably don't want to do this, right?",a[0]),t){if(u>=a[0]){r=o,t=!1;break}}else if(u>=a[0]){n[o-1]=r,t=!0;break}}!1===t&&(n[e.rules.length]=r);e.loopPoint=n,n={},t=!0;for(s=0;s<e.loops.length;s++)for(a=e.loops[s],o=0;o<e.lateRules.length;o++){var h;l=(h=e.lateRules[o])[0],c=h[h.length-1],u=l.lineNumber,d=c.lineNumber;if(t){if(u>=a[0]){r=o,t=!1;break}}else if(u>=a[0]){n[o-1]=r,t=!0;break}}!1===t&&(n[e.lateRules.length]=r);e.lateLoopPoint=n}Level.prototype.calcBackgroundMask=function(e){void 0===e.backgroundlayer&&(logError("You have to have a background layer"),TooManyErrors());for(var n=e.layerMasks[e.backgroundlayer],t=0;t<this.n_tiles;t++){var r=this.getCell(t);if(r.iand(n),!r.iszero())return r}return(r=new BitVec(STRIDE_OBJ)).ibitset(e.backgroundid),r};var ifrm,soundDirectionMasks={up:1,down:2,left:4,right:8,horizontal:12,vertical:3,orthogonal:15,_action_:16,_lclick_:32,_rclick_:64};function generateSoundData(e){const n={},t=[],r=[],o=e.collisionLayers.map((e=>[])),a=[];for(const i of e.sounds)if("SOUNDEVENT"===i[0]){const e=i[1],t=i[2],r=i[3];n[e]&&logWarning(`${e.toUpperCase()} already declared.`,r),n[e]=t}else{const n=i[1];let s=i[2],l=i[3];const c=i[4],u=i[5];n in e.aggregatesDict&&logError('cannot assign sound events to aggregate objects (declared with "and"), only to regular objects, or properties, things defined in terms of "or" ("'+n+'").',u),n in e.objectMasks||logError(`Object "${n}" not found.`,u),soundverbs_directional.includes(s)?0==l.length&&(l=["orthogonal"]):soundverbs_movement.includes(s)?(l=[`_${s}_`],s="move"):l.length>0&&logError("Incorrect sound declaration - cannot have directions (UP/DOWN/etc.) attached to non-directional sound verbs (CREATE is not directional, but MOVE is directional).",u);let d=0;for(const e of l)soundDirectionMasks[e]?d|=soundDirectionMasks[e]:logError(`Was expecting a direction, instead found "${e}".`,u);let h=[n],g=!0;for(;g;){g=!1;for(let n=0;n<h.length;n++){const t=h[n];if(t in e.synonymsDict)h[n]=e.synonymsDict[t],g=!0;else if(t in e.propertiesDict){g=!0;const r=e.propertiesDict[t];h.splice(n,1),n--;for(let e=0;e<r.length;e++)h.push(r[e])}}}for(let n=0;n<h.length;n++){const i=h[n],l=e.objects[i],u=l.layer;let g=null;"move"!==s&&"cantmove"!==s||(g=new BitVec(STRIDE_MOV),g.ishiftor(d,MOV_BITS*u));const m={objId:l.id,directionMask:g,layer:u,seed:c};debugSwitch.includes("sfx")&&console.log(`Sfx verb ${s} o: ${JSON.stringify(m)}`),"move"===s?o[u].push(m):"cantmove"===s?a.push(m):"create"===s?t.push(m):r.push(m)}}e.sfx_Events=n,e.sfx_CreationMasks=t,e.sfx_DestructionMasks=r,e.sfx_MovementMasks=o,e.sfx_MovementFailureMasks=a}function formatHomePage(e){if(e.bgcolor="background_color"in e.metadata?colorToHex(colorPalette,e.metadata.background_color):"#000000",e.fgcolor="text_color"in e.metadata?colorToHex(colorPalette,e.metadata.text_color):"#FFFFFF",e.author_color="author_color"in e.metadata?colorToHex(colorPalette,e.metadata.author_color):"#FFFFFF",e.title_color="title_color"in e.metadata?colorToHex(colorPalette,e.metadata.title_color):"#FFFFFF",e.keyhint_color="keyhint_color"in e.metadata?colorToHex(colorPalette,e.metadata.keyhint_color):"#FFFFFF",canSetHTMLColors&&("background_color"in e.metadata&&(document.body.style.backgroundColor=e.bgcolor),"text_color"in e.metadata)){const r=document.getElementById("separator");null!=r&&(r.style.color=e.fgcolor);for(var n=document.getElementsByTagName("a"),t=0;t<n.length;t++)n[t].style.color=e.fgcolor;for(n=document.getElementsByTagName("h1"),t=0;t<n.length;t++)n[t].style.color=e.fgcolor}if("homepage"in e.metadata){var r=e.metadata.homepage;r=(r=r.replace("http://","")).replace("https://",""),e.metadata.homepage=r}}function loadFile(e){var n=new codeMirrorFn,t=n.startState();if(e&&0!=e.trim().length){for(var r=e.split("\n"),o=0;o<r.length;o++){var a=r[o];t.lineNumber=o+1;var i=new CodeMirror.StringStream(a,4);do{n.token(i,t)}while(!1===i.eol())}return debugSwitch.includes("tag")&&console.log("Tags",t.tags),debugSwitch.includes("map")&&console.log("Mappings",t.mappings),debugSwitch.includes("layer")&&console.log("Collision Layers",t.collisionLayers),debugSwitch.includes("layer")&&console.log("Collision Layer Groups",t.collisionLayerGroups),generateExtraMembers(t),generateMasks(t),levelsToArray(t),extractSections(t),rulesToArray(t),t.invalid>0?null:(cacheAllRuleNames(t),removeDuplicateRules(t),t.invalid>0?null:(convertSectionNamesToIndices(t),rulesToMask(t),debugMode&&printRules(t),arrangeRulesByGroupNumber(t),collapseRules(t.rules),collapseRules(t.lateRules),generateRigidGroupList(t),processWinConditions(t),checkObjectsAreLayered(t),twiddleMetaData(t),generateExtraMembersPart2(t),generateLoopPoints(t),fixUpGosubs(t),generateSoundData(t),formatHomePage(t),delete t.commentLevel,delete t.commentStyle,delete t.line_should_end,delete t.line_should_end_because,delete t.sol_after_comment,delete t.names,delete t.abbrevNames,delete t.objects_candname,delete t.objects_section,delete t.objects_spritematrix,delete t.section,delete t.subsection,delete t.tokenIndex,delete t.current_line_wip_array,delete t.visitedSections,delete t.loops,t))}logErrorNoLine("Empty file! Compilation abandoned!",!0)}function compile(e,n,t){(matchCache={},forceRegenImages=!0,void 0===e&&(e=["restart"]),void 0===t&&(t=null),lastDownTarget=canvas,void 0===n)&&(n=window.form1.code.editorreference.getValue()+"\n");!0===canDump&&(compiledText=n),errorCount=0,compiling=!0,errorStrings=[],consolePrint("=================================");try{console.log(`Begin compile: '${n.split("\n")[0]}'`);var r=loadFile(n)}catch(e){consolePrint(e),console.error(`Compile error: ${e}`),console.error(`${e.stack}`),errorStrings.push(e)}finally{compiling=!1}if(!r||r.invalid)return console.log(`End compile: aborted with error ${errorStrings[errorStrings.length-1]}`),consoleError(`<span class="systemMessage">Compilation aborted. ${errorStrings[errorStrings.length-1]}</span>`),null;if(console.log("End compile: "+(r&&!r.invalid&&0==errorCount?"ok":"FAILED, error count = "+errorCount)),r.levels&&0===r.levels.length&&logError("No levels found. Add some levels!",void 0,!0),errorCount>0)consoleError('<span class="systemMessage">Errors detected during compilation; the game may not work correctly.</span>');else{for(var o=0,a=0;a<r.rules.length;a++)o+=r.rules[a].length;for(a=0;a<r.lateRules.length;a++)o+=r.lateRules[a].length;consolePrint(htmlClass("systemMessage",`Successful ${"restart"==e[0]?"compilation":"live recompilation"}, generated ${o} instructions.`)),debugMode&&consolePrint(htmlClass("systemMessage",`Tags: ${Object.keys(r.tags).length} Objects: ${r.objectCount} Layers: ${r.collisionLayers.length} Sounds: ${r.sounds.length} Levels: ${r.levels.length}.`)),IDE&&void 0!==r.metadata.title&&(document.title=`${r.metadata.title} - PuzzleScript Next`)}return IDE&&(void 0!==r.metadata.tween_length&&r.lateRules.length>=1&&(logWarning("Using tweens in a game that also has LATE rules is currently experimental! If you change objects that moved with LATE then tweens might not play!",void 0,!0),logWarning("Note that if you change objects that have moved in LATE rules, their tweens won't play!",void 0,!0)),void 0!==r.metadata.level_select_unlocked_ahead&&void 0!==r.metadata.level_select_unlocked_rollover&&logWarning("You can't use both level_select_unlocked_ahead and level_select_unlocked_rollover at the same time, so please choose only one!",void 0,!0),void 0!==r.metadata.level_select||void 0===r.metadata.level_select_lock&&void 0===r.metadata.level_select_unlocked_ahead&&void 0===r.metadata.level_select_unlocked_rollover&&void 0===r.metadata.continue_is_level_select&&void 0===r.metadata.level_select_solve_symbol||logWarning("You're using level select prelude flags, but didn't define the 'level_select' flag.",void 0,!0),void 0!==r.metadata.level_select_lock||void 0===r.metadata.level_select_unlocked_ahead&&void 0===r.metadata.level_select_unlocked_rollover||logWarning("You've defined a level unlock condition, but didn't define the 'level_select_lock' flag.",void 0,!0),void 0!==r.metadata.runtime_metadata_twiddling_debug&&logWarning("RUNTIME_METADATA_TWIDDLING_DEBUG is deprecated, however you can now use verbose logging instead to see when metadata is changed.",void 0,!0),void 0!==r.metadata.level_select&&0==r.sections.length&&logWarning("To use LEVEL_SELECT, you need to create some sections first, otherwise the level list will be empty! Please see the docs for more info.",void 0,!0),isSitelocked()&&logError("The game is sitelocked. To continue testing, add the current domain '"+window.location.origin+"' to the list.",void 0,!0)),r&&(setGameState(r,e,t),clearInputHistory()),consoleCacheDump(),r}function qualifyURL(e){var n=document.createElement("a");return n.href=e,n.href}function isSitelocked(){if(void 0===state.metadata.sitelock_origin_whitelist&&void 0===state.metadata.sitelock_hostname_whitelist)return!1;if(1==IDE)return!1;if(void 0===state.metadata.sitelock_origin_whitelist)for(var e=state.metadata.sitelock_origin_whitelist.split(" "),n=window.location.origin,t=0;t<e.length;t+=1)if(n==e[t])return!1;if(null==state.metadata.sitelock_hostname_whitelist){var r=state.metadata.sitelock_hostname_whitelist.split(" "),o=window.location.hostname;for(t=0;t<r.length;t+=1)if(o==r[t])return!1}return!0}var keyRepeatTimer=0,keyRepeatIndex=0,input_throttle_timer=0,lastinput=-100,dragging=!1,rightdragging=!1,columnAdded=!1;function selectText(e,n){var t=document.getElementById(e);if(n&&(n.ctrlKey||n.metaKey)){if(solving)return;var r=["console"].concat(t.innerHTML.split("<br>")),o=levelFromString(state,r);loadLevelFromLevelDat(state,o,null),canvasResize()}else{if(document.selection)(a=document.body.createTextRange()).moveToElementText(t),a.select();else if(window.getSelection){var a;(a=document.createRange()).selectNode(t);var i=window.getSelection();i.removeAllRanges(),i.addRange(a)}}}function recalcLevelBounds(){}function arrCopy(e,n,t,r,o){for(;o--;)t[r++]=e[n]++}function adjustLevel(e,n,t){backups.push(backupLevel());var r=e.clone();e.width+=n,e.height+=t,e.n_tiles=e.width*e.height,e.objects=new Int32Array(e.n_tiles*STRIDE_OBJ);var o=new BitVec(STRIDE_OBJ);o.ibitset(state.backgroundid);for(var a=0;a<e.n_tiles;++a)e.setCell(a,o);return e.movements=new Int32Array(e.objects.length),columnAdded=!0,RebuildLevelArrays(),r}function addLeftColumn(){for(var e=adjustLevel(curLevel,1,0),n=1;n<curLevel.width;++n)for(var t=0;t<curLevel.height;++t){var r=n*curLevel.height+t;curLevel.setCell(r,e.getCell(r-curLevel.height))}}function addRightColumn(){for(var e=adjustLevel(curLevel,1,0),n=0;n<curLevel.width-1;++n)for(var t=0;t<curLevel.height;++t){var r=n*curLevel.height+t;curLevel.setCell(r,e.getCell(r))}}function addTopRow(){for(var e=adjustLevel(curLevel,0,1),n=0;n<curLevel.width;++n)for(var t=1;t<curLevel.height;++t){var r=n*curLevel.height+t;curLevel.setCell(r,e.getCell(r-n-1))}}function addBottomRow(){for(var e=adjustLevel(curLevel,0,1),n=0;n<curLevel.width;++n)for(var t=0;t<curLevel.height-1;++t){var r=n*curLevel.height+t;curLevel.setCell(r,e.getCell(r-n))}}function removeLeftColumn(){if(!(curLevel.width<=1))for(var e=adjustLevel(curLevel,-1,0),n=0;n<curLevel.width;++n)for(var t=0;t<curLevel.height;++t){var r=n*curLevel.height+t;curLevel.setCell(r,e.getCell(r+curLevel.height))}}function removeRightColumn(){if(!(curLevel.width<=1))for(var e=adjustLevel(curLevel,-1,0),n=0;n<curLevel.width;++n)for(var t=0;t<curLevel.height;++t){var r=n*curLevel.height+t;curLevel.setCell(r,e.getCell(r))}}function removeTopRow(){if(!(curLevel.height<=1))for(var e=adjustLevel(curLevel,0,-1),n=0;n<curLevel.width;++n)for(var t=0;t<curLevel.height;++t){var r=n*curLevel.height+t;curLevel.setCell(r,e.getCell(r+n+1))}}function removeBottomRow(){if(!(curLevel.height<=1))for(var e=adjustLevel(curLevel,0,-1),n=0;n<curLevel.width;++n)for(var t=0;t<curLevel.height;++t){var r=n*curLevel.height+t;curLevel.setCell(r,e.getCell(r+n))}}function matchGlyph(e,n){for(var t,r=-1,o=0;o<n.length;++o){var a=n[o][0],i=n[o][1],s=n[o][2];if(i.bitsSetInArray(e.data)){for(var l=0,c=0;c<32*STRIDE_OBJ;++c)s.get(c)&&e.get(c)&&l++,i.get(c)&&e.get(c)&&l++;l>r&&(r=l,t=a)}}return r>0?t:(logErrorNoLine("Wasn't able to approximate a glyph value for some tiles, using '.' as a placeholder.",!0),".")}var lastCoord,htmlEntityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"},selectableint=0;function printLevel(){var e=[];for(var n in state.glyphDict)if(state.glyphDict.hasOwnProperty(n)&&1===n.length){for(var t=state.glyphDict[n],r=new BitVec(STRIDE_OBJ),o=0;o<t.length;o++){var a=t[o];a>=0&&r.ibitset(a)}var i=r.clone(),s=state.layerMasks[state.backgroundlayer];r.iclear(s),e.push([n,r,i])}var l="selectable"+ ++selectableint,c='Printing level contents:<br><br><span id="'+l+'" onclick="selectText(\''+l+"',event)\"><br>";cache_console_messages=!1;for(var u=0;u<curLevel.height;u++){for(o=0;o<curLevel.width;o++){var d=u+o*curLevel.height;(t=matchGlyph(curLevel.getCell(d),e))in htmlEntityMap&&(t=htmlEntityMap[t]),c+=t}u<curLevel.height-1&&(c+="<br>")}consolePrint(c+="</span><br><br>",!0)}function levelEditorClick(e,n){if(mouseCoordY<=-2){var t=mouseCoordX+(screenwidth-1)*(editorRowCount-(-mouseCoordY-2)-1);-1===mouseCoordX?printLevel():mouseCoordX>=0&&t<glyphImages.length&&(glyphSelectedIndex=t,redraw())}else if(mouseCoordX>-1&&mouseCoordY>-1&&mouseCoordX<screenwidth-2&&mouseCoordY<screenheight-2-editorRowCount){for(var r=glyphImagesCorrespondance[glyphSelectedIndex],o=state.glyphDict[r],a=new BitVec(STRIDE_OBJ),i=0;i<o.length;i++){var s=o[i];s>=0&&a.ibitset(s)}var l=state.layerMasks[state.backgroundlayer];a.bitsClearInArray(l.data)&&a.ibitset(state.backgroundid);var c=mouseCoordY+mouseCoordX*curLevel.height;if(curLevel.getCell(c).equals(a))return;!1===anyEditsSinceMouseDown&&(anyEditsSinceMouseDown=!0,backups.push(backupLevel())),curLevel.setCell(c,a),redraw()}else n&&(-1===mouseCoordX?(addLeftColumn(),canvasResize()):mouseCoordX===screenwidth-2&&(addRightColumn(),canvasResize()),-1===mouseCoordY?(addTopRow(),canvasResize()):mouseCoordY===screenheight-2-editorRowCount&&(addBottomRow(),canvasResize()))}function levelEditorRightClick(e,n){if(-2===mouseCoordY)mouseCoordX<=glyphImages.length&&(glyphSelectedIndex=mouseCoordX,redraw());else if(mouseCoordX>-1&&mouseCoordY>-1&&mouseCoordX<screenwidth-2&&mouseCoordY<screenheight-2-editorRowCount){var t=mouseCoordY+mouseCoordX*curLevel.height,r=new BitVec(STRIDE_OBJ);r.ibitset(state.backgroundid),curLevel.setCell(t,r),redraw()}else n&&(-1===mouseCoordX?(removeLeftColumn(),canvasResize()):mouseCoordX===screenwidth-2&&(removeRightColumn(),canvasResize()),-1===mouseCoordY?(removeTopRow(),canvasResize()):mouseCoordY===screenheight-2-editorRowCount&&(removeBottomRow(),canvasResize()))}function getTilesTraversingPoints(e,n,t,r){if(cellwidth!==cellheight)throw"Error: Cell is not square.";var o=t-e,a=r-n,i=e*a-n*o,s=cellwidth*(Math.abs(o)+Math.abs(a)),l=2*i-s,c=2*i+s;for(var u=Math.floor(e/cellwidth),d=Math.floor(n/cellheight),h=Math.floor(t/cellwidth),g=Math.floor(r/cellheight),m=cellwidth-1,f=h-u>=0?1:-1,p=g-d>=0?1:-1,v=d,_=[],b=[],y=u;y!=h+f;y+=f)for(var w=!1,S=v;S!=g+p;S+=p){if(S>=curLevel.height||S<0||y>=curLevel.width||y<0)throw error="Mouse input loop failed; it:"+y+" "+S+" cell1:"+u+" "+d+" cell2:"+h+" "+g,console.log(error),error;if(fOfPointTimesTwo=a*(2*y*cellwidth+m)-o*(2*S*cellwidth+m),l<fOfPointTimesTwo==fOfPointTimesTwo<=c)_.push(y),b.push(S),w=!0,v=S;else if(w)break}for(var k=("mouse_obstacle"in state.metadata),E=[u],T=[d];u!==h||d!==g;){if(d>=curLevel.height||d<0||u>=curLevel.width||u<0)throw error="Mouse input loop failed; cell1:"+u+" "+d+" cell2:"+h+" "+g,console.log(error),error;if(hitObstacle=function(){var e=screenOffsetY+d+(screenOffsetX+u)*curLevel.height,n=curLevel.getCell(e);return!!state.obstacleMask.anyBitsInCommon(n)},cellCornerXTimesTwo=2*u*cellwidth+m+f*cellwidth,cellCornerYTimesTwo=2*d*cellwidth+m+p*cellwidth,fOfPointTimesTwo=a*cellCornerXTimesTwo-o*cellCornerYTimesTwo,fOfPointTimesTwo>2*i==p>0!=f>0?(u+=f,k&&hitObstacle()&&(u-=f,d+=p)):(d+=p,k&&hitObstacle()&&(d-=p,u+=f)),k&&hitObstacle())break;E.push(u),T.push(d)}if(k)_=E,b=T;else for(y=0;y<_.length;y++)if(_[y]!==E[y]||b[y]!==T[y]){try{displayError("line tile placement algorithm discrepancies detected")}catch(e){}throw consolePrint("line tile placement algorithm discrepancies detected",!0),"line tile placement algorithm discrepancies detected"}return{tileListX:_,tileListY:b}}var x1=5,y1=5,x2=5,y2=5;function mouseAction(e,n,t){if(debugSwitch.includes("input")&&console.log("mouseAction",e,n,t),textMode){if(!n){if(quittingTitleScreen)return;return void(hoverSelection=!mouseInCanvas||mouseCoordY<0||mouseCoordY>12?-1:mouseCoordY)}if("mousedown"!=e.type&&"touchstart"!=e.type)return;if(titleScreen){if(quittingTitleScreen||titleSelected)return;if(0==titleMode)generateTitleScreen(-1,0,!0),titleButtonSelected();else if(1==titleMode)generateTitleScreen(-1,0,mouseCoordY),titleSelection&&titleButtonSelected();else if(2===titleMode){if(generateLevelSelectScreen(mouseCoordY),0==mouseCoordY)goToTitleScreen(),tryPlayTitleSound();else if(2==mouseCoordY)0!=levelSelectScrollPos&&levelSelectScroll(-3);else if(12==mouseCoordY)state.sections.length-amountOfLevelsOnScreen>levelSelectScrollPos&&levelSelectScroll(3);else if(mouseCoordY>2&&mouseCoordY<12){mouseCoordY-3+levelSelectScrollPos<state.sections.length&&(generateLevelSelectScreen(-1,0,mouseCoordY),null!=titleSelection&&(titleSelected=!0,messageselected=!1,timer=0,quittingTitleScreen=!0))}}else 3==titleMode&&(generatePauseScreen(mouseCoordY),timer=0,quittingTitleScreen=!0)}else!1!==messageselected||!state.levels[curLevelNo].message&&""==messagetext||(messageselected=!0,timer=0,quittingMessageScreen=!0,tryPlayCloseMessageSound(),titleScreen=!1,drawMessageScreen(""))}else{if(winning)return;if(x1=x2,y1=y2,x2=mousePixelX,y2=mousePixelY,x2=Math.max(0,Math.min(cellwidth*screenwidth-1,mousePixelX)),y2=Math.max(0,Math.min(cellheight*screenheight-1,mousePixelY)),n){if(mouseCoordX>=0&&mouseCoordY>=0&&mouseCoordX<screenwidth&&mouseCoordY<screenheight){s=screenOffsetY+mouseCoordY+(screenOffsetX+mouseCoordX)*curLevel.height;againing||(pushInput(`mouse,${t},${s}`),mouseInput(t,s),e.handled=!0)}}else for(var r=getTilesTraversingPoints(x1,y1,x2,y2),o=r.tileListX,a=r.tileListY,i=0;i<o.length;i++){var s=screenOffsetY+a[i]+(screenOffsetX+o[i])*curLevel.height;lastCoord!==s&&(lastCoord=s,againing||(pushInput(`mouse,${t},${s}`),mouseInput(t,s),e.handled=!0))}}}function mouseInput(e,n){if(e>=0)try{var t=backupLevel(),r=curLevel.getCell(n);r.ibitset(e),curLevel.setCell(n,r);processInput(5,!1,!1,t)&&redraw()}catch(e){console.log(e),consolePrint(e,!0)}else{processInput(-1==e?6:7,!1,!1,t,n)&&redraw()}}var anyEditsSinceMouseDown=!1;function onMouseDown(e,n=!1){if(!e.handled){ULBS();var t=0===e.button,r=2===e.button;if("touchstart"==e.type&&(t=!0),t&&(e.ctrlKey||e.metaKey)&&(t=!1,r=!0),t){if(lastDownTarget=e.target,keybuffer=[],e.target===canvas||"tapFocusIndicator"===e.target.className){if(setMouseCoord(e),dragging=!0,rightdragging=!1,anyEditsSinceMouseDown=!1,levelEditorOpened&&!textMode)return levelEditorClick(e,!0);if("mouse_left"in state.metadata)return n&&prevent(e),mouseAction(e,!0,state.lmbID);if(state.metadata.mouse_clicks)return mouseAction(e,!0,-1)}dragging=!1,rightdragging=!1}else if(r)if("gameCanvas"===e.target.id){if(setMouseCoord(e),dragging=!1,rightdragging=!0,levelEditorOpened)return levelEditorRightClick(e,!0);if("mouse_right"in state.metadata)return mouseAction(e,!0,state.rmbID);if(state.metadata.mouse_clicks)return mouseAction(e,!0,-2)}else dragging=!1,rightdragging=!1;else if(1===e.button&&!1===textMode&&(IsMouseGameInputEnabled()||levelEditorOpened))return pushInput("undo"),DoUndo(!1,!0),canvasResize(),prevent(e);e.handled=!0}}function rightClickCanvas(e){return mouseCoordX>=0&&mouseCoordY>=0&&mouseCoordX<screenwidth&&mouseCoordY<screenheight||levelEditorOpened?prevent(e):void 0}function onMouseUp(e,n=!1){if(!e.handled){dragging=!1,rightdragging=!1;var t=0===e.button,r=2===e.button;if("touchend"==e.type&&(t=!0),t){if(e.target===canvas&&(setMouseCoord(e),"mouse_up"in state.metadata))return n&&prevent(e),mouseAction(e,!0,state.lmbupID)}else if(r&&"gameCanvas"===e.target.id&&(setMouseCoord(e),"mouse_rup"in state.metadata))return mouseAction(e,!0,state.rmbupID);e.handled=!0}}function onKeyDown(e){if(ULBS(),!IDE&&[32,37,38,39,40].indexOf(e.keyCode)>-1&&(e&&(e.ctrlKey||e.metaKey)||prevent(e)),IDE||77!==e.keyCode||toggleMute(),keybuffer.indexOf(e.keyCode)>=0)return prevent(e);(lastDownTarget===canvas||window.Mobile&&lastDownTarget===window.Mobile.focusIndicator)&&-1===keybuffer.indexOf(e.keyCode)&&(e&&(e.ctrlKey||e.metaKey)||(keybuffer.splice(keyRepeatIndex,0,e.keyCode),keyRepeatTimer=0,checkKey(e,!e.repeat))),!0===canDump&&(74===e.keyCode&&(e.ctrlKey||e.metaKey)?(dumpTestCase(),prevent(e)):75===e.keyCode&&(e.ctrlKey||e.metaKey)?(makeGIF(),prevent(e)):83===e.keyCode&&(e.ctrlKey||e.metaKey)?(saveClick(),prevent(e)):120===e.keyCode?(prevent(e),solve()):119===e.keyCode?(prevent(e),stopSolving()):13===e.keyCode&&(e.ctrlKey||e.metaKey)&&(canvas.focus(),editor.display.input.blur(),e.shiftKey?runClick():rebuildClick(),prevent(e),e.target.blur(),canvas.focus()))}function relMouseCoords(e){var n=0,t=0,r=0,o=0,a=this;do{n+=a.offsetLeft-a.scrollLeft,t+=a.offsetTop-a.scrollTop}while(a=a.offsetParent);return e.touches&&e.touches.length>=1?(r=e.touches[0].pageX-n,o=e.touches[0].pageY-t):null!=e.changedTouches&&e.changedTouches.length>=1?(r=e.changedTouches[0].pageX-n,o=e.changedTouches[0].pageY-t):(r=e.pageX-n,o=e.pageY-t),{x:r,y:o}}function onKeyUp(e){var n=keybuffer.indexOf(e.keyCode);n>=0&&(keybuffer.splice(n,1),keyRepeatIndex>=n&&keyRepeatIndex--)}function onMyFocus(e){keybuffer=[],keyRepeatIndex=0,keyRepeatTimer=0}function onMyBlur(e){keybuffer=[],keyRepeatIndex=0,keyRepeatTimer=0}HTMLCanvasElement.prototype.relMouseCoords=relMouseCoords;var mouseCoordX=0,mouseCoordY=0,mousePixelX=0,mousePixelY=0;function setMouseCoord(e){var n=canvas.relMouseCoords(e);mousePixelX=n.x-xoffset,mousePixelY=n.y-yoffset,mouseCoordX=Math.floor(mousePixelX/cellwidth),mouseCoordY=Math.floor(mousePixelY/cellheight)}function mouseMove(e){if(!e.handled){if(levelEditorOpened)setMouseCoord(e),dragging?levelEditorClick(e,!1):rightdragging&&levelEditorRightClick(e,!1),redraw();else if(titleScreen&&IsMouseGameInputEnabled()){var n=hoverSelection;setMouseCoord(e),mouseAction(e,!1,null),n!=hoverSelection&&(1==titleMode?generateTitleScreen(hoverSelection):2==titleMode?generateLevelSelectScreen(hoverSelection):3==titleMode&&generatePauseScreen(hoverSelection))}else dragging&&"mouse_drag"in state.metadata?(setMouseCoord(e),mouseAction(e,!1,state.dragID),redraw()):rightdragging&&"mouse_rdrag"in state.metadata&&(setMouseCoord(e),mouseAction(e,!1,state.rdragID),redraw());e.handled=!0}}let mouseInCanvas=!1;function onMouseIn(){mouseInCanvas=!0}function onMouseOut(){mouseInCanvas=!1}function onTouchDown(e){onMouseDown(e,!0)}function onTouchUp(e){onMouseUp(e,!0)}function onMouseWheel(e){mouseInCanvas&&!e.ctrlKey&&(normalizedDelta=Math.sign(e.deltaY),titleScreen&&2==titleMode&&IsMouseGameInputEnabled()&&(levelSelectScroll(normalizedDelta),redraw(),prevent(e)),levelEditorOpened&&(glyphSelectedIndex=clamp(glyphSelectedIndex+normalizedDelta,0,glyphCount()-1),redraw(),prevent(e)))}function levelSelectScroll(e){levelSelectScrollPos=clamp(levelSelectScrollPos+e,0,Math.max(state.sections.length-amountOfLevelsOnScreen,0)),titleSelection=clamp(titleSelection+e,0,state.sections.length-1),generateLevelSelectScreen()}function clamp(e,n,t){return Math.min(Math.max(e,n),t)}function prevent(e){return e.preventDefault&&e.preventDefault(),e.stopImmediatePropagation&&e.stopImmediatePropagation(),e.stopPropagation&&e.stopPropagation(),e.returnValue=!1,!1}function titleButtonSelected(){titleSelected||(tryPlayStartGameSound(),titleSelected=!0,timer=0,quittingTitleScreen=!0,canvasResize(),document.dispatchEvent(new Event("psplusGameStarted")))}document.addEventListener("touchstart",onTouchDown,{passive:!1}),document.addEventListener("touchmove",mouseMove,!1),document.addEventListener("touchend",onTouchUp,{passive:!1}),document.addEventListener("mousedown",onMouseDown,!1),document.addEventListener("mouseup",onMouseUp,!1),document.addEventListener("mousemove",mouseMove,!1),document.addEventListener("contextmenu",rightClickCanvas,!1),document.addEventListener("keydown",onKeyDown,!1),document.addEventListener("keyup",onKeyUp,!1),document.addEventListener("wheel",onMouseWheel,{passive:!1}),window.addEventListener("focus",onMyFocus,!1),window.addEventListener("blur",onMyBlur,!1),canvas.addEventListener("mouseenter",onMouseIn,!1),canvas.addEventListener("mouseleave",onMouseOut,!1);var gamepadKeys=[];function pollGamepads(){function e(e,n){return!(e.length<n)&&("object"==typeof e[n]?e[n].pressed:1==e[n])}function n(e,n,t){return!(e.length<n)&&e[n]*t>.5}var t=[];function r(e){-1===keybuffer.indexOf(e)&&(keybuffer.splice(keyRepeatIndex,0,e),keyRepeatTimer=0,checkKey({keyCode:e},!0)),t.splice(0,0,e)}function o(){for(var e=0;e<gamepadKeys.length;e++)if(!(t.indexOf(gamepadKeys[e])>=0)){var n=keybuffer.indexOf(gamepadKeys[e]);n>=0&&(keybuffer.splice(n,1),keyRepeatIndex>=n&&keyRepeatIndex--)}gamepadKeys=t}var a=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];if(null!=a&&0!=a.length){for(var i=0;i<a.length;i++){var s=a[i];null!=s&&s.connected&&((e(s.buttons,3)||e(s.buttons,4))&&r(82),(e(s.buttons,1)||n(s.axes,2,1))&&r(90),(e(s.buttons,2)||e(s.buttons,0)||e(s.buttons,5)||n(s.axes,1,1))&&r(88),e(s.buttons,7)&&r(27),e(s.buttons,6)&&r(69),(n(s.axes,0,1)||n(s.axes,6,1))&&r(39),(n(s.axes,0,-1)||n(s.axes,6,-1))&&r(37),(n(s.axes,1,-1)||n(s.axes,7,-1))&&r(38),(n(s.axes,1,1)||n(s.axes,7,1))&&r(40))}o()}else o()}let debugTimestamp;function checkKey(e,n){if(debugSwitch.includes("input")&&n&&console.log("checkKey",prevTimestamp,e,n),debugSwitch.includes("key")){const t=document.getElementById("debug");t&&(t.innerHTML=`key-${e.keyCode} just=${n} last=${~~(prevTimestamp-debugTimestamp)} TS=${~~prevTimestamp} delta=${~~(1e3*deltatime)} keybuffer=${keybuffer.length}`),debugTimestamp=prevTimestamp}if(ULBS(),!winning&&!(e&&(e.ctrlKey||e.metaKey||e.altKey)||e.keyCode>=112&&e.keyCode<=131)){var t=-1;switch(e.keyCode){case 65:case 37:t=dirNames.indexOf("left");break;case 38:case 87:t=dirNames.indexOf("up");break;case 68:case 39:t=dirNames.indexOf("right");break;case 83:case 40:t=dirNames.indexOf("down");break;case 80:return printLevel(),prevent(e);case 13:case 32:case 88:if(n&&ignoreNotJustPressedAction&&(ignoreNotJustPressedAction=!1),!1===n&&ignoreNotJustPressedAction)return prevent(e);if(!1!==norepeat_action&&!n)return prevent(e);t=dirNames.indexOf("action");break;case 85:case 90:if(!textMode)return pushInput("undo"),DoUndo(!1,!0),canvasResize(),prevent(e);break;case 82:if(!textMode&&n)return pushInput("restart"),DoRestart(),canvasResize(),prevent(e);break;case 27:if(solving){stopSolving();break}if(titleScreen){if(!titleScreen||titleMode>1)return(timer/1e3>.5||titleMode>1)&&!quittingTitleScreen&&n&&(titleSelection=0,timer=0,!1===titleScreen&&void 0!==state.metadata.level_select?gotoLevelSelectScreen():goToTitleScreen(),tryPlayTitleSound(),canvasResize()),prevent(e)}else goToPauseScreen(),canvasResize();break;case 69:if(!solving&&canOpenEditor)return n&&(titleScreen&&("EMPTY GAME"===state.title?compile(["loadFirstNonMessageLevel"]):nextLevel()),!1===(levelEditorOpened=!levelEditorOpened)&&printLevel(),restartTarget=backupLevel(),canvasResize()),prevent(e);break;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:if(levelEditorOpened&&n){var r=9;return e.keyCode>=49&&(r=e.keyCode-49),r<glyphImages.length?glyphSelectedIndex=r:consolePrint("Trying to select tile outside of range in level editor.",!0),canvasResize(),prevent(e)}break;case 189:if(levelEditorOpened&&n&&glyphSelectedIndex>0)return glyphSelectedIndex--,canvasResize(),prevent(e);break;case 187:if(levelEditorOpened&&n&&glyphSelectedIndex+1<glyphImages.length)return glyphSelectedIndex++,canvasResize(),prevent(e);break;case 33:if(!textMode&&showLayers)return showLayerNo++,canvasResize(),prevent(e);case 34:if(!textMode&&showLayers)return showLayerNo--,canvasResize(),prevent(e)}if(debugSwitch.includes("input")&&console.log("checkKey",prevTimestamp,throttle_movement,t,input_throttle_timer,repeatinterval),throttle_movement&&t>=0&&t<=3){if(lastinput==t&&input_throttle_timer<repeatinterval)return prevent(e);lastinput=t,input_throttle_timer=0}if(textMode){if(!throttle_movement){if(!titleScreen&&lastinput==t&&input_throttle_timer<repeatinterval)return prevent(e);lastinput=t,input_throttle_timer=0}if(0===state.levels.length);else if(titleScreen){if(isSitelocked())return prevent(e);if(!1===quittingTitleScreen)if(0===titleMode)4===t&&n&&(generateTitleScreen(-1,0,!0),titleButtonSelected(),clearInputHistory());else if(3==titleMode)4==t&&n?(generatePauseScreen(-1,0,levelSelectScrollPos),timer=0,quittingTitleScreen=!0,redraw()):0!=t&&2!=t||generatePauseScreen(-1,0==t?-1:1);else if(4==t&&n)!1===titleSelected&&(tryPlayStartGameSound(),titleSelected=!0,timer=0,quittingTitleScreen=!0,1==titleMode?(generateTitleScreen(-1,0,levelSelectScrollPos),document.dispatchEvent(new Event("psplusGameStarted"))):2==titleMode&&generateLevelSelectScreen(-1,0,levelHighlightLine));else if(0===t||2===t){if(quittingTitleScreen||titleSelected)return prevent(e);1==titleMode?generateTitleScreen(-1,0==t?-1:1):2==titleMode?generateLevelSelectScreen(-1,0==t?-1:1):3==titleMode&&generatePauseScreen(-1,0==t?-1:1)}}else if(4==t&&n){if(unitTesting)return nextLevel(),prevent(e);!1===messageselected&&(messageselected=!0,timer=0,quittingMessageScreen=!0,tryPlayCloseMessageSound(),titleScreen=!1,drawMessageScreen(""))}return prevent(e)}return!againing&&t>=0?(4===t&&"noaction"in state.metadata||(pushInput(t),processInput(t)&&redraw()),prevent(e)):prevent(e)}}function update(){var e=!1;if(timer+=deltatime,tweentimer+=deltatime,input_throttle_timer+=deltatime,quittingTitleScreen&&timer/1e3>.3&&(quittingTitleScreen=!1,titleMode<=1?nextLevel():2==titleMode?gotoLevel(titleSelection):3==titleMode&&selectPauseScreen()),againing&&timer>againinterval&&""==messagetext&&processInput(-1)&&(e=!0,keyRepeatTimer=0,autotick=0),quittingMessageScreen&&timer/1e3>.15&&(quittingMessageScreen=!1,state.levels[curLevelNo].message?nextLevel():(messagetext="",textMode=!1,titleScreen=!1,titleMode=curLevelNo>0||null!==curlevelTarget?1:0,titleSelected=!1,ignoreNotJustPressedAction=!0,titleSelection=0,canvasResize(),checkWin())),winning&&timer/1e3>.5&&(winning=!1,nextLevel()),pollGamepads(),keybuffer.length>0){keyRepeatTimer+=deltatime;var n=throttle_movement?repeatinterval:repeatinterval/Math.sqrt(keybuffer.length);if(keyRepeatTimer>n){keyRepeatTimer=0,keyRepeatIndex=(keyRepeatIndex+1)%keybuffer.length;var t=keybuffer[keyRepeatIndex];if(debugSwitch.includes("key")){const e=document.getElementById("debug");e&&(e.innerHTML=`key-${t} TL=${~~n} last=${~~(prevTimestamp-debugTimestamp)} TS=${~~prevTimestamp} delta=${~~(1e3*deltatime)} keybuffer=${keybuffer.length}`),debugTimestamp=prevTimestamp}checkKey({keyCode:t},!1)}}!(autotickinterval>0)||textMode||levelEditorOpened||againing||winning||(autotick+=deltatime)>autotickinterval&&(autotick=0,pushInput("tick"),processInput(-1)&&(e=!0)),(e||isAnimating)&&redraw()}var prevTimestamp,loop=function(e){if(void 0!==prevTimestamp&&(deltatime=e-prevTimestamp,debugSwitch.includes("key"))){const n=document.getElementById("debug");n&&(n.innerHTML=`timer=${timer.toFixed()} TS=${~~e} delta=${~~(1e3*deltatime)} KB=${keybuffer.length}`)}prevTimestamp=e;try{update()}catch(e){console.error(e)}window.requestAnimationFrame(loop)};function Animatable(e,n,t){var r;function o(){var e;return(r+=n)>=1&&(e=!0,r=1),t(r),e}function a(){var e;return(r-=n)<=0&&(e=!0,r=0),t(r),e}return r=0,{animateUp:function(){Animator.getInstance().animate(e,o)},animateDown:function(){Animator.getInstance().animate(e,a)}}}window.requestAnimationFrame(loop),window.Mobile={},Mobile.hasTouch=function(){var e;return("ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch)&&(e=!0),e},Mobile.enable=function(e){return(e||Mobile.hasTouch()&&!Mobile._instance)&&(Mobile._instance=new Mobile.GestureHandler,Mobile._instance.bindEvents(),Mobile._instance.bootstrap()),Mobile._instance},window.Mobile.GestureHandler=function(){this.initialize.apply(this,arguments)},Mobile.log=function(e){document.getElementsByTagName("h1")[0].innerHTML=Math.random().toString().substring(4,1)+"-"+e},Mobile.debugDot=function(e){var n,t;t="border-radius: 50px;width: 5px;height: 5px;background: red;position: absolute;left: "+e.touches[0].clientX+"px;top: "+e.touches[0].clientY+"px;",(n=document.createElement("div")).setAttribute("style",t),document.getElementsByTagName("body")[0].appendChild(n)},function(e){var n={action:88,left:37,right:39,up:38,down:40,undo:85,restart:82,quit:27},t=['<div class="tab">','  <div class="tab-affordance"></div>','  <div class="tab-icon">','    <div class="slice"></div>','    <div class="slice"></div>',"  </div>","</div>"].join("\n");e.initialize=function(){this.firstPos={x:0,y:0},this.setTabAnimationRatio=this.setTabAnimationRatio.bind(this),this.setMenuAnimationRatio=this.setMenuAnimationRatio.bind(this),this.repeatTick=this.repeatTick.bind(this),this.isFocused=!0},e.setFocusElement=function(e){this.focusElement=e,this.isFocused=!1,this.buildFocusIndicator()},e.bindEvents=function(){window.addEventListener("touchstart",this.onTouchStart.bind(this)),window.addEventListener("touchend",this.onTouchEnd.bind(this)),window.addEventListener("touchmove",this.onTouchMove.bind(this))},e.bootstrap=function(){this.showTab(),this.disableScrolling(),this.isAudioSupported()||this.disableAudio(),this.disableSelection()},e.onTouchStart=function(e){this.isTouching||(this.handleFocusChange(e),this.isFocused&&"A"!==e.target.tagName.toUpperCase()&&(this.isTouching=!0,this.mayBeSwiping=!0,this.gestured=!1,this.swipeDirection=void 0,this.swipeDistance=0,this.startTime=(new Date).getTime(),this.firstPos.x=e.touches[0].clientX,this.firstPos.y=e.touches[0].clientY))},e.onTouchEnd=function(e){this.isFocused&&this.isTouching&&(this.gestured||0===e.touches.length&&"unMuteButton"!==e.target.id&&"muteButton"!==e.target.id&&this.handleTap(),0===e.touches.length&&(this.isTouching=!1,this.endRepeatWatcher()))},e.onTouchMove=function(e){if(this.isFocused&&!levelEditorOpened)return this.isSuccessfulSwipe()?(this.handleSwipe(this.swipeDirection,this.touchCount),this.gestured=!0,this.mayBeSwiping=!1,this.beginRepeatWatcher(e)):this.mayBeSwiping?this.swipeStep(e):this.isRepeating&&this.repeatStep(e),prevent(e),!1},e.handleFocusChange=function(e){this.focusElement&&(this.isFocused=this.isTouchInsideFocusElement(e),this.setFocusIndicatorVisibility(this.isFocused),canvas.focus(),editor.display.input.blur())},e.isTouchInsideFocusElement=function(e){var n;return!(!e.touches||!e.touches[0])&&(n=this.absoluteElementPosition(this.focusElement),!(e.touches[0].clientX<n.left||e.touches[0].clientY<n.top)&&!(e.touches[0].clientX>n.left+this.focusElement.clientWidth||e.touches[0].clientY>n.top+this.focusElement.clientHeight))},e.setFocusIndicatorVisibility=function(e){},e.absoluteElementPosition=function(e){var n,t;for(n={top:e.offsetTop||0,left:e.offsetLeft||0},t=document.getElementsByTagName("body")[0],n.top-=t.scrollTop||0;e=e.offsetParent;)n.top+=e.offsetTop||0,n.left+=e.offsetLeft||0;return n},e.beginRepeatWatcher=function(e){var n;this.repeatInterval||(this.isRepeating=!0,n=1e3*state.metadata.key_repeat_interval,!isNaN(n)&&n||(n=150),this.repeatInterval=setInterval(this.repeatTick,n),this.recenter(e))},e.endRepeatWatcher=function(){this.repeatInterval&&(clearInterval(this.repeatInterval),delete this.repeatInterval,this.isRepeating=!1)},e.repeatTick=function(){this.isTouching&&this.handleSwipe(this.direction,this.touchCount)},e.recenter=function(e){this.firstPos.x=e.touches[0].clientX,this.firstPos.y=e.touches[0].clientY},e.isSuccessfulSwipe=function(){var e;return this.mayBeSwiping&&void 0!==this.swipeDirection&&this.swipeDistance>=50&&(e=!0),e},e.swipeStep=function(e){var n,t,r;this.mayBeSwiping&&(n={x:e.touches[0].clientX,y:e.touches[0].clientY},t=(new Date).getTime(),r=e.touches.length,this.swipeDistance=this.cardinalDistance(this.firstPos,n),this.swipeDirection?t-this.startTime>1e3&&(this.mayBeSwiping=!1):this.swipeDistance>10&&(this.swipeDirection=this.dominantDirection(this.firstPos,n),this.touchCount=r))},e.repeatStep=function(e){var n;n={x:e.touches[0].clientX,y:e.touches[0].clientY},this.cardinalDistance(this.firstPos,n)>=50&&(this.swipeDirection=this.dominantDirection(this.firstPos,n),this.recenter(e))},e.cardinalDistance=function(e,n){var t,r;return t=Math.abs(e.x-n.x),r=Math.abs(e.y-n.y),Math.max(t,r)},e.dominantDirection=function(e,n){var t,r,o;return t=n.x-e.x,r=n.y-e.y,o="x",Math.abs(r)>Math.abs(t)&&(o="y"),"x"===o?t>0?"right":"left":r>0?"down":"up"},e.handleSwipe=function(e,n){IsMouseGameInputEnabled()||(1===n?this.emitKeydown(this.swipeDirection):n>1&&this.toggleMenu())},e.handleTap=function(){IsMouseGameInputEnabled()||this.emitKeydown("action")},e.emitKeydown=function(e){var t;(this.isMenuVisible||"undo"!=e&&"restart"!=e&&"quit"!=e)&&(t={keyCode:n[e]},this.fakeCanvasFocus(),onKeyDown(t),onKeyUp(t))},e.fakeCanvasFocus=function(){onMouseDown({button:0,target:document.getElementById("gameCanvas")})},e.toggleMenu=function(){this.isMenuVisible?this.hideMenu():this.showMenu()},e.showMenu=function(){this.menuElem||this.buildMenu(),this.getAnimatables().menu.animateUp(),this.isMenuVisible=!0,this.hideTab()},e.hideMenu=function(){this.menuElem&&this.getAnimatables().menu.animateDown(),this.isMenuVisible=!1,this.showTab()},e.getAnimatables=function(){return this._animatables||(this._animatables={tab:Animatable("tab",.1,this.setTabAnimationRatio),menu:Animatable("menu",.1,this.setMenuAnimationRatio)}),this._animatables},e.showTab=function(){this.tabElem||this.buildTab(),this.getAnimatables().tab.animateDown()},e.hideTab=function(){this.tabElem&&this.tabElem.setAttribute("style","display: none;"),this.getAnimatables().tab.animateUp()},e.buildTab=function(){var e,n,r,o=this;(e=document.createElement("div")).innerHTML=t,r=e.children[0],n=function(e){e.stopPropagation(),o.showMenu()},this.tabAffordance=r.getElementsByClassName("tab-affordance")[0],this.tabElem=r.getElementsByClassName("tab-icon")[0],this.tabAffordance.addEventListener("touchstart",n),this.tabAffordance.addEventListener("click",(e=>{})),this.tabElem.addEventListener("touchstart",n),this.tabElem.addEventListener("click",(e=>{})),document.getElementsByTagName("body")[0].appendChild(r)},e.buildMenu=function(){var e,n,t,r,o,a,i=this;(e=document.createElement("div")).innerHTML=this.buildMenuString(state),this.menuElem=e.children[0],this.closeElem=this.menuElem.getElementsByClassName("close")[0],a=function(e){e.stopPropagation(),i.hideMenu()},this.closeAffordance=this.menuElem.getElementsByClassName("close-affordance")[0],o=this.menuElem.getElementsByClassName("close")[0],this.closeAffordance.addEventListener("touchstart",a),this.closeAffordance.addEventListener("click",(e=>{})),o.addEventListener("touchstart",a),o.addEventListener("click",(e=>{})),(n=this.menuElem.getElementsByClassName("undo")[0])&&(n.addEventListener("touchstart",(function(e){e.stopPropagation(),i.emitKeydown("undo")})),n.addEventListener("click",(e=>{}))),(t=this.menuElem.getElementsByClassName("restart")[0])&&(t.addEventListener("touchstart",(function(e){e.stopPropagation(),i.emitKeydown("restart")})),t.addEventListener("click",(e=>{}))),(r=this.menuElem.getElementsByClassName("quit")[0]).addEventListener("touchstart",(function(e){e.stopPropagation(),i.emitKeydown("quit")})),r.addEventListener("click",(e=>{})),document.getElementsByTagName("body")[0].appendChild(this.menuElem)},e.buildMenuString=function(e){var n,t,r,o;return n=3,(r=e.metadata.noundo)&&(n-=1),(o=e.metadata.norestart)&&(n-=1),t=['<div class="mobile-menu item-count-'+n+'">','  <div class="close-affordance"></div>','  <div class="close">','    <div class="slice"></div>','    <div class="slice"></div>',"  </div>"],r||t.push('  <div class="undo button">Undo</div>'),o||t.push('  <div class="restart button">Restart</div>'),(t=t.concat(['  <div class="quit button">Quit to Menu</div>','  <div class="clear"></div>',"</div>"])).join("\n")},e.buildFocusIndicator=function(){this.focusIndicator=document.createElement("DIV"),this.focusIndicator.setAttribute("class","tapFocusIndicator"),this.focusIndicator.setAttribute("style","visibility: hidden;"),this.focusElement.parentNode.appendChild(this.focusIndicator)},e.setTabAnimationRatio=function(e){var n;(e=Math.round(1e3*e)/1e3)>=.999?this.tabAffordance.setAttribute("style","display: none;"):this.tabAffordance.setAttribute("style","display: block;"),n="opacity: "+(1-e)+";"+" width: "+(66*e+18*(1-e))+"px;",this.tabElem.setAttribute("style",n)},e.setMenuAnimationRatio=function(e){var n,t,r;r="left: "+((n=-18*(e=Math.round(1e3*e)/1e3)+-66*(1-e))-4)+"px; "+(t="opacity: "+e+";")+" width: "+-n+"px;",(e=Math.round(1e3*e)/1e3)<=.001?(this.closeAffordance.setAttribute("style","display: none;"),t="display:none;"):this.closeAffordance.setAttribute("style","display: block;"),this.closeElem.setAttribute("style",r),this.menuElem.setAttribute("style",t)},e.disableScrolling=function(){var e={height:"100%",overflow:"hidden",position:"fixed",width:"100%",margin:0},n="";for(var t in e)n+=t+": "+e[t]+"; ";document.body.setAttribute("style",n)},e.disableAudio=function(){window.playSeed=function(){}},e.isAudioSupported=function(){var e=!0;return"undefined"!=typeof webkitAudioContext&&(e=!1),e},e.disableSelection=function(){var e;(e=document.getElementsByTagName("body")[0]).setAttribute("class",e.getAttribute("class")+" disable-select")}}(window.Mobile.GestureHandler.prototype),window.Animator=function(){this.initialize.apply(this,arguments)},function(e){e.initialize=function(){this._animations={},this.tick=this.tick.bind(this)},e.animate=function(e,n){this._animations[e]=n,this.wakeup()},e.wakeup=function(){this._isAnimating||(this._isAnimating=!0,this.tick())},e.tick=function(){var e,n,t;for(e in t=[],n=!0,this._animations){if(!this._animations.hasOwnProperty(e))return;this._animations[e]()?t.push(e):n=!1}if(n){for(0;0<t.length;t++)delete this._isAnimating[t[0]];this._isAnimating=!1}else requestAnimationFrame(this.tick)}}(window.Animator.prototype),window.Animator.getInstance=function(){return window.Animator._instance||(window.Animator._instance=new window.Animator),window.Animator._instance},function(){var e,n,t=["ms","moz","webkit","o"];for(e=0;e<t.length&&!window.requestAnimationFrame;e++)window.requestAnimationFrame=window[t[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[e]+"CancelAnimationFrame"],window.cancelAnimationFrame||(window.cancelAnimationFrame=window[t[e]+"CancelRequestAnimationFrame"]);window.requestAnimationFrame||(n=0,window.requestAnimationFrame=function(e,t){var r,o,a;return r=(new Date).getTime(),o=Math.max(0,16-(r-n)),a=window.setTimeout((function(){e(r+o)}),o),n=r+o,a}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)}),Mobile.enable()}();
//# sourceMappingURL=scripts_play_compiled.js.map</script><div style="z-index:2;background:0 0;position:absolute;top:.5em;right:1em"><img alt=mute id=muteButton width=32px height=32px onclick=muteAudio() style=display:none src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAALGPC/xhBQAAAAlwSFlzAAAOwgAADsIBFShKgAAAABl0RVh0U29mdHdhcmUAcGFpbnQubmV0IDQuMC4xOdTWsmQAAAIGSURBVFhH3ZchcsJAGIURiApEBbIH6BEqOQASWYHoESoQFcwgOAaiEsEBKip6BERlBQJRwQEqtu/tvj+TLMnAJpntTL+ZP/De7p/9k102YUCcc0tEbpbx4MHIAMcKQ2LM4ktmOCYH9gXIawXzQasLYGKnAphryErC53VJLiPvhNgjtog54tZ3bgDt7QpgTkyD/42Y+aQa2CG5APYvMdGnFTBC3COeEG8IY4M4uxtsSCqAfQ1ZhSdZATangdNCvhCVImheVQC6FFdKZHtkeQ8fB8QOsUCM5N0hPhBkQ8+gEQ5BXLUb+swSsu0cZXjFE/kswu7ElB6hCAeJS/isCDXZOcaIKeKdHvhBPKiN00F4l+zu1BaQtKkop1Ic5BCx8g3OfSJu5Fthj9LnBfB7Ckqzc/Dq1oihtA34LP0SpHuV7r0AYyXN6SC7SO+ley9gFpQ7SHNNkFifpP9fAcZaOvsUNC3ChbQtwq30eQGg88+QwLKNjRuS/e6toLl0bQGNsF+MmuwcdRuR7Ya2EfEJ6Z8JFOEQRK6tuHg8U4TDBdClr4eRn3uDRjhcCfsasgpPsgLs8uP4iBiryUMzqQDC/iXiFxJbA1zttg4IX9EqgxM2JBdAmBPT4Pf/SmYwr4y8PC+lBnMNWUn4vLbJBvNBtz8m4E//mtkGlK0IjhWG1Jj8EnRWMPhg8AvjeqPLyfe3igAAAABJRU5ErkJggg=="> <img alt=unmute id=unMuteButton width=32px height=32px onclick=unMuteAudio() style=display:none src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAZdEVYdFNvZnR3YXJlAHBhaW50Lm5ldCA0LjAuMTnU1rJkAAABqElEQVRYR72XW3LDMAwDc7QerTdPRWjBoW1aedXZGUYUAIlqP9LpLbjf77+jvs3vfvgUvkDMmiPHzGxg9HTXEjNjsB6A0Nar+MxYg+UPFoH5ccLCauE+3Wmqvke+Pk5YWAl3sJuXGiSx3wfSOsMsrKRm4i6DJJAEktB+L1YW1oG4xyAJJIGUSOsMs7A2xB0GSSAJpA3Sz8xgYYnh/8R5g+ZKFG6Q9yAQ9dS3JEcEkkBqkb8K2X8EcYEkkE5RxkH6rkz7VT10uu3wwcbrcOipB+hEg62ZmlR9hbL1wEkJndgRMpVgif1+j3yH6LsSOtGALZAE0rUPwBJICfJ1D0A2ylamfDxXke8QfVfCGdak6pXpNkZBvkP0XeUl3hvkFiKfP8CwT5BPIfavD0iQBNJhEPJnDzCjr6Q31sMfI4P0/gPM6BP20ivTnSClxrZFvkP0WQ4YCQuImfzNYLfId4i+VqL0ExDfgNUi3yF6V6LkC3AsQW6R7xB9rZeHmzhrkFrkO0R/qHcZZ4Plv3sROARHv1mvImbG4GxixbucmDVHMjOauf8qY/jt9gdOODPsYZA1BAAAAABJRU5ErkJggg=="></div><script>const sourceCode="title 2222\nauthor pestopancake\nhomepage https://github.com/ivanreese/2222/puzzlescript-next/by-pestopancake\n\n// https://github.com/ivanreese/2222\n\ntext_controls Say the words you see.\\nIf you make a mistake press [r].\\nHow far can you get?\nrealtime_interval 0.6039604\nsprite_size 16x16\nzoomscreen 4x1\nnokeyboard\nnoundo\nlevel_select\n\n========\nOBJECTS\n========\n\nBackground; white\n\nLetterA\nwhite black\n0000000000000000\n0000111111110000\n0001111111111000\n0011111111111100\n0011100000111100\n0111000000011110\n0111000000011110\n0111000000011110\n0111111111111110\n0111111111111110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0000000000000000\n\nLetterB\nwhite black\n0000000000000000\n0111111111110000\n0111111111111000\n0111000000111100\n0111000000011100\n0111000000011100\n0111000000111100\n0111111111111000\n0111111111111100\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000111100\n0111111111111000\n0111111111110000\n0000000000000000\n\nLetterC\nwhite black\n0000000000000000\n0000111111110000\n0011111111111100\n0111100000111110\n0111000000011110\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000011110\n0111100000111110\n0011111111111100\n0000111111110000\n0000000000000000\n\nLetterD\nwhite black\n0000000000000000\n0111111111100000\n0111111111111000\n0111000001111100\n0111000000111100\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000111100\n0111000001111100\n0111111111111000\n0111111111100000\n0000000000000000\n\nLetterE\nwhite black\n0000000000000000\n0111111111111110\n0111111111111110\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0111111111111000\n0111111111111000\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0111111111111110\n0111111111111110\n0000000000000000\n\nLetterF\nwhite black\n0000000000000000\n0111111111111110\n0111111111111110\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0111111111110000\n0111111111110000\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0000000000000000\n\nLetterG\nwhite black\n0000000000000000\n0000111111110000\n0011111111111100\n0111100000111110\n0111000000011110\n0111000000000000\n0111000000000000\n0111000111111110\n0111000111111110\n0111000000011110\n0111000000011110\n0111100000111110\n0011111111111100\n0001111111111000\n0000111111110000\n0000000000000000\n\nLetterH\nwhite black\n0000000000000000\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111111111111110\n0111111111111110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0000000000000000\n\nLetterI\nwhite black\n0000000000000000\n0001111111111000\n0001111111111000\n0000011110000000\n0000011110000000\n0000011110000000\n0000011110000000\n0000011110000000\n0000011110000000\n0000011110000000\n0000011110000000\n0000011110000000\n0000011110000000\n0001111111111000\n0001111111111000\n0000000000000000\n\nLetterJ\nwhite black\n0000000000000000\n0000001111111110\n0000001111111110\n0000000001111000\n0000000001111000\n0000000001111000\n0000000001111000\n0000000001111000\n0000000001111000\n0111000001111000\n0111000001111000\n0111100011111000\n0011111111110000\n0001111111100000\n0000111111000000\n0000000000000000\n\nLetterK\nwhite black\n0000000000000000\n0111000000111100\n0111000001111000\n0111000011110000\n0111000111100000\n0111001111000000\n0111011110000000\n0111111100000000\n0111111110000000\n0111011111000000\n0111001111100000\n0111000111110000\n0111000011111000\n0111000001111100\n0111000000111110\n0000000000000000\n\nLetterL\nwhite black\n0000000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0111111111111110\n0111111111111110\n0000000000000000\n\nLetterM\nwhite black\n0000000000000000\n0111000000011110\n0111100001111110\n0111110011111110\n0111111111111110\n0111111111011110\n0111011110011110\n0111001100011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0000000000000000\n\nLetterN\nwhite black\n0000000000000000\n0111000000011110\n0111100000011110\n0111110000011110\n0111111000011110\n0111111100011110\n0111011110011110\n0111001111011110\n0111000111111110\n0111000011111110\n0111000001111110\n0111000000111110\n0111000000011110\n0111000000011110\n0111000000011110\n0000000000000000\n\nLetterO\nwhite black\n0000000000000000\n0000111111110000\n0011111111111100\n0111100000111110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111100000111110\n0011111111111100\n0001111111111000\n0000111111110000\n0000000000000000\n\nLetterP\nwhite black\n0000000000000000\n0111111111110000\n0111111111111000\n0111000001111100\n0111000000111100\n0111000000111100\n0111000001111100\n0111111111111000\n0111111111110000\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0111000000000000\n0000000000000000\n\nLetterQ\nwhite black\n0000000000000000\n0000111111110000\n0011111111111100\n0111100000111110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000110011110\n0111001111011110\n0111100111111110\n0011111111111100\n0001111111111110\n0000111111001110\n0000000000000000\n\nLetterR\nwhite black\n0000000000000000\n0111111111110000\n0111111111111000\n0111000001111100\n0111000000111100\n0111000000111100\n0111000001111000\n0111111111110000\n0111111111111000\n0111001111111000\n0111000011111000\n0111000001111100\n0111000000111100\n0111000000111110\n0111000000011110\n0000000000000000\n\nLetterS\nwhite black\n0000000000000000\n0001111111111000\n0011111111111100\n0111100000111110\n0111000000011110\n0111100000000000\n0011111100000000\n0001111111110000\n0000001111111100\n0000000000111110\n0111000000011110\n0111100000111110\n0011111111111100\n0001111111111000\n0000111111110000\n0000000000000000\n\nLetterT\nwhite black\n0000000000000000\n0111111111111110\n0111111111111110\n0000011110000000\n0000011110000000\n0000011110000000\n0000011110000000\n0000011110000000\n0000011110000000\n0000011110000000\n0000011110000000\n0000011110000000\n0000011110000000\n0000011110000000\n0000011110000000\n0000000000000000\n\nLetterU\nwhite black\n0000000000000000\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111100000111110\n0011111111111100\n0001111111111000\n0000111111110000\n0000000000000000\n\nLetterV\nwhite black\n0000000000000000\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0011100000111100\n0001110001111000\n0000111011110000\n0000011111100000\n0000001111000000\n0000000110000000\n0000000000000000\n\nLetterW\nwhite black\n0000000000000000\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000000011110\n0111000110011110\n0111001111011110\n0111011111111110\n0111111111111110\n0111111001111110\n0111110000111110\n0111100000011110\n0111000000011110\n0000000000000000\n\nLetterX\nwhite black\n0000000000000000\n0111000000011110\n0111100000111110\n0011110001111100\n0001111011111000\n0000111111110000\n0000011111100000\n0000001111000000\n0000011111100000\n0000111111110000\n0001111011111000\n0011110001111100\n0111100000111110\n0111000000011110\n0111000000011110\n0000000000000000\n\nLetterY\nwhite black\n0000000000000000\n0111000000011110\n0011100000111100\n0001110001111000\n0000111011110000\n0000011111100000\n0000001111000000\n0000000110000000\n0000000110000000\n0000000110000000\n0000000110000000\n0000000110000000\n0000000110000000\n0000000110000000\n0000000110000000\n0000000000000000\n\nLetterZ\nwhite black\n0000000000000000\n0111111111111110\n0111111111111110\n0000000001111100\n0000000011111000\n0000000111110000\n0000001111100000\n0000011111000000\n0000111110000000\n0001111100000000\n0011111000000000\n0111110000000000\n0111100000000000\n0111111111111110\n0111111111111110\n0000000000000000\n\nNumber2\nblack white\n0000000000000000\n0001111111111000\n0011111111111100\n0111000000111110\n0000000001111100\n0000000011111000\n0000001111110000\n0000011111100000\n0000111111000000\n0001111110000000\n0011111100000000\n0111111000000000\n0111100000000000\n0111111111111110\n0111111111111110\n0000000000000000\n\nTarget; #FFF\nPlayer; #FFF\n\n=======\nLEGEND\n=======\n\n. = Background\n~ = Player\n{ = Player AND LetterA\n2 = Number2\n# = Target\n! = Target AND Number2\nA = LetterA\nB = LetterB\nC = LetterC\nD = LetterD\nE = LetterE\nF = LetterF\nG = LetterG\nH = LetterH\nI = LetterI\nJ = LetterJ\nK = LetterK\nL = LetterL\nM = LetterM\nN = LetterN\nO = LetterO\nP = LetterP\nQ = LetterQ\nR = LetterR\nS = LetterS\nT = LetterT\nU = LetterU\n_ = LetterV\nW = LetterW\nX = LetterX\nY = LetterY\nZ = LetterZ\n\n=======\nSOUNDS\n=======\n\nplayer move 85101706:1\nendlevel 123413:8\nStartlevel 765436:4\nTitleScreen 8817708:8\nrestart 29245308:15\n\n================\nCOLLISIONLAYERS\n================\n\nBackground\nTarget\nPlayer\nNumber2\nLetterA\nLetterB\nLetterC\nLetterD\nLetterE\nLetterF\nLetterG\nLetterH\nLetterI\nLetterJ\nLetterK\nLetterL\nLetterM\nLetterN\nLetterO\nLetterP\nLetterQ\nLetterR\nLetterS\nLetterT\nLetterU\nLetterV\nLetterW\nLetterX\nLetterY\nLetterZ\n\n======\nRULES\n======\n\nDOWN [ Player ] -> [ > Player ]\n\n==============\nWINCONDITIONS\n==============\n\nall Player on Target\n\n=======\nLEVELS\n=======\n\nsection 2222\n{BET\nABLE\nABLY\nABUT\nACAI\nACED\nACES\nACHE\nACHY\nACID\nACME\nACNE\nACRE\nACTS\nADDS\nAEON\nAFAR\nAFRO\nAGED\nAGES\nAGOG\nAHEM\nAIDE\nAILS\nAIMS\nAIRS\nAIRY\nAJAR\nAKIN\nALAS\nALLY\nALMS\nALOE\nALSO\nALTO\nALUM\nAMEN\nAMID\nAMMO\nAMOK\nAMPS\nANDS\nANEW\nANKH\nANON\nANTI\nANTS\nAPES\nAPEX\nAPPS\nAQUA\nARCH\nARCS\nAREA\nARIA\nARID\nARKS\nARMS\nARMY\nARSE\nARTS\nARTY\nASHY\nASKS\nATOM\nATOP\nAUNT\nAURA\nAUTO\nA_ID\nA_OW\nAWAY\nAWED\nAWES\nAWLS\nAWRY\nAXED\nAXES\nAXIS\nAXLE\nBABA\nBABE\nBABY\nBACH\nBACK\nBADS\nBAGS\nBAIL\nBAIT\nBAKE\nBALD\nBALE\nBALK\nBALL\nBALM\nBAND\nBANE\nBANG\nBANK\nBANS\nBARB\nBARD\nBARE\nBARF\nBARK\nBARN\nBARS\nBASE\nBASH\nBASK\nBASS\nBAST\nBATH\nBATS\nBAUD\nBAWL\nBAYS\nBEAD\nBEAK\nBEAM\nBEAN\nBEAR\nBEAT\nBEAU\nBECK\nBEDS\nBEEF\nBEEN\nBEEP\nBEER\nBEES\nBEET\nBEGS\nBELL\nBELT\nBEND\nBENT\nBERG\nBERM\nBEST\nBETA\nBETS\nBE_Y\nBEYS\nBIAS\nBIBS\nBIDE\nBIDS\nBIFF\nBIKE\nBILE\nBILK\nBILL\nBIND\nBIOS\nBIRD\nBITE\nBITS\nBLAB\nBLAH\nBLEB\nBLED\nBLEW\nBLIP\nBLOB\nBLOC\nBLOG\nBLOT\nBLOW\nBLUE\nBLUR\nBOAR\nBOAS\nBOAT\nBOBS\nBODE\nBODS\nBODY\nBOGS\nBOGY\nBOIL\nBOLA\nBOLD\nBOLO\nBOLT\nBOMB\nBOND\nBONE\nBONG\nBONK\nBONY\nBOOK\nBOOM\nBOON\nBOOR\nBOOS\nBOOT\nBORE\nBORN\nBOSS\nBOTH\nBOTS\nBOUT\nBOWL\nBOWS\nBOXY\nBOYO\nBOYS\nBOZO\nBRAG\nBRAN\nBRAS\nBRAT\nBRAY\nBRED\nBREW\nBRIE\nBRIG\nBRIM\nBRIS\nBRIT\nBROS\nBROW\nBUCK\nBUDS\nBUFF\nBUGS\nBULB\nBULK\nBULL\nBUMP\nBUMS\nBUND\nBUNG\nBUNK\nBUNS\nBUNT\nBUOY\nBURB\nBURG\nBURL\nBURN\nBURP\nBURR\nBURY\nBUSH\nBUSK\nBUST\nBUSY\nBUTT\nBUYS\nBUZZ\nBYES\nBYTE\nCABS\nCAFE\nCAFF\nCAGE\nCAKE\nCALF\nCALL\nCALM\nCAME\nCAMO\nCAMP\nCANE\nCANS\nCAPE\nCAPO\nCAPS\nCARB\nCARD\nCARE\nCARP\nCARS\nCART\nCASE\nCASH\nCASK\nCAST\nCATS\nCA_E\nCAWS\nCAYS\nCEDE\nCELL\nCELS\nCELT\nCENT\nCESS\nCHAD\nCHAI\nCHAP\nCHAR\nCHAT\nCHEF\nCHEW\nCHIC\nCHIN\nCHIP\nCHIT\nCHOP\nCHOW\nCHUB\nCHUG\nCHUM\nCIAO\nCITE\nCITY\nCLAD\nCLAM\nCLAN\nCLAP\nCLAW\nCLAY\nCLEF\nCLIP\nCLOD\nCLOG\nCLOP\nCLOT\nCLUB\nCLUE\nCOAL\nCOAT\nCOAX\nCOBS\nCOCA\nCOCO\nCODA\nCODE\nCODS\nCOED\nCOGS\nCOIL\nCOIN\nCOKE\nCOLA\nCOLD\nCOLE\nCOLT\nCOMA\nCOMB\nCOME\nCOMP\nCONE\nCONS\nCOOK\nCOOL\nCOOP\nCOOS\nCOPE\nCOPS\nCOPY\nCORD\nCORE\nCORK\nCORN\nCOST\nCOSY\nCOTS\nCOUP\nCO_E\nCOWL\nCOWS\nCOZY\nCRAB\nCRAG\nCRAM\nCRAP\nCRAW\nCREW\nCRIB\nCRIT\nCROC\nCROP\nCROW\nCRUD\nCRUX\nCUBE\nCUBS\nCUDS\nCUED\nCUES\nCUFF\nCULL\nCULT\nCUPS\nCURB\nCURD\nCURE\nCURL\nCURT\nCUSP\nCUSS\nCUTE\nCUTS\nCYAN\nCYST\nCZAR\nDABS\nDADA\nDADS\nDAFT\nDAME\nDAMN\nDAMP\nDAMS\nDANK\nDARE\nDARK\nDARN\nDART\nDASH\nDATA\nDATE\nDAWN\nDAYS\nDAZE\nDEAD\nDEAF\nDEAL\nDEAN\nDEAR\nDEBT\nDECK\nDEED\nDEEM\nDEEP\nDEER\nDEFT\nDEFY\nDELI\nDELL\nDELT\nDEMO\nDENS\nDENT\nDERM\nDESK\nDEWS\nDEWY\nDIAL\nDICE\nDIED\nDIES\nDIET\nDIGS\nDILL\nDIME\nDIMS\nDINE\nDING\nDINK\nDINO\nDINT\nDIPS\nDIRE\nDIRT\nDISC\nDISH\nDISK\nDISS\nDI_A\nDI_E\nDOCK\nDOCS\nDODO\nDOER\nDOES\nDOFF\nDOGS\nDOJO\nDOLE\nDOLL\nDOLT\nDOME\nDONE\nDONG\nDOOM\nDOOR\nDOPE\nDORK\nDORM\nDORY\nDOSE\nDOTE\nDOTH\nDOTS\nDOUR\nDO_E\nDOWN\nDOXY\nDOZE\nDOZY\nDRAB\nDRAG\nDRAM\nDRAW\nDRAY\nDREW\nDRIP\nDROP\nDRUG\nDRUM\nDRYS\nDUAL\nDUBS\nDUCK\nDUCT\nDUDE\nDUDS\nDUEL\nDUES\nDUET\nDUFF\nDUKE\nDULL\nDULY\nDUMB\nDUMP\nDUNE\nDUNG\nDUNK\nDUNS\nDUOS\nDUPE\nDUSK\nDUST\nDUTY\nDYAD\nDYED\nDYER\nDYES\nEACH\nEARL\nEARN\nEARS\nEASE\nEAST\nEASY\nEATS\nEA_E\nEBBS\nECHO\nEDDY\nEDGE\nEDGY\nEDIT\nEELS\nEGGS\nEGGY\nEGOS\nELKS\nELMS\nELSE\nEMIT\nEMMY\nEMUS\nENDS\nEN_Y\nEONS\nEPEE\nEPIC\nERAS\nERRS\nETCH\nEURO\nE_EN\nE_ER\nE_ES\nE_IL\nEWES\nEXAM\nEXEC\nEXIT\nEXON\nEXPO\nEYED\nEYES\nFABS\nFACE\nFACT\nFADE\nFADS\nFAIL\nFAIR\nFAKE\nFALL\nFAME\nFANG\nFANS\nFARE\nFARM\nFART\nFAST\nFATE\nFATS\nFAUN\nFA_A\nFA_E\nFAWN\nFAZE\nFEAR\nFEAT\nFEED\nFEEL\nFEES\nFEET\nFELL\nFELT\nFEND\nFENS\nFERN\nFESS\nFEST\nFETA\nFETE\nFEUD\nFIAT\nFIBS\nFIFE\nFIGS\nFILE\nFILL\nFILM\nFILO\nFIND\nFINE\nFINK\nFINS\nFIRE\nFIRM\nFIRS\nFISH\nFIST\nFITS\nFI_E\nFIZZ\nFLAB\nFLAG\nFLAK\nFLAM\nFLAN\nFLAP\nFLAT\nFLAW\nFLAX\nFLAY\nFLEA\nFLED\nFLEE\nFLEW\nFLEX\nFLIP\nFLIT\nFLOC\nFLOE\nFLOG\nFLOP\nFLOW\nFLUB\nFLUE\nFLUS\nFLUX\nFOAL\nFOAM\nFOBS\nFOCI\nFOES\nFOGS\nFOGY\nFOIL\nFOLD\nFOLK\nFOND\nFONT\nFOOD\nFOOL\nFOOT\nFOPS\nFORD\nFORE\nFORK\nFORM\nFORT\nFOUL\nFOUR\nFOWL\nFOXY\nFRAG\nFRAT\nFRAY\nFREE\nFRET\nFRIG\nFROG\nFROM\nFUEL\nFUCK\nFUGU\nFULL\nFUME\nFUND\nFUNK\nFURL\nFURS\nFURY\nFUSE\nFUSS\nFUTZ\nFUZZ\nGAFF\nGAGS\nGAIN\nGAIT\nGALA\nGALE\nGALL\nGALS\nGAME\nGANG\nGAPE\nGAPS\nGARB\nGASH\nGASP\nGATE\nGA_E\nGAWK\nGAYS\nGAZE\nGEAR\nGEEK\nGEES\nGELS\nGEMS\nGENE\nGENS\nGENT\nGERM\nGETS\nGHAT\nGHEE\nGIFT\nGIGS\nGILD\nGILL\nGILT\nGINS\nGIRD\nGIRL\nGIST\nGITS\nGI_E\nGLAD\nGLAM\nGLEE\nGLEN\nGLIB\nGLOB\nGLOM\nGLOP\nGLOW\nGLUE\nGLUG\nGLUM\nGLUT\nGNAR\nGNAT\nGNAW\nGOAD\nGOAL\nGOAT\nGOBS\nGOBY\nGODS\nGOER\nGOES\nGOLD\nGOLF\nGONE\nGONG\nGOOD\nGOOF\nGOON\nGOOP\nGOOS\nGORE\nGORY\nGOSH\nGOTH\nGOUT\nGOWN\nGRAB\nGRAD\nGRAM\nGRAN\nGRAY\nGREW\nGREY\nGRID\nGRIM\nGRIN\nGRIP\nGRIT\nGROG\nGROW\nGRUB\nGUFF\nGULF\nGULL\nGULP\nGUMS\nGUNK\nGUNS\nGURU\nGUSH\nGUST\nGUTS\nGUYS\nGYMS\nGYRE\nGYRO\nHACK\nHAGS\nHAIL\nHAIR\nHALF\nHALL\nHALO\nHALT\nHAMS\nHAND\nHANG\nHANK\nHAPS\nHARD\nHARE\nHARK\nHARM\nHARP\nHART\nHASH\nHATE\nHATH\nHATS\nHAUL\nHA_E\nHAWK\nHAWS\nHAYS\nHAZE\nHAZY\nHEAD\nHEAL\nHEAP\nHEAR\nHEAT\nHECK\nHEED\nHEEL\nHEFT\nHEIR\nHELD\nHELL\nHELM\nHELP\nHEMP\nHEMS\nHENS\nHERB\nHERD\nHERE\nHERO\nHERS\nHEST\nHEWN\nHEWS\nHICK\nHIDE\nHIGH\nHIKE\nHILL\nHILT\nHIND\nHINT\nHIPS\nHIRE\nHISS\nHITS\nHI_E\nHIYA\nHOAR\nHOAX\nHOBO\nHOCK\nHOED\nHOES\nHOGS\nHOLD\nHOLE\nHOLO\nHOLT\nHOLY\nHOME\nHONE\nHONK\nHOOD\nHOOF\nHOOK\nHOOP\nHOOT\nHOPE\nHOPS\nHORN\nHOSE\nHOST\nHOUR\nHO_E\nHOWL\nHUBS\nHUCK\nHUED\nHUES\nHUFF\nHUGE\nHUGS\nHULA\nHULK\nHULL\nHUMP\nHUMS\nHUNG\nHUNK\nHUNT\nHURL\nHURT\nHUSH\nHUSK\nHUTS\nHYMN\nHYPE\nHYPO\nICED\nICES\nICKY\nICON\nIDEA\nIDLE\nIDLY\nIDOL\nIFFY\nILLS\nIMPS\nINCH\nINFO\nINKS\nINKY\nINNS\nINTO\nIONS\nIOTA\nIRIS\nIRKS\nIRON\nISLE\nISMS\nITCH\nITEM\nJABS\nJACK\nJADE\nJAIL\nJAKE\nJAMB\nJAMS\nJAPE\nJARS\nJA_A\nJAWA\nJAWS\nJAYS\nJAZZ\nJEAN\nJEEP\nJEER\nJEEZ\nJELL\nJERK\nJEST\nJETS\nJIBE\nJIBS\nJIGS\nJILT\nJINK\nJINX\nJI_E\nJOBS\nJOCK\nJOGS\nJOIN\nJOKE\nJOLT\nJOTS\nJOWL\nJOYS\nJUDO\nJUGS\nJUJU\nJUKE\nJUMP\nJUNK\nJURY\nJUST\nJUTE\nJUTS\nKALE\nKEEL\nKEEN\nKEEP\nKEGS\nKELP\nKEPT\nKETO\nKEYS\nKHAN\nKHAT\nKICK\nKIDS\nKILL\nKILN\nKILO\nKILT\nKIND\nKING\nKIPS\nKISS\nKITE\nKITS\nKIWI\nKNEE\nKNEW\nKNIT\nKNOB\nKNOT\nKNOW\nKOAN\nKOOK\nKOTO\nLABS\nLACE\nLACK\nLACY\nLADS\nLADY\nLAGS\nLAID\nLAIN\nLAIR\nLAKE\nLAMA\nLAMB\nLAME\nLAMP\nLAND\nLANE\nLAPS\nLARD\nLARK\nLASH\nLASS\nLAST\nLATE\nLAUD\nLA_A\nLAWN\nLAWS\nLAYS\nLAZE\nLAZY\nLEAD\nLEAF\nLEAK\nLEAN\nLEAP\nLEAS\nLEEK\nLEER\nLEET\nLEFT\nLEGS\nLEND\nLENS\nLENT\nLESS\nLEST\nLEWD\nLIAR\nLIBS\nLICE\nLICK\nLIDS\nLIED\nLIEN\nLIER\nLIES\nLIEU\nLIFE\nLIFT\nLIKE\nLILT\nLILY\nLIMA\nLIMB\nLIME\nLIMO\nLIMP\nLINE\nLING\nLINO\nLINT\nLION\nLIPS\nLISP\nLIST\nLITE\nLI_E\nLOAD\nLOAF\nLOAM\nLOAN\nLOBE\nLOBS\nLOCH\nLOCK\nLOCO\nLODE\nLOFT\nLOGE\nLOGO\nLOGS\nLOIN\nLONE\nLONG\nLOOK\nLOOM\nLOON\nLOOP\nLOOS\nLOOT\nLOPS\nLORD\nLORE\nLOSE\nLOSS\nLOST\nLOTH\nLOTS\nLOUD\nLOUT\nLO_E\nLOWS\nLUBE\nLUCK\nLUFF\nLUGS\nLULL\nLUMP\nLUNE\nLUNG\nLURE\nLURK\nLUSH\nLUST\nLUTE\nLU_S\nLYNX\nLYRE\nMACE\nMACH\nMACK\nMACS\nMADE\nMAGE\nMAGI\nMAGS\nMAID\nMAIL\nMAIM\nMAIN\nMAKE\nMAKI\nMALE\nMALL\nMALT\nMAMA\nMANE\nMANS\nMANY\nMAPS\nMARE\nMARK\nMARS\nMART\nMASH\nMASK\nMASS\nMAST\nMATE\nMATH\nMATS\nMAUL\nMAWS\nMAXI\nMAYO\nMAZE\nMAZY\nMEAD\nMEAL\nMEAN\nMEAT\nMEEK\nMEET\nMEGA\nMELD\nMELT\nMEMO\nMEND\nMENU\nMEOW\nMERE\nMESA\nMESH\nMESS\nMETA\nMETE\nMEWL\nMEWS\nMICA\nMICE\nMICS\nMIDS\nMILD\nMILE\nMILK\nMILL\nMIME\nMIND\nMINE\nMINI\nMINK\nMINT\nMINX\nMIRE\nMISO\nMISS\nMIST\nMITE\nMOAN\nMOAT\nMOBS\nMOCK\nMODE\nMODS\nMOJO\nMOLD\nMOLE\nMOLT\nMOMS\nMONK\nMONO\nMOOD\nMOON\nMOOR\nMOOS\nMOOT\nMOPE\nMOPS\nMORE\nMORN\nMOSH\nMOSS\nMOST\nMOTE\nMOTH\nMO_E\nMOWS\nMUCH\nMUCK\nMUDS\nMUFF\nMUGS\nMULE\nMULL\nMUMS\nMUON\nMURK\nMUSE\nMUSH\nMUSK\nMUST\nMUTE\nMUTT\nMYTH\nNAAN\nNABS\nNAGS\nNAIL\nNAME\nNANA\nNANS\nNAPE\nNAPS\nNARC\nNARD\nNARY\nNA_Y\nNAYS\nNEAR\nNEAT\nNECK\nNEED\nNEEM\nNEON\nNERD\nNESS\nNEST\nNETS\nNEWS\nNEWT\nNEXT\nNIBS\nNICE\nNICK\nNIGH\nNINE\nNITE\nNOBS\nNODE\nNODS\nNOEL\nNOIR\nNONE\nNOOK\nNOON\nNOPE\nNORI\nNORM\nNOSE\nNOSH\nNOSY\nNOTE\nNOUN\nNO_A\nNUBS\nNUDE\nNUKE\nNULL\nNUMB\nNUNS\nNUTS\nOAFS\nOAKS\nOAKY\nOARS\nOATH\nOATS\nOBEY\nOBIT\nOBOE\nODDS\nODES\nODOR\nOGLE\nOGRE\nOILS\nOILY\nOINK\nOKAY\nOKRA\nOLDS\nOMEN\nOMIT\nONCE\nONES\nONLY\nONTO\nONUS\nONYX\nOOPS\nOOZE\nOOZY\nOPAL\nOPEN\nOPTS\nOPUS\nORAL\nORBS\nORCA\nORES\nORGY\nORZO\nOUCH\nOURS\nOUST\nOUTS\nO_AL\nO_EN\nO_ER\nO_UM\nOWED\nOWES\nOWLS\nOWNS\nPACE\nPACK\nPACT\nPADS\nPAGE\nPAID\nPAIL\nPAIN\nPAIR\nPALE\nPALL\nPALM\nPALP\nPALS\nPANE\nPANG\nPANS\nPANT\nPAPA\nPAPS\nPARA\nPARE\nPARK\nPARS\nPART\nPASS\nPAST\nPATE\nPATH\nPATS\nPA_E\nPAWN\nPAWS\nPAYS\nPEAK\nPEAL\nPEAR\nPEAS\nPEAT\nPECK\nPECS\nPEED\nPEEK\nPEEL\nPEEP\nPEER\nPEES\nPEGS\nPELT\nPENS\nPENT\nPEON\nPERK\nPERM\nPERP\nPESO\nPEST\nPETS\nPEWS\nPHEW\nPICK\nPICS\nPIED\nPIER\nPIES\nPIGS\nPIKA\nPIKE\nPILE\nPILL\nPINE\nPING\nPINK\nPINS\nPINT\nPIPE\nPISS\nPITA\nPITH\nPITS\nPITY\nPLAN\nPLAT\nPLAY\nPLEA\nPLEB\nPLED\nPLEX\nPLOD\nPLOP\nPLOT\nPLOW\nPLOY\nPLUG\nPLUM\nPLUS\nPOCK\nPODS\nPOEM\nPOET\nPOKE\nPOKY\nPOLE\nPOLL\nPOLO\nPOLY\nPOMP\nPOND\nPONG\nPONY\nPOOF\nPOOL\nPOOP\nPOOR\nPOPE\nPOPS\nPORE\nPORK\nPORT\nPOSE\nPOSH\nPOSY\nPOTS\nPOUF\nPOUR\nPOUT\nPRAM\nPRAY\nPREP\nPREY\nPREZ\nPRIG\nPRIM\nPROB\nPROD\nPROF\nPROG\nPROM\nPROP\nPROS\nPROW\nPUBS\nPUCK\nPUDS\nPUFF\nPUGS\nPUKE\nPULL\nPULP\nPUMA\nPUMP\nPUNK\nPUNS\nPUNT\nPUNY\nPUPA\nPUPS\nPURE\nPURL\nPURR\nPUSH\nPUSS\nPUTS\nPUTT\nPUTZ\nPYRE\nPYRO\nQUAD\nQUID\nQUIP\nQUIT\nQUIZ\nRACE\nRACK\nRACY\nRADS\nRAFT\nRAGA\nRAGE\nRAGS\nRAID\nRAIL\nRAIN\nRAJA\nRAKE\nRAKU\nRALE\nRAMP\nRAMS\nRANG\nRANK\nRANT\nRAPS\nRAPT\nRARE\nRASH\nRASP\nRATE\nRATH\nRATS\nRA_E\nRAYS\nRAZE\nRAZZ\nREAD\nREAL\nREAM\nREAP\nREAR\nREDO\nREED\nREEF\nREEK\nREEL\nREFS\nREIN\nRELY\nREMS\nREND\nRENT\nREPO\nREPP\nREPS\nREST\nRIBS\nRICE\nRICH\nRIDE\nRIDS\nRIFE\nRIFF\nRIFT\nRIGS\nRILE\nRILL\nRIME\nRIMS\nRIND\nRING\nRINK\nRIOT\nRIPE\nRIPS\nRISE\nRISK\nRITE\nRITZ\nROAD\nROAM\nROAN\nROAR\nROBE\nROBS\nROCK\nRODE\nRODS\nROES\nROIL\nROLE\nROLL\nROMP\nROMS\nROOF\nROOK\nROOM\nROOS\nROOT\nROPE\nROPY\nROSE\nROSY\nROTE\nROTI\nROTO\nROTS\nROUT\nROUX\nRO_E\nROWS\nRUBE\nRUBS\nRUBY\nRUCK\nRUDE\nRUED\nRUES\nRUFF\nRUGS\nRUIN\nRULE\nRUMP\nRUMS\nRUNE\nRUNG\nRUNS\nRUNT\nRUSE\nRUSH\nRUST\nRUTS\nSACK\nSACS\nSAFE\nSAGA\nSAGE\nSAGO\nSAGS\nSAID\nSAIL\nSAKE\nSAKI\nSALE\nSALT\nSAME\nSAND\nSANE\nSANG\nSANK\nSAPS\nSARI\nSASH\nSASS\nSATE\nSA_E\nSAWN\nSAWS\nSAYS\nSCAB\nSCAD\nSCAM\nSCAN\nSCAR\nSCAT\nSCOT\nSCUD\nSCUM\nSEAL\nSEAM\nSEAR\nSEAS\nSEAT\nSECT\nSEED\nSEEK\nSEEM\nSEEN\nSEEP\nSEER\nSEES\nSELF\nSELL\nSEMI\nSEND\nSENT\nSEPT\nSETS\nSEWN\nSEWS\nSHAM\nSHED\nSHEW\nSHIM\nSHIN\nSHIP\nSHIT\nSHI_\nSHOD\nSHOE\nSHOO\nSHOP\nSHOT\nSHOW\nSHUN\nSHUT\nSIBS\nSICK\nSIDE\nSIFT\nSIGH\nSIGN\nSILK\nSILL\nSILO\nSILT\nSINE\nSING\nSINK\nSINS\nSIPS\nSIRE\nSIRS\nSITE\nSITS\nSIZE\nSKEW\nSKID\nSKIM\nSKIN\nSKIP\nSKIS\nSKIT\nSLAB\nSLAG\nSLAM\nSLAP\nSLAT\nSLAW\nSLAY\nSLED\nSLEW\nSLID\nSLIM\nSLIP\nSLIT\nSLOB\nSLOE\nSLOG\nSLOP\nSLOT\nSLOW\nSLUG\nSLUM\nSMOG\nSMUG\nSNAG\nSNAP\nSNIP\nSNIT\nSNOB\nSNOT\nSNOW\nSNUB\nSNUG\nSOAK\nSOAP\nSOAR\nSOBA\nSOBS\nSOCK\nSODA\nSODS\nSOFA\nSOFT\nSOIL\nSOLD\nSOLE\nSOLO\nSOME\nSONG\nSONS\nSOON\nSOOT\nSOPS\nSORE\nSORT\nSOUL\nSOUP\nSOUR\nSOWN\nSOWS\nSOYA\nSPAM\nSPAN\nSPAR\nSPAS\nSPAT\nSPAY\nSPEC\nSPED\nSPEW\nSPIN\nSPIT\nSPOT\nSPRY\nSPUD\nSPUN\nSPUR\nSTAB\nSTAG\nSTAR\nSTAT\nSTAY\nSTEM\nSTEP\nSTEW\nSTIR\nSTOP\nSTOW\nSTUB\nSTUD\nSTUN\nSTYE\nSUBS\nSUCH\nSUCK\nSUED\nSUES\nSUET\nSUIT\nSULK\nSUMO\nSUMP\nSUMS\nSUNG\nSUNK\nSUNS\nSUPS\nSURE\nSURF\nSUSS\nSWAB\nSWAG\nSWAM\nSWAN\nSWAP\nSWAT\nSWAY\nSWIG\nSWIM\nSWUM\nSYNC\nSYNE\nTABS\nTACH\nTACK\nTACO\nTACT\nTAIL\nTAKE\nTALC\nTALE\nTALK\nTALL\nTAME\nTAMP\nTANG\nTANK\nTANS\nTAPE\nTAPS\nTARE\nTARN\nTARO\nTARP\nTARS\nTART\nTASK\nTAUT\nTAXI\nTEAK\nTEAL\nTEAM\nTEAR\nTEAS\nTEAT\nTECH\nTEEM\nTEEN\nTEES\nTEFF\nTELE\nTELL\nTEMP\nTEND\nTENT\nTERM\nTERN\nTEST\nTEXT\nTHAN\nTHAT\nTHAW\nTHEE\nTHEM\nTHEN\nTHEY\nTHIN\nTHIS\nTHOU\nTHRU\nTHUD\nTHUG\nTHUS\nTICK\nTIDE\nTIDY\nTIED\nTIER\nTIES\nTIFF\nTIKI\nTILE\nTILL\nTILT\nTIME\nTINE\nTING\nTINS\nTINT\nTINY\nTIPS\nTIRE\nTITS\nTOAD\nTODE\nTOED\nTOES\nTOFU\nTOGA\nTOIL\nTOKE\nTOLD\nTOLE\nTOLL\nTOMB\nTOME\nTONE\nTONG\nTOOK\nTOOL\nTOON\nTOOT\nTOPS\nTORE\nTORN\nTORT\nTORY\nTOSS\nTOTE\nTOTS\nTOUR\nTOUT\nTOWN\nTOWS\nTOYS\nTRAM\nTRAP\nTRAY\nTREE\nTREK\nTREY\nTRIG\nTRIM\nTRIO\nTRIP\nTROD\nTROT\nTSAR\nTUBA\nTUBE\nTUBS\nTUCK\nTUFF\nTUFT\nTUGS\nTUMS\nTUNA\nTUNE\nTURD\nTURF\nTURK\nTURN\nTUSH\nTUSK\nTUTS\nTUTU\nTWEE\nTWIG\nTWIN\nTWIT\nTWOS\nTYKE\nTYPE\nTYPO\nUDON\nUGLY\nUMPS\nUNDO\nUNIT\nUNTO\nUPON\nURGE\nURNS\nUSED\nUSER\nUSES\n_AIL\n_AIN\n_AMP\n_ANE\n_ANS\n_ARY\n_ASE\n_AST\n_ATS\n_EAL\n_EER\n_EIL\n_EIN\n_END\n_ENT\n_ERB\n_ERT\n_ERY\n_EST\n_ETO\n_ETS\n_IAL\n_IBE\n_ICE\n_IDS\n_IED\n_IES\n_IEW\n_ILE\n_IMS\n_INE\n_INO\n_ISA\n_ISE\n_ITA\n_I_A\n_OID\n_OLE\n_OLT\n_OTE\n_OWS\nWACK\nWADE\nWADS\nWAFT\nWAGE\nWAGS\nWAIF\nWAIL\nWAIT\nWAKE\nWALK\nWALL\nWAND\nWANE\nWANT\nWARD\nWARE\nWARM\nWARN\nWARP\nWARS\nWART\nWARY\nWASH\nWASP\nWATT\nWA_E\nWA_Y\nWAXY\nWAYS\nWEAK\nWEAN\nWEAR\nWEBS\nWEDS\nWEED\nWEEK\nWEEN\nWEEP\nWELL\nWENT\nWERE\nWEST\nWHAT\nWHEN\nWHOM\nWIDE\nWIFE\nWILD\nWILL\nWILT\nWIND\nWINE\nWING\nWINS\nWIPE\nWIRE\nWISE\nWISH\nWITH\nWOLF\nWOOD\nWOOL\nWORD\nWORE\nWORK\nWORM\nWORN\nWRAP\nYARD\nYARN\nYEAH\nYEAR\nYOGA\nYOUR\nZERO\nZINC\nZONE\nZOOM\n!!!!\n\nMESSAGE Well done, you completed 2222.";compile(["restart"],sourceCode);</script></body></html>